{"path":"Documents/Books/Software Reverse Engineering/9391030378 Implementing Reverse Engineering [Narula 2022] {6EF8BFA0}.pdf","text":"Imp le me n t in g R e v e r s e E n gin e e r in g T h e R e a l P r a c t ic e o f x 86 Int e r n a ls , C o d e C a llin g C o n v e n t io n s , R a n s o m w a r e D e c r y p t io n , A p p lic a t io n C r a c k in g , A s s e m b ly L a n g u a g e , a n d P r o v e n C y b e r s e c u r it y O p e n S o u r c e To o ls Jit e n d e r N a r u la w w w .b p b o n lin e .c o m FIRST EDITION 2022 Copyright © BPB Publications, India ISBN: 978-93-91030-377 All Rights Reserved. No part of this publication may be reproduced, distributed or transmitted in any form or by any means or stored in a database or retrieval system, without the prior written permission of the publisher with the exception to the program listings which may be entered, stored and executed in a computer system, but they can not be reproduced by the means of publication, photocopy, recording, or by any electronic and mechanical means. LIMITS OF LIABILITY AND DISCLAIMER OF WARRANTY The information contained in this book is true to correct and the best of author’s and publisher’s knowledge. The author has made every eﬀort to ensure the accuracy of these publications, but publisher cannot be held responsible for any loss or damage arising from any information in this book. All trademarks referred to in the book are acknowledged as properties of their respective owners but BPB Publications cannot guarantee the accuracy of this information. sanet.st w w w .b p b o n lin e .c o m D e d ic a t e d t o M y p a r e n t s A lw a y s s e e n G o d in t h e m A b o u t t h e A u t h o r Jit e n d e r N a r u la is a n e x p e r ie n c e d C y b e r S e c u r it y S p e c ia lis t c u r r e n t ly a s s o c ia t e d w it h In t e r n a t io n a l In s t it u t e o f C y b e r S e c u r it y h a v in g o v e r 1 8 y e a r s o f in d u s t r y e x p e r ie n c e . H e h a s m a n y y e a r s o f c y b e r s e c u r it y e x p e r ie n c e w it h go v e r n m e n t s a n d c o r p o r a t e w o r ld . In In d ia , h e h a s w o r k e d w it h go v e r n m e n t e n t it ie s lik e D e lh i P o lic e , IC A I ( In s t it u t e o f C h a r t e r e d A c c o u n t a n t s o f In d ia ) , D e lh i Un iv e r s it y a n d o t h e r p r iv a t e o r ga n iz a t io n s . H e h a s w o r k e d o n t h e p r o je c t s o f A T & T, C it r ix , G o o gle , C o n e x a n t , IP o lic y N e t w o r k s ( Te c h M a h in d r a n o w ) , N a r u s ( a w h o lly o w n e d s u b s id ia r y o f T h e B o e in g C o m p a n y ) a n d H F C L . A p a r t fr o m t h is , h e h a s c o n d u c t e d t r a in in g p r o gr a m s fo r v a r io u s c o r p o r a t e a n d go v e r n m e n t o ﬃ c ia ls in In d ia a n d M e x ic o . H e h a s p u b lis h e d a r t ic le s , r e s e a r c h in fo r m a t io n a n d in t e r v ie w s in t h e a r e a o f c y b e r s e c u r it y fo r In fo r m a t io n S e c u r it y N e w s p a p e r N o t ic ia s d e s e gu r id a d in fo r m á t ic a C ib e r t ip - N o t ic ia s d e H a c k in g E x p lo it O n e iic y b e r s e c u r it y b lo g a n d a ls o c o n t r ib u t e d t o t h e V is h v a s N e w s , w h ic h is p a r t o f D a in ik Ja gr a n ( In d ia n la n gu a ge d a ily n e w s p a p e r ) . A b o u t t h e R e v ie w e r S a n il N a d k a r n i is C IS O / C R O / D P O in a n M N C . H e h a s w o r k e d fo r o r ga n iz a t io n s a n d c lie n t s s u c h a s M ic r o s o f t , S y m a n t e c , M p h a s iS , C a p it a , S L K a n d h a s s u p p o r t e d In t e r n a t io n a l B a n k s a n d F in a n c ia l O r ga n iz a t io n s . H e is a n in t e r n a t io n a l s p e a k e r, a u t h o r a n d t r a in e r. S a n il h a s p u b lis h e d o v e r 1 0 0 a r t ic le s o n lin e a n d a ls o fo r v a r io u s m a ga z in e s . H is c e r t iﬁ c a t io n s in c lu d e C F E , C IS S P, C IS A , C IS M , S e c u r it y +, IS O 2 7 0 0 1 L A , IS O 2 2 3 0 1 L A , A +, N +, M C P, M C S A , C C N A , S C S A , IS O 1 0 0 1 2 ( G D P R ) , R H C E , C E H ,C B C P, IS O 3 1 0 0 0 R is k a n d M ic r o s o f t A z u r e A r c h it e c t . S a n il h a s r e c e iv e d h o n o r s a n d a w a r d s s u c h a s C IS O T O P 1 0 0 A w a r d , D y n a m ic C IS O A w a r d , To p 1 0 0 C IO a w a r d a n d m a n y m o r e . H e h a s p u b lis h e d a b o o k o n F u n d a m e n t a ls o n In fo r m a t io n S e c u r it y w h ic h is a v a ila b le o n A m a z o n . A c k n o w le d ge me n t F ir s t a n d fo r e m o s t , p r a is e s a n d t h a n k s t o m y D a d , M o m a n d G o d fo r s h o w e r in g b le s s in gs t h r o u gh o u t m y w o r k t o c o m p le t e t h e b o o k s u c c e s s fu lly. I w o u ld lik e t o e x p r e s s m y d e e p a n d s in c e r e gr a t it u d e t o A t u l N a r u la , m y c o lle a gu e a t In t e r n a t io n a l In s t it u t e o f C y b e r S e c u r it y, M e x ic o fo r h e lp in g w it h t h e r e v ie w p r o c e s s o f t h is b o o k . I a m e x t r e m e ly gr a t e fu l fo r w h a t h e h a s o ﬀ e r e d m e . I w o u ld a ls o lik e t o t h a n k h im fo r h is fr ie n d s h ip , e m p a t h y a n d gr e a t s e n s e o f h u m o r. I a m e x t r e m e ly gr a t e fu l t o m y p a r e n t s ( R a m e s h N a r u la a n d M o h in i N a r u la ) fo r t h e ir lo v e , p r a y e r s , c a r e a n d s a c r iﬁ c e s fo r e d u c a t in g a n d p r e p a r in g m e fo r m y fu t u r e . I a m v e r y m u c h t h a n k fu l t o m y w ife a n d s o n fo r t h e ir lo v e , u n d e r s t a n d in g, p r a y e r s a n d c o n t in u in g s u p p o r t t o c o m p le t e t h is b o o k . A ls o , I w o u ld lik e t o e x p r e s s m y t h a n k s t o D r. S h ilp i S a h i a n d O m N a r u la fo r t h e ir s u p p o r t a n d m o t iv a t io n t h r o u gh o u t t h is p r o c e s s o f w r it in g. O n c e a ga in , I w o u ld lik e t o t h a n k m y fa m ily fo r p u t t in g u p w it h m e w h ile I w a s s p e n d in g m a n y n igh t s w r it in g—I c o u ld h a v e n e v e r c o m p le t e d t h is b o o k w it h o u t t h e ir s u p p o r t . F in a lly, I w o u ld lik e t o t h a n k s B P B P u b lic a t io n s fo r giv in g m e t h e o p p o r t u n it y t o w r it e m y ﬁ r s t b o o k fo r t h e m . P r e fa c e R e v e r s e E n gin e e r in g ( R E ) is a n a r t o f u n d e r s t a n d in g a n y p r o gr a m c o d e w h e n n o s o u r c e c o d e is a v a ila b le . T h is b o o k p r o v id e s s t e p - b y -s t e p e x p la n a t io n o f t h e e s s e n t ia l c o n c e p t s a n d p r a c t ic a l e x a m p le s t o u n d e r s t a n d a n d im p le m e n t R e v e r s e E n gin e e r in g. It w ill e n a b le t h e r e a d e r s t o u n d e r s t a n d t h e a p p lic a t io n c o d e ﬂ o w t o id e n t if y v u ln e r a b ilit ie s a n d b u gs in t h e a p p lic a t io n . T h is b o o k is fo r t h e r e a d e r s w h o w a n t t o s t a r t le a r n in g R e v e r s e E n gin e e r in g fr o m b a s ic s in a s t e p -b y -s t e p m a n n e r. T h e b o o k is d iv id e d in t o t h r e e p a r t s : E x p lo r in g R e v e r s e E n gin e e r in g R e v e r s e E n gin e e r in g A p p lic a t io n s R e a l W o r ld E x a m p le s w it h S o lu t io n s T h e ﬁ r s t p a r t E x p lo r in g R e v e r s e E n gin e e r in g s t a r t s w it h t h e b a s ic c o n c e p t s o f C o m p u t in g S y s t e m a n d D a t a B u ild in g B lo c k s o f t h e C o m p u t in g S y s t e m . T h is p a r t a ls o e n lis t s o p e n -s o u r c e t o o ls r e q u ir e d fo r R E a p p lic a t io n s a n d t h e p r o gr a m m in g in s t r u c t io n s o f R E . T h e s e c o n d p a r t R e v e r s e E n gin e e r in g A p p lic a t io n s w a lk s u s t h r o u gh t h e d iﬀ e r e n t a p p lic a t io n s / p r o gr a m s t o u n d e r s t a n d t h e im p le m e n t a t io n o f R E . T h is p a r t c o v e r s v a r io u s p r a c t ic a ls , w h ic h giv e t h e u s e r s a h a n d s -o n e x p e r ie n c e . A ll t h e a p p lic a t io n s / p r o gr a m s m e n t io n e d in t h is p a r t a r e a lign e d in a s y s t e m a t ic m a n n e r ; fr o m r e v e r s e e n gin e e r in g o f b a s ic C / C ++ p r o gr a m s t o c o m p le x C / C ++ p r o gr a m s . In t h e t h ir d p a r t R e a l W o r ld E x a m p le s a n d S o lu t io n s o f t h is b o o k , R E o f w e ll-k n o w n Win d o w s a p p lic a t io n a lo n g w it h d iﬀ e r e n t e x e r c is e s a r e d e m o n s t r a t e d in a s t e p -b y -s t e p m a n n e r. O v e r t h e 1 8 c h a p t e r s in t h is b o o k , y o u w ill le a r n t h e fo llo w in g: P A R T 1 : E x p lo r in g R e v e r s e E n gin e e r in g In t h is p a r t , t h e r e a d e r s w ill u n d e r s t a n d t h e im p a c t o f R E o n in d u s t r y, b u ild in g b lo c k s o f x 8 6 c o m p u t in g s y s t e m a n d t h e r o le o f e a c h in t h e o v e r a ll fu n c t io n in g o f x 8 6 s y s t e m . C h a p t e r 1 t a lk s a b o u t t h e im p a c t o f R E o n IT in d u s t r y a n d h o w it o r igin a t e d a s a n a r e a . C h a p t e r 2 t a lk s a b o u t t h e b u ild in g b lo c k s o f a c o m p u t in g s y s t e m a n d t h e r o le o f e a c h b u ild in g b lo c k in t h e o v e r a ll fu n c t io n in g o f t h e s y s t e m . T h is c h a p t e r is im p o r t a n t in o r d e r t o u n d e r s t a n d t h e c o r e c o n c e p t b e h in d t h e w o r k in g o f x 8 6 c o m p u t in g s y s t e m s . C h a p t e r 3 fo c u s e s o n t h e o p e n -s o u r c e t o o ls u s e d in R E a n d h o w t h e s e t o o ls a r e u s e d fo r d e b u ggin g a n d a n a ly s is . T h e s e t o o ls w ill b e u s e d in a ll illu s t r a t io n s s h o w n in t h is b o o k . C h a p t e r 4 e x p la in s a b o u t t h e m a jo r a s s e m b ly in s t r u c t io n s u s e d a n d a ls o a b o u t h o w d iﬀ e r e n t in s t r u c t io n s a r e s e gm e n t e d in v a r io u s s e c t io n s fo r e a s y u n d e r s t a n d in g a lo n g w it h e x a m p le s . C h a p t e r 5 h e lp s u s u n d e r s t a n d t h e d iﬀ e r e n t c a llin g c o n v e n t io n s a lo n g w it h p r a c t ic a l illu s t r a t io n s . P A R T 2 : R e v e r s e E n gin e e r in g A p p lic a t io n s T h is is w h e r e t h e s t r a t e gic w a y o f le a r n in g R E a p p lic a t io n s / p r o gr a m s is e x p la in e d w it h d iﬀ e r e n t illu s t r a t io n s . E v e r y c a s e is t h e o u t c o m e o f r e s e a r c h e x p la in e d in a v e r y s im p liﬁ e d a n d s t e p -b y -s t e p m a n n e r. C h a p t e r 6 giv e s a s t e p -b y -s t e p u n d e r s t a n d in g o f t h e a s s e m b ly c o d e ge n e r a t e d fr o m b a s ic C / C ++ p r o gr a m . C h a p t e r 7 p r o v id e s a s t e p -b y -s t e p u n d e r s t a n d in g o f t h e a s s e m b ly c o d e ge n e r a t e d fr o m p r in t f( ) fu n c t io n in C / C ++ p r o gr a m . C h a p t e r 8 giv e s a s t e p -b y -s t e p u n d e r s t a n d in g o f t h e a s s e m b ly c o d e ge n e r a t e d fr o m p o in t e r s in C / C ++ p r o gr a m . C h a p t e r 9 p r o v id e s a s t e p -b y -s t e p u n d e r s t a n d in g o f t h e a s s e m b ly c o d e ge n e r a t e d fr o m d e c is io n c o n t r o l s t r u c t u r e in C / C ++ p r o gr a m . C h a p t e r 1 0 giv e s a s t e p -b y -s t e p u n d e r s t a n d in g o f t h e a s s e m b ly c o d e ge n e r a t e d fr o m lo o p c o n t r o l s t r u c t u r e in C / C ++ p r o gr a m . P A R T 3 : R e a l W o r ld E x a mp le s a n d S o lu t io n s In t h is p a r t , u n d e r s t a n d in g o f w h a t e v e r le a r n e d in t h e p r e v io u s c h a p t e r s is e x p la in e d w it h r e a l w o r ld e x e r c is e s w it h s o lu t io n s a n d a ls o r e v e r s in g o f Win d o w s w e ll-k n o w n a p p lic a t io n is d e m o n s t r a t e d . C h a p t e r 1 1 c o v e r s R E e x e r c is e o f a n a r r a y c o d e a lo n g w it h t h e s o lu t io n u s e d in t h e R E p r o c e s s . C h a p t e r 1 2 c o v e r s R E e x e r c is e o f a s t r u c t u r e c o d e a lo n g w it h t h e s o lu t io n u s e d in t h e R E p r o c e s s . C h a p t e r 1 3 e x p la in s R E e x e r c is e o f a S c a n f p r o gr a m a lo n g w it h t h e s o lu t io n u s e d in t h e R E p r o c e s s . C h a p t e r 1 4 e x p la in s R E e x e r c is e o f a s t r c p y p r o gr a m a lo n g w it h t h e s o lu t io n u s e d in t h e R E p r o c e s s . C h a p t e r 1 5 c o v e r s R E e x e r c is e o f a s im p le in t e r e s t c o d e a lo n g w it h t h e s o lu t io n u s e d in t h e R E p r o c e s s . C h a p t e r 1 6 e x p la in s R E e x e r c is e o f b r e a k in g W a n n a c r y r a n s o m w a r e w it h G h id r a . C h a p t e r 1 7 c o v e r s R E e x e r c is e u s in g C u t t e r t o o l. C h a p t e r 1 8 d e m o n s t r a t e s t h e p r o c e s s o f R E o f Win d o w s C a lc u la t o r in a s t e p -b y -s t e p m a n n e r. T h is b o o k is t o e d u c a t e t h e le a r n e r s o n t h e t o p ic o f R e v e r s e E n gin e e r in g o n x 8 6 p la t fo r m . T h is w ill b e a go o d b o o k fo r b e gin n e r s a n d c o m p u t e r gr a d u a t e s in t h e a r e a o f R E . P r o fe s s io n a ls w h o w a n t t o s w it c h t h e ir c a r e e r t o R E c a n a ls o u s e t h is b o o k . O t h e r r e a d e r s c a n b e fr o m s c h o o ls , u n iv e r s it ie s o r t h o s e w h o a r e p a s s io n a t e t o ge t in t o t h e a r e a o f c y b e r s e c u r it y. D o w n lo a d in g t h e c o d e b u n d le a n d c o lo u r e d ima ge s : P le a s e fo llo w t h e lin k t o d o w n lo a d t h e C o d e B u n d le a n d t h e C o lo u r e d Im a g e s o f t h e b o o k : h t t p s :// r e b r a n d .ly / b 2 fe 9 c E r r a t a W e t a k e im m e n s e p r id e in o u r w o r k a t B P B P u b lic a t io n s a n d fo llo w b e s t p r a c t ic e s t o e n s u r e t h e a c c u r a c y o f o u r c o n t e n t t o p r o v id e w it h a n in d u lgin g r e a d in g e x p e r ie n c e t o o u r s u b s c r ib e r s . O u r r e a d e r s a r e o u r m ir r o r s , a n d w e u s e t h e ir in p u t s t o r e ﬂ e c t a n d im p r o v e u p o n h u m a n e r r o r s , if a n y, t h a t m a y h a v e o c c u r r e d d u r in g t h e p u b lis h in g p r o c e s s e s in v o lv e d . To le t u s m a in t a in t h e q u a lit y a n d h e lp u s r e a c h o u t t o a n y r e a d e r s w h o m igh t b e h a v in g d iﬃ c u lt ie s d u e t o a n y u n fo r e s e e n e r r o r s , p le a s e w r it e t o u s a t : e r r a t a @b p b o n lin e .c o m Yo u r s u p p o r t , s u gge s t io n s a n d fe e d b a c k s a r e h igh ly a p p r e c ia t e d b y t h e B P B P u b lic a t io n s ’ F a m ily. D id y o u k n o w t h a t B P B o ﬀ e r s e B o o k v e r s io n s o f e v e r y b o o k p u b lis h e d , w it h P D F a n d e P u b ﬁ le s a v a ila b le ? Yo u c a n u p gr a d e t o t h e e B o o k v e r s io n a t w w w .b p b o n lin e .c o m a n d a s a p r in t b o o k c u s t o m e r, y o u a r e e n t it le d t o a d is c o u n t o n t h e e B o o k c o p y. G e t in t o u c h w it h u s a t b u s in e s s @b p b o n lin e .c o m fo r m o r e d e t a ils . A t y o u c a n a ls o r e a d a c o lle c t io n o f fr e e t e c h n ic a l a r t ic le s , s ign u p fo r a r a n ge o f fr e e n e w s le t t e r s , a n d r e c e iv e e x c lu s iv e d is c o u n t s a n d o ﬀ e r s o n B P B b o o k s a n d e B o o k s . B P B is s e a r c h in g fo r a u t h o r s lik e y o u If y o u 'r e in t e r e s t e d in b e c o m in g a n a u t h o r fo r B P B , p le a s e v is it w w w .b p b o n lin e .c o m a n d a p p ly t o d a y. W e h a v e w o r k e d w it h t h o u s a n d s o f d e v e lo p e r s a n d t e c h p r o fe s s io n a ls , ju s t lik e y o u , t o h e lp t h e m s h a r e t h e ir in s igh t w it h t h e glo b a l t e c h c o m m u n it y. Yo u c a n m a k e a ge n e r a l a p p lic a t io n , a p p ly fo r a s p e c iﬁ c h o t t o p ic t h a t w e a r e r e c r u it in g a n a u t h o r fo r, o r s u b m it y o u r o w n id e a . T h e c o d e b u n d le fo r t h e b o o k is a ls o h o s t e d o n G it H u b a t In c a s e t h e r e 's a n u p d a t e t o t h e c o d e , it w ill b e u p d a t e d o n t h e e x is t in g G it H u b r e p o s it o r y. W e a ls o h a v e o t h e r c o d e b u n d le s fr o m o u r r ic h c a t a lo g o f b o o k s a n d v id e o s a v a ila b le a t C h e c k t h e m o u t ! P IR A C Y If y o u c o m e a c r o s s a n y ille ga l c o p ie s o f o u r w o r k s in a n y fo r m o n t h e in t e r n e t , w e w o u ld b e gr a t e fu l if y o u w o u ld p r o v id e u s w it h t h e lo c a t io n a d d r e s s o r w e b s it e n a m e . P le a s e c o n t a c t u s a t b u s in e s s @b p b o n lin e .c o m w it h a lin k t o t h e m a t e r ia l. If y o u a r e in t e r e s t e d in b e c o min g a n a u t h o r If t h e r e is a t o p ic t h a t y o u h a v e e x p e r t is e in , a n d y o u a r e in t e r e s t e d in e it h e r w r it in g o r c o n t r ib u t in g t o a b o o k , p le a s e v is it R E V IEWS P le a s e le a v e a r e v ie w . O n c e y o u h a v e r e a d a n d u s e d t h is b o o k , w h y n o t le a v e a r e v ie w o n t h e s it e t h a t y o u p u r c h a s e d it fr o m ? P o t e n t ia l r e a d e r s c a n t h e n s e e a n d u s e y o u r u n b ia s e d o p in io n t o m a k e p u r c h a s e d e c is io n s , w e a t B P B c a n u n d e r s t a n d w h a t y o u t h in k a b o u t o u r p r o d u c t s , a n d o u r a u t h o r s c a n s e e y o u r fe e d b a c k o n t h e ir b o o k . T h a n k y o u ! F o r m o r e in fo r m a t io n a b o u t B P B , p le a s e v is it Ta b le o f C o n t e n t s 1 . Imp a c t o f R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e In t r o d u c t io n t o R e v e r s e E n gin e e r in g Im p o r t a n c e o f R e v e r s e E n gin e e r in g S t u d y in g a n e x is t in g d e s ig n R e d e v e lo p in g a n o u t d a t e d o r lo s t p r o d u c t S e c u r it y a u d it in g F in d in g s e n s it iv e d a t a M ilit a r y e s p io n a g e F in d in g p r o d u c t v u ln e r a b ilit ie s B o u n t y fo r c y b e r e n t h u s ia s t s T h e R o le o f R e v e r s e E n gin e e r in g C o n c lu s io n 2 . Un d e r s t a n d in g A r c h it e c t u r e o f x 8 6 M a c h in e s S t r u c t u r e O b je c t iv e A r c h it e c t u r e o f a C o m p u t in g S y s t e m C P U M e m o r y Inp u t / o u t p u t D e v ic e s S y s t e m B u s B u ild in g b lo c k s o f a C o m p u t in g S y s t e m M ic r o p r o c e s s o r M e m o r y R e gis t e r s G e n e r a l P u r p o s e R e g is t e r S e g m e n t R e g is t e r s S t a t u s R e g is t e r s Ins t r u c t io n P o in t e r R e g is t e r C o n c e p t o f S t a c k C a lle r B e fo r e C a lle e C a ll C a lle e A f t e r F u n c t io n C a ll C a lle e B e fo r e R e t u r n in g C a lle r A f t e r R e t u r n in g C o n c lu s io n 3 . Up a n d R u n n in g w it h R e v e r s e E n gin e e r in g To o ls S t r u c t u r e O b je c t iv e Im p o r t a n c e o f t o o ls in r e v e r s e e n gin e e r in g R e v e r s e e n gin e e r in g t o o ls P o r t a b le E x e c u t a b le E d it o r s C F F E x p lo r e r D is a s s e m b le r G h id r a C u t t e r D e b u gge r s x 3 2 d b g C o n c lu s io n 4 . W a lk T h r o u gh o n A s s e mb ly In s t r u c t io n s S t r u c t u r e O b je c t iv e D iﬀ e r e n t a s s e m b ly la n gu a ge in s t r u c t io n s S t a c k In s t r u c t io n s P US H P US H A D P US H F D P O P P O P A D P O P F D R E T D a t a Tr a n s fe r In s t r u c t io n s M O V L E A X C H G C M P X C H G L A H F S A H F L A R M O V S X M O V Z X X L A T M O V S A r it h m e t ic In s t r u c t io n s A A A A A S A A D A A M A D C A D D C M P D A A D A S D E C D IV ID IV M UL IM UL IN C N E G S B B S UB X A D D P r o gr a m E x e c u t io n In s t r u c t io n s C A L L E N T E R L E A V E IN T IN T O IR E T L O O P L O O P E L O O P N E T E S T B r a n c h in g In s t r u c t io n s JM P JZ JN Z JE JN E JG JG E JA JA E JL JL E JB JB E JO JS JEC X Z B it M a n ip u la t io n In s t r u c t io n s B S W A P A N D N O T O R X O R R C L R C R R O L R O R S H R S H L S A R S A L S H L D S H R D P r o c e s s o r C o n t r o l In s t r u c t io n s C L C C L D C L I C M C E S C L O C K N O P S T C S T D S T I S t r in g In s t r u c t io n s C M P S / C M P S B / C M P S W IN / IN S B / IN S W/ IN S D O UT/ O UTS B / O UTS W/ O UTS D L O D S / L O D S B / L O D S W/ L O D S D S T O S / S T O S B / S T O S W S C A S / S C A S B / S C A S W M O V S / M O V S B / M O V S W R E P R E P E / R E P Z R E P N E / R E P N Z C o n c lu s io n 5 . Ty p e s o f C o d e C a llin g C o n v e n t io n s S t r u c t u r e O b je c t iv e Un d e r s t a n d t y p e s o f c a llin g c o n v e n t io n s C D E C L S T D C A L L F A S T C A L L C o n c e p t b e h in d d iﬀ e r e n t c a llin g c o n v e n t io n s C D E C L S T D C A L L F A S T C A L L C o n c lu s io n 6 . R e v e r s e E n gin e e r in g P a t t e r n o f B a s ic C o d e S t r u c t u r e O b je c t iv e Wh a t is C o d e O p t im iz a t io n ? E m p t y fu n c t io n E m p t y F u n c t io n w it h o u t O p t im iz a t io n E m p t y F u n c t io n w it h O p t im iz a t io n R e t u r n in g V a lu e R e t u r n in g V a lu e w it h o u t O p t im iz a t io n R e t u r n in g V a lu e w it h O p t im iz a t io n B a s ic “ H e llo , W o r ld ” P r o gr a m B a s ic “ H e llo , W o r ld ” P r o g r a m w it h o u t O p t im iz a t io n B a s ic “ H e llo , W o r ld ” P r o g r a m w it h O p t im iz a t io n C o n c lu s io n 7 . R e v e r s e E n gin e e r in g P a t t e r n o f P r in t f P r o gr a m S t r u c t u r e O b je c t iv e F u n c t io n p r in t f w it h In t e ge r s F u n c t io n p r in t f P r in t in g Int e g e r s w it h o u t O p t im iz a t io n F u n c t io n p r in t f P r in t in g Int e g e r s w it h O p t im iz a t io n F u n c t io n p r in t f w it h F lo a t F u n c t io n p r in t f P r in t in g F lo a t w it h o u t O p t im iz a t io n F u n c t io n p r in t f P r in t in g F lo a t w it h O p t im iz a t io n F u n c t io n p r in t f w it h c h a r F u n c t io n p r in t f P r in t in g C h a r w it h o u t O p t im iz a t io n F u n c t io n p r in t f p r in t in g C h a r w it h O p t im iz a t io n C o n c lu s io n 8 . R e v e r s e E n gin e e r in g P a t t e r n o f P o in t e r P r o gr a m S t r u c t u r e O b je c t iv e P o in t e r s P o in t e r w it h o u t O p t im iz a t io n P o in t e r w it h O p t im iz a t io n C o n c lu s io n 9 . R e v e r s e E n gin e e r in g P a t t e r n o f D e c is io n C o n t r o l S t r u c t u r e S t r u c t u r e O b je c t iv e If-e ls e s t a t e m e n t If-e ls e s t a t e m e n t w it h o u t O p t im iz a t io n If-e ls e s t a t e m e n t w it h O p t im iz a t io n C o n c lu s io n 1 0 . R e v e r s e E n gin e e r in g P a t t e r n o f L o o p C o n t r o l S t r u c t u r e S t r u c t u r e O b je c t iv e Wh ile C o n d it io n While c o n d it io n w it h o u t O p t im iz a t io n While c o n d it io n w it h O p t im iz a t io n F o r L o o p F o r L o o p w it h o u t O p t im iz a t io n F o r L o o p w it h O p t im iz a t io n C o n c lu s io n 1 1 . A r r a y C o d e P a t t e r n in R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e Un d e r s t a n d in g a n a r r a y A r r a y L o o p w it h o u t O p t im iz a t io n A r r a y L o o p w it h O p t im iz a t io n C o n c lu s io n 1 2 . S t r u c t u r e C o d e P a t t e r n in R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e Un d e r s t a n d in g o f s t r u c t u r e s S t r u c t u r e w it h o u t O p t im iz a t io n S t r u c t u r e w it h O p t im iz a t io n C o n c lu s io n 1 3 . S c a n f P r o gr a m P a t t e r n in R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e F u n c t io n s c a n f w it h In t e ge r s F u n c t io n s c a n f w it h o u t O p t im iz a t io n F u n c t io n s c a n f w it h O p t im iz a t io n C o n c lu s io n 1 4 . S t r c p y P r o gr a m P a t t e r n in R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e S t r c p y S t r c p y w it h o u t O p t im iz a t io n S t r c p y w it h O p t im iz a t io n C o n c lu s io n 1 5 . S imp le In t e r e s t C o d e P a t t e r n in R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e P r o gr a m t o C a lc u la t e S im p le In t e r e s t C a lc u la t e S im p le In t e r e s t Wit h o u t O p t im iz a t io n C o n c lu s io n 1 6 . B r e a k in g W a n n a c r y R a n s o m w a r e Wit h R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e In s t a lla t io n A n a ly z in g a n d B r e a k in g W a n n a c r y C o n c lu s io n 1 7 . G e n e r a t e P s e u d o C o d e F r o m B in a r y F ile S t r u c t u r e O b je c t iv e C u t t e r In s t a lla t io n B in a r y A n a ly s is Us in g C u t t e r D a s h b o a r d S t r in g s Im p o r t s D is a s s e m b ly G r a p h H e x d u m p D e c o m p ile r D e c r y p t in g t h e H id d e n UR L C o n c lu s io n 1 8 . F u n Wit h Win d o w s C a lc u la t o r Us in g R e v e r s e E n gin e e r in g S t r u c t u r e O b je c t iv e R e v e r s e E n gin e e r in g C a lc u la t o r Un d e r s t a n d in g t h e c o d e ﬂ o w w it h b r e a k p o in t s F in d in g a p la c e h o ld e r t o c a ll o u r c o d e W r it in g o u r c o d e in t h e C o d e C a v e P a t c h in g t h e b in a r y C o n c lu s io n A p p e n d ix M a c r o P r o c e d u r e n p a d L S B a n d M S B S ign e d a n d Un s ign e d Un s ign e d S ign e d B it S h if t in g L o gic a l b it s h if t in g A r it h m e t ic b it s h if t in g A S C II Un ic o d e D is a b le A d d r e s s S p a c e L a y o u t R a n d o m iz a t io n In d e x C H A P T E R 1 Imp a c t o f R e v e r s e E n gin e e r in g B e fo r e w e s t a r t o n t h e im p le m e n t a t io n o f r e v e r s e e n gin e e r in g, it w ill b e in t e r e s t in g t o u n d e r s t a n d w h a t r e v e r s e e n gin e e r in g r e a lly is , h o w it c a m e in t o e x is t e n c e , a n d h o w it is b e n e ﬁ c ia l in t h e m o d e r n e r a . R e v e r s e e n gin e e r in g, a s t h e n a m e s u gge s t s , is a c o m b in a t io n o f t w o w o r d s : R e v e r s e a n d E n gin e e r in g. E n gin e e r in g is t h e s c ie n c e o f d e s ign in g a n d b u ild in g s o m e t h in g b e n e ﬁ c ia l fo r t h e h u m a n r a c e . E n gin e e r in g h a s p r o v id e d u s w it h b o t h a d v a n t a ge s a n d d is a d v a n t a ge s . E n gin e e r in g e q u ip p e d u s w it h t h e k n o w le d ge a n d m e a n s t o b u ild e s s e n t ia l t h in gs fo r t h e h u m a n r a c e , in c lu d in g r o a d s , b u ild in gs , b r id ge s , c a r s , a ir p la n e s , s o f t w a r e , a n d m o r e . H o w e v e r, gr a d u a lly, w e a ls o s t a r t e d u s in g e n gin e e r in g t o p r o d u c e w e a p o n s o f m a s s d e s t r u c t io n lik e m is s ile s , m a lw a r e , a n d o t h e r d e a d ly p r o d u c t s h a r m fu l fo r h u m a n s a n d n a t u r e it s e lf. Wh e n a n y t h in g is e n gin e e r e d , it go e s t h r o u gh m a n y p h a s e s o f d e s ign , d e v e lo p m e n t , a n d t e s t in g. Wit h r e v e r s e e n gin e e r in g, t h in gs h a v e r e a lly c h a n ge d . T h e c o n c e p t b e h in d r e v e r s e e n gin e e r in g is t o b r e a k s o m e t h in g t o u n d e r s t a n d it s in t e r n a l a r c h it e c t u r e t o b u ild a c o p y o r fo r t h e p u r p o s e o f im p r o v e m e n t o r m o d iﬁ c a t io n . In t h is c h a p t e r, w e w ill t a lk a b o u t s o m e r e a l-life e x a m p le s t o u n d e r s t a n d t h e im p o r t a n c e o f r e v e r s e e n gin e e r in g a n d h o w it is c h a n gin g t h e w a y t h e s o f t w a r e in d u s t r y w o r k s . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : In t r o d u c t io n t o R e v e r s e E n gin e e r in g Im p o r t a n c e o f R e v e r s e E n gin e e r in g T h e R o le o f R e v e r s e E n gin e e r in g O b je c t iv e A f t e r s t u d y in g t h is c h a p t e r, y o u s h o u ld b e a b le t o u n d e r s t a n d t h e im p o r t a n c e o f r e v e r s e e n gin e e r in g a n d it s im p a c t o n t h e s o f t w a r e in d u s t r y. W e w ill a ls o t a lk a b o u t t h e o p p o r t u n it ie s a s s o c ia t e d w it h r e v e r s e e n gin e e r in g a n d h o w m a lw a r e w r it e r s a r e u s in g it t o e x p lo it t h e s o f t w a r e s y s t e m s o f b ig c o m p a n ie s . In t r o d u c t io n t o R e v e r s e E n gin e e r in g In s o f t w a r e t e r m s , R e v e r s e E n gin e e r in g is t h e a r t o f u n d e r s t a n d in g a n y p r o gr a m c o d e w h e n n o s o u r c e c o d e is a v a ila b le . A ll o f t h is s t a r t e d in t h e la t e 1 9 8 0 s w h e n t h e D is k O p e r a t in g S y s t e m w a s in u s e . M o s t o f u s w e r e n o t b o r n a t t h a t t im e o r m igh t b e in o u r c h ild h o o d t im e . D u r in g t h a t t im e , p e o p le u s e d t o p la y D O S -b a s e d v id e o ga m e s . M o s t o f t h e ga m e s w e r e p la y e r -b a s e d v id e o ga m e s , w h e r e t h e ga m e p la y e r h a d a life lin e a n d is e q u ip p e d w it h t h e w e a p o n s . T h is is w h e r e s o m e gr o u p o f c o m p u t e r ge e k s fo llo w e d r e v e r s e e n gin e e r in g t e c h n iq u e s t o in c r e a s e t h e life lin e o f t h e ga m e p la y e r a n d c h a n ge t h e n u m b e r o f w e a p o n s a p la y e r c o u ld u s e . T h is w a s d o n e b y s im p ly m o d if y in g t h e v a lu e s a t t h e m e m o r y lo c a t io n w h e r e t h e life lin e a n d t h e n u m b e r o f w e a p o n s o f a p la y e r w e r e s t o r e d . T h is m igh t s o u n d lik e c h e a t in g, b u t in r e a lit y, it w a s a w a y t o b r e a c h t h e s e c u r it y o f t h e v id e o ga m e . To u n d e r s t a n d t h e im p o r t a n c e o f r e v e r s e e n gin e e r in g in t h e p r e s e n t t im e s , w e w ill t a k e a n e x a m p le . Im a gin e t h a t t h r e e p e o p le n a m e d Jit e n d e r, S h ilp i, a n d A t u l a r e w o r k in g fo r a r e s e a r c h a n d d e v e lo p m e n t o r ga n iz a t io n , t h e In t e r n a t io n a l In s t it u t e o f C y b e r S e c u r it y, h a v in g o ﬃ c e s in In d ia , M e x ic o , a n d t h e US . T h e s e t h r e e e m p lo y e e s a r e w o r k in g fr o m t h r e e d iﬀ e r e n t ge o gr a p h ic a l lo c a t io n s . F ig u r e 1 .1 : A n e x a m p le o f r e v e r s e e n g in e e r in g T h e y a r e a ll w o r k in g o n s o m e r e s e a r c h a n d d e v e lo p m e n t p r o je c t a n d s o t h e y s h a r e t h e ir r e s e a r c h ﬁ n d in gs o v e r t h e in t e r n e t . T h e y u s e s o m e s e c u r e s o f t w a r e t o s h a r e t h e d a t a a m o n g t h e m s e lv e s . A s t h e d a t a is v e r y c r it ic a l fo r t h e o r ga n iz a t io n , t h e s e c u r it y o f t h e s o f t w a r e u s e d t o s h a r e t h is d a t a s h o u ld a ls o b e v e r y s e c u r e . N o w , t h is s o f t w a r e c a n b e o p e n -s o u r c e s o f t w a r e o r c lo s e d -s o u r c e s o f t w a r e . If t h e s o f t w a r e t h e y a r e u s in g is o p e n -s o u r c e , t h e n t h e y c a n c h e c k t h e s e c u r it y o f t h e s o f t w a r e u s in g c o d e r e v ie w . B u t w h a t if t h e s o f t w a r e is c lo s e d -s o u r c e ? T h e y w ill n o t h a v e a n a c c e s s t o t h e s o u r c e c o d e o f t h e s o f t w a r e . In t h is c a s e , r e v e r s e e n gin e e r in g p la y s a b ig r o le in c h e c k in g t h e s e c u r it y o f c lo s e d -s o u r c e s o f t w a r e . Wit h t h e h e lp o f r e v e r s e e n gin e e r in g, s o f t w a r e s e c u r it y c a n b e e v a lu a t e d e v e n if y o u d o n o t h a v e t h e s o u r c e c o d e a v a ila b le . It w ill a ls o h e lp in ﬁ n d in g v u ln e r a b ilit ie s in t h e s o f t w a r e o r a p p lic a t io n if a n y. T h e p r o c e s s o f r e v e r s e e n gin e e r in g w a s in it ia lly a p p lie d t o c o m p u t e r a p p lic a t io n s a n d h a r d w a r e b u t n o w , r e v e r s e e n gin e e r in g is a p p lie d e v e r y w h e r e , fr o m s o f t w a r e a n d m a c h in e r y t o e v e n h u m a n D N A . R e v e r s e e n gin e e r in g is im p o r t a n t e s p e c ia lly w h e n y o u h a v e c lo s e d -s o u r c e s o f t w a r e o r s o f t w a r e w it h m a lic io u s c o n t e n t . L e t u s s t u d y a n o t h e r fa m o u s e x a m p le o f r e v e r s e e n gin e e r in g. A c o m p a n y n a m e d P h o e n ix Te c h n o lo gie s , b a s e d o u t in S a n Jo s e , w a n t e d t o d e v e lo p a B IO S c o m p a t ib le w it h IB M P C s . R a t h e r t h a n d e v e lo p in g a s e lf-d e s ign e d B IO S , t h e y t o o k t h e IB M p r o p r ie t a r y B IO S , r e v e r s e e n gin e e r e d it u s in g t h e \"c le a n r o o m \" o r \"C h in e s e w a ll\" a p p r o a c h . Un d e r t h is a p p r o a c h , t h e y t o o k t w o t e a m s o f e n gin e e r s . T h e ﬁ r s t t e a m r e v e r s e e n gin e e r e d t h e IB M p r o p r ie t a r y B IO S t o r e c r e a t e t h e d e s ign o f t h e IB M p r o p r ie t a r y B IO S . E v e r y t h in g w a s d o c u m e n t e d b y t h e ﬁ r s t t e a m o f e n gin e e r s fo r t h e s e c o n d t e a m t o w o r k o n . O n c e t h is d e s ign w a s r e c r e a t e d , t h e s e c o n d t e a m fo llo w e d t h e d o c u m e n t a t io n o f t h e d e s ign s p e c iﬁ c a t io n s a lo n g w it h t h e fu n c t io n a l r e q u ir e m e n t s c r e a t e d b y t h e ﬁ r s t t e a m t o c o d e t h e B IO S c o m p a t ib le w it h IB M P C s . T h e s e c o n d t e a m w a s t o t a lly ign o r a n t a b o u t t h e r e v e r s e e n gin e e r in g w o r k o f t h e ﬁ r s t t e a m . T h e ﬁ n a l p r o d u c t d e v e lo p e d b y P h o e n ix Te c h n o lo gie s w a s s o ld t o o t h e r P C m a n u fa c t u r e r s . T h e p r o d u c t d e v e lo p e d b y P h o e n ix Te c h n o lo gie s w a s o p e r a t io n a lly id e n t ic a l b u t w it h n o c o p y r igh t in fr in ge m e n t . M o r e o v e r, o t h e r c o m p a n ie s lik e A d v a n c e d M ic r o D e v ic e s a ls o r e v e r s e e n gin e e r e d In t e l c o r p o r a t io n m ic r o p r o c e s s o r s t o m a k e le s s e x p e n s iv e c h ip s . R e v e r s e e n gin e e r in g is n o t o n ly u s e d fo r u n e t h ic a l p u r p o s e s b u t a ls o e t h ic a l p u r p o s e s . O n e a m o n g t h e m is m a lw a r e a n a ly s is . A s m a lw a r e ’s a r e c lo s e d -s o u r c e b in a r ie s , r e v e r s e e n gin e e r in g h e lp s m a lw a r e r e s e a r c h e r s d e c o d e m a lw a r e fu n c t io n a lit y t o b r e a k t h e m . To u n d e r s t a n d t h e r e a l im p o r t a n c e o f r e v e r s e e n gin e e r in g, le t ’s t a lk a b o u t a fa m o u s r a n s o m w a r e k n o w n a s W a n n a c r y r a n s o m w a r e . R a n s o m w a r e s a r e t h e k in d o f m a lw a r e s t h a t , w h e n in s t a lle d in a v ic t im ’s c o m p u t e r, e n c r y p t s t h e v ic t im ’s ﬁ le s a n d d e m a n d s a r a n s o m t o d e c r y p t t h o s e ﬁ le s . If t h e v ic t im d o e s n o t p a y t h e r a n s o m w it h in t im e , t h e v ic t im ’s c o m p u t e r d a t a m a y b e d e le t e d o r t h e d a t a m a y b e le f t e n c r y p t e d fo r e v e r o r t h e r e a r e c h a n c e s t h a t t h is d a t a m igh t b e s o ld in t h e b la c k m a r k e t . W a n n a c r y t a r ge t e d Win d o w s u s e r s b y e n c r y p t in g t h e ir d a t a a n d t h e n d e m a n d e d a r a n s o m t o d e c r y p t t h e d a t a . To e s c a p e t h e la w e n fo r c e m e n t a ge n c ie s , t h e r a n s o m d e m a n d e d in B it c o in c r y p t o c u r r e n c y. B it c o in is a d igit a l c u r r e n c y t h a t is a ls o k n o w n a s c r y p t o c u r r e n c y. It a llo w s p e o p le t o s e n d a n d r e c e iv e m o n e y o n t h e in t e r n e t w it h o u t h a v in g t o d is c lo s e t h e r e a l id e n t it y o f t h e s e n d e r o r t h e r e c e iv e r. Wit h t h e e ﬀ o r t s o f a r e v e r s e e n gin e e r, W a n n a c r y r a n s o m w a r e w a s m a d e in e ﬀ e c t iv e . W e w ill s t u d y t h is in d e t a il in C h a p t e r 1 6, B r e a k in g W a n n a c r y R a n s o m w a r e Wit h R e v e r s e Imp o r t a n c e o f R e v e r s e E n gin e e r in gS t u d y in g a n e x is t in g d e s ign B e fo r e d e s ign in g a n y t h in g, it is a lw a y s a go o d a p p r o a c h t o s t u d y t h e e x is t in g p r o d u c t s a v a ila b le in t h e m a r k e t . A go o d u n d e r s t a n d in g o f w h a t a p r o d u c t d o e s a n d h o w it w o r k s is im p o r t a n t fo r n e w in s igh t s , b u t id e n t if y in g w h e r e it c a n b e im p r o v e d c a n le a d t o s e v e r a l a d v a n t a ge s . R e d e v e lo p in g a n o u t d a t e d o r lo s t p r o d u c t E v e r y p r o d u c t in t h e m a r k e t t o d a y is t h e o u t c o m e o f h a r d w o r k in t e r m s o f t im e a n d m o n e y. Im a gin e a s it u a t io n w h e r e a c o m p a n y ’s p r o d u c t is in gr e a t d e m a n d in t h e m a r k e t , b u t d u e t o s o m e u n fo r e s e e n s it u a t io n , t h e p r o d u c t is n o t ge t t in g a n y u p gr a d e s w it h t im e . T h is c a n b e d u e t o s o m e in t e r n a l r e a s o n s o r t h e c o m p a n y t h a t d e v e lo p e d t h e p r o d u c t is n o m o r e in t h e m a r k e t . Wit h r e v e r s e e n gin e e r in g, s u c h o u t d a t e d p r o d u c t s c a n b e s t u d ie d t o r e c r e a t e u p d a t e d p r o d u c t s . S e c u r it y a u d it in g R e v e r s e e n gin e e r in g s o m e t im e s is a p a r t o f t h e s e c u r it y a u d it d o n e fo r o r ga n iz a t io n s . T h is is t o c h e c k t h e s e c u r it y o f s o f t w a r e a n d t h e a p p lic a t io n s u s e d w it h in t h e s e o r ga n iz a t io n s . It h e lp s in ﬁ n d in g u n k n o w n v u ln e r a b ilit ie s r u n n in g in s id e t h e o r ga n iz a t io n s . F in d in g s e n s it iv e d a t a S e n s it iv e d a t a e n c o d e d o r e n c r y p t e d in t h e s o f t w a r e c o d e c a n b e e x t r a c t e d w it h t h e h e lp o f r e v e r s e e n gin e e r in g. T h is is d o n e t o v a lid a t e t h e s e c u r it y p o s t u r e o f t h e s o f t w a r e . M ilit a r y e s p io n a ge T h is is d o n e t o le a r n t h e s t r e n gt h o f t h e o p p o n e n t o r e n e m y b y c a p t u r in g t h e h igh -le v e l p r o t o t y p e o f d e v ic e s o b t a in e d b y t r o o p s in t h e ﬁ e ld a n d d is m a n t lin g it t o d e v e lo p s o m e t h in g n e w . F in d in g p r o d u c t v u ln e r a b ilit ie s F o r t h e w e ll-b e in g a n d s a fe t y o f t h e c u s t o m e r s u s in g a giv e n p r o d u c t , r e v e r s e e n gin e e r in g is u s e d t o ﬁ n d d e fe c t s o r v u ln e r a b ilit ie s in s u c h a p r o d u c t . E v e r y o r ga n iz a t io n s p e n d s a s u b s t a n t ia l a m o u n t o f t im e a n d m o n e y o n e ﬀ o r t s t o ﬁ n d b u gs o r v u ln e r a b ilit ie s in t h e ir p r o d u c t s . B u t a s it is w e ll k n o w n , \"n o t h in g is s e c u r e \". D u r in g t h e d e s ign , d e v e lo p m e n t , a n d t e s t in g, s o m e b u gs d o n ’t ge t c a u gh t . T h is is w h e r e r e v e r s e e n gin e e r in g p la y s a v it a l r o le in a id in g s e c u r it y r e s e a r c h e r s t o u n c o v e r t h e is s u e s t h a t c o u ld n ’t b e d e t e c t e d e a r lie r. B o u n t y fo r c y b e r e n t h u s ia s t s E a r lie r, p r o d u c t -b a s e d c o m p a n ie s h a d a n in t e r n a l q u a lit y a s s u r a n c e t e a m fo r s e c u r it y t e s t in g a s w e ll a s fu n c t io n a l t e s t in g fo r t h e ir p r o d u c t s . B u t w it h t im e , e v e r y t h in g c h a n ge s . C y b e r s e c u r it y r e q u ir e m e n t s in t h e m a r k e t c h a n ge d d r a s t ic a lly w it h a n in c r e a s e in c y b e r s e c u r it y a t t a c k s . C o m p a n ie s s t a r t e d o ﬀ e r in g s e c u r it y r e s e a r c h e r s a b o u n t y t o ﬁ n d v u ln e r a b ilit ie s in t h e ir p r o d u c t s . T h is h e lp e d b o t h t h e s e c u r it y r e s e a r c h e r s in t e r m s o f m o n e y a n d t h e p r o d u c t c o m p a n ie s in ﬁ x in g u n c a u gh t b u gs . T h e R o le o f R e v e r s e E n gin e e r in g C o m p u t e r p r o gr a m s w r it t e n in C / C ++ a r e h u m a n -r e a d a b le . Wh e n t h e s e p r o gr a m s a r e c o m p ile d u s in g a c o m p ile r, a n o b je c t ﬁ le is c r e a t e d w h ic h is fu r t h e r p a s s e d t h r o u gh a lin k e r t o ge t a b in a r y ﬁ le o r a n e x e c u t a b le ﬁ le o r, w e c a n s a y, t h e o n e s a n d z e r o s o f t h e m a c h in e la n gu a ge . F ig u r e 1 .2 : T h e r o le o f r e v e r s e e n g in e e r in g T h e o n e s a n d z e r o s a r e n o t h u m a n -r e a d a b le . To c o n v e r t t h e m a c h in e c o d e b a c k t o a h u m a n -r e a d a b le fo r m a t , a t o o l c a lle d t h e d e c o m p ile r is u s e d . T h e r o le o f a d e c o m p ile r is t o c o n v e r t b in a r y c o d e in t o a h u m a n r e a d a b le fo r m a t a n d r e ge n e r a t e t h e c o d e o u t o f it . W e w ill t a lk a b o u t s u c h t o o ls in C h a p t e r 3 , Up a n d R u n n in g w it h R e v e r s e E n g in e e r in g To o ls C o n c lu s io n In t h is c h a p t e r, w e le a r n e d h o w r e v e r s e e n gin e e r in g a ll b e ga n a n d h o w it is p la y in g a b ig r o le in t o d a y ’s e r a . W e a ls o s t u d ie d t h e im p o r t a n c e o f r e v e r s e e n gin e e r in g a n d it s im p a c t o n t h e s o f t w a r e in d u s t r y. W e d is c u s s e d o p p o r t u n it ie s a s s o c ia t e d w it h r e v e r s e e n gin e e r in g a n d h o w m a lw a r e w r it e r s a r e u s in g it t o e x p lo it t h e s o f t w a r e o f b ig c o m p a n ie s . In t h e n e x t c h a p t e r, w e w ill s t u d y t h e in t e r n a ls o f a c o m p u t in g s y s t e m in t e r m s o f r e v e r s e e n gin e e r in g. C H A P T E R 2 Un d e r s t a n d in g A r c h it e c t u r e o f x 8 6 M a c h in e s In t h e fu t u r e , e v e r y d e v ic e o r m a c h in e w ill b e c o m e ‘ s m a r t ’ . T h e b ig d iﬀ e r e n c e b e t w e e n a n o r m a l d e v ic e ( o r ‘ t h e le ga c y d e v ic e ’ , a s w e c a ll it ) a n d a s m a r t d e v ic e is t h e p r e s e n c e o f t h e in t e r n e t fe a t u r e in a s m a r t d e v ic e . B y s m a r t , it m e a n s t h a t t h e d e v ic e is p r o gr a m m e d t o fu n c t io n in a s m a r t fa s h io n a n d it c a n b e o p e r a t e d r e m o t e ly u s in g t h e in t e r n e t fe a t u r e . To d a y, m o s t o f t h e d e v ic e s w e u s e in o u r h o u s e h o ld s a r e in t e r n e t e n a b le d o r w e c a n s a y, s m a r t d e v ic e s . Te le v is io n s a r e n o w s m a r t t e le v is io n s , w a s h in g m a c h in e s a r e n o w s m a r t w a s h in g m a c h in e s , r e fr ige r a t o r s w e u s e a r e a ls o n o w s m a r t r e fr ige r a t o r s , a n d m a n y m o r e . A ll t h is b e c a m e p o s s ib le w it h t h e in t r o d u c t io n o f a s m a ll c o m p u t e r in t h e le ga c y d e v ic e s lik e t e le v is io n s , w a s h in g m a c h in e s , r e fr ige r a t o r s , a n d o t h e r s . N o w a b ig q u e s t io n is , w h a t ’ s in s id e t h e s e s m a ll c o m p u t e r s a n d h o w d o t h e y w o r k ? T h e s e s m a ll c o m p u t e r s a r e m a d e u p o f s m a ll c o m p o n e n t s , w h e r e e v e r y c o m p o n e n t p la y s a n im p o r t a n t r o le in t h e fu n c t io n in g o f t h e o v e r a ll s y s t e m . Im a gin e t h a t t h e s e s m a ll c o m p u t e r s a r e a s m a lle r v e r s io n o f y o u r p e r s o n a l c o m p u t e r. A ll t h e s e d e v ic e s a r e a d d r e s s e d a s m o d e r n c o m p u t in g d e v ic e s . T h e s e c o m p u t in g d e v ic e s a r e m a d e u p o f s e v e r a l c o m p o n e n t s fo r p r o c e s s in g, d a t a s t o r a ge , d a t a t r a n s fe r, a n d m o r e . M o d e r n c o m p u t in g d e v ic e s c o u p le d w it h s o f t w a r e a r e p r o gr a m m e d t o d o m a n y t a s k s . To u n d e r s t a n d R e v e r s e E n gin e e r in g o n m o d e r n c o m p u t in g d e v ic e s , w e n e e d t o ﬁ r s t u n d e r s t a n d w h a t go e s in s id e t h e s e c o m p u t in g d e v ic e s a n d h o w t h e y w o r k . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : A r c h it e c t u r e o f a C o m p u t in g S y s t e m B u ild in g B lo c k s o f a C o m p u t in g S y s t e m H is t o r y o f t h e D iﬀ e r e n t Ty p e s o f P r o c e s s o r s R e gis t e r s , Ty p e s o f R e gis t e r s a n d t h e ir R o le s C o n c e p t o f S t a c k O b je c t iv e In t h is c h a p t e r, w e w ill t a lk a b o u t c o m p u t in g s y s t e m s a n d t h e ir t y p e s . W e w ill a ls o t a lk a b o u t t h e c o m p o n e n t s o f m o d e r n c o m p u t in g s y s t e m s . T h e n w e w ill c o v e r t h e t o p ic s o f p r o c e s s o r s a n d t h e d iﬀ e r e n c e b e t w e e n p r o c e s s o r v a r ia n t s a lo n g w it h t h e ir n u m b e r in g s c h e m e . W e w ill a ls o t a k e a lo o k a t t h e r o le o f s t a c k in r e v e r s e e n gin e e r in g t o u n d e r s t a n d t h e d iﬀ e r e n c e b e t w e e n c a lle r a n d c a lle e . A r c h it e c t u r e o f a C o mp u t in g S y s t e m A n y c o m p u t in g s y s t e m w e s e e a r o u n d is m a d e u p o f s o m e b a s ic b u ild in g b lo c k s . Wh e n w e s a y c o m p u t in g s y s t e m , it c a n b e y o u r c o m p u t e r, la p t o p , m o b ile , Io T d e v ic e s , a n d o t h e r d e v ic e s w h ic h a r e c a p a b le o f p e r fo r m in g t a s k s . B a s ic a lly, t h e r e a r e t w o t y p e s o f c o m p u t in g s y s t e m s : F ix e d P r o gr a m C o mp u t in g T h e s e s y s t e m s a r e a r c h it e c t e d t o p e r fo r m a s p e c iﬁ c t a s k . F o r e x a m p le , a c a lc u la t o r. S t o r e d P r o gr a m C o mp u t in g O n t h e o t h e r h a n d , t h e s e s y s t e m s a r e a r c h it e c t e d in s u c h a w a y t h a t t h e y c a n b e p r o gr a m m e d a s p e r t h e r e q u ir e m e n t s . T h e y c a n r u n m a n y t a s k s s im u lt a n e o u s ly a n d w e c a n s t o r e a n d r u n a p p lic a t io n s o n t h e m . F o r e x a m p le , a c o m p u t e r. T h e a r c h it e c t u r e o f t h e s e s y s t e m s w a s in t r o d u c e d b y Jo h n v o n N e u m a n n in 1 9 4 5 . T h e v o n N e u m a n n a r c h it e c t u r e is b a s e d o n t h e s t o r e d p r o gr a m c o n c e p t , w h e r e p r o gr a m d a t a a n d in s t r u c t io n d a t a a r e s t o r e d in t h e s a m e m e m o r y. T h is d e s ign is u s e d b y m o d e r n c o m p u t in g s y s t e m s , w h ic h a r e m a d e u p o f t h e fo llo w in g b u ild in g b lo c k s : F ig u r e 2 .1 : A r c h it e c t u r e o f a C o m p u t in g S y s t e m C P U T h e C e n t r a l P r o c e s s in g Un it c o n t r o ls t h e o p e r a t io n s o f o u r c o m p u t in g d e v ic e o r s y s t e m . In o u r c o m p u t in g s y s t e m , t h e C P U is a ls o r e fe r r e d t o a s p r o c e s s o r, w h ic h is t h e b r a in o f o u r c o m p u t in g s y s t e m . T h e jo b o f t h e C P U is t o fe t c h in s t r u c t io n s fr o m t h e m e m o r y, d e c o d e t h e in s t r u c t io n s in t o a s e r ie s o f a c t io n s , a n d c a r r y o u t t h e s e s t e p s in a s e q u e n c e . In s id e t h e C P U, w e h a v e s e v e r a l c o m p o n e n t s . S o m e o f t h e m a r e : C o n t r o l T h is is r e s p o n s ib le fo r r e t r ie v in g a n d d e c o d in g in s t r u c t io n s fr o m t h e m e m o r y o r R A M . E x e c u t io n T h is u n it is r e s p o n s ib le fo r t h e e x e c u t io n o f in s t r u c t io n s w it h t h e h e lp o f r e gis t e r s . To s a v e t im e , t h e C P U d o e s n o t a c c e s s R A M e v e r y s in gle t im e t o fe t c h in s t r u c t io n s . S o C P U h a s in it s e lf b a s ic s t o r a ge u n it s c a lle d r e gis t e r s . T h e r e a r e m a n y t y p e s o f r e gis t e r s , w h ic h w e w ill s t u d y in t h e fo llo w in g s e c t io n s . O n e a m o n g t h e m is In s t r u c t io n P o in t e r r e gis t e r, w h ic h s t o r e s t h e m e m o r y a d d r e s s o f t h e n e x t in s t r u c t io n t o b e e x e c u t e d . T h e s e a r e r e gis t e r s o n ly, b u t t h e y r e c o r d t h e s t a t e o f C P U a f t e r a r it h m e t ic c a lc u la t io n s . M e mo r y T h is c a n b e R a n d o m A c c e s s M e mo r y o r R e a d O n ly M e mo r y It c a n a ls o b e a n e x t e r n a l s t o r a ge d e v ic e s u c h a s H a r d D is k o p t ic a l d is k , a n d o t h e r s . T h e p r im a r y p u r p o s e o f m e m o r y is t o s t o r e t h e s e q u e n c e o f in s t r u c t io n s t h a t o u r c o m p u t e r o r c o m p u t in g s y s t e m e x e c u t e s . T h is is a ls o c a lle d p r o gr a m c o d e . T h e s e c o n d p u r p o s e o f m e m o r y is t o s t o r e d a t a , o n w h ic h o u r c o m p u t e r w o r k s . In p u t / o u t p u t D e v ic e s A ll t h e d e v ic e s w h ic h a r e in t e r fa c e d w it h o u r c o m p u t in g s y s t e m a r e c a lle d I/ O ( In p u t / O u t p u t ) d e v ic e s . T h is c a n b e o u r k e y b o a r d , m o u s e , m o n it o r, a n d o t h e r s . T h e s e d e v ic e s a r e in t e r fa c e d u s in g p o r t s a n d t h e r e a r e t w o t y p e s o f p o r t s , In p u t & O u t p u t p o r t s . In p u t p o r t s a r e u s e d fo r r e a d in g d a t a fr o m t h e s e p e r ip h e r a l d e v ic e s in t o t h e c o m p u t in g s y s t e m . O u t p u t p o r t s a r e u s e d t o s e n d d a t a fr o m t h e c o m p u t in g s y s t e m t o t h e p e r ip h e r a l d e v ic e s s u c h a s v id e o d is p la y, p r in t e r, a n d o t h e r s . S y s t e m B u s T h e S y s t e m B u s c a n b e im a gin e d a s a gr o u p o f w ir e s t h a t c a r r y in fo r m a t io n o r d a t a b e t w e e n d iﬀ e r e n t c o m p o n e n t s in o u r c o m p u t in g s y s t e m . D e p e n d in g o n t h e t y p e o f in fo r m a t io n c a r r ie d b e t w e e n t h e c o m p o n e n t s , b u s e s a r e c la s s iﬁ e d a s A d d r e s s B u s , D a t a B u s , a n d C o n t r o l B u s . A d d r e s s T h e s e a r e p a r a lle l s ign a l lin e s w h ic h a r e u s e d t o s e n d o u t t h e a d d r e s s o f t h e m e m o r y lo c a t io n t h a t is t o b e r e a d fr o m o r w r it t e n t o . T h e n u m b e r o f m e m o r y lo c a t io n s t h a t a C P U c a n a d d r e s s is c a lc u la t e d b y t h e n u m b e r o f s ign a l lin e s o r a d d r e s s lin e s . S u p p o s e a C P U h a s N a d d r e s s lin e s , s o t h e t o t a l n u m b e r o f m e m o r y lo c a t io n s t h e C P U c a n a d d r e s s is F o r e x a m p le , a C P U h a s 8 a d d r e s s lin e s . T h is C P U c a n a d d r e s s 2 5 6 m e m o r y lo c a t io n s . If a C P U h a s 1 6 a d d r e s s lin e s , t h e n t h e C P U c a n a d d r e s s 6 5 ,5 3 6 m e m o r y lo c a t io n s . D a t a T h e s e a r e a ls o p a r a lle l s ign a l lin e s w h ic h a r e u s e d t o t r a n s fe r d a t a b e t w e e n t h e C P U a n d m e m o r y. C o n t r o l A C o n t r o l B u s c o n t a in s p a r a lle l s ign a l lin e s c a r r y in g s y n c h r o n iz in g s ign a ls t o c o n t r o l v a r io u s p e r ip h e r a l d e v ic e s c o n n e c t e d t o t h e C P U. T h e s e a r e u s e d t o t r a n s fe r in fo r m a t io n r e q u ir e d t o c o o r d in a t e m u lt ip le t a s k s . T h is c o n s is t s o f 4 -1 0 p a r a lle l s ign a l lin e s t o s e n d o u t s ign a ls o n t h e c o n t r o l b u s . Ty p ic a l c o n t r o l b u s s ign a ls a r e I/ O R e a d , I/ O W r it e , M e m o r y R e a d , a n d M e m o r y W r it e . S u p p o s e a C P U n e e d s t o r e a d a b y t e o f d a t a fr o m t h e m e m o r y lo c a t io n . In t h is p r o c e s s , t h e fo llo w in g a c t iv it ie s w ill h a p p e n : T h e C P U w ill s e n d t h e m e m o r y a d d r e s s o f t h e d e s ir e d b y t e o n t h e A d d r e s s B u s . T h e C P U w ill t h e n s e n d t h e M e m o r y R e a d s ign a l o n t h e C o n t r o l B u s . T h e M e m o r y R e a d s ign a l w ill e n a b le t h e a d d r e s s e d m e m o r y d e v ic e t o o u t p u t d a t a ( o r b y t e ) o n t o t h e D a t a B u s . T h e D a t a ( o r b y t e ) t r a v e ls fr o m t h e d e s ir e d m e m o r y a d d r e s s t o t h e C P U u s in g t h e D a t a B u s . B u ild in g b lo c k s o f a C o mp u t in g S y s t e m To u n d e r s t a n d r e v e r s e e n gin e e r in g, k n o w le d ge o f t h e b a s ic d a t a b u ild in g b lo c k s is a m u s t . T h e s e d a t a b u ild in g b lo c k s in c lu d e t h e m e a n in g o f B it , N ib b le , B y t e , W o r d , a n d D W O R D . A ll o f t h e s e c a n b e e x p la in e d fr o m t h e fo llo w in g ﬁ gu r e : F ig u r e 2 .2 : Und e r s t a n d in g B it , N ib b le , B y t e H u m a n s c a n c o m m u n ic a t e w it h e a c h o t h e r in d iﬀ e r e n t la n gu a ge s b a s e d o n t h e c o u n t r ie s t h e y r e s id e in . B u t w h e n w e t a lk a b o u t a c o m p u t in g s y s t e m lik e c o m p u t e r s , t h e y c a n o n ly u n d e r s t a n d b in a r y, w h ic h is 0 o r 1 . C o m p u t e r s c o m m u n ic a t e w it h e a c h o t h e r b y s e n d in g o r e x c h a n gin g d a t a . T h e s m a lle s t u n it o f d a t a is c a lle d b it , w h ic h c a n b e 0 o r 1 . 1 N ib b le m e a n s 4 b it s . S im ila r ly, w e c a n r e fe r t o B YTE, W O R D , a n d D W O R D a s : 1 B YTE = 2 N IB B L E S = 8 b it s 1 W O R D = 2 B YTES = 1 6 b it s 1 D W O R D = 4 B YTES = 3 2 b it s M ic r o p r o c e s s o r A s w e k n o w , t h e C P U is t h e b r a in o f a c o m p u t in g s y s t e m . T h e C P U is s u r r o u n d e d b y c ir c u it r y w h ic h in it s w h o le is r e fe r r e d t o a s t h e m ic r o p r o c e s s o r. A m ic r o p r o c e s s o r c a n h a v e m o r e t h a n o n e C P U, lik e gr a p h ic s p r o c e s s o r. S o , t h e C P U is a c t u a lly a p a r t o f t h e m ic r o p r o c e s s o r, b u t m ic r o p r o c e s s o r s c a n h a v e m o r e t h a n o n e C P U. T h e r e a r e m a n y t y p e s o f m ic r o p r o c e s s o r s . Yo u m u s t h a v e h e a r d o f c o m p a n ie s lik e In t e l, A M D , a n d m a n y m o r e . T h e y a r e t h e t o p m a n u fa c t u r e r s o f m ic r o p r o c e s s o r s . S o m e o f t h e m o s t p o p u la r m o d e ls o f t h e ﬁ r s t ge n e r a t io n m ic r o p r o c e s s o r s a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : a r e : S o c o lle c t iv e ly, a ll t h e p r o c e s s o r s a r e r e fe r r e d t o a s t h e x 8 6 In t e l fa m ily. G e n e r a lly, w e r e fe r t o t h e In t e l p r o c e s s o r a s fo llo w s : It m e a n s a 1 6 -b it p r o c e s s o r. x 8 6 -3 2 ( a k a It m e a n s a 3 2 -b it p r o c e s s o r ( IA m e a n s : In t e l A r c h it e c t u r e ) , a ls o r e fe r r e d t o a s x 8 6 o n ly. It m e a n s a 6 4 -b it p r o c e s s o r, a ls o r e fe r r e d t o a s x 6 4 . N o t e : T h r o u gh o u t t h is b o o k , w e w ill fo c u s o n t h e In t e l x 8 6 -3 2 p r o c e s s o r. M e mo r y T h e m e m o r y, w h ic h w e c a ll R A M , fo r a s in gle p r o c e s s r u n n in g o n t h e x 8 6 -3 2 a r c h it e c t u r e is d iv id e d in t o t h e fo llo w in g s e c t io n s : F ig u r e 2 .3 : P r o c e s s A d d r e s s S p a c e T h e m e m o r y a d d r e s s is r a n ge d fr o m 0 x 0 0 0 0 0 0 0 0 – T h e p r e ﬁ x 0 x r e fe r s t o h e x a d e c im a l n u m b e r s . E v e r y h e x a d e c im a l n u m b e r is 4 b it in s iz e , s o a n y m e m o r y a d d r e s s o f x 8 6 -3 2 a r c h it e c t u r e is r e fe r r e d b y a c o m b in a t io n o f 8 h e x a d e c im a l n u m b e r s , w h ic h m a k e 4 x 8 = 3 2 b it s in s iz e . T h is is w h y, t h e m e m o r y a d d r e s s o f x 8 6 -3 2 c o m p u t e r is 3 2 b it s in s iz e . K e r n e l 1 G B is r e s e r v e d fo r t h e O p e r a t in g S y s t e m k e r n e l. T h is is t h e s p a c e r e s e r v e d fo r t h e fu n c t io n lo c a l v a r ia b le s a n d p a r a m e t e r s . A s t a c k gr o w s u p t o a ﬁ x e d m e m o r y s iz e . It gr o w s fr o m a h igh e r m e m o r y a d d r e s s t o a lo w e r m e m o r y a d d r e s s . T h is is w h e r e o u r S h a r e d L ib r a r ie s a r e lo a d e d . T h e c o m m o n d ia lo g b o x lik e s a v e d ia lo g b o x is s t o r e d in lib r a r y w h ic h is s h a r e d a m o n g m a n y p r o gr a m s . H e a p gr o w s d o w n . Wh e n a n im a ge is lo a d e d , d e p e n d in g o n t h e s iz e o f t h e im a ge , d y n a m ic m e m o r y is r e q u ir e d t o lo a d a n im a ge d u r in g t h e p r o gr a m e x e c u t io n . T h is m e m o r y is fr e e d w h e n t h e p r o gr a m ﬁ n is h e s . T h is h e a p m e m o r y d y n a m ic a lly c h a n ge s d u r in g p r o gr a m e x e c u t io n . It gr o w s fr o m a lo w e r m e m o r y a d d r e s s t o a h igh e r m e m o r y a d d r e s s . T h is is t h e s e c t io n o f m e m o r y u s e d t o s t o r e s t a t ic v a r ia b le s a n d glo b a l v a r ia b le s in t h e c o d e . T h is s e c t io n o f m e m o r y h o ld s t h e in s t r u c t io n o r c o d e t o b e e x e c u t e d t o p e r fo r m s o m e a c t io n . R e gis t e r s To s a v e t im e , a s m a ll a m o u n t o f t e m p o r a r y s t o r a ge is a v a ila b le w it h t h e C P U c a lle d In t h e x 8 6 p r o c e s s o r, r e gis t e r s a r e d iv id e d in t o t h e fo llo w in g c a t e go r ie s : F ig u r e 2 .4 : R e g is t e r s G e n e r a l P u r p o s e R e gis t e r X 8 6 a r c h it e c t u r e h a s 8 ge n e r a l p u r p o s e r e gis t e r s : E A X is u s e d fo r a r it h m e t ic a n d lo gic a l o p e r a t io n s . It is a ls o u s e d t o s t o r e t h e fu n c t io n r e t u r n v a lu e . E B X is u s e d a s a p o in t e r t o d a t a . E C X is u s e d fo r lo o p o p e r a t io n s . E D X is u s e d fo r I/ O a n d a r it h m e t ic o p e r a t io n s . E S I is u s e d a s a p o in t e r t o t h e s o u r c e in s t r in g o p e r a t io n s . E D I is u s e d a s a p o in t e r t o t h e d e s t in a t io n in s t r in g o p e r a t io n s . E S P is a p o in t e r t o t h e t o p o f t h e s t a c k . E B P is a p o in t e r t o t h e b a s e o f t h e s t a c k fr a m e . A ll ge n e r a l p u r p o s e r e gis t e r s a r e 3 2 b it s in s iz e a n d t h e y c a n a ls o b e r e fe r r e d in t h e s iz e s o f 1 6 b it s a n d 8 b it s . T h e s m a lle r u n it o f a n y r e gis t e r c a n b e r e fe r r e d a s s h o w n b e lo w . T h e s iz e o f t h e E A X is 4 b y t e ( 3 2 b it s ) . T h e “ E ” in E A X s t a n d s fo r E x t e n d e d . F ig u r e 2 .5 : S m a lle r u n it o f r e g is t e r A X is t h e lo w e r h a lf o f t h e E A X r e gis t e r, w h ic h is o f s iz e 1 6 b it s . A X is fu r t h e r d iv id e d in t o A H ( A -H igh ) a n d A L ( A -L o w ) , e a c h o f 8 b it s in s iz e . T h e s a m e go e s fo r o t h e r ge n e r a l p u r p o s e r e gis t e r s . 3 2 -b it v e r s io n o f ge n e r a l p u r p o s e r e gis t e r s : E A X , E B X , E C X , E D X , E S I, E D I, E B P, E S P 1 6 -b it v e r s io n o f ge n e r a l p u r p o s e r e gis t e r s : A X , B X , C X , D X , S I, D I, B P, S P 8 -b it v e r s io n o f ge n e r a l p u r p o s e r e gis t e r s : A H , A L , B H , B L , C H , C L , D H , D L S e gme n t R e gis t e r s T h e s e gm e n t r e gis t e r s C S , D S , S S , E S , F S a n d G S a r e 1 6 b it s in s iz e . A s e gm e n t r e gis t e r p o in t s a t t h e s t a r t o f a s e gm e n t in m e m o r y. S e gm e n t s c a n b e c a t e go r iz e d b a s e d o n t h e t h r e e t y p e s o f s t o r a ge : C o d e , D a t a , a n d S t a c k . C o d e T h is s e gm e n t c o n t a in s a ll t h e in s t r u c t io n s t o b e e x e c u t e d a n d t h e C o d e S e gme n t r e gis t e r c o n t a in s t h e p o in t e r t o t h e c o d e . S t a c k T h is s e gm e n t h o ld s t h e d a t a , v a r ia b le s , a n d a r gu m e n t s o f t h e fu n c t io n s . S t a c k S e gme n t r e gis t e r h o ld s t h e p o in t e r t o t h e s t a c k . D a t a F o r c o d e e ﬃ c ie n c y a n d s e c u r it y, fo u r s e p a r a t e D a t a S e gm e n t s a r e c r e a t e d . T h e s e a r e : O n e fo r d a t a s t r u c t u r e o f c u r r e n t lo a d e d m o d u le D a t a e x p o r t e d fr o m o t h e r t h ir d -p a r t y m o d u le s D y n a m ic a lly c r e a t e d d a t a s t r u c t u r e s D a t a w h ic h is s h a r e d a m o n g d iﬀ e r e n t p r o gr a m s To a c c e s s t h e d iﬀ e r e n t t y p e s o f d a t a s t r u c t u r e s a n d a d d it io n a l d a t a s e gm e n t s , D S , E S , F S , G S r e gis t e r s a r e u s e d . S t a t u s R e gis t e r s T h e s t a t u s r e gis t e r is E E F L A G S r e gis t e r. T h is r e gis t e r is a ls o 4 b y t e in s iz e . E a c h b it o f t h is r e gis t e r r e p r e s e n t s s o m e ﬂ a g, w h ic h c a n b e e it h e r z e r o ( 0 ) o r o n e ( 1 ) . T h e s t a t u s o f e a c h b it r e p r e s e n t s s o m e r e s u lt o f t h e C P U o p e r a t io n . S o m e o f t h e c o m m o n ﬂ a gs u s e d w h ile p e r fo r m in g r e v e r s e e n gin e e r in g a r e : Z e r o F la g T h is ﬂ a g is s e t t o 1 w h e n t h e r e s u lt o f t h e o p e r a t io n is z e r o . O t h e r w is e , it is c le a r e d . C a r r y F la g T h is ﬂ a g is s e t t o 1 w h e n t h e r e s u lt o f t h e o p e r a t io n is e it h e r t o o la r ge o r t o o s m a ll fo r t h e d e s t in a t io n . O t h e r w is e , it is c le a r e d . S ign F la g T h is ﬂ a g is s e t t o 1 w h e n t h e r e s u lt o f t h e o p e r a t io n is n e ga t iv e . T h e ﬂ a g is c le a r e d , o r w e c a n s a y 0 , w h e n t h e r e s u lt o f t h e o p e r a t io n is a p o s it iv e v a lu e . Tr a p F la g T h is ﬂ a g is s e t t o 1 w h e n t h e p r o c e s s o r e x e c u t e s o n e in s t r u c t io n a t a t im e a n d it is u s e d fo r d e b u ggin g. P a r it y F la g It is s e t t o 1 w h e n L e a s t S ign iﬁ c a n t B it o f t h e r e s u lt c o n t a in s a n e v e n n u m b e r. O t h e r w is e , it is c le a r e d . O v e r ﬂ o w F la g T h is ﬂ a g is s e t t o 1 w h e n t h e r e s u lt o f t h e o p e r a t io n is t o o la r ge t o ﬁ t . In s t r u c t io n P o in t e r R e gis t e r In s t r u c t io n P o in t e r is a ls o k n o w n a s E IP. T h is r e gis t e r c o n t a in s t h e m e m o r y a d d r e s s o f t h e n e x t in s t r u c t io n t o b e e x e c u t e d . E IP t e lls t h e p r o c e s s o r w h a t t o d o n e x t . Fr o m t h e s e c u r it y p o in t o f v ie w , E IP is v e r y im p o r t a n t . A n a t t a c k e r c o m p r o m is e s a n y s y s t e m b y t a k in g c o n t r o l o v e r t h e in s t r u c t io n p o in t e r. O n c e t h e E IP is in c o n t r o l o f t h e a t t a c k e r, a m a lw a r e c o d e c a n b e e x e c u t e d t o p e r fo r m a n y t a s k . C o n c e p t o f S t a c k T h is is t h e m o s t im p o r t a n t c o n c e p t in R e v e r s e E n gin e e r in g. Im a gin e a s t a c k a s a p ile o f lu n c h p la t e s ly in g o n e a b o v e t h e o t h e r a t y o u r lo c a l r e s t a u r a n t o r c a fe t e r ia . To p ic k u p a p la t e , w e t a k e o u t t h e p la t e fr o m t h e t o p a n d t h e s a m e p r o c e s s is fo llo w e d t o a d d m o r e p la t e s t o t h e p ile . T h e p la t e a d d e d t o t h e p ile w ill b e a d d e d o n t h e t o p . If w e h a v e t o t a k e o u t t h e p la t e a t t h e b o t t o m o f t h e p ile , w e w ill h a v e t o t a k e o u t e v e r y p la t e a b o v e it , o n e b y o n e . F o r t h e t im e b e in g, a s s u m e t h a t a d d in g a p la t e t o t h e p ile is c a lle d P US H a n d t a k in g o u t a p la t e fr o m t h e p ile is c a lle d A s t a c k w o r k s t h e s a m e w a y, L a s t In F ir s t O u t T h is m e a n s t h a t t h e la s t t h in g a d d e d ( p u s h e d ) w ill b e t h e ﬁ r s t t h in g t o ge t p u lle d o ﬀ ( p o p p e d ) . To u n d e r s t a n d t h e w o r k in g o f a s t a c k , w e w ill t a k e a p s e u d o c o d e : F ig u r e 2 .6: P s e u d o c o d e In t h is p s e u d o c o d e , t h e r e a r e t w o fu n c t io n s : o n e is t h e ma in fu n c t io n fr o m w h e r e o u r c o d e e x e c u t io n s t a r t s a n d a n o t h e r is t h e F o o fu n c t io n . F o o fu n c t io n h a s 3 a r gu m e n t s w h ic h a r e lo c a l t o ma in fu n c t io n a n d 2 lo c a l v a r ia b le s . D u r in g t h e c o d e e x e c u t io n , t h e F o o fu n c t io n is c a lle d fr o m t h e ma in fu n c t io n . In t h is c o d e , t h e ma in fu n c t io n is t h e C a lle r a n d t h e F o o fu n c t io n is t h e C a lle e . W e a r e a s s u m in g t h a t t h e 3 a r gu m e n t s a n d 2 lo c a l v a r ia b le s m e n t io n e d in t h e c o d e a r e o f t y p e T h e d a t a t y p e o f in t o c c u p ie s 4 b y t e s in t h e m e m o r y, a s s iz e o f( in t ) is 4 b y t e s . Wh e n o u r e x e c u t io n r e a c h e s in s id e t h e F o o fu n c t io n , t h e t y p ic a l s t a c k s t a t e w ill lo o k lik e s o m e t h in g a s fo llo w s : F ig u r e 2 .7 : S t a c k E v e r y fu n c t io n h a s a s t a c k fr a m e . A s w e h a v e t w o fu n c t io n s ma in a n d w e w ill h a v e t w o s t a c k fr a m e s . T h e h igh e s t a d d r e s s o f t h e s t a c k fr a m e is t h e E B P o f t h a t s t a c k fr a m e . L e t ’s go s t e p b y s t e p t o u n d e r s t a n d h o w a s t a c k fr a m e is s e t u p a n d c le a n e d u p o n fu n c t io n r e t u r n . C a lle r B e fo r e C a lle e C a ll In t h is s e c t io n , w e w ill lo o k a t t h e s t a c k s t a t e w h e n t h e ma in fu n c t io n is ju s t a b o u t t o c a ll t h e F o o fu n c t io n . C o n s id e r t h e F o o fu n c t io n c a ll a s fo llo w s : in t m a in ( ) { F o o R e t u r n V a lu e = F o o ( 1 0 , 2 0 , 3 0 ) ; } C a lle r is o u r ma in fu n c t io n a n d is a b o u t t o c a ll t h e F o o fu n c t io n w h ic h is C a lle e . T h e ma in fu n c t io n h a s it s o w n s t a c k fr a m e , w h e r e t h e E S P is p o in t in g t o t h e t o p o f t h e s t a c k a n d E B P is a b a s e p o in t e r o f t h e ma in fu n c t io n ’s s t a c k fr a m e . F ig u r e 2 .8: C a lle r B e fo r e C a lle e C a ll B e fo r e t h e F o o fu n c t io n is c a lle d , t h e ma in fu n c t io n p u s h e s t h e E A X , E C X a n d E D X r e gis t e r s o n t o t h e s t a c k , o n ly if t h e c o n t e n t o f t h e s e r e gis t e r s n e e d s t o b e p r e s e r v e d . N e x t , t h e ma in fu n c t io n p u s h e s t h e F o o fu n c t io n a r gu m e n t s o n e b y o n e o n t o t h e s t a c k . F o o R e t u r n V a lu e = F o o ( 1 0 , 2 0 , 3 0 ) ; // F o o fu n c t io n a r gu m e n t s a r e 1 0 , 2 0 , 3 0 A r gu m e n t s a r e p u s h e d fr o m t h e r igh t t o le f t o r d e r, s o ﬁ r s t 3 0 t h e n 2 0 a n d t h e n 1 0 is p u s h e d o n t o t h e s t a c k . T h e a s s e m b ly in s t r u c t io n s fo r t h e s a m e a r e : P US H 3 0 P US H 2 0 P US H 1 0 A f t e r p u s h in g t h e F o o a r gu m e n t s o n t h e s t a c k , a c a ll t o F o o fu n c t io n is m a d e u s in g t h e C A L L in s t r u c t io n in t h e a s s e m b ly la n gu a ge : C A L L F o o Wh e n t h e C A L L in s t r u c t io n is e x e c u t e d , t h e c o n t e n t o f t h e E IP r e gis t e r is p u s h e d o n t o t h e s t a c k a s E IP p o in t s t o t h e n e x t in s t r u c t io n in t h e ma in a f t e r t h e C A L L in s t r u c t io n . A f t e r p u s h in g t h e E IP o n t o t h e s t a c k , w e w ill h a v e t h e r e t u r n a d d r e s s o n t h e t o p o f t h e s t a c k . T h is r e t u r n a d d r e s s w ill h e lp t h e in s t r u c t io n p o in t e r t o r e s u m e e x e c u t io n in t h e ma in o n c e t h e e x e c u t io n o f t h e F o o fu n c t io n is o v e r. C a lle e A f t e r F u n c t io n C a ll Wh e n t h e F o o fu n c t io n ge t s t h e c o n t r o l, it w ill p e r fo r m t h e fo llo w in g t h r e e t a s k s : S e t u p t h e F o o fu n c t io n s t a c k fr a m e . A llo c a t e s p a c e fo r t h e F o o fu n c t io n lo c a l v a r ia b le s . If r e q u ir e d , p r e s e r v e t h e c o n t e n t s o f E B X , E S I a n d E D I. T h e F o o fu n c t io n s t a c k fr a m e is s e t u p u s in g t h e fo llo w in g a s s e m b ly in s t r u c t io n s : P US H E B P M O V E B P, E S P To s e t u p t h e s t a c k fr a m e fo r t h e F o o fu n c t io n , w e w ill ﬁ r s t p r e s e r v e t h e ma in ’s E B P ( w h ic h is t h e b a s e p o in t e r o f t h e ma in fu n c t io n ) b y p u s h in g it o n t o t h e s t a c k . F ig u r e 2 .9: C a lle e a f t e r fu n c t io n c a ll A f t e r p u s h in g t h e ma in ’s E B P o n t h e s t a c k , E S P ( w h ic h is p o in t in g t o t h e t o p o f t h e s t a c k ) w ill b e c o m e t h e n e w E B P ( b a s e p o in t e r o f t h e F o o fu n c t io n ) . T h is E B P, a lo n g w it h t h e o ﬀ s e t , w ill b e u s e d t o r e fe r t o t h e v a r ia b le s o n t h e s t a c k . A s w e c a n n o t ic e in t h e p r e c e d in g ﬁ gu r e , t h e ﬁ r s t a r gu m e n t c a n b e a c c e s s e d u s in g E B P p lu s 8 b y t e s ( 4 b y t e s fo r ma in ’s E B P + 4 b y t e s fo r t h e R e t u r n A d d r e s s ) . N o w w e n e e d t o a llo c a t e s p a c e fo r t h e F o o fu n c t io n lo c a l v a r ia b le s o n t o t h e s t a c k . T h is is d o n e b y s u b t r a c t in g 2 0 b y t e s fr o m t h e s t a c k p o in t e r, w h e r e 2 0 b y t e s in c lu d e 8 b y t e s ( 4 b y t e s + 4 b y t e s s p a c e fo r 2 v a r ia b le s ) a n d 1 2 b y t e s fo r t e m p o r a r y s t o r a ge . T h is w ill b e d o n e u s in g: S UB E S P, 2 0 L o c a l v a r ia b le s a n d t e m p o r a r y v a r ia b le s c a n b e a c c e s s e d u s in g t h e o ﬀ s e t fr o m E B P. A f t e r a llo c a t in g r o o m fo r t h e lo c a l v a r ia b le s o n t h e s t a c k , E B X , E S I a n d E D I r e gis t e r s a r e p r e s e r v e d b y p u s h in g o n t h e s t a c k . T h e s t a c k s t a t e a f t e r p r e s e r v in g t h e c o n t e n t s o f E S I a n d E D I w ill b e a s fo llo w s : F ig u r e 2 .1 0 : S t a c k F r a m e s o f F o o a n d M a in D u r in g t h e F o o fu n c t io n e x e c u t io n , t h e r e c a n b e m a n y p u s h in g a n d p o p p in g o n t h e s t a c k . In t h is c a s e , E S P w ill m o v e u p a n d d o w n , b u t t h e E B P w ill r e m a in u n c h a n ge d . Wit h t h e h e lp o f v a r ia b le s c a n b e a c c e s s e d u s in g t h e o ﬀ s e t fr o m C a lle e B e fo r e R e t u r n in g N o w s u p p o s e w e a r e d o n e w it h t h e F o o fu n c t io n e x e c u t io n . B e fo r e r e t u r n in g, t h e c a lle e w ill m a k e a r r a n ge m e n t s t o s a v e t h e F o o fu n c t io n r e t u r n v a lu e in t h e E A X r e gis t e r. S e c o n d ly, t h e v a lu e s o f E B X , E D I a n d E S I a r e r e s t o r e d b a c k . T h e F o o fu n c t io n s t a c k fr a m e w ill b e t a k e n d o w n b y t h e fo llo w in g a s s e m b ly in s t r u c t io n s : M O V E S P, E B P P O P E B P R E T T h e s e in s t r u c t io n s w ill b r in g t h e s t a c k t o t h e fo llo w in g s t a t e b y m o v in g t h e s t a c k p o in t e r E S P b a c k t o t h e E B P ( b a s e p o in t e r o f t h e F o o fu n c t io n ) a n d t h e o ld E B P E B P ) is r e s t o r e d b y p o p p in g E B P fr o m t h e s t a c k . F ig u r e 2 .1 1 : C a lle e b e fo r e r e t u r n in g R E T, r e t u r n in s t r u c t io n w ill p o p r e t u r n a d d r e s s fr o m t h e s t a c k a n d m o v e it t o E IP. T h is w ill p o in t t h e In s t r u c t io n p o in t e r b a c k t o t h e ma in fu n c t io n , t o r e s u m e e x e c u t io n o f ma in fu n c t io n . C a lle r A f t e r R e t u r n in g A s t h e in s t r u c t io n p o in t e r is b a c k in t h e ma in fu n c t io n , n o w w e d o n o t r e q u ir e a r gu m e n t s o n t h e s t a c k a n y m o r e . F ig u r e 2 .1 2 : C a lle r a f t e r r e t u r n in g A ll t h e a r gu m e n t s o n t h e s t a c k a r e c le a n e d b y a d d in g E S P b y 1 2 b y t e s ( 4 b y t e s fo r e a c h a r gu m e n t a n d m u lt ip lie d b y t h e n u m b e r o f a r gu m e n t s , w h ic h is 3 ) . A D D E S P, 1 2 A s t h e E A X r e gis t e r is h o ld in g t h e r e t u r n v a lu e o f t h e F o o fu n c t io n , t h e c o n t e n t o f t h e E A X r e gis t e r c o u ld b e m o v e d t o s o m e o t h e r r e gis t e r. F in a lly, t h e p r e s e r v e d r e gis t e r s a n d E D X a r e p o p p e d fr o m t h e s t a c k a n d E S P is p o in t e d b a c k t o t h e s a m e lo c a t io n o n t h e s t a c k w h e r e it s t a r t e d . C o n c lu s io n W e c o v e r e d t h e a r c h it e c t u r e o f m o d e r n c o m p u t in g d e v ic e s a n d t h e d iﬀ e r e n t c o m p o n e n t s t h a t m a k e u p a c o m p u t in g d e v ic e . W e a ls o c o v e r e d t h e fu n c t io n in g o f d iﬀ e r e n t c o m p o n e n t s u s e d in a c o m p u t in g d e v ic e . T h is c o v e r e d t h e b a s ic s a b o u t m ic r o p r o c e s s o r s , m e m o r y, a n d t h e d iﬀ e r e n t t y p e s o f r e gis t e r s . T h e d iﬀ e r e n t p r o c e s s o r v a r ia n t s w e r e a ls o d is c u s s e d a lo n g w it h t h e r e le v a n c e o f t h e x 8 6 n u m b e r in g c o n v e n t io n . W e c o v e r e d a n im p o r t a n t a s p e c t o f s t a c k . Wit h t h e h e lp o f p s e u d o c o d e , w e u n d e r s t o o d t h e d iﬀ e r e n c e b e t w e e n c a lle r a n d c a lle e . Un d e r s t a n d in g o f s t a c k p la y s a n im p o r t a n t r o le in t h e r e v e r s e e n gin e e r in g o f a n y a p p lic a t io n . S o d o n ’t s k ip t h e s t a c k p a r t . In t h e n e x t c h a p t e r, w e w ill t a lk a b o u t t h e d iﬀ e r e n t r e v e r s e e n gin e e r in g t o o ls u s e d b y p r o fe s s io n a ls in t h e in d u s t r y. C H A P T E R 3 Up a n d R u n n in g w it h R e v e r s e E n gin e e r in g To o ls To o ls p la y a v it a l r o le in e v e r y a s p e c t o f life . W e o f t e n u s e m o b ile c a lc u la t o r s t o p e r fo r m b a s ic m a t h in o u r d a y -t o -d a y life . B e fo r e m o b ile c a lc u la t o r s , w e u s e d h a r d w a r e c a lc u la t o r t o p e r fo r m m a t h c a lc u la t io n s . T h is c a lc u la t o r is a s im p le e x a m p le o f a t o o l w e u s e t o p e r fo r m c e r t a in t a s k s . S im p le c a lc u la t io n s c a n b e d o n e v e r b a lly b u t w h e n it c o m e s t o c o m p le x o n e s , it b e c o m e s n e c e s s a r y t o u s e a t o o l. S im ila r ly, fo r r e v e r s e e n gin e e r in g t h e r e a r e p le n t y o f t o o ls a v a ila b le in t h e m a r k e t . S o m e a r e c o m m e r c ia l a n d s o m e a r e fr e e t o u s e o r o p e n s o u r c e . F o r s e le c t io n o f t h e c o r r e c t t o o ls , c o n c e p t u a l k n o w le d ge o f t h e t o p ic b e c o m e s e s s e n t ia l. If y o u s e a r c h t h e in t e r n e t fo r r e v e r s e e n gin e e r in g t o o ls , y o u w ill ﬁ n d s e v e r a l. It is a lw a y s im p o r t a n t t o h a v e t h e r igh t s e le c t io n o f t o o ls b a s e d o n y o u r r e q u ir e m e n t s . In t h is c h a p t e r, w e w ill ﬁ r s t le a r n a b o u t t h e c o n c e p t o f t o o ls in r e v e r s e e n gin e e r in g a n d t h e n u n d e r s t a n d t h e im p o r t a n c e o f t h e s e t o o ls in t h e p r o c e s s o f r e v e r s e e n gin e e r in g. W e w ill t a lk a b o u t t h e t o o ls t h a t a r e e a s ily a n d fr e e ly a c c e s s ib le . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Im p o r t a n c e o f t o o ls in r e v e r s e e n gin e e r in g R e v e r s e e n gin e e r in g t o o ls P o r t a b le e x e c u t a b le e d it o r s D is a s s e m b le r s D e b u gge r s O b je c t iv e T h e o b je c t iv e o f t h is c h a p t e r is t o u n d e r s t a n d t h e b a s ic c o n c e p t b e h in d t o o ls a n d w h y t h e y a r e r e q u ir e d in t h e p r o c e s s o f r e v e r s e e n gin e e r in g. T h e n w e w ill t a lk a b o u t s o m e t o o ls r e q u ir e d t o r e a d t h e b in a r y fo r m a t . W e w ill a ls o c o v e r s o m e c o n c e p t s r e la t e d t o P o r t a b le E x e c u t a b le ( P E ) e d it o r s , d is a s s e m b le r s , a n d d e b u gge r s . Imp o r t a n c e o f t o o ls in r e v e r s e e n gin e e r in g Wh e n w e c o m p ile a p r o gr a m u s in g a h igh -le v e l la n gu a ge lik e C / C ++, it ge t s c o n v e r t e d t o a s e r ie s o f b y t e s t h a t a C P U c a n u n d e r s t a n d . T h is is a m a c h in e c o d e , w h ic h is d iﬃ c u lt t o u n d e r s t a n d b y h u m a n s . To m a k e t h is c o d e e a s ie r t o u n d e r s t a n d , w e u s e a t o o l c a lle d d is a s s e m b le r. T h is d is a s s e m b le r t r a n s la t e s m a c h in e c o d e t o h u m a n -r e a d a b le fo r m a t . T h is fo r m a t is c a lle d a s s e m b ly c o d e w h ic h u s e s t h e s y n t a x o f a s s e m b ly la n gu a ge . T h e fo llo w in g ﬁ gu r e w ill h e lp y o u u n d e r s t a n d t h e c o n c e p t t h r o u gh o u t y o u r life : F ig u r e 3 .1 : Im p o r t a n c e o f R E t o o ls R e v e r s e e n gin e e r in g h e lp s t o r e ge n e r a t e t h e a p p lic a t io n lo gic w it h o u t h a v in g t h e s o u r c e c o d e o f a n a p p lic a t io n o r a p r o gr a m . M a lw a r e r e s e a r c h e r s fo llo w t h is c o n c e p t t o p e r fo r m r e v e r s e e n gin e e r in g t a s k s . N o w w e w ill d is c u s s a fe w t o o ls r e q u ir e d fo r r e v e r s e e n gin e e r in g. W e w ill a ls o u s e t h e s e t o o ls t h r o u gh o u t t h is b o o k . R e v e r s e e n gin e e r in g t o o ls F o r e a s y u n d e r s t a n d in g, r e v e r s e e n gin e e r in g t o o ls a r e d iv id e d in d iﬀ e r e n t c a t e go r ie s lik e P E e d it o r s , d is a s s e m b le r s , a n d d e b u gge r s . Wit h in e a c h c a t e go r y, w e h a v e fr e e o r o p e n -s o u r c e t o o ls a v a ila b le , a n d a ll t o o ls w it h in a giv e n c a t e go r y s e r v e t h e s a m e p u r p o s e w it h s o m e s ligh t fe a t u r e d iﬀ e r e n c e s . W e w ill fo c u s o n fr e e a n d o p e n - s o u r c e t o o ls w it h gr a p h ic a l u s e r in t e r fa c e . A ll t h e s e t o o ls a r e u s e d t h r o u gh o u t t h is b o o k . P o r t a b le E x e c u t a b le E d it o r s P E s t a n d s fo r P o r t a b le P o r t a b le E x e c u t a b le is t h e s t a n d a r d Win d o w s ﬁ le fo r m a t . E v e r y Win d o w s e x e c u t a b le u s e s t h is ﬁ le fo r m a t . D y n a mic L in k L ib r a r y C o mp o n e n t O b je c t M o d e l ﬁ le s , a n d . N E T e x e c u t a b le u s e t h e P E ﬁ le fo r m a t . T h e fo llo w in g ﬁ gu r e s h o w s t h e b a s ic s t r u c t u r e o f P E : F ig u r e 3 .2 : P E s t r u c t u r e A ll t h e P E ﬁ le s s t a r t w it h t h e D O S h e a d e r t h e n P E h e a d e r a ls o c a lle d N T h e a d e r a n d s e c t io n s t h a t a r e c o m m o n in e x e c u t a b le . T h e s e c o m m o n s e c t io n s a r e a s fo llo w s : T h is s e c t io n c o n t a in s t h e a c t u a l b in a r y e x e c u t a b le c o d e . T h is s e c t io n r e p r e s e n t s u n in it ia liz e d d a t a . T h is s e c t io n c o n t a in s r e a d o n ly d a t a , s u c h a s c o n s t a n t s , s t r in gs . T h is s e c t io n is t h e r e s o u r c e s e c t io n w h e r e r e s o u r c e in fo r m a t io n is s t o r e d . T h is is t h e e x p o r t d a t a s e c t io n c o n t a in in g in fo r m a t io n a b o u t e x p o r t e d fu n c t io n s . T h is is im p o r t d a t a s e c t io n w h ic h c o n t a in s in fo r m a t io n a b o u t im p o r t e d fu n c t io n s a lo n g w it h t h e im p o r t d ir e c t o r y a n d im p o r t a d d r e s s t a b le . In it ia lly, d e b u g in fo r m a t io n w a s p la c e d in t h is d e b u g in fo r m a t io n s e c t io n . P E ﬁ le s a ls o s u p p o r t a s e p a r a t e d e b u g ﬁ le w it h .d b g e x t e n s io n . To v ie w a n d e d it a ll t h e s e d e t a ils , w e c a n u s e t h e fo llo w in g t o o ls . C F F E x p lo r e r T h is t o o l is d e s ign e d t o v ie w a n d e d it P E ﬁ le s w it h o u t lo s in g t h e in t e r n a l s t r u c t u r e o f P E ﬁ le s . T h is t o o l is n o t o n ly u s e d b y r e v e r s e e n gin e e r s b u t a ls o t h e d e v e lo p e r o f a p p lic a t io n s . F ig u r e 3 .3 : C F F E x p lo r e r W e w ill b e u s in g t h is C F F e x p lo r e r t o e d it P E ﬁ le s in o u r s u b s e q u e n t c h a p t e r s . D is a s s e mb le r A s w e d is c u s s e d in t h e e a r lie r s e c t io n t h a t a m a c h in e c o d e is n o t h u m a n r e a d a b le , w e n e e d s o m e t o o ls t o c o n v e r t m a c h in e c o d e in t o a h u m a n -r e a d a b le fo r m a t . T h is is w h e r e d is a s s e m b le r s c o m e in t o p ic t u r e . D is a s s e m b le r s a r e u s e d t o c o n v e r t a m a c h in e c o d e in t o a h u m a n -r e a d a b le a s s e m b ly c o d e . T h e fo llo w in g a r e s o m e d is a s s e m b le r s u s e d in t h is b o o k . G h id r a T h is is a n o p e n -s o u r c e t o o l d e v e lo p e d b y t h e N a t io n a l S e c u r it y A ge n c y It is fr e e a n d u s e d fo r r e v e r s e e n gin e e r in g. It s s o u r c e c o d e w a s r e le a s e d o n A p r il 4 , 2 0 1 9 . T h is t o o l is u s e d b y m a lw a r e r e s e a r c h e r s a n d r e v e r s e e n gin e e r s t o a n a ly z e m a lw a r e s a n d ﬁ n d v u ln e r a b ilit ie s in a p p lic a t io n s . F ig u r e 3 .4 : G h id r a C u t t e r C u t t e r is a n o p e n -s o u r c e in t e r fa c e t o t h e R a d a r e 2 r e v e r s e e n gin e e r in g fr a m e w o r k . R a d a r e 2 is t h e c o m m a n d lin e t o o l fo r r e v e r s e e n gin e e r in g a n d is u s e d fo r s t a t ic a n d d y n a m ic a n a ly s is o f b in a r y fo r m a t s o n d iﬀ e r e n t p la t fo r m s a n d a r c h it e c t u r e s . C u t t e r is t h e gr a p h ic a l u s e r in t e r fa c e o f R a d a r e 2 . F ig u r e 3 .5 : C u t t e r D e b u gge r s Wh e n w e r u n a n a p p lic a t io n o r a b in a r y, w e c h e c k t h e s t a t e o f a r u n n in g p r o gr a m . A d e b u gge r giv e s t h e d y n a m ic s t a t e o f a b in a r y w h e n it is e x e c u t e d in t h e m e m o r y. S o m e v u ln e r a b ilit ie s a r e n o t c a p t u r e d b y t h e d e v e lo p e r w h ile w r it in g o r e x e c u t in g a c o d e . T h is is w h e r e w e u s e d e b u gge r s t o r u n t h e c o d e a n d m o n it o r t h e r e gis t e r s , m e m o r y lo c a t io n s , a n d o t h e r p a r a m e t e r s . W e w ill b e h e a v ily u s in g t h e fo llo w in g d e b u gge r in t h is b o o k . x 3 2 d b g A d e b u gge r c o m e s in t w o ﬂ a v o r s : 3 2 b it a n d 6 4 b it . x 3 2 d b g is u s e d fo r x 8 6 ( 3 2 b it ) b in a r ie s . A n o t h e r v e r s io n is x 6 4 d b g, w h ic h is u s e d fo r x 6 4 ( 6 4 b it ) b in a r ie s . A s s h o w n in t h e fo llo w in g ﬁ gu r e , x 3 2 d b g is d iv id e d in t o 4 s e c t io n s : F ig u r e 3 .6: x 3 2 d b g A s s h o w n in t h e p r e c e d in g ﬁ gu r e , t h e s e fo u r s e c t io n s a r e a s fo llo w s : D is a s s e mb ly o r C P U T h is is w h e r e a m a c h in e c o d e c o n v e r t e d in t o a n a s s e m b ly c o d e is s h o w n . T h e ﬁ r s t c o lu m n is t h e m e m o r y a d d r e s s o f t h e in s t r u c t io n . T h e s e c o n d c o lu m n is t h e o p c o d e , a ls o c a lle d t h e o p e r a t io n T h e t h ir d c o lu m n is t h e a s s e m b ly in s t r u c t io n s . T h e fo r t h c o lu m n s h o w s t h e c o m m e n t a b o u t in s t r u c t io n s . R e gis t e r s a n d T h is s e c t io n s h o w s t h e r e gis t e r s a n d t h e ir v a lu e s d u r in g a d y n a m ic a n a ly s is o f t h e b in a r y. It a ls o s h o w s t h e v a lu e o f a ﬂ a g t o d is p la y t h e c u r r e n t s t a t e o f t h e p r o c e s s o r. A s d is c u s s e d in t h e e a r lie r c h a p t e r, a s t a c k is L a s t In F ir s t O u t T h is m e a n s t h e la s t t h in g a d d e d ( p u s h e d ) w ill b e t h e ﬁ r s t t h in g t o ge t p u lle d o ﬀ ( p o p p e d ) . A s t a c k gr o w s fr o m a h igh e r m e m o r y a d d r e s s t o a lo w e r m e m o r y a d d r e s s . M e mo r y It is lik e h e x e d it o r w h ic h s h o w s t h e h e x a d e c im a l c o d e o f a b in a r y in t h e m e m o r y. It s h o w s r a w d a t a in t h e h e x a d e c im a l a n d A S C II fo r m a t s . T h e v a lu e o n a p a r t ic u la r m e m o r y a d d r e s s c a n b e c h a n ge d b y d o u b le c lic k in g o n t h e r e s p e c t iv e m e m o r y lo c a t io n . C o n c lu s io n In t h is c h a p t e r, w e c o v e r e d d iﬀ e r e n t r e v e r s e e n gin e e r in g t o o ls u s e d t h r o u gh o u t t h is b o o k . W e a ls o d is c u s s e d t h e d iﬀ e r e n c e b e t w e e n a d is a s s e m b le r a n d a d e b u gge r. T h e im p o r t a n c e o f t o o ls in r e v e r s e e n gin e e r in g w a s a ls o d is c u s s e d a n d t h e n w e lis t e d s o m e P E e d it o r s , d is a s s e m b le r s , a n d d e b u gge r s . In t h e n e x t c h a p t e r, w e w ill w a lk t h r o u gh t h e a s s e m b ly in s t r u c t io n s t h a t w ill h e lp u s r e a d a n d u n d e r s t a n d a d is a s s e m b le d a s s e m b ly c o d e . C H A P T E R 4 W a lk T h r o u gh o n A s s e mb ly In s t r u c t io n s In t h e la s t c h a p t e r, w e in t r o d u c e d s o m e a s s e m b ly la n gu a ge in s t r u c t io n s . T h e r e a r e m a n y t y p e s o f in s t r u c t io n s in t h e a s s e m b ly la n gu a ge w h ic h c a n b e gr o u p e d t o ge t h e r t o ge t a c le a r u n d e r s t a n d in g a n d o b je c t iv e o f a s p e c iﬁ c s e t o f a s s e m b ly in s t r u c t io n s . To u n d e r s t a n d t h e r e le v a n c e o f w a lk in g o v e r t h e b a s ic a s s e m b ly in s t r u c t io n s in r e v e r s e e n gin e e r in g, w e w ill t a k e u p a r e a l-life e x a m p le . H a v e y o u e v e r o p e n e d a t o y in y o u r c h ild h o o d ? It w a s a lw a y s fu n t o o p e n a t o y a n d c h e c k it s in t e r n a l c o m p o n e n t s . To d a y, if y o u h a d t o u n d e r s t a n d t h e in t e r n a l w o r k in g o f a t o y, y o u n e e d t o ﬁ r s t u n d e r s t a n d t h e d iﬀ e r e n t c o m p o n e n t s in s t a lle d in t e r n a lly in t h e h a r d w a r e d e s ign o f t h e t o y. N o w , t o u n c o v e r t h e in t e r n a l w o r k in g o f t h e t o y, w e h a v e t o u n d e r s t a n d t h e w o r k in g o f e a c h c o m p o n e n t in s t a lle d in it . T h is w h o le p r o c e s s c a n b e s o m e w h a t c o m p a r e d t o t h e r e v e r s e e n gin e e r in g o f t h e t o y. O n s im ila r lin e s , fo r r e v e r s e e n gin e e r o f a n y s o f t w a r e o r a p p lic a t io n , w e n e e d t o d is a s s e m b le it in t o d iﬀ e r e n t in s t r u c t io n s a n d t h e u n d e r s t a n d in g o f t h e d is a s s e m b le d a s s e m b ly in s t r u c t io n s b e c o m e s a m u s t . S o , t o u n d e r s t a n d t h e w o r k in g o f a n y s o f t w a r e o r a p p lic a t io n , w e n e e d t o h a v e a c le a r u n d e r s t a n d in g o f t h e in s t r u c t io n s a n d t h e ir e x e c u t io n p a t h . T h is is w h e r e u n d e r s t a n d in g o f d iﬀ e r e n t in s t r u c t io n s in a s s e m b ly la n gu a ge is n e e d e d . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : D iﬀ e r e n t a s s e m b ly la n gu a ge in s t r u c t io n s S y n t a x o f t h e a s s e m b ly in s t r u c t io n s G r o u p in g o f a s s e m b ly in s t r u c t io n s O b je c t iv e A f t e r go in g t h r o u gh t h is c h a p t e r, y o u w ill b e a b le t o u n d e r s t a n d t h e im p o r t a n t a s s e m b ly in s t r u c t io n s u s e d in r e v e r s e e n gin e e r in g a n d h o w t h e s e in s t r u c t io n s a r e gr o u p e d in v a r io u s s e c t io n s fo r e a s y u n d e r s t a n d in g a lo n g w it h s o m e e x a m p le s . W e w ill a ls o le a r n t h e s y n t a x o f t h e in s t r u c t io n s , t h e ir in t e r n a l w o r k in g, a n d t h e b a s ic c o n c e p t b e h in d t h e d iﬀ e r e n t t y p e s o f in s t r u c t io n s . D iﬀ e r e n t a s s e mb ly la n gu a ge in s t r u c t io n s In s t r u c t io n s a r e t h e b a s ic b u ild in g b lo c k s o f A s s e m b ly C o d e . In s t r u c t io n s a r e a c o m b in a t io n o f t h e o p e r a t io n c o d e a n d z e r o o r m o r e o p e r a n d s . F ig u r e 4 .1 : A s s e m b ly in s t r u c t io n s y n t a x O p e r a t io n c o d e is o f t e n r e fe r r e d t o a s o p c o d e . O p e r a n d s c a n b e o f t h r e e t y p e s : In t e r me d ia t e T h e s e a r e ﬁ x e d h e x a d e c im a l v a lu e , lik e 0 x 0 A . R e gis t e r T h e y c a n b e a n y r e gis t e r, s u c h a s E C X , E A X , e t c . M e mo r y a d d r e s s T h e s e a r e m e m o r y a d d r e s s e s a n d a r e r e p r e s e n t e d b e t w e e n s q u a r e b r a c k e t s , lik e [E A X ]. T h e p r o gr a m c o d e is s a v e d in t h e m e m o r y in a s e q u e n c e o f o p e r a t io n c o d e ( o r o p c o d e ) a n d o p e r a n d s . T h e y a r e s a v e d in c o n s e c u t iv e m e m o r y lo c a t io n s . A s s h o w n in t h e fo llo w in g im a ge , in s t r u c t io n 1 o c c u p ie s t w o m e m o r y lo c a t io n s , in s t r u c t io n 2 o c c u p ie s t h e s a m e t w o m e m o r y lo c a t io n s , a n d in s t r u c t io n 3 o c c u p ie s o n ly o n e m e m o r y lo c a t io n . F ig u r e 4 .2 : P r o g r a m c o d e in m e m o r y L o o k a t t h e fo llo w in g e x a m p le o f a n a s s e m b ly in s t r u c t io n w it h r e gis t e r o p e r a n d s : In s t r u c t io n F o r m a t : O P E R A T IO N _C O D E D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D E x a mp le M O V E A X , E C X O P E R A T IO N _C O D E = M O V, s t a n d s fo r m o v e D E S T IN A T IO N _O P E R A N D = E A X , is a d e s t in a t io n r e gis t e r S O UR C E _O P E R A N D = E C X , is a s o u r c e r e gis t e r T h is in s t r u c t io n m o v e s d a t a fr o m t h e E C X r e gis t e r t o t h e E A X r e gis t e r. N o w e a c h in s t r u c t io n r e p r e s e n t e d b y t h e o p c o d e s is a ls o c a lle d t h e o p e r a t io n c o d e . T h e s e o p c o d e s t e ll t h e C P U w h a t o p e r a t io n t h e p r o gr a m w a n t s t o p e r fo r m . S o , t h e o p c o d e s fo r t h e p r e c e d in g in s t r u c t io n is 8 9 C 8 , w h ic h is t h e h e x a d e c im a l r e p r e s e n t a t io n o f t h e in s t r u c t io n . T h e d is a s s e m b le r c o n v e r t s t h e s e o p c o d e s in t o a h u m a n r e a d a b le fo r m a t . S o , 8 9 C 8 w ill b e c o n v e r t e d t o M O V E A X , N o w t h a t w e a r e c le a r w it h t h e c o n c e p t o f a s s e m b ly in s t r u c t io n s , w e w ill m o v e o n t o t h e e x p la n a t io n o f m a jo r a s s e m b ly in s t r u c t io n s t h a t c o m e o n t h e w a y t o u n d e r s t a n d r e v e r s e e n gin e e r in g. T h e s e a s s e m b ly in s t r u c t io n s c a n b e s e gm e n t e d o r gr o u p e d in v a r io u s s e c t io n s fo r e a s y u n d e r s t a n d in g. G r o u p in g o f a s s e m b ly in s t r u c t io n s c a n b e b r o a d ly c la s s iﬁ e d in t o t h e fo llo w in g c a t e go r ie s : S t a c k In s t r u c t io n s D a t a Tr a n s fe r In s t r u c t io n s A r it h m e t ic In s t r u c t io n s P r o gr a m E x e c u t io n In s t r u c t io n s B r a n c h in g In s t r u c t io n s B it M a n ip u la t io n In s t r u c t io n s P r o c e s s o r C o n t r o l In s t r u c t io n s S t r in g In s t r u c t io n s L e t ’s w a lk t h r o u gh e a c h s e c t io n o n e b y o n e a n d u n d e r s t a n d a s s e m b ly in s t r u c t io n s t h a t fa ll u n d e r e a c h c a t e go r y. S t a c k In s t r u c t io n s T h e s e a r e ge n e r a l p u r p o s e in s t r u c t io n s u s e d fo r t r a n s fe r o p e r a t io n s a c r o s s t h e s t a c k . P US H In s t r u c t io n F o r m a t : P US H S O UR C E _O P E R A N D M e a n in g: P u s h c o p ie s t h e v a lu e fr o m t h e s o u r c e o p e r a n d o n t o t h e t o p o f t h e s t a c k a n d d e c r e m e n t s t h e E S P r e gis t e r. F la gs A ﬀ e c t e d : N o n e P US H A D In s t r u c t io n F o r m a t : P US H A D M e a n in g: P u s h e s t h e v a lu e s o f a ll t h e r e gis t e r s o n t o t h e s t a c k . R e gis t e r s a r e p u s h e d in t h e o r d e r o f E A X , E C X , E D X , E B X , E S P, E B P, E S I, a n d E D I. F la gs A ﬀ e c t e d : N o n e P US H F D In s t r u c t io n F o r m a t : P US H F D M e a n in g: T h is in s t r u c t io n p u s h e s t h e ﬂ a gs r e gis t e r o n t o t h e s t a c k . F la gs A ﬀ e c t e d : N o n e P O P In s t r u c t io n F o r m a t : P O P D E S T IN A T IO N _O P E R A N D M e a n in g: P O P r e t r ie v e s t h e v a lu e fr o m t h e t o p o f t h e s t a c k a n d c o p ie s it t o t h e d e s t in a t io n o p e r a n d . It in c r e m e n t s t h e E S P r e gis t e r. F la gs A ﬀ e c t e d : N o n e P O P A D In s t r u c t io n F o r m a t : P O P A D M e a n in g: T h is in s t r u c t io n p o p s t h e v a lu e s o f t h e s t a c k a n d c o p ie s t h e m t o a ll t h e r e gis t e r s . R e gis t e r s a r e p o p p e d in t h e o r d e r o f E D I, E S I, E B P, E S P, E D X , E C X , a n d E A X . T h e E S P v a lu e is ign o r e d in P O P A D . F la gs A ﬀ e c t e d : N o n e P O P F D In s t r u c t io n F o r m a t : P O P F D M e a n in g: T h is in s t r u c t io n p o p s t h e D W O R D fr o m t h e s t a c k in t o t h e ﬂ a gs r e gis t e r. F la gs A ﬀ e c t e d : N o n e R E T In s t r u c t io n F o r m a t : R E T [n B y t e s ] M e a n in g: Wh e n a fu n c t io n c a lls a n o t h e r fu n c t io n , t h e fu n c t io n t h a t c a lls a n o t h e r fu n c t io n is c a lle d ‘ c a lle r ’ a n d t h e fu n c t io n t h a t is c a lle d is n a m e d ‘ c a lle e ’ . R E T t r a n s fe r s c o n t r o l fr o m t h e c a lle e t o t h e c a lle r, t o t h e r e t u r n a d d r e s s s a v e d o n t h e s t a c k . n B y t e s a r e o p t io n a l; w h e n n B y t e s a r e m e n t io n e d , it m e a n s t h a t n b y t e s a r e r e le a s e d t o c le a n u p t h e s t a c k . D a t a Tr a n s fe r In s t r u c t io n s T h e s e a r e ge n e r a l p u r p o s e in s t r u c t io n s u s e d fo r d a t a t r a n s fe r o p e r a t io n s . M O V In s t r u c t io n F o r ma t : M O V D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: M o v e s d a t a fr o m t h e s o u r c e o p e r a n d t o t h e d e s t in a t io n o p e r a n d a n d t h e r e s u lt is s t o r e d in t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : N o n e L E A In s t r u c t io n F o r m a t : L E A R E G IS T E R O P E R A N D M e a n in g: L E A s t a n d s fo r L o a d E ﬀ e c t iv e A d d r e s s a n d it lo a d s t h e r e gis t e r w it h t h e m e m o r y a d d r e s s o f t h e o p e r a n d . F la gs A ﬀ e c t e d : N o n e X C H G In s t r u c t io n F o r m a t : X C H G D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: X C H G in s t r u c t io n e x c h a n ge s t h e v a lu e s b e t w e e n t h e s o u r c e o p e r a n d a n d t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : N o n e C M P X C H G In s t r u c t io n F o r ma t : C M P X C H G D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h is in s t r u c t io n is u s e d fo r c o m p a r in g a n d e x c h a n gin g. E A X is c o m p a r e d w it h t h e If E A X is e q u a l t o D E S T IN A T IO N _O P E R A N D t h e n D E S T IN A T IO N _O P E R A N D is lo a d e d w it h If E A X is n o t e q u a l t o D E S T IN A T IO N _O P E R A N D t h e n E A X is lo a d e d w it h F la gs A ﬀ e c t e d : C F Z F S F A F P F O F L A H F In s t r u c t io n F o r ma t : L A H F M e a n in g: T h is in s t r u c t io n lo a d s A H fr o m t h e ﬂ a gs . It c o p ie s t h e s t a t u s t o t h e A H r e gis t e r a n d o n ly 5 ﬂ a gs a r e c o p ie d t o b it s 7 , 6 , 4 , 2 , a n d 0 o f t h e A H r e gis t e r ; b it s 5 , 3 a n d 1 o f t h e A H r e gis t e r w ill b e u n a ﬀ e c t e d . A H r e gis t e r a f t e r r u n n in g t h is in s t r u c t io n : F ig u r e 4 .3 : L o a d A H fr o m F la g s F la gs A ﬀ e c t e d : N o n e S A H F In s t r u c t io n F o r m a t : S A H F M e a n in g: It s t o r e s t h e A H in t o t h e ﬂ a gs . T h is in s t r u c t io n c o p ie s t h e b it s o f t h e A H r e gis t e r ( b it s 7 , 6 , 4 , 2 , a n d 0 ) t o S F, Z F, A F, P F, a n d C F ﬂ a gs . F la gs A ﬀ e c t e d : S F, Z F, A F, P F, a n d C F L A R In s t r u c t io n F o r ma t : L A R D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: L o a d s t h e e ﬀ e c t iv e r igh t fr o m t h e s e gm e n t d e s c r ip t o r s p e c iﬁ e d b y t h e S O UR C E _O P E R A N D in t o t h e D E S T IN A T IO N _O P E R A N D . F la gs A ﬀ e c t e d : Z F M O V S X In s t r u c t io n F o r m a t : M O V S X D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: M o v e w it h S ign E x t e n s io n . S u p p o s e y o u h a v e a s m a lle r v a lu e a n d w a n t t o c o p y it t o a b ig r e gis t e r. In t h a t c a s e , w e w ill u s e it c o p ie s S O UR C E _O P E R A N D t o D E S T IN A T IO N _O P E R A N D a n d ﬁ lls t h e b it s n o t p r o v id e d b y S O UR C E _O P E R A N D w it h s ign b it s . F la gs A ﬀ e c t e d : N o n e M O V Z X In s t r u c t io n F o r ma t : M O V Z X D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: M o v e w it h Z e r o E x t e n s io n . S u p p o s e y o u h a v e a s m a lle r v a lu e a n d w a n t t o c o p y it t o a b ig r e gis t e r. In t h a t c a s e , w e w ill u s e it c o p ie s S O UR C E _O P E R A N D t o D E S T IN A T IO N _O P E R A N D a n d ﬁ lls t h e b it s n o t p r o v id e d b y S O UR C E _O P E R A N D w it h z e r o . F la gs A ﬀ e c t e d : N o n e X L A T In s t r u c t io n F o r ma t : X L A T M e a n in g: T h e X L A T in s t r u c t io n r e p la c e s t h e A L r e gis t e r fr o m t h e t a b le in d e x t o t h e t a b le e n t r y. It s e t s t h e A L t o D S : [E B X + u n s ign e d A L ]. T h e v a lu e o f A L is t r e a t e d a s a n u n s ign e d in d e x , w h ic h is a d d e d t o t h e E B X r e gis t e r t o ge t t h e t a b le e n t r y. E B X c o n t a in s t h e b a s e a d d r e s s o f t h e t a b le . M O V S In s t r u c t io n F o r ma t : M O V S D E S T IN A T IO N _S T R IN G S O UR C E _S T R IN G M e a n in g: T h is in s t r u c t io n c o p ie s d a t a ( B y t e , W O R D , D W O R D ) fr o m S O UR C E _S T R IN G t o w h e r e : S O UR C E _S T R IN G is p o in t e d b y D S :S I ( o r E S I) D E S T IN A T IO N _S T R IN G is p o in t e d b y E S :D I ( o r E D I) S I is t h e o ﬀ s e t a d d r e s s in D a t a S e gme n t D I is t h e o ﬀ s e t a d d r e s s in E x t r a S e gme n t F la gs A ﬀ e c t e d : N o n e A r it h me t ic In s t r u c t io n s T h e s e in s t r u c t io n s a r e u s e d fo r a r it h m e t ic o p e r a t io n s in t h e a s s e m b ly la n gu a ge . A A A In s t r u c t io n F o r m a t : A A A M e a n in g: T h is in s t r u c t io n a d ju s t s t h e A S C II a f t e r a d d it io n . T h e A A A in s t r u c t io n is u s e d a f t e r t h e a d d it io n ( A D D in s t r u c t io n ) o f t w o u n p a c k e d B C D n u m b e r s . Un p a c k e d B C D n u m b e r s a r e A S C II s in gle -d igit n u m b e r s fr o m 0 t o 9 o r 0 x 3 0 t o 0 x 3 9 . Wh e n t h e A A A in s t r u c t io n is u s e d a f t e r t h e A D D in s t r u c t io n , it c o n v e r t s t h e r e s u lt t o a t w o -d igit B C D n u m b e r. F o r A S C II c o d e s , r e fe r t o t h e Wh e n t w o A S C II c o d e d n u m b e r s a r e a d d e d , t h e r e s u lt is n o t A S C II. To c o n v e r t t h is t o A S C II, A A A is u s e d a f t e r A D D . F la gs A ﬀ e c t e d : A F C F ( S F,Z F,O F,P F u n d e ﬁ n e d ) E x a mp le X O R A H , A H         ; c le a r A H r e gis t e r M O V A L , 3 2 H       ; m o v e A S C II 2 in A L A D D A L , 3 9 H       ; a d d A S C II 9 , t h e r e s u lt s h o u ld b e A S C II 1 1 , b u t w e ge t 6 B in A L A A A                      ; A H =0 x 0 1 , A L =0 x 0 1 a n d A X =0 x 0 1 0 1 A A S In s t r u c t io n F o r m a t : A A S M e a n in g: T h e in s t r u c t io n a d ju s t s t h e A S C II a f t e r s u b t r a c t io n . T h e A A S in s t r u c t io n is u s e d a f t e r t h e s u b t r a c t io n ( S UB in s t r u c t io n ) o f t w o u n p a c k e d B C D n u m b e r s . Un p a c k e d B C D n u m b e r s a r e A S C II s in gle -d igit n u m b e r s fr o m 0 t o 9 o r 0 x 3 0 t o 0 x 3 9 . Wh e n t h e A A S in s t r u c t io n is u s e d a f t e r t h e S UB in s t r u c t io n , it c o n v e r t s t h e r e s u lt t o a t w o -d igit B C D n u m b e r. F la gs A ﬀ e c t e d : A F C F ( S F,Z F,O F,P F u n d e ﬁ n e d ) A A D In s t r u c t io n F o r ma t : A A D M e a n in g: T h e A S C II is a d ju s t e d b e fo r e d iv is io n . T h is in s t r u c t io n is u s e d b e fo r e t h e d iv is io n in s t r u c t io n t o c o n v e r t t h e u n p a c k e d B C D n u m b e r in A H a n d A L t o t h e b in a r y e q u iv a le n t . T h e q u o t ie n t w ill b e s a v e d in A L a n d t h e r e m a in d e r w ill b e s a v e d in A H ; b o t h a r e u n p a c k e d B C D . F la gs A ﬀ e c t e d : P F, S F, Z F E x a mp le D iv id e 6 8 b y 8 . M O V A X , 0 6 0 8 H       ;A H =0 x 0 6 , A L =0 x 0 8 a n d A X =0 x 0 6 0 8 M O V C H , 0 8 H           ;d iv id e A S C II 8 , t h e r e s u lt s h o u ld b e 8 in q u o t ie n t a n d 4 in r e m a in d e r A A D                            ;A X = 0 0 4 4 = 4 4 H = 6 8 D IV C H                      ;D iv id e A X b y in C H , r e s u lt : A L = 0 8 , A H = 0 4 u n p a c k e d B C D A A M In s t r u c t io n F o r m a t : A A M M e a n in g: T h e A S C II is a d ju s t e d fo r m u lt ip lic a t io n . T h is in s t r u c t io n is u s e d in t h e m u lt ip lic a t io n o f t w o A S C II n u m b e r s . Wh e n t h e u n p a c k e d B C D d igit s a r e m u lt ip lie d , t h e r e s u lt s t o r e d in A X is c o n v e r t e d t o t h e u n p a c k e d B C D n u m b e r in A H a n d A L . F la gs A ﬀ e c t e d : P F, S F, Z F E x a mp le M O V A L , 0 0 0 0 0 1 1 1       ;m o v e 7 in A L , m a s k in g u p p e r 4 b it s M O V B H , 0 0 0 0 0 1 0 1      ;m o v e 5 in B H , m a s k in g u p p e r 4 b it s M UL B H                         ;A X = 2 3 H , 3 5 in d e c im a l A A M                               ;re s u lt : A X = 0 2 0 3 H , A H = 0 2 H , A L = 0 3 H u n p a c k e d B C D A D C In s t r u c t io n F o r m a t : A D C D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: A d d s t w o o p e r a n d s , s o u r c e o p e r a n d a n d d e s t in a t io n o p e r a n d . T h e r e s u lt is s t o r e d in t h e d e s t in a t io n o p e r a n d . If C F ﬂ a g is s e t t o 1 , t h e n 1 is a d d e d t o t h e d e s t in a t io n . F la gs A ﬀ e c t e d : A F C F O F P F S F Z F A D D In s t r u c t io n F o r m a t : A D D D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h e in s t r u c t io n a d d s t w o o p e r a n d s , s o u r c e o p e r a n d a n d d e s t in a t io n o p e r a n d . T h e r e s u lt is s t o r e d in t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : A F C F O F P F S F Z F C M P In s t r u c t io n F o r ma t : C M P D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: It s u b t r a c t s t w o o p e r a n d s , s o u r c e o p e r a n d a n d d e s t in a t io n o p e r a n d . T h e r e s u lt is n o t s t o r e d , b u t t h e ﬂ a gs a r e u p d a t e d . T h e ﬂ a gs a r e s u b s e q u e n t ly c h e c k e d in t h e in s t r u c t io n s . F la gs A ﬀ e c t e d : A F C F O F P F S F Z F D A A In s t r u c t io n F o r ma t : D A A M e a n in g: T h e d e c im a l is a d ju s t e d a f t e r a d d it io n . T h is in s t r u c t io n c o m e s a f t e r t h e A D D o r A D C in s t r u c t io n t o a d ju s t t h e ﬁ n a l r e s u lt in B C D . T h is o n ly w o r k s w it h t h e A L r e gis t e r s . F la gs A ﬀ e c t e d : A F C F ( O F, P F, S F, Z F u n d e ﬁ n e d ) E x a mp le M O V D X , 1 1 2 2 H      ;lo a d 1 1 2 2 H B C D M O V B X , 3 0 8 8 H      ;lo a d 3 0 8 8 H B C D M O V A L , B L            ;o n ly A L r e gis t e r w o r k s fo r D A A A D D A L , D L            ; D A A                           ; B C D a d ju s t e d r e s u lt , a n s w e r s a v e d in A L D A S In s t r u c t io n F o r ma t : D A S M e a n in g: T h e d e c im a l is a d ju s t e d a f t e r s u b t r a c t io n . T h is in s t r u c t io n c o m e s a f t e r t h e S UB o r S B B in s t r u c t io n t o a d ju s t t h e ﬁ n a l r e s u lt in B C D . T h is o n ly w o r k s w it h t h e A L r e gis t e r s . F la gs A ﬀ e c t e d : A F C F ( O F, P F, S F, Z F u n d e ﬁ n e d ) E x a mp le : M O V D X , 1 1 2 2 H      ;lo a d 1 1 2 2 H B C D M O V B X , 3 0 8 8 H      ;lo a d 3 0 8 8 H B C D M O V A L , B L            ;o n ly A L r e gis t e r w o r k s fo r D A A S UB A L , D L             ; D A S                           ; B C D a d ju s t e d r e s u lt , a n s w e r s a v e d in A L D E C In s t r u c t io n F o r m a t : D E C D E S T IN A T IO N _O P E R A N D M e a n in g: T h e in s t r u c t io n d e c r e m e n t s o n e fr o m t h e d e s t in a t io n o p e r a n d w h ic h c a n b e r e gis t e r o r a m e m o r y lo c a t io n . T h e r e s u lt is s a v e d b a c k in t h e r e gis t e r o r m e m o r y lo c a t io n . F la gs A ﬀ e c t e d : A F O F P F S F Z F E x a mp le : M O V E A X , 0 2 H       ; lo a d E A X w it h 0 2 H D E C E A X                 ; E A X w ill b e 0 1 H D IV In s t r u c t io n F o r ma t : D IV S O UR C E _O P E R A N D M e a n in g: T h e D IV in s t r u c t io n is u s e d t o d iv id e t h e u n s ign e d Q W O R D / D W O R D / W O R D b y D W O R D / W O R D / B YTE. Wh e n a W O R D is d iv id e d b y b y t e , t h e n u m b e r t o b e d iv id e d , t h a t is W O R D , m u s t b e in t h e A X r e gis t e r a n d t h e d iv is o r, w h ic h is s o u r c e o p e r a n d , c a n b e in r e gis t e r o r m e m o r y lo c a t io n . A f t e r d iv is io n , t h e q u o t ie n t w ill b e s a v e d in A L a n d t h e r e m a in d e r w ill b e in A H . Wh e n a D W O R D is d iv id e d b y W O R D , t h e n u m b e r t o b e d iv id e d , t h a t is D W O R D , m u s t b e in D X :A X ( m o s t s ign iﬁ c a n t W O R D in D X a n d le a s t s ign iﬁ c a n t W O R D in A X ) . T h e d iv is o r, w h ic h is t h e s o u r c e o p e r a n d , c a n b e in r e gis t e r o r m e m o r y lo c a t io n . A f t e r d iv is io n , t h e q u o t ie n t w ill b e s a v e d in A X a n d t h e r e m a in d e r w ill b e s a v e d in D X . Wh e n a D o u b le D W O R D ( Q W O R D ) is d iv id e d b y D W O R D , t h e n u m b e r t o b e d iv id e d , t h a t is D o u b le D W O R D ( Q W O R D ) , m u s t b e in E D X :E A X ( h igh e r o r d e r D W O R D in E D X a n d lo w e r o r d e r D W O R D in E A X ) . T h e d iv is o r, w h ic h is t h e s o u r c e o p e r a n d , c a n b e in r e gis t e r o r m e m o r y lo c a t io n . A f t e r d iv is io n , t h e q u o t ie n t w ill b e s a v e d in E A X a n d r e m a in d e r in E D X . F la gs A ﬀ e c t e d : N o n e E x a mp le M O X D X , 0                  ;lo a d D X w it h 0 0 H M O V A X , 0 x 8 0 0 3        ;lo a d A X w it h 8 0 0 3 H M O V C X , 0 x 1 0 0          ;lo a d C X w it h 1 0 0 H D IV C X                        ;A X =8 0 H , D X =0 3 H ID IV In s t r u c t io n F o r m a t : ID IV S O UR C E _O P E R A N D M e a n in g: T h e D IV in s t r u c t io n ( In t e ge r D iv id e ) is u s e d in d iv is io n o f s ign e d d a t a . T h e r e s t is t h e s a m e w it h r e s p e c t t o t h e d iv id e n d , d iv is o r, q u o t ie n t , a n d r e m a in d e r a s in D IV in s t r u c t io n . F la gs A ﬀ e c t e d : N o n e M UL In s t r u c t io n F o r m a t : M UL S O UR C E _O P E R A N D M e a n in g: T h e M UL in s t r u c t io n is u s e d t o m u lt ip le t h e u n s ign e d D W O R D / W O R D / B YTE b y D W O R D / W O R D / B YTE. Wh e n a B YTE is m u lt ip lie d b y B YTE, t h e m u lt ip lic a n d , t h a t is B YTE, m u s t b e in t h e A L r e gis t e r a n d t h e m u lt ip lie r, w h ic h is t h e s o u r c e o p e r a n d , c a n b e in t h e r e gis t e r o r m e m o r y lo c a t io n . A f t e r m u lt ip lic a t io n , t h e r e s u lt w ill b e s a v e d in A X . H igh e r o r d e r 8 b it s a r e s t o r e d in A H a n d lo w e r o r d e r 8 b it s a r e s t o r e d in A L . Wh e n a W O R D is m u lt ip lie d b y W O R D , t h e m u lt ip lic a n d , t h a t is W O R D , m u s t b e in t h e A X r e gis t e r a n d t h e m u lt ip lie r, w h ic h is t h e s o u r c e o p e r a n d , c a n b e in t h e r e gis t e r o r m e m o r y lo c a t io n . A f t e r m u lt ip lic a t io n , t h e r e s u lt w ill b e D W O R D , w h ic h is s a v e d in D X :A X . T h e h igh e r o r d e r W O R D is s t o r e d in D X a n d t h e lo w e r o r d e r W O R D in A X . Wh e n a D W O R D is m u lt ip lie d b y D W O R D , t h e m u lt ip lic a n d , t h a t is D W O R D , m u s t b e in t h e E A X r e gis t e r a n d t h e m u lt ip lie r, w h ic h is t h e s o u r c e o p e r a n d , c a n b e in t h e r e gis t e r o r m e m o r y lo c a t io n . A f t e r m u lt ip lic a t io n , t h e r e s u lt w ill b e Q W O R D , w h ic h is s a v e d in E D X :E A X . T h e h igh e r o r d e r D W O R D is s t o r e d in E D X a n d t h e lo w e r o r d e r D W O R D in E A X . F la gs A ﬀ e c t e d : O F, C F E x a mp le M O V A X , 0 x 8 0 0 3      ;lo a d A X w it h 8 0 0 3 H M O V C X , 0 x 1 0 0        ;lo a d A X w it h 1 0 0 H M UL C X                    ;D X =8 0 H , A X =0 3 0 0 H IM UL In s t r u c t io n F o r m a t : IM UL S O UR C E _O P E R A N D M e a n in g: T h e In t e ge r M u lt ip le in s t r u c t io n is u s e d t o m u lt ip ly t h e s ign e d d a t a . T h e r e s t is t h e s a m e w it h r e s p e c t t o t h e m u lt ip lic a n d a n d m u lt ip lie r a s in M UL in s t r u c t io n . F la gs A ﬀ e c t e d : O F, C F IN C In s t r u c t io n F o r m a t : IN C D E S T IN A T IO N _O P E R A N D M e a n in g: It in c r e m e n t s o r a d d s o n e t o t h e d e s t in a t io n o p e r a n d , w h ic h c a n b e t h e r e gis t e r o r a m e m o r y lo c a t io n . R e s u lt is s a v e d b a c k in r e gis t e r o r a m e m o r y lo c a t io n . F la gs A ﬀ e c t e d : A F O F P F S F Z F E x a mp le M O V E A X , 0 2 H      ; lo a d E A X w it h 0 2 H IN C E A X                 ; E A X w ill b e 0 3 H N E G In s t r u c t io n F o r ma t : N E G D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n c h a n ge s t h e s ign o f t h e d e s t in a t io n o p e r a n d fr o m a p o s it iv e n u m b e r t o a n e ga t iv e n u m b e r o r fr o m a n e ga t iv e n u m b e r t o a p o s it iv e n u m b e r. B a s ic a lly, it s u b t r a c t s 0 fr o m t h e d e s t in a t io n o p e r a n d a n d p e r fo r m s t h e 2 ’s c o m p le m e n t t o s a v e t h e r e s u lt b a c k in t h e d e s t in a t io n o p e r a n d . 2 ’s c o m p le m e n t o f a n 8 -b it n u m b e r 0 0 1 0 0 1 0 1 -> 1 1 0 1 1 0 1 0 ( In v e r t b it s ) -> t h e n a d d 0 0 0 0 0 0 0 1 = 1 1 0 1 1 0 1 1 F la gs A ﬀ e c t e d : A F O F P F S F Z F E x a mp le M O V E A X , 0 2 H      ;lo a d E A X w it h 0 2 H , ( 2 in d e c im a l) N E G E A X                ;E A X w ill b e F F F F F F F E H , ( -2 in d e c im a l) S B B In s t r u c t io n F o r m a t : S B B D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: It s u b t r a c t s s o u r c e o p e r a n d fr o m t h e d e s t in a t io n o p e r a n d . T h e r e s u lt is s t o r e d in t h e d e s t in a t io n o p e r a n d . If t h e C F ﬂ a g is s e t t o 1 , t h e n 1 is s u b t r a c t e d fr o m t h e d e s t in a t io n . F la gs A ﬀ e c t e d : A F C F O F P F S F Z F S UB In s t r u c t io n F o r ma t : S UB D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: S u b t r a c t t h e s o u r c e o p e r a n d fr o m d e s t in a t io n o p e r a n d . T h e r e s u lt is s t o r e d in t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : A F C F O F P F S F Z F X A D D In s t r u c t io n F o r ma t : X A D D D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h e E x c h a n ge a n d A d d in s t r u c t io n is t h e s a m e a s t h e A D D in s t r u c t io n w h e r e it a d d s t h e s o u r c e o p e r a n d a n d t h e d e s t in a t io n o p e r a n d , t o s t o r e t h e r e s u lt in t h e d e s t in a t io n o p e r a n d . T h e d iﬀ e r e n c e fr o m A D D in s t r u c t io n is t h a t a f t e r t h e X A D D in s t r u c t io n , t h e o r igin a l v a lu e o f t h e d e s t in a t io n o p e r a n d is c o p ie d t o t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : A F C F O F P F S F Z F E x a mp le M O V E A X , 0 x 0 0 0 0 0 0 0 1     ; lo a d E A X w it h 0 1 H , ( 1 in d e c im a l) M O V E B X , 0 x 0 0 0 0 0 0 0 2     ; lo a d E B X w it h 0 2 H , ( 2 in d e c im a l) X A D D E A X ,E B X               ; E A X = 0 3 H ( 3 in d e c im a l) , E B X =0 1 H P r o gr a m E x e c u t io n In s t r u c t io n s T h e s e in s t r u c t io n s a r e u s e d in c o n t r o llin g t h e p r o gr a m e x e c u t io n ﬂ o w a n d ﬂ a gs . C A L L In s t r u c t io n F o r ma t : C A L L D E S T IN A T IO N _O P E R A N D M e a n in g: D u r in g p r o gr a m e x e c u t io n , a p r o c e d u r e is c a lle d fr o m a n o t h e r fu n c t io n ; t h e C A L L in s t r u c t io n is u s e d . Us in g C A L L in s t r u c t io n p o in t e r ju m p t o t h e c o d e o f a p r o c e d u r e c a lle d w it h in a fu n c t io n . Wh e n t h e C A L L in s t r u c t io n is e x e c u t e d , t h e m e m o r y a d d r e s s o f t h e n e x t in s t r u c t io n a f t e r t h e C A L L in s t r u c t io n is p u s h e d o n t o t h e s t a c k . T h is m e m o r y a d d r e s s is p o p p e d b a c k fr o m t h e s t a c k o n c e t h e c a lle d p r o c e d u r e e x e c u t io n is o v e r w it h t h e R E T in s t r u c t io n . F la gs A ﬀ e c t e d : N o n e E x a mp le C A L L P r o gr a m ﬂ o w is d e v ia t e d t o t h e p r o c e d u r e la b e l m e m o r y lo c a t io n E N T E R In s t r u c t io n F o r m a t : E N T E R S t o r a ge , L e v e l M e a n in g: In In t e l A r c h it e c t u r e , a n o t h e r m e t h o d o f p e r fo r m in g t h e p r o c e d u r e c a ll is s u p p o r t e d w it h t h e E N T E R a n d L E A V E in s t r u c t io n s . T h e s e in s t r u c t io n s c r e a t e a n d r e le a s e t h e s t a c k fr a m e fo r t h e p r o c e d u r e t o s t o r e v a r ia b le s a n d p o in t e r s t o r e t u r n t h e e x e c u t io n fr o m t h e p r o c e d u r e . In b lo c k -s t r u c t u r e d la n gu a ge lik e C a n d P a s c a l, t h e s e in s t r u c t io n s p r o v id e m a c h in e la n gu a ge s u p p o r t fo r p r o c e d u r e c a lls . T h e E N T E R in s t r u c t io n h a s 2 o p e r a n d s : T h is t e lls t h e n u m b e r o f b y t e s t o b e r e s e r v e d o n t h e s t a c k fo r t h e p r o c e d u r e c a ll. A ls o c a lle d le x ic a l n e s t in g le v e l ( fr o m 0 t o 3 1 ) , it is t h e d e p t h o f p r o c e d u r e in a la d d e r o f p r o c e d u r e c a lls . F la gs A ﬀ e c t e d : N o n e L E A V E In s t r u c t io n F o r ma t : L E A V E M e a n in g: T h is in s t r u c t io n r e le a s e s t h e s t a c k fr a m e c r e a t e d fo r t h e p r o c e d u r e t o s t o r e v a r ia b le s a n d p o in t e r s t o r e t u r n t h e e x e c u t io n fr o m t h e p r o c e d u r e b y r e s t o r in g ( E ) S P / ( E ) B P. F la gs A ﬀ e c t e d : N o n e IN T In s t r u c t io n F o r ma t : IN T t y p e is b e t w e e n 0 a n d 2 5 5 . M e a n in g: In t e r r u p t is a c o n d it io n w h ic h h a lt s t h e p r o c e s s o r t o t e m p o r a r ily w o r k o n s o m e o t h e r t a s k a n d t h e n r e t u r n t o t h e m a in t a s k . In t e r r u p t is a n e v e n t o r s ign a l t h a t a s k s fo r t h e C P U’s a t t e n t io n . T h is is u s e d b y p e r ip h e r a l h a r d w a r e d e v ic e s t o a c c e s s t h e C P U. Wh e n e v e r t h e in t e r r u p t o c c u r s , t h e p r o c e s s o r c o m p le t e s t h e c u r r e n t s e t o f in s t r u c t io n s a n d t h e n s t a r t s t h e in t e r r u p t s e r v ic e r o u t in e o r in t e r r u p t h a n d le r. IS R is a r o u t in e w h ic h c o n t a in s a s e t o f in s t r u c t io n s t o h a n d le s p e c iﬁ c in t e r r u p t s . T h is IS R t e lls t h e p r o c e s s o r w h a t t o d o w h e n a n in t e r r u p t o c c u r s . N o w , t h e IN T in s t r u c t io n a llo w s a p r o gr a m t o e x p lic it ly c a ll t h e in t e r r u p t h a n d le r. T h e fo llo w in g t a s k s a r e d o n e w h e n a n IN T in s t r u c t io n is c a lle d : T h e F L A G S r e gis t e r is p u s h e d o n t h e s t a c k . T h e C o d e s e gme n t is p u s h e d o n t h e s t a c k . T h e o ﬀ s e t o f t h e n e x t in s t r u c t io n a f t e r t h e IN T in s t r u c t io n is p u s h e d o n t o t h e s t a c k . T h e IP ( In s t r u c t io n P o in t e r ) is lo a d e d fr o m a n a b s o lu t e m e m o r y a d d r e s s , w h ic h is a m u lt ip le o f t h e in t e r r u p t t y p e b y 4 . If IN T is 8 , t h e IP ( In s t r u c t io n P o in t e r ) w ill b e r e a d fr o m 8 * 4 = 3 2 d e c im a l = 0 x 0 0 0 2 0 m e m o r y lo c a t io n . T h e c o d e s e gm e n t w ill b e t h e n e x t W O R D lo c a t io n . T h e C S w ill b e 0 x 0 0 0 2 2 ( 0 x 0 0 0 2 0 + 2 ) . R e s e t T F Tr a p ﬂ a g ( T F ) a n d IF In t e r r u p t ﬂ a g ( IF ) . F la gs A ﬀ e c t e d : IF, T F IN T O In s t r u c t io n F o r ma t : IN T O M e a n in g: In t e r r u p t O v e r ﬂ o w If t h e O v e r ﬂ o w ﬂ a g is s e t , t h is in s t r u c t io n r a is e s t h e o v e r ﬂ o w e x c e p t io n . If O F is n o t s e t , t h e n t h e in s t r u c t io n e x e c u t io n c o n t in u e s w it h o u t r a is in g a n e x c e p t io n . T h is h e lp s t o c h e c k t h e o v e r ﬂ o w c o n d it io n . T h e fo llo w in g t a s k s a r e d o n e w h e n a n IN T in s t r u c t io n is c a lle d : T h e F L A G S r e gis t e r is p u s h e d o n t h e s t a c k . T h e C S ( c o d e s e gm e n t ) is p u s h e d o n t h e s t a c k . T h e o ﬀ s e t o f t h e n e x t in s t r u c t io n a f t e r t h e IN T in s t r u c t io n is p u s h e d o n t o t h e s t a c k . T h e IP ( In s t r u c t io n P o in t e r ) is lo a d e d fr o m a n a b s o lu t e m e m o r y a d d r e s s , w h ic h is m u lt ip le o f in t e r r u p t t y p e b y 4 . If t h e o v e r ﬂ o w c o n d it io n is IN T 4 , t h e IP ( In s t r u c t io n P o in t e r ) w ill b e r e a d fr o m 4 * 4 = 1 6 d e c im a l = 0 x 0 0 0 1 0 m e m o r y lo c a t io n . T h e c o d e s e gm e n t w ill b e t h e n e x t W O R D lo c a t io n . T h e C S w ill b e 0 x 0 0 0 1 2 ( 0 x 0 0 0 1 0 + 2 ) . R e s e t In t e r r u p t ﬂ a g a n d Tr a p ﬂ a g t o 0 . F la gs A ﬀ e c t e d : IF, T F IR E T In s t r u c t io n F o r ma t : IR E T M e a n in g: In t e r r u p t R e t u r n T h is in s t r u c t io n is u s e d t o e n d t h e In t e r r u p t S e r v ic e R o u t in e o r in t e r r u p t h a n d le r a n d r e t u r n t h e e x e c u t io n t o t h e in t e r r u p t e d p r o gr a m . Wh e n a n In t e r r u p t S e r v ic e R o u t in e is c a lle d , t h e in s t r u c t io n p o in t e r, c o d e s e gm e n t , a n d ﬂ a gs r e gis t e r s a r e p u s h e d o n t o t h e s t a c k . O n r e t u r n fr o m t h e IS R in s t r u c t io n p o in t e r, t h e c o d e s e gm e n t a n d ﬂ a gs a r e r e s t o r e d b a c k fr o m t h e s t a c k t o c o n t in u e t h e e x e c u t io n o f t h e in t e r r u p t e d p r o gr a m . F la gs A ﬀ e c t e d : A F, C F, D F, IF, Z F, S F, T F, P F L O O P In s t r u c t io n F o r m a t : L O O P D E S T IN A T IO N M e a n in g: In L O O P in s t r u c t io n , t h e ( E ) C X r e gis t e r is d e c r e m e n t e d b y 1 . If t h e n e w v a lu e in t h e ( E ) C X r e gis t e r is n o n -z e r o , t h e n a ju m p is t a k e n t o t h e d e s t in a t io n m e n t io n e d in t h e in s t r u c t io n . If t h e ( E ) C X r e gis t e r is d e c r e m e n t e d a n d t h e E C X is e q u a l t o 0 , t h e n n o a c t io n w ill b e t a k e n a n d t h e in s t r u c t io n n e x t t o t h e L O O P E in s t r u c t io n is e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le L O O P E M E M _L O C      ; P r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E C X is n o n -z e r o                                       ; a f t e r d e c r e m e n t in g L O O P E In s t r u c t io n F o r m a t : L O O P E D E S T IN A T IO N M e a n in g: In t h e L O O P E in s t r u c t io n , t h e ( E ) C X r e gis t e r is d e c r e m e n t e d b y 1 . If t h e n e w v a lu e in t h e ( E ) C X r e gis t e r is n o n -z e r o a n d t h e Z F ﬂ a g is s e t t o 1 , t h e n a ju m p is t a k e n t o t h e d e s t in a t io n m e n t io n e d in t h e in s t r u c t io n . If t h e ( E ) C X r e gis t e r is d e c r e m e n t e d a n d E C X is e q u a l t o 0 , t h e n n o a c t io n w ill b e t a k e n a n d t h e in s t r u c t io n n e x t t o t h e L O O P E in s t r u c t io n is e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le L O O P E M E M _L O C      ; P r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E C X is n o n -z e r o                                        ; a f t e r d e c r e m e n t in g a n d Z F =1 d u e t o t h e p r e v io u s in s t r u c t io n L O O P N E In s t r u c t io n F o r m a t : L O O P N E D E S T IN A T IO N M e a n in g: In t h e L O O P N E in s t r u c t io n , t h e ( E ) C X r e gis t e r is d e c r e m e n t e d b y 1 . If t h e n e w v a lu e in t h e ( E ) C X r e gis t e r is n o n -z e r o a n d t h e Z F ﬂ a g is s e t t o 0 , t h e n a ju m p is t a k e n t o t h e d e s t in a t io n m e n t io n e d in t h e in s t r u c t io n . If t h e ( E ) C X r e gis t e r is d e c r e m e n t e d a n d E C X is e q u a l t o 0 , t h e n n o a c t io n w ill b e t a k e n a n d t h e in s t r u c t io n n e x t t o t h e L O O P N E in s t r u c t io n is e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le L O O P N E M E M _L O C     ; P r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E C X is n o n -z e r o                                         ; a f t e r d e c r e m e n t in g a n d Z F =0 d u e t o t h e p r e v io u s in s t r u c t io n T E S T In s t r u c t io n F o r m a t : T E S T D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h is in s t r u c t io n p e r fo r m s t h e lo gic a l A N D b e t w e e n t h e s o u r c e o p e r a n d a n d t h e d e s t in a t io n o p e r a n d . Un lik e t h e A N D in s t r u c t io n , t h e T E S T in s t r u c t io n d o e s n o t u p d a t e a n y o f t h e o p e r a n d s . It u p d a t e s t h e ﬂ a gs w it h o u t s a v in g t h e r e s u lt s . T h is in s t r u c t io n is u s e d t o c h e c k t h e r e gis t e r s fo r z e r o , w it h o u t a lt e r in g it s v a lu e . F la gs A ﬀ e c t e d : S F, Z F, a n d P F E x a mp le T E S T E A X , 0 1 H     ; IF E A X =0 1 H                                 ; 0 1 H A N D 0 1 H = 0 1 H ( n o n –z e r o v a lu e )                                 ; R e s u lt is n o n -z e r o v a lu e , Z F is n o t s e t , Z F =0 T E S T E A X , 0 2 H     ; IF E A X =0 1 H                                 ; 0 1 H A N D 0 2 H = 0 0 H ( z e r o v a lu e )                                 ; R e s u lt is z e r o v a lu e , Z F is s e t , Z F =1 T E S T E A X , E A X    ; if E A X is e q u a l t o 0 , s e t Z F t o 1 B r a n c h in g In s t r u c t io n s T h is in c lu d e s in s t r u c t io n s w h ic h h e lp in c o n t r o llin g t h e c o d e ﬂ o w . T h e r e a r e t w o t y p e s o f ju m p s in x 8 6 : Un c o n d it io n a l T h e in s t r u c t io n p o in t e r ju m p s t o t h e c o d e p a t h m e n t io n e d . C o n d it io n a l T h e in s t r u c t io n p o in t e r ju m p s a f t e r e v a lu a t in g t h e c o n d it io n . T h e c o n d it io n is c o m m o n ly e v a lu a t e d u s in g t w o in s t r u c t io n s . B o t h t h e in s t r u c t io n s d o n o t s t o r e a n y r e s u lt b u t c h a n ge t h e ﬂ a gs in t h e E F L A G S r e gis t e r. T E S T It p e r fo r m s t h e lo gic a l A N D . C M P It p e r fo r m s s u b t r a c t io n . N o t e : T h e D E S T IN A T IO N _O P E R A N D u s e d in b r a n c h in g in s t r u c t io n s is a ls o n a m e d a s a L A B E L o r D E S T IN A T IO N L A B E L o r D E S T IN A T IO N A D D R E S S . T h is is a d is p la c e m e n t fr o m t h e a d d r e s s o f t h e u n c o n d it io n a l/ c o n d it io n a l ju m p in s t r u c t io n it s e lf o r t h e a b s o lu t e a d d r e s s . JM P In s t r u c t io n F o r m a t : JM P D E S T IN A T IO N _O P E R A N D M e a n in g: T h is is a n u n c o n d it io n a l ju m p in s t r u c t io n w h e r e t h e in s t r u c t io n p o in t e r ju m p s t o t h e d e s t in a t io n o p e r a n d d u r in g e x e c u t io n . F la gs A ﬀ e c t e d : N o n e E x a mp le JM P P R O C _L A B E L    ; P r o gr a m ﬂ o w ju m p s t o t h e p r o c e d u r e la b e l m e m o r y lo c a t io n JZ In s t r u c t io n F o r ma t : JZ D E S T IN A T IO N _O P E R A N D M e a n in g: T h is is a c o n d it io n a l ju m p in s t r u c t io n w h ic h ju m p s t o t h e d e s t in a t io n o p e r a n d if t h e z e r o ﬂ a g ( Z F ) is s e t t o 1 . If Z F is s e t t o 0 , t h e n n o a c t io n w ill b e t a k e n a n d t h e n e x t in s t r u c t io n fo llo w in g it w ill b e e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le JZ M E M _L O C   ; P r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if Z F =1 JN Z In s t r u c t io n F o r m a t : JN Z D E S T IN A T IO N _O P E R A N D M e a n in g: T h is is a c o n d it io n a l ju m p in s t r u c t io n w h ic h ju m p s t o t h e d e s t in a t io n o p e r a n d if t h e z e r o ﬂ a g ( Z F ) is s e t t o 0 . If Z F is s e t t o 1 , t h e n n o a c t io n w ill b e t a k e n a n d t h e n e x t in s t r u c t io n fo llo w in g it w ill b e e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le JN Z M E M _L O C     ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if Z F =0 JE In s t r u c t io n F o r m a t : JE D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n is t h e s a m e a s JZ . A s Ju mp if E q u a l is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is e q u a l t o t h e s o u r c e o p e r a n d in t h e c o n d it io n a l ju m p . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 1 H     ; C o m p a r e t h e E A X v a lu e w it h 0 1 H JE M E M _L O         ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X = 0 1 H a n d Z F = 1 JN E In s t r u c t io n F o r m a t : JN E D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n is t h e s a m e a s JN Z . A s Ju mp if N o t E q u a l is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is n o t e q u a l t o t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 1 H     ; C o m p a r e t h e E A X v a lu e w it h 0 1 H JN E M E M _L O       ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X != 0 1 H a n d Z F = 0 JG In s t r u c t io n F o r m a t : JG D E S T IN A T IO N _O P E R A N D M e a n in g: A s Ju mp if G r e a t e r ( JG ) is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m s a s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is gr e a t e r t h a n t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 2 H     ; C o m p a r e t h e E A X v a lu e w it h 0 2 H JG M E M _L O         ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X > 0 2 H JG E In s t r u c t io n F o r ma t : JG E D E S T IN A T IO N _O P E R A N D M e a n in g: T h e Ju mp if G r e a t e r o r E q u a l is a c o n d it io n a l ju m p in s t r u c t io n , s o it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m s a s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is gr e a t e r t h a n o r e q u a l t o t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 2 H      ; C o m p a r e t h e E A X v a lu e w it h 0 2 H b y s u b t r a c t in g 0 2 H fr o m E A X JG E M E M _L O       ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X ≥ 0 2 H JA In s t r u c t io n F o r m a t : JA D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n is t h e s a m e a s JG . A s Ju mp if a b o v e is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m a n u n s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is a b o v e t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 4 H     ; C o m p a r e t h e E A X v a lu e w it h 0 4 H b y s u b t r a c t in g 0 4 H fr o m E A X JA M E M _L O         ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X is a b o v e 0 4 H JA E In s t r u c t io n F o r m a t : JA E D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n is t h e s a m e a s JG E . A s Ju mp if a b o v e o r e q u a l is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m s a n u n s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is a b o v e o r e q u a l t o t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 4 H     ; C o m p a r e t h e E A X v a lu e w it h 0 4 H , b y s u b t r a c t in g 0 4 H fr o m E A X JA E M E M _L O      ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X is a b o v e o r e q u a l t o 0 4 H JL In s t r u c t io n F o r m a t : JL D E S T IN A T IO N _O P E R A N D M e a n in g: A s Ju mp if L e s s is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m s a s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is le s s t h a n t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 2 H     ; C o m p a r e t h e E A X v a lu e w it h 0 2 H b y s u b t r a c t in g 0 2 H fr o m E A X JL M E M _L O         ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X < 0 2 H JL E In s t r u c t io n F o r m a t : JL E D E S T IN A T IO N _O P E R A N D M e a n in g: T h e Ju mp if L e s s o r e q u a l is a c o n d it io n a l ju m p in s t r u c t io n . It is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m s a s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is le s s t h a n o r e q u a l t o t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 2 H     ; C o m p a r e t h e E A X v a lu e w it h 0 2 H b y s u b t r a c t in g 0 2 H fr o m E A X JL E M E M _L O       ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X ≤ 0 2 H JB In s t r u c t io n F o r ma t : JB D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n is t h e s a m e a s JL . A s Ju mp if b e lo w is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n w h e r e it p e r fo r m s a n u n s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is b e lo w t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 4 H     ; C o m p a r e t h e E A X v a lu e w it h 0 4 H b y s u b t r a c t in g 0 4 H fr o m E A X JB M E M _L O         ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X is b e lo w 0 4 H JB E In s t r u c t io n F o r m a t : JB E D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n is t h e s a m e a s JL E . A s Ju mp if b e lo w o r e q u a l is a c o n d it io n a l ju m p in s t r u c t io n , it is c o m m o n ly u s e d a f t e r t h e C M P in s t r u c t io n t o p e r fo r m a n u n s ign e d c o m p a r is o n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e ju m p w ill h a p p e n if t h e d e s t in a t io n o p e r a n d is b e lo w o r e q u a l t o t h e s o u r c e o p e r a n d . F la gs A ﬀ e c t e d : N o n e E x a mp le C M P E A X , 0 4 H     ; C o m p a r e t h e E A X v a lu e w it h 0 4 H b y s u b t r a c t in g 0 4 H fr o m E A X JB E M E M _L O      ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E A X is b e lo w o r e q u a l t o ; 0 4 H JO In s t r u c t io n F o r ma t : JO D E S T IN A T IO N _O P E R A N D M e a n in g: T h is is a c o n d it io n a l ju m p in s t r u c t io n w h ic h ju m p s t o t h e d e s t in a t io n o p e r a n d if t h e o v e r ﬂ o w ﬂ a g ( O F ) is s e t t o 1 . If O F is s e t t o 0 , t h e n n o a c t io n w ill b e t a k e n a n d t h e n e x t in s t r u c t io n fo llo w in g it w ill b e e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le A D D A L , B L        ; A d d t h e s ign e d b y t e s in A L a n d B L JO M E M _L O C    ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if O F =1 , d u e t o a d d it io n ; a b o v e JS In s t r u c t io n F o r ma t : JS D E S T IN A T IO N _O P E R A N D M e a n in g: T h is is a c o n d it io n a l ju m p in s t r u c t io n w h ic h ju m p s t o t h e d e s t in a t io n o p e r a n d if t h e s ign ﬂ a g ( S F ) is s e t t o 1 . If S F is s e t t o 0 , t h e n n o a c t io n w ill b e t a k e n a n d t h e n e x t in s t r u c t io n fo llo w in g it w ill b e e x e c u t e d . F la gs A ﬀ e c t e d : N o n e E x a mp le A D D A L , B L        ; A d d s ign e d b y t e s in A L a n d B L JS M E M _L O C    ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if S F =1 , d u e t o a d d it io n ; a b o v e JEC X Z In s t r u c t io n F o r ma t : JEC X Z D E S T IN A T IO N _O P E R A N D M e a n in g: T h is is a c o n d it io n a l ju m p in s t r u c t io n w h ic h ju m p s t o t h e d e s t in a t io n o p e r a n d if t h e E C X r e gis t e r is e q u a l t o 0 . F la gs A ﬀ e c t e d : N o n e E x a mp le JEC X Z M E M _L O C    ; T h e p r o gr a m w ill ju m p t o t h e m e m o r y lo c a t io n if E C X = 0 B it M a n ip u la t io n In s t r u c t io n s T h is in c lu d e s in s t r u c t io n s u s e d in b it m a n ip u la t io n o p e r a t io n s . B e fo r e w e ge t s t a r t e d w it h t h e in s t r u c t io n s , le t ’s w a lk t h r o u gh t h e t r u t h t a b le : F ig u r e 4 .4 : Tr u t h t a b le B S W A P In s t r u c t io n F o r ma t : B S W A P R E G IS T E R 3 2 M e a n in g: T h is in s t r u c t io n c h a n ge s t h e b y t e o r d e r o f t h e r e gis t e r fr o m B ig- e n d ia n t o L it t le -e n d ia n o r fr o m L it t le -e n d ia n t o B ig-e n d ia n . F la gs A ﬀ e c t e d : N o n e E x a mp le M O V E A X , 8 7 6 5 4 3 2 1 H     ; E A X is 8 7 6 5 4 3 2 1 H B S W A P E A X                      ; E A X w ill b e c o m e 2 1 4 3 6 5 8 7 H A N D In s t r u c t io n F o r ma t : A N D D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h is in s t r u c t io n p e r fo r m s t h e lo gic a l A N D o p e r a t io n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e r e s u lt o f t h e A N D o p e r a t io n is s a v e d in t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : C F O F P F S F Z F E x a mp le M O V E A X , 8 7 6 5 4 3 2 1 H     ; E A X is 8 7 6 5 4 3 2 1 H M O V E B X , 2 1 4 3 6 5 8 7 H     ; E B X is 2 1 4 3 6 5 8 7 H A N D E A X , E B X                ; E A X w ill b e c o m e 0 x 0 1 4 1 4 1 0 1 N O T In s t r u c t io n F o r ma t : N O T D E S T IN A T IO N _O P E R A N D M e a n in g: T h is in s t r u c t io n in v e r t s a ll t h e b it s o f t h e d e s t in a t io n o p e r a n d . A ll t h e 1 s w ill b e c o m e 0 a n d a ll t h e 0 s w ill b e c o m e 1 b y t a k in g o n e 's c o m p le m e n t . O n e ’s c o m p le m e n t is o b t a in e d b y t o gglin g a ll t h e b it s . F la gs A ﬀ e c t e d : N o n e E x a mp le M O V E A X , 1 2 1 2 1 2 1 2 H     ; E A X is 1 2 1 2 1 2 1 2 H N O T E A X                            ; E A X w ill b e c o m e E D E D E D E D H O R In s t r u c t io n F o r ma t : O R D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h is in s t r u c t io n p e r fo r m s t h e lo gic a l O R o p e r a t io n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e r e s u lt o f t h e lo gic a l O R o p e r a t io n is s a v e d in t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : C F O F P F S F Z F E x a mp le M O V E A X , 8 7 6 5 4 3 2 1 H     ; E A X is 8 7 6 5 4 3 2 1 H M O V E B X , 2 1 4 3 6 5 8 7 H     ; E B X is 2 1 4 3 6 5 8 7 H O R E A X , E B X                   ; E A X w ill b e c o m e 0 x A 7 6 7 6 7 A 7 X O R In s t r u c t io n F o r ma t : X O R D E S T IN A T IO N _O P E R A N D S O UR C E _O P E R A N D M e a n in g: T h is in s t r u c t io n p e r fo r m s t h e e x c lu s iv e -O R o p e r a t io n b e t w e e n t h e d e s t in a t io n o p e r a n d a n d t h e s o u r c e o p e r a n d . T h e r e s u lt o f t h e X O R o p e r a t io n is s a v e d in t h e d e s t in a t io n o p e r a n d . F la gs A ﬀ e c t e d : C F O F P F S F Z F E x a mp le M O V E A X , 8 7 6 5 4 3 2 1 H     ; E A X is 8 7 6 5 4 3 2 1 H X O R E A X , E A X                ; E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 0 R C L In s t r u c t io n F o r ma t : R C L D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: F ig u r e 4 .5 : R C L R o t a t e t h r o u gh C a r r y L e f t r o t a t e s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e r igh t t o le f t t h r o u gh t h e C F F la g. O n e v e r y r o t a t io n , M o s t S ign iﬁ c a n t B it is m o v e d t o t h e C F ﬂ a g a n d t h e C F ﬂ a g e n t e r s in t o L e a s t s ign iﬁ c a n t b it F la gs A ﬀ e c t e d : C F O F E x a mp le M O V E A X , 0 1 H     ; E A X is 0 0 0 0 0 0 0 1 H a n d C F =0 R C L E A X , 2           ; R C L E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 4 R C R In s t r u c t io n F o r ma t : R C R D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: F ig u r e 4 .6: R C R R o t a t e t h r o u gh c a r r y r igh t ( R C R ) r o t a t e s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e le f t t o r igh t t h r o u gh t h e C F ﬂ a g. O n e v e r y r o t a t io n , L S B is m o v e d t o t h e C F ﬂ a g a n d t h e C F ﬂ a g e n t e r s in t o M S B . F la gs A ﬀ e c t e d : C F O F E x a mp le M O V E A X , 0 1 H     ; E A X is 0 0 0 0 0 0 0 1 H a n d C F =0 R C R E A X , 2           ; R C R E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 8 0 0 0 0 0 0 0 R O L In s t r u c t io n F o r ma t : R O L D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: F ig u r e 4 .7 : R O L R o t a t e L e f t r o t a t e s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e r igh t t o le f t a n d t h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it r o t a t e d . F la gs A ﬀ e c t e d : C F O F E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H       ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 R O L E A X , 2                     ; R O L E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 5 a n d ; C F w ill s e t t o 1 R O R In s t r u c t io n F o r ma t : R O R D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: F ig u r e 4 .8: R O R R o t a t e R igh t r o t a t e s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e le f t t o r igh t a n d t h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it r o t a t e d . F la gs A ﬀ e c t e d : C F O F E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H      ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =1 R O R E A X , 2                    ; R O R E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 5 0 0 0 0 0 0 0 a n d ; C F w ill s e t t o 0 S H R In s t r u c t io n F o r ma t : S H R D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: To u n d e r s t a n d t h e b it s h if t in g c o n c e p t , r e fe r t o it in t h e F ig u r e 4 .9: S H R S h if t L o gic a l R igh t s h if t s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e le f t t o r igh t a n d t h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it s h if t e d o u t . A s it is lo gic a l s h if t in g, t h e b it p la c e h o ld e r o n e v e r y s h if t c o u n t is s e t t o 0 . F la gs A ﬀ e c t e d : C F O F P F S F Z F ( A F u n d e ﬁ n e d ) E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H      ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 S H R E A X , 2                     ; S H R E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 1 0 0 0 0 0 0 0 a n d ; C F w ill s e t t o 0 S H L In s t r u c t io n F o r ma t : S H L D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: A s s a id a b o v e , t o u n d e r s t a n d b it s h if t in g c o n c e p t , r e fe r b it s h if t in g s e c t io n in F ig u r e 4 .1 0 : S H L S h if t L o gic a l L e f t s h if t s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e r igh t t o le f t a n d t h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it s h if t e d o u t . A s it is lo gic a l s h if t in g, t h e b it p la c e h o ld e r o n e v e r y s h if t c o u n t is s e t t o 0 . F la gs A ﬀ e c t e d : C F O F P F S F Z F ( A F u n d e ﬁ n e d ) E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H       ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 S H L E A X , 2                      ; S H L E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 4 a n d ; C F w ill s e t t o 1 S A R In s t r u c t io n F o r ma t : S A R D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: F ig u r e 4 .1 1 : S A R S h if t A r it h me t ic R igh t s h if t s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e le f t t o r igh t a n d t h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it s h if t e d o u t . A s it is a r it h m e t ic s h if t in g, t h e b it p la c e h o ld e r is d e t e r m in e d b y M S B . F la gs A ﬀ e c t e d : C F O F P F S F Z F ( A F u n d e ﬁ n e d ) E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H       ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =1 S A R E A X , 2                      ; S A R E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 1 0 0 0 0 0 0 0 a n d ; C F w ill s e t t o 0 S A L In s t r u c t io n F o r ma t : S A L D E S T IN A T IO N _O P E R A N D C O UN T M e a n in g: F ig u r e 4 .1 2 : S A L S h if t A r it h me t ic L e f t s h if t s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e r igh t t o le f t a n d t h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it s h if t e d o u t . A s it is a r it h m e t ic s h if t in g, t h e b it p la c e h o ld e r a t L S B w ill a lw a y s b e 0 . F la gs A ﬀ e c t e d : C F O F P F S F Z F ( A F u n d e ﬁ n e d ) E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H       ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 S A L E A X , 2                      ; S A L E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 4 a n d ; C F w ill s e t t o 1 S H L D In s t r u c t io n F o r ma t : S H L D D E S T IN A T IO N _O P E R A N D , S O UR C E _O P E R A N D , C O UN T M e a n in g: F ig u r e 4 .1 3 : S H L D S h if t L e f t D o u b le s h if t s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e r igh t t o le f t a n d t h e e m p t y b it p la c e h o ld e r s in t h e d e s t in a t io n o p e r a n d a r e ﬁ lle d b y t h e b it s s h if t e d o u t o f t h e s o u r c e o p e r a n d . T h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it s h if t e d o u t o f t h e d e s t in a t io n o p e r a n d . T h e s o u r c e o p e r a n d w ill n o t b e m o d iﬁ e d . F la gs A ﬀ e c t e d : C F O F P F S F Z F ( A F u n d e ﬁ n e d ) E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H     ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 M O V E B X , 5 0 0 0 0 0 0 1 H     ; E B X is 5 0 0 0 0 0 0 1 H a n d C F =0 S H L D E A X , E B X , 2          ; E A X = 0 x 0 0 0 0 0 0 0 5 a n d E A X = 0 x 5 0 0 0 0 0 0 1                                            ; C F w ill s e t t o 1 S H R D In s t r u c t io n F o r ma t : S H R D D E S T IN A T IO N _O P E R A N D , S O UR C E _O P E R A N D , C O UN T M e a n in g: F ig u r e 4 .1 4 : S H R D S h if t R igh t D o u b le s h if t s t h e b it s n ( c o u n t ) t im e s in t h e d e s t in a t io n o p e r a n d fr o m t h e le f t t o r igh t a n d t h e e m p t y b it p la c e h o ld e r s in t h e d e s t in a t io n o p e r a n d a r e ﬁ lle d b y t h e b it s s h if t e d o u t o f t h e s o u r c e o p e r a n d . T h e C F ﬂ a g w ill h a v e t h e v a lu e o f t h e la s t b it s h if t e d o u t o f t h e d e s t in a t io n o p e r a n d . T h e s o u r c e o p e r a n d w ill n o t b e m o d iﬁ e d . F la gs A ﬀ e c t e d : C F O F P F S F Z F ( A F u n d e ﬁ n e d ) E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H     ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =1 M O V E B X , 5 0 0 0 0 0 0 1 H     ; E B X is 5 0 0 0 0 0 0 1 H a n d C F =1 S H R D E A X , E B X , 2          ; E A X = 0 x 5 0 0 0 0 0 0 0 a n d E A X = 0 x 5 0 0 0 0 0 0 1                                            ; C F w ill s e t t o 0 P r o c e s s o r C o n t r o l In s t r u c t io n s T h is in c lu d e s in s t r u c t io n s u s e d in c o n t r o llin g t h e p r o c e s s o r o p e r a t io n s . C L C In s t r u c t io n F o r ma t : C L C M e a n in g: C le a r t h e C a r r y F la g T h is in s t r u c t io n c le a r s t h e C a r r y F la g. F la gs A ﬀ e c t e d : C F E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H        ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 S A L E A X , 2                       ; S A L E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 4 a n d ; C F w ill s e t t o 1 C L C                                       ; C le a r t h e C F ﬂ a g, C F =0 C L D In s t r u c t io n F o r ma t : C L D M e a n in g: C le a r t h e D ir e c t io n F la g T h is in s t r u c t io n c le a r s t h e D ir e c t io n F la g t o 0 . F la gs A ﬀ e c t e d : C F C L I In s t r u c t io n F o r ma t : C L I M e a n in g: C le a r t h e In t e r r u p t F la g T h is in s t r u c t io n c le a r s t h e In t e r r u p t F la g t o 0 . O n c e t h e IF ﬂ a g is r e s e t , t h e p r o c e s s o r w ill n o t r e s p o n d t o t h e in t e r r u p t s ign a l. F la gs A ﬀ e c t e d : C F C M C In s t r u c t io n F o r ma t : C M C M e a n in g: C o mp le me n t C a r r y T h is in s t r u c t io n in v e r t s t h e C a r r y F la g. F la gs A ﬀ e c t e d : C F E x a mp le M O V E A X , 4 0 0 0 0 0 0 1 H        ; E A X is 4 0 0 0 0 0 0 1 H a n d C F =0 S A L E A X , 2                       ; S A L E A X b it s 2 t im e s , E A X w ill b e c o m e 0 x 0 0 0 0 0 0 0 4 a n d ; C F w ill s e t t o 1 C M C                                      ; To ggle C F ﬂ a g fr o m 1 t o 0 , C F =0 E S C In s t r u c t io n F o r ma t : E S C O P C O D E S O UR C E _O P E R A N D O P C O D E = D 8 t o D F S O UR C E _O P E R A N D = R E G IS T E R O R M E M O R Y M e a n in g: E s c a p e t o F lo a t in g P o in t C o p r o c e s s o r T h is in s t r u c t io n p a s s e s t h e in s t r u c t io n s t o t h e c o p r o c e s s o r, a ls o c a lle d ﬂ o a t in g p o in t o r m a t h c o p r o c e s s o r. T h e m ic r o p r o c e s s o r fe t c h e s t h e in s t r u c t io n b y t e s a n d t h e c o p r o c e s s o r a ls o fe t c h e s t h e s e in s t r u c t io n b y t e s fr o m t h e d a t a b u s a n d q u e u e s t h e m . A ll t h e n o r m a l m ic r o p r o c e s s o r in s t r u c t io n s a r e t r e a t e d a s N O P b y t h e c o p r o c e s s o r b u t w h e n t h e E S C in s t r u c t io n is fe t c h e d b y t h e m ic r o p r o c e s s o r, t h e c o p r o c e s s o r d e c o d e s t h e in s t r u c t io n t o c a r r y o u t t h e a c t io n . Wh e n t h e E S C in s t r u c t io n is e x e c u t e d , t h e m ic r o p r o c e s s o r p r o v id e s t h e m e m o r y a d d r e s s o t h e r w is e p e r fo r m N O P. F la gs A ﬀ e c t e d : N o n e L O C K In s t r u c t io n F o r ma t : L O C K : [IN S T R UC T IO N ] M e a n in g: L O C K is t h e n o t a n in s t r u c t io n b u t a n in s t r u c t io n p r e ﬁ x . Wh e n L O C K is u s e d a s a p r e ﬁ x in fr o n t o f a n y in s t r u c t io n , t h e p r o c e s s o r L O C K p in is a c t iv a t e d o r a ls o c a lle d a s s e r t e d . Wh e n t h e L O C K p in is a c t iv a t e d b y t h e L O C K in s t r u c t io n , t h e e x t e r n a l b u s m a s t e r a n d o t h e r p e r ip h e r a ls a r e d is a b le d u n t il t h e in s t r u c t io n a f t e r L O C K is e x e c u t e d . S o , L O C K is u s e d in fr o n t o f c r it ic a l in s t r u c t io n s t h a t a r e t o b e e x e c u t e d w it h o u t a n y d is t u r b a n c e t o b u s m a s t e r ( B u s M a s t e r is a p r o gr a m t h a t c o n t r o ls t h e b u s o n w h ic h t h e a d d r e s s a n d c o n t r o l s ign a ls ﬂ o w ) a n d s y s t e m b u s ( S y s t e m B u s is a c o m m o n t e r m fo r a d d r e s s b u s a n d d a t a b u s ) . F la gs A ﬀ e c t e d : N o n e E x a mp le L O C K : M O V E A X , E B X   ; A c t iv a t e t h e L O C K p in o f t h e p r o c e s s o r fo r t h e M O V in s t r u c t io n ; e x e c u t io n N O P In s t r u c t io n F o r ma t : N O P M e a n in g: N o O p e r a t io n T h is in s t r u c t io n d o e s n o t h in g. It is u s e d t o e a t u p t h e p r o c e s s o r t im e a n d m e m o r y. F la gs A ﬀ e c t e d : N o n e E x a mp le N O P     ; D o n o t h in g S T C In s t r u c t io n F o r ma t : S T C M e a n in g: S e t t h e C a r r y F la g T h is in s t r u c t io n s e t s t h e C a r r y F la g t o 1 . F la gs A ﬀ e c t e d : C F E x a mp le C L C    ; C le a r t h e C F ﬂ a g, C F =0 S T C    ; S e t t h e C F ﬂ a g, C F =1 S T D In s t r u c t io n F o r ma t : S T D M e a n in g: S e t t h e D ir e c t io n F la g T h is in s t r u c t io n s e t s t h e D ir e c t io n F la g t o 1 . F la gs A ﬀ e c t e d : D F S T I In s t r u c t io n F o r ma t : S T I M e a n in g: S e t t h e F la g T h is in s t r u c t io n s e t s t h e In t e r r u p t F la g t o 1 . A s a lr e a d y e x p la in e d in a b o v e in s t r u c t io n s , w h e n t h e IF ﬂ a g is e n a b le d , t h e in t e r r u p t e v e n t o r s ign a l w ill c a u s e t h e p r o c e s s o r t o in t e r r u p t t h e p r o gr a m e x e c u t io n . Wh e n e v e r t h e in t e r r u p t o c c u r s , t h e p r o c e s s o r c o m p le t e s t h e c u r r e n t s e t o f in s t r u c t io n s a n d t h e n s t a r t s t h e in t e r r u p t s e r v ic e r o u t in e o r in t e r r u p t h a n d le r. IS R is a r o u t in e w h ic h c o n t a in s a s e t o f in s t r u c t io n s t o h a n d le s p e c iﬁ c in t e r r u p t s . T h is IS R t e lls t h e p r o c e s s o r w h a t t o d o w h e n a n in t e r r u p t o c c u r s . T h e IR E T in s t r u c t io n a f t e r IS R r e t u r n s t h e e x e c u t io n b a c k t o t h e in t e r r u p t e d p r o gr a m . F la gs A ﬀ e c t e d : IF S t r in g In s t r u c t io n s T h is in c lu d e s in s t r u c t io n s u s e d in h a n d lin g s t r in g o p e r a t io n s . C M P S / C M P S B / C M P S W In s t r u c t io n F o r ma t : T h is in s t r u c t io n c a n b e v is u a liz e d a s a c o m b in a t io n o f C M P fo r c o m p a r e + S fo r S t r in g + B fo r B y t e o r W fo r W O R D o r D fo r D W O R D C M P S B S O UR C E , D E S T IN A T IO N C M P S W S O UR C E , D E S T IN A T IO N C M P S D S O UR C E , D E S T IN A T IO N M e a n in g: T h is in s t r u c t io n is u s e d t o c o m p a r e t w o s t r in gs w h e r e t h e s o u r c e s t r in g is p o in t e d b y E S I a n d t h e d e s t in a t io n s t r in g is p o in t e d b y E D I. Wh e n C M P S B is u s e d , t h e c o m p a r is o n is d o n e b e t w e e n e v e r y b y t e . Wh e n C M P S W is u s e d , t h e c o m p a r is o n is d o n e b e t w e e n e v e r y w o r d . Wh e n C M P S D is u s e d , t h e c o m p a r is o n is d o n e b e t w e e n e v e r y D W O R D . B y c o m p a r is o n , it m e a n s s u b t r a c t in g a b y t e / w o r d / d w o r d p o in t e d b y t h e E S I a n d E D I r e gis t e r s , ju s t a s w e s t u d ie d in t h e C M P in s t r u c t io n . T h e C M P S in s t r u c t io n is u s e d w it h t h e p r e ﬁ x e s R E P E / R E P Z , w h ic h m e a n s r e p e a t t h e c o m p a r is o n u n t il E C X =0 o r Z F =0 . W e w ill c o v e r R E P E / R E P Z la t e r. If D ir e c t io n ﬂ a g, D F =0 , t h e n E S I a n d E D I a r e in c r e m e n t e d b y 1 fo r b y t e , 2 fo r w o r d , a n d 4 fo r d w o r d a f t e r e a c h m o v e . If D ir e c t io n ﬂ a g, D F =1 t h e n E S I a n d E D I a r e d e c r e m e n t e d b y 1 fo r b y t e , 2 fo r w o r d , a n d 4 fo r d w o r d a f t e r e a c h m o v e . F la gs A ﬀ e c t e d : A F,C F,O F,P F,S F,Z F E x a mp le F ig u r e 4 .1 5 : C M P S B e x a m p le M O V E S I, 0 x 4 1 0 0 0 0 0 1      ; E S I p o in t in g t o S T R IN G 1 M O V E D I, 0 x 8 2 0 0 0 0 0 1      ; E S I p o in t in g t o S T R IN G 2 M O V E C X , 0 x 0 8                 ; E C X is in it ia liz e d t o 0 x 0 8 C L D                                     ; C le a r d ir e c t io n ﬂ a g, D F =0 R E P E C M P S B                    ; C o m p a r e t w o s t r in gs u n t il E C X =0 o r Z F =0 IN / IN S B / IN S W/ IN S D T h is in s t r u c t io n c a n b e v is u a liz e d a s a c o m b in a t io n o f IN fo r In p u t + S fo r S t r in g + B fo r B y t e o r W fo r W O R D o r D fo r D W O R D . M e a n in g: T h e r e a r e t w o t y p e s o f in s t r u c t io n s u s e d t o t r a n s fe r d a t a b e t w e e n t h e p r o c e s s o r in p u t / o u t p u t p o r t s a n d t h e p e r ip h e r a l d e v ic e s . T h e s e t w o t y p e s o f in s t r u c t io n a r e a s fo llo w s : R e gis t e r in p u t / o u t p u t T h e s e in s t r u c t io n s m o v e t h e d a t a b e t w e e n t h e p r o c e s s o r I/ O p o r t a n d t h e r e gis t e r. B lo c k ( o r s t r in g) in p u t / o u t p u t T h e s e in s t r u c t io n s m o v e b lo c k s o f d a t a b e t w e e n t h e p r o c e s s o r I/ O p o r t a n d t h e m e m o r y. R e gis t e r in p u t in s t r u c t io n IN D E S T IN A T IO N S O UR C E Wh e r e , S O UR C E is t h e p o r t a d d r e s s A n d D E S T N A T IO N is t h e r e gis t e r, E A X ( 3 2 -b it ) r e gis t e r o r A X ( 1 6 - b it ) r e gis t e r o r A L ( 8 -b it ) r e gis t e r. T h e d e s t in a t io n r e gis t e r le n gt h d e t e r m in e s t h e a m o u n t o f d a t a t o b e r e a d fr o m t h e in p u t p o r t , w h ic h c a n b e b y t e , w o r d , o r d w o r d . T h e d e s t in a t io n c a n b e s o m e o t h e r ge n e r a l p u r p o s e r e gis t e r. IN E A X , 8 0     ; It w ill r e a d d w o r d ( 3 2 -b it s ) fr o m p o r t 8 0 a n d s t o r e it in E A X . IN A X , 8 0        ; It w ill r e a d w o r d ( 1 6 -b it s ) fr o m p o r t 8 0 a n d s t o r e it in A X . B lo c k ( o r s t r in g) in p u t in s t r u c t io n IN S B / IN S W/ IN S D Wh e r e t h e p r o c e s s o r in p u t p o r t a d d r e s s is s p e c iﬁ e d in t h e D X r e gis t e r a n d t h e d e s t in a t io n is t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. T h e IN S B in s t r u c t io n m o v e s a b y t e ( 8 -b it s ) d a t a fr o m t h e in p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. To t r a n s fe r b lo c k s o f d a t a b e t w e e n t h e p r o c e s s o r in p u t p o r t a n d t h e m e m o r y, t h e IN S B in s t r u c t io n is u s e d w it h t h e r e p e a t p r e ﬁ x R E P. A f t e r e v e r y b y t e t r a n s fe r b e t w e e n t h e in p u t p o r t a n d t h e m e m o r y p o in t e d b y E D I, E D I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 1 . T h e IN S W in s t r u c t io n m o v e s a w o r d ( 1 6 b it s ) d a t a fr o m t h e in p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. To t r a n s fe r b lo c k s o f d a t a b e t w e e n t h e p r o c e s s o r in p u t p o r t a n d t h e m e m o r y, t h e IN S W in s t r u c t io n is u s e d w it h t h e r e p e a t p r e ﬁ x R E P. A f t e r e v e r y w o r d t r a n s fe r b e t w e e n t h e in p u t p o r t a n d t h e m e m o r y p o in t e d b y E D I, E D I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 2 . T h e IN S D in s t r u c t io n m o v e s a d w o r d ( 3 2 b it s ) d a t a fr o m t h e in p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. To t r a n s fe r b lo c k s o f d a t a b e t w e e n t h e p r o c e s s o r in p u t p o r t a n d t h e m e m o r y, t h e IN S D in s t r u c t io n is u s e d w it h t h e r e p e a t p r e ﬁ x R E P. A f t e r e v e r y d w o r d t r a n s fe r b e t w e e n t h e in p u t p o r t a n d t h e m e m o r y p o in t e d b y E D I, E D I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 4 . F la gs A ﬀ e c t e d : N o n e E x a mp le M O V D X , P O R T _A D D R E S S     ; M o v e t h e in p u t p o r t a d d r e s s t o t h e D X r e gis t e r M O V E D I, o ﬀ s e t S T R                 ; M o v e t h e m e m o r y o ﬀ s e t fo r s t r in g t o t h e E D I r e gis t e r IN S W                                          ; M o v e a w o r d ( 1 6 b it s ) fr o m t h e in p u t p o r t a d d r e s s                                                     ; s p e c iﬁ e d in t h e D X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d                                                     ; b y E D I r e gis t e r O UT/ O UTS B / O UTS W/ O UTS D T h is in s t r u c t io n c a n b e v is u a liz e d a s a c o m b in a t io n o f O UT fo r O u t p u t + S fo r S t r in g + B fo r B y t e o r W fo r W O R D o r D fo r D W O R D . M e a n in g: T h e s a m e c o n c e p t fr o m in p u t in s t r u c t io n is r e it e r a t e d h e r e . T h e r e a r e t w o t y p e s o f in s t r u c t io n s u s e d t o t r a n s fe r d a t a b e t w e e n t h e p r o c e s s o r in p u t / o u t p u t p o r t s a n d t h e p e r ip h e r a l d e v ic e s . T h e s e t w o t y p e s o f in s t r u c t io n a r e a s fo llo w s : R e gis t e r in p u t / o u t p u t T h e s e in s t r u c t io n s m o v e t h e d a t a b e t w e e n t h e p r o c e s s o r I/ O p o r t a n d t h e r e gis t e r. B lo c k ( o r s t r in g) in p u t / o u t p u t T h e s e in s t r u c t io n m o v e b lo c k s o f d a t a b e t w e e n t h e p r o c e s s o r I/ O p o r t a n d t h e m e m o r y. R e gis t e r o u t p u t in s t r u c t io n O UT D E S T IN A T IO N S O UR C E S O UR C E is t h e r e gis t e r, E A X ( 3 2 b it ) r e gis t e r o r A X ( 1 6 b it ) r e gis t e r o r A L ( 8 b it ) r e gis t e r. T h e s o u r c e r e gis t e r le n gt h d e t e r m in e s t h e a m o u n t o f d a t a t o b e o u t p u t fr o m t h e s o u r c e r e gis t e r t o t h e p o r t , w h ic h c a n b e b y t e , w o r d , o r d w o r d . T h e s o u r c e c a n a ls o b e s o m e o t h e r ge n e r a l p u r p o s e r e gis t e r. A n d D E S T N A T IO N is t h e p o r t a d d r e s s O UT 8 0 , E A X      ; It w ill o u t p u t d w o r d ( 3 2 -b it s ) fr o m E A X t o p o r t 8 0 . O UT 8 0 , A X         ; It w ill o u t p u t w o r d ( 1 6 -b it s ) fr o m A X t o p o r t 8 0 . B lo c k ( o r s t r in g) o u t p u t in s t r u c t io n O UTS B / O UTS W/ O UTS D Wh e r e t h e p r o c e s s o r o u t p u t p o r t a d d r e s s is s p e c iﬁ e d in t h e D X r e gis t e r a n d t h e s o u r c e is t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r. T h e O UTS B in s t r u c t io n o u t p u t s a b y t e ( 8 -b it s ) d a t a fr o m t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e o u t p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r. To t r a n s fe r b lo c k s o f d a t a b e t w e e n t h e m e m o r y a n d t h e p r o c e s s o r o u t p u t p o r t , t h e O UTS B in s t r u c t io n is u s e d w it h t h e r e p e a t p r e ﬁ x R E P. A f t e r e v e r y b y t e ( 8 - b it s ) o u t p u t fr o m t h e m e m o r y p o in t e d b y E S I t o t h e o u t p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r, E S I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 1 . T h e O UTS W in s t r u c t io n o u t p u t s a w o r d ( 1 6 -b it s ) d a t a fr o m t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e o u t p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r. To t r a n s fe r b lo c k s o f d a t a b e t w e e n t h e m e m o r y a n d t h e p r o c e s s o r o u t p u t p o r t , t h e O UTS W in s t r u c t io n is u s e d w it h t h e r e p e a t p r e ﬁ x R E P. A f t e r e v e r y w o r d ( 1 6 -b it s ) o u t p u t fr o m t h e m e m o r y p o in t e d b y E S I t o t h e o u t p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r, E S I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 2 . T h e O UTS D in s t r u c t io n o u t p u t s a d w o r d ( 3 2 -b it s ) d a t a fr o m t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e o u t p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r. To t r a n s fe r b lo c k s o f d a t a b e t w e e n t h e m e m o r y a n d t h e p r o c e s s o r o u t p u t p o r t , t h e O UTS D in s t r u c t io n is u s e d w it h t h e r e p e a t p r e ﬁ x R E P. A f t e r e v e r y d w o r d ( 3 2 -b it s ) o u t p u t fr o m t h e m e m o r y p o in t e d b y E S I t o t h e o u t p u t p o r t a d d r e s s s p e c iﬁ e d in t h e D X r e gis t e r, E S I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 4 . F la gs A ﬀ e c t e d : N o n e E x a mp le M O V E S I, o ﬀ s e t S T R                    ; M o v e m e m o r y o ﬀ s e t fo r s t r in g t o t h e E S I r e gis t e r M O V D X , P O R T _A D D R E S S        ; M o v e O u t p u t P o r t a d d r e s s t o t h e D X r e gis t e r O UTS W                                          ; O u t p u t a w o r d ( 1 6 b it s ) fr o m m e m o r y lo c a t io n p o in t e d                                                        ; b y E S I r e gis t e r t o o u t p u t P o r t a d d r e s s in D X r e gis t e r L O D S / L O D S B / L O D S W/ L O D S D In s t r u c t io n F o r ma t : L O D S B L O D S W L O D S D M e a n in g: L o a d S t r in g lo a d s t h e s t r in g p o in t e d b y t h e E S I r e gis t e r t o t h e E A X r e gis t e r. L o a d S t r in g B y t e lo a d s a b y t e o f s t r in g p o in t e d b y t h e E S I r e gis t e r t o t h e A L r e gis t e r. L o a d S t r in g W o r d lo a d s a w o r d o f s t r in g p o in t e d b y t h e E S I r e gis t e r t o t h e A X r e gis t e r. L o a d S t r in g D W O R D lo a d s a d w o r d o f s t r in g p o in t e d b y t h e E S I r e gis t e r t o t h e E A X r e gis t e r. E S I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 1 fo r L o a d S t r in g B y t e 2 fo r L o a d S t r in g W o r d a n d 4 fo r L o a d S t r in g D W O R D F la gs A ﬀ e c t e d : N o n e E x a mp le C L D                                  ; C le a r D ir e c t io n ﬂ a g, D F =0 M O V E S I, O ﬀ s e t S T R      ; M o v e m e m o r y o ﬀ s e t o f s t r in g t o E S I r e gis t e r L O D S B                              ; L o a d s a b y t e o f t h e s t r in g p o in t e d b y E S I r e gis t e r t o A L                                          ; r e gis t e r S T O S / S T O S B / S T O S W In s t r u c t io n F o r ma t : S T O S B S T O S W S T O S D M e a n in g: S t o r e S t r in g s t o r e s t h e s t r in g fr o m t h e E A X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. S t o r e S t r in g B y t e s t o r e s a b y t e o f s t r in g fr o m t h e A L r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. S t o r e S t r in g W o r d s t o r e s a w o r d o f s t r in g fr o m t h e A X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. S t o r e S t r in g D W O R D s t o r e s a d w o r d o f s t r in g fr o m t h e E A X r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. E D I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 1 fo r S t o r e S t r in g B y t e 2 fo r S t o r e S t r in g W o r d a n d 4 fo r S t o r e S t r in g D W O R D F la gs A ﬀ e c t e d : N o n e E x a mp le C L D                                ; C le a r D ir e c t io n ﬂ a g, D F =0 M O V E S I, O ﬀ s e t S T R    ; M o v e m e m o r y o ﬀ s e t o f s t r in g t o E S I r e gis t e r S T O S B                            ; S t o r e s a b y t e o f t h e s t r in g fr o m A L r e gis t e r t o m e m o r y                                        ; p o in t e d b y E D I r e gis t e r S C A S / S C A S B / S C A S W In s t r u c t io n F o r ma t : S C A S B S C A S W S C A S D M e a n in g: S c a n S t r in g s c a n s t h e s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r a n d c o m p a r e s ( o r s u b t r a c t s ) it w it h t h e c o n t e n t s o f t h e E A X r e gis t e r. T h e r e s u lt o f t h e c o m p a r is o n o r s u b t r a c t io n is d is c a r d e d a n d t h e s t a t u s ﬂ a gs a r e u p d a t e d a c c o r d in gly. S c a n S t r in g B y t e s c a n s a b y t e o f s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r a n d c o m p a r e s it w it h t h e c o n t e n t s o f t h e A L r e gis t e r. S c a n S t r in g W o r d s c a n s a w o r d o f s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r a n d c o m p a r e s it w it h t h e c o n t e n t s o f t h e A X r e gis t e r. S c a n S t r in g D W O R D s c a n s a d w o r d o f s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r a n d c o m p a r e s it w it h t h e c o n t e n t s o f t h e E A X r e gis t e r. E D I is in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 1 fo r S c a n S t r in g B y t e 2 fo r S c a n S t r in g W o r d a n d 4 fo r S c a n S t r in g D W O R D F la gs A ﬀ e c t e d : N o n e E x a mp le M O V E C X , 1 0 0              ; S c a n a s t r in g o f 1 0 0 c h a r a c t e r s M O V E D I, o ﬀ s e t S T R    ; M o v e m e m o r y o ﬀ s e t o f s t r in g t o E S I r e gis t e r M O V A L , 0 x 2 0               ; S c a n n in g s t r in g fo r s p a c e c h a r a c t e r, s p a c e =0 x 2 0 R E P N E S C A S B              ; R e p e a t u n t il E C X =0 o r Z F =1 M O V S / M O V S B / M O V S W In s t r u c t io n F o r ma t : M O V S B M O V S W M O V S D M e a n in g: M o v e S t r in g m o v e s t h e s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. M o v e S t r in g B y t e m o v e s a b y t e ( 8 -b it s ) o f s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. M o v e S t r in g W o r d m o v e s a w o r d ( 1 6 -b it s ) o f s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. M o v e S t r in g D W O R D m o v e s a d w o r d ( 3 2 -b it s ) o f s t r in g in t h e m e m o r y lo c a t io n p o in t e d b y t h e E S I r e gis t e r t o t h e m e m o r y lo c a t io n p o in t e d b y t h e E D I r e gis t e r. E S I a n d E D I a r e in c r e m e n t e d ( w h e n D F =0 ) o r d e c r e m e n t e d ( w h e n D F =1 ) b y 1 fo r M o v e S t r in g B y t e 2 fo r M o v e S t r in g W o r d a n d 4 fo r M o v e S t r in g D W O R D F la gs A ﬀ e c t e d : N o n e E x a mp le M O V E S I, S R C _S T R    ; M o v e s o u r c e s t r in g lo c a t io n in E S I M O V E D I, D S T _S T R    ; M o v e d e s t in a t io n s t r in g lo c a t io n in E D I M O V E C X , 0 5 H            ; In it ia liz e E C X t o 0 x 0 5 , w h ic h is s t r in g le n gt h C L D                               ; C le a r t h e d ir e c t io n ﬂ a g, D F =0 R E P M O V S B                ; M o v e s t h e s t r in g o f le n gt h 5 b y t e s fr o m s r c t o d e s t R E P In s t r u c t io n F o r ma t : R E P M e a n in g: R e p e a t is n o t a n in s t r u c t io n . It is a p r e ﬁ x w h ic h is u s e d b e fo r e s t r in g in s t r u c t io n s . Wh e n R E P is u s e d b e fo r e a s t r in g in s t r u c t io n , it w ill r e p e a t t h e in s t r u c t io n u n t il E C X c o u n t e r b e c o m e s 0 . O n e v e r y e x e c u t io n o f t h e in s t r u c t io n a f t e r R E P, t h e E C X c o u n t e r is d e c r e m e n t e d b y 1 u n t il E C X =0 . F la gs A ﬀ e c t e d : D e p e n d s o n t h e in s t r u c t io n u s e d a f t e r R E P. E x a mp le : M O V D W O R D P T R D S :[0 x 0 1 1 E 8 0 0 0 ], 0 x 4 1 4 2 4 3 4 4      ;w r it e A B C D t o 0 x 0 1 1 E 8 0 0 0                                                                                             ; m e m o r y lo c a t io n , A B C D w ill b e                                                                                             ; w r it t e n in r e v e r s e o r d e r ( lit t le                                                                                             ; e n d ia n ) M O V E S I, 0 X 1 1 E 8 0 0 0                                                        ; M o v e s o u r c e s t r in g lo c a t io n in E S I M O V E D I, 0 X 1 1 E 8 0 1 0                                                      ; M o v e s o u r c e s t r in g lo c a t io n in E D I M O V E C X , 0 X 0 5                                                              ; In it ia liz e E C X t o 0 x 0 5 , t o r u n it e r a t io n 5 t im e s C L D                                                                                   ; C le a r t h e d ir e c t io n ﬂ a g, D F =0 R E P M O V S B                                                                     ; M o v e s t h e A B C D fr o m s r c                                                                                           ; t o d e s t , u n t il E C X =0 R E P E / R E P Z In s t r u c t io n F o r ma t : R E P E R E P Z M e a n in g: R e p e a t if E q u a l a n d R e p e a t if Z e r o c a u s e t h e p r e c e d in g s t r in g in s t r u c t io n t o r e p e a t u n t il E C X =0 o r Z e r o ﬂ a g ( Z F ) = 0 . T h e s e p r e ﬁ x e s a r e u s e d w it h t h e C M P S a n d S C A S in s t r u c t io n s . F la gs A ﬀ e c t e d : D e p e n d s o n t h e in s t r u c t io n u s e d a f t e r R E P E / R E P Z in s t r u c t io n . R E P N E / R E P N Z In s t r u c t io n F o r ma t : R E P N E R E P N Z M e a n in g: R e p e a t if N o t E q u a l a n d R e p e a t if N o t Z e r o c a u s e t h e p r e c e d in g s t r in g in s t r u c t io n t o r e p e a t u n t il E C X =0 o r Z F =1 . T h e s e p r e ﬁ x e s a r e u s e d w it h t h e C M P S a n d S C A S in s t r u c t io n s . F la gs A ﬀ e c t e d : D e p e n d s o n in s t r u c t io n u s e d a f t e r R E P N E / R E P N Z in s t r u c t io n . C o n c lu s io n In t h is c h a p t e r, w e s t u d ie d t h e e x p la n a t io n o f m a jo r a s s e m b ly in s t r u c t io n s u s e d in r e v e r s e e n gin e e r in g. W e a ls o c o v e r e d t h e d iﬀ e r e n t t y p e s o f in s t r u c t io n s fo r s t a c k , d a t a t r a n s fe r, a r it h m e t ic , p r o gr a m e x e c u t io n , b r a n c h in g, b it m a n ip u la t io n , p r o c e s s o r c o n t r o l, a n d s t r in g. E x a m p le s w it h s o m e in s t r u c t io n s w e r e a ls o c o v e r e d t o e la b o r a t e t h e w o r k in g o f t h e in s t r u c t io n s . In t h e n e x t c h a p t e r, w e w ill t a lk a b o u t s o m e s t a c k b a s e d in s t r u c t io n s in d e t a il a n d u n d e r s t a n d t h e c o n c e p t o f c o d e c a llin g c o n v e n t io n s . T h is c o n c e p t is im p o r t a n t fr o m t h e r e v e r s e e n gin e e r in g p o in t o f v ie w a n d y o u w ill c o m e a c r o s s t h is q u it e o f t e n in im p le m e n t in g r e v e r s e e n gin e e r in g. C H A P T E R 5 Ty p e s o f C o d e C a llin g C o n v e n t io n s In C h a p t e r 2 , Und e r s t a n d in g A r c h it e c t u r e o f x 86 M a c h in e s , w e u n d e r s t o o d t h e c o n c e p t o f s t a c k . S e v e r a l t h in gs h a p p e n in t h e b a c k gr o u n d w h e n w e c a ll a fu n c t io n . C o n t r o l is t r a n s fe r r e d t o t h e n e w fu n c t io n in a w a y t h a t t h e s t a c k fr a m e is a llo c a t e d fo r lo c a l v a r ia b le s a n d p a r a m e t e r s a r e p a s s e d fo r a c a lle e t o u n d e r s t a n d . O n r e t u r n , t h e r e t u r n a d d r e s s is p la c e d o n t h e s t a c k s o t h a t t h e c a lle r c a n ﬁ n d it a n d a s t a c k c le a n -u p is p e r fo r m e d a s w e ll. Im a gin e if t h e c a lle e a n d t h e c a lle r b o t h c le a n u p t h e s t a c k , t h e n it w ill c r e a t e a d is a s t r o u s s it u a t io n w h e r e t h e s t a c k is c le a n e d t w ic e b o t h b y c a lle e a n d c a lle r. S o , u n d e r s t a n d in g t h e d iﬀ e r e n c e in c o d e c a llin g c o n v e n t io n s b e c o m e s im p o r t a n t . A s t h e r e a r e m a n y v a r ia n t s o f C P Us , s o m e C P Us h a v e a s t r ic t p r o t o c o l o n h o w t h is is p e r fo r m e d . B u t w h e n w e t a lk a b o u t t h e x 8 6 a r c h it e c t u r e , it is a ll ﬂ e x ib le w h e r e a p r o gr a m m e r d e c id e s o n h o w t o c a ll t h e m e t h o d s . T h is is t h e r e a s o n t h a t le d t o d iﬀ e r e n t c a llin g c o n v e n t io n s . Wh e n y o u w r it e C / C ++ c o d e w h e r e in y o u u s e s h a r e d lib r a r ie s , c o d e c a llin g c o n v e n t io n b e c o m e s im p o r t a n t , a s t h e c o d e y o u a r e in t e r a c t in g is b e y o n d y o u r c o n t r o l. If y o u a r e a p r o gr a m m e r w h o w r it e s C / C ++ c o d e , t h e n a s a p r o gr a m m e r, y o u d o n ’t h a v e t o w o r r y a s t h e c o m p ile r t a k e s c a r e o f t h e c a llin g c o n v e n t io n fo r y o u . T h e c o m p ile r ge n e r a lly t a k e s t h e d e fa u lt c o d e c o n v e n t io n a u t o m a t ic a lly b a s e d o n t h e la n gu a ge . In t h is c h a p t e r, w e w ill u n d e r s t a n d t h e d iﬀ e r e n c e in c o d e c a llin g c o n v e n t io n s . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Un d e r s t a n d t h e t y p e s o f c a llin g c o n v e n t io n s C o n c e p t b e h in d d iﬀ e r e n t c a llin g c o n v e n t io n s O b je c t iv e A f t e r s t u d y in g t h is c h a p t e r, y o u w ill b e a b le t o d iﬀ e r e n t ia t e b e t w e e n d iﬀ e r e n t a s s e m b ly c o d e s w it h r e s p e c t t o t h e c a llin g c o n v e n t io n . If in c a s e y o u r e c e iv e s o m e a s s e m b ly c o d e t h e n , b y go in g o v e r t h e a s s e m b ly lis t in g, y o u w ill b e a b le t o e v a lu a t e t h e c a llin g c o n v e n t io n u s e d . To u n d e r s t a n d t h e d iﬀ e r e n t c o d e c a llin g c o n v e n t io n s , w e w ill t a k e u p a p s e u d o c o d e t o r u n o v e r t h e c o n c e p t b e h in d e a c h c a llin g c o n v e n t io n in d e t a il. Un d e r s t a n d t y p e s o f c a llin g c o n v e n t io n s To u n d e r s t a n d c a llin g c o n v e n t io n s , le t ’s t a k e a b a s ic p s e u d o c o d e . In t h is c o d e , fu n c t io n fu n c A c a lls a n o t h e r fu n c t io n In t h is c a s e , fu n c A is c a lle d t h e c a lle r a n d fu n c B is c a lle d t h e F u n c A ( ) { A r g1 ; A r g2 ; F u n c B ( A r g1 , A r g2 ) ; } N o w w h e n F u n c B is c a lle d , it is c a lle d w it h 2 a r gu m e n t s Wh e n t h is c o d e is c o m p ile d w it h d iﬀ e r e n t c o m p ile r s , it w ill ge n e r a t e d iﬀ e r e n t a s s e m b ly c o d e s . C a llin g c o n v e n t io n is t h is s e t o f r u le s t h a t s p e c if y h o w C o r C ++ fu n c t io n s a r e c o n v e r t e d in t o a n a s s e m b ly c o d e . S o , c a llin g c o n v e n t io n b a s ic a lly d e ﬁ n e s : H o w a r gu m e n t s a r e p a s s e d t o t h e fu n c t io n H o w fu n c t io n s r e t u r n v a lu e s H o w t h e c a lle r c a lls t h e c a lle e H o w s t a c k is m a n a ge d w h e n o n e fu n c t io n c a lls a n o t h e r H o w s t a c k is c le a r e d A ll t h e s e a r e d e ﬁ n e d b y t h e c a llin g c o n v e n t io n m e t h o d t h e c o m p ile r u s e s . In C / C ++ la n gu a ge , t h e r e a r e t h r e e t y p e s o f c a llin g c o n v e n t io n s m a jo r ly u s e d : a n d W e w ill w a lk t h r o u gh a ll t h e s e c a llin g c o n v e n t io n s o n e b y o n e . C D E C L C D E C L c a n a ls o b e r e a d a s C D e c la r a t io n . Wh e n C D E C L c a llin g c o n v e n t io n is u s e d : A r gu m e n t s a r e p a s s e d fr o m t h e r igh t t o le f t o r d e r. In t h e s a m e p s e u d o c o d e , r igh t t o le f t o r d e r m e a n s A r g2 is ﬁ r s t p u s h e d o n t h e s t a c k a n d t h e n A r g1 is p u s h e d o n t h e s t a c k . F u n c A ( ) { A r g1 ; A r g2 ; F u n c B ( A r g1 , A r g2 ) ; } T h e fu n c t io n r e t u r n v a lu e is p a s s e d in t o t h e E A X r e gis t e r. C a llin g fu n c t io n , t h e c a lle r c le a n s t h e s t a c k . S T D C A L L S T D C A L L s t a n d s fo r S t a n d a r d C a ll. T h is c a llin g c o n v e n t io n is d e ﬁ n e d b y M ic r o s o f t a s a s t a n d a r d c a llin g c o n v e n t io n fo r Win 3 2 A P I. Wh e n S T D C A L L is u s e d : T h e ﬁ r s t p o in t is t h e s a m e a s C D E C L . A r gu m e n t s a r e p a s s e d fr o m t h e r igh t t o le f t o r d e r. T h e fu n c t io n r e t u r n v a lu e is p a s s e d in t o t h e E A X r e gis t e r. T h is p o in t is a ls o t h e s a m e a s C D E C L . T h is p o in t d iﬀ e r s fr o m C D E C L w h e r e c a lle d fu n c t io n , c a lle e c le a n s t h e s t a c k . F A S T C A L L T h e m a in d iﬀ e r e n c e b e t w e e n C D E C L / S T D C A L L a n d F A S T C A L L is t h a t t h e in it ia l a r gu m e n t s a r e n o t p u s h e d o n s t a c k b u t r a t h e r p a s s e d in t h e r e gis t e r s . K e e p in g d a t a in r e gis t e r s is fa s t e r t h a n in m e m o r y, h e n c e it is n a m e d F A S T C A L L . In F A S T C A L L , w h e n t h e c a llin g c o n v e n t io n is u s e d : T h e ﬁ r s t t w o o r t h r e e p a r a m e t e r s a r e p a s s e d in t h e r e gis t e r s E D X , E C X , o r E A X . A d d it io n a l p a r a m e t e r s a r e p a s s e d o n t o t h e s t a c k . A r gu m e n t s a r e p a s s e d fr o m t h e r igh t t o le f t o r d e r. T h e fu n c t io n r e t u r n v a lu e is p a s s e d in t o t h e E A X r e gis t e r. C a llin g fu n c t io n , t h e c a lle r c le a n s t h e s t a c k if n e e d e d . C o n c e p t b e h in d d iﬀ e r e n t c a llin g c o n v e n t io n s N o w t o u n d e r s t a n d t h e c o n c e p t b e h in d d iﬀ e r e n t c a llin g c o n v e n t io n s , w e w ill w r it e a s im p le c o d e in C / C ++. T h e n u s in g c l.e x e ( V S c o m p ile r ) , w e w ill c o m p ile t h e c o d e w it h d iﬀ e r e n t c a llin g c o n v e n t io n s a n d u n d e r s t a n d t h e d iﬀ e r e n c e b e t w e e n t h e a s s e m b ly c o d e s ge n e r a t e d . T h e fo llo w in g im a ge s h o w s a s im p le C / C ++ c o d e t h a t w ill a d d n u m b e r s : F ig u r e 5 .1 : A d d N u m b e r.c p p T h e A d d N u mb e r.c p p c o d e is a s im p le c o d e o f a d d in g t w o n u m b e r s . A fe w p o in t s t o n o t ic e in t h e p r e c e d in g p r o gr a m a r e a s fo llo w s : T h e ma in fu n c t io n is t h e e n t r y p o in t o f t h e p r o gr a m . T h e ma in fu n c t io n is c a llin g a n a d d it io n fu n c t io n . S o , t h e ma in fu n c t io n is t h e c a lle r a n d t h e a d d it io n fu n c t io n is t h e c a lle e . T h e lo c a l v a r ia b le d e ﬁ n e d in t h e ma in fu n c t io n a n d t h e a d d it io n fu n c t io n a r e o f t y p e in t e ge r. Tw o p a r a m e t e r s a r e p a s s e d t o t h e c a lle e , w h ic h a r e 4 a n d 5 . A f t e r w r it in g t h e c o d e , w e w ill c o m p ile t h e c o d e w it h c l.e x e a n d u s e d iﬀ e r e n t s w it c h e s t h a t w ill fo r c e t h e c o m p ile r t o c h a n ge t h e c a llin g c o n v e n t io n . Us e t h is s w it c h fo r t h e C D C E L c a llin g c o n v e n t io n . Us e t h is s w it c h fo r t h e S T D C A L L c a llin g c o n v e n t io n . Us e t h is s w it c h fo r t h e F A S T C A L L c a llin g c o n v e n t io n . W e w ill t a k e u p e a c h c a llin g c o n v e n t io n o n e b y o n e a n d u n d e r s t a n d h o w t h e y d iﬀ e r fr o m e a c h o t h e r. C D E C L W e w ill c o m p ile t h e A d d N u mb e r.c p p c o d e w it h n o o p t im iz a t io n a n d w it h C D E C L c a llin g c o n v e n t io n . W e w ill u s e t h e / G d s w it c h fo r t h is . R u n t h e c o m m a n d s giv e n b e lo w o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s . Us e t h is s w it c h fo r t h e C D C E L c a llin g c o n v e n t io n . N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 5 .2 : C D E C L T h is w ill ge n e r a t e N o w w e w ill m o v e o n t o a n a ly z e t h e a s s e m b ly c o d e ge n e r a t e d in O u r C ++ c o d e is d iv id e d in t o t w o fu n c t io n s , o n e is t h e ma in fu n c t io n ( c a lle r ) a n d o t h e r is t h e a d d it io n fu n c t io n To u n d e r s t a n d C D E C L c a llin g c o n v e n t io n , w e w ill t a k e u p t h e ma in fu n c t io n c o d e c o n v e r s a t io n fr o m t h e C ++ c o d e t o a s s e m b ly. F ig u r e 5 .3 : M a in fu n c t io n c o d e in A d d N u m b e r.c p p T h e a s s e m b ly c o d e o f t h e m a in fu n c t io n b e c o m e s : F ig u r e 5 .4 : M a in p r o c a s s e m b ly c o d e in A d d N u m b e r -C D E C L .a s m L e t ’s a n a ly z e t h e a s s e m b ly c o d e o f t h e m a in fu n c t io n in a s m ﬁ le : L in e 2 0 -2 1 is fu n c t io n p r o lo n g. T h e s e a r e a s e q u e n c e o f in s t r u c t io n s t o s t a r t a fu n c t io n . In lin e 2 2 , t h e o b je c t iv e o f P US H E C X a f t e r t h e fu n c t io n p r o lo gu e is n o t t o s a v e E C X o n s t a c k b u t t o a llo c a t e 4 b y t e s o n t h e s t a c k fo r s t o r in g lo c a l v a r ia b le s , w h ic h is A d d v a r ia b le c a n b e a c c e s s e d w it h t h e h e lp o f t h e _a d d $ m a c r o , w h ic h is e q u a l t o -4 . S o , A d d c a n b e a c c e s s e d a t - Fr o m lin e 2 4 , w e w ill u n d e r s t a n d t h e c o n c e p t o f C D E C L . L e t ’s r e c a ll t h e C D C E L c a llin g c o n v e n t io n p o in t s o n e b y o n e t o u n d e r s t a n d t h e c o n c e p t p r a c t ic a lly : A r gu m e n t s a r e p a s s e d fr o m t h e r igh t t o le f t o r d e r. A t lin e 1 2 o f A d d N u mb e r.c p p , w h ic h is in t w e a r e p a s s in g 4 ,5 p a r a m e t e r s t o t h e a d d it io n fu n c t io n . N o w , fr o m r igh t t o le f t m e a n s 5 w ill b e p u s h e d o n t h e s t a c k ﬁ r s t a n d t h e n 4 w ill b e p u s h e d o n t h e s t a c k , a s d o n e in A d d N u mb e r -C D E C L .a s m c o d e a t lin e 2 4 -2 5 . A f t e r t h e p a r a m e t e r s a r e p u s h e d o n t h e s t a c k , t h e a d d it io n fu n c t io n is c a lle d a t lin e 2 6 o f C a llin g c a lle r c le a n s t h e s t a c k . A f t e r r e t u r n in g fr o m t h e a d d it io n fu n c t io n , a t lin e 2 7 o f A d d N u mb e r -C D E C L .a s m in s t r u c t io n a d d e s p , 8 s h r in k s t h e s t a c k b y 8 . T h is is b e c a u s e t h e c a lle r ( w h ic h is ma in in o u r c a s e ) c le a n s u p t h e s t a c k a s p e r C D E C L's c a llin g c o n v e n t io n . T h e fu n c t io n r e t u r n v a lu e s a r e p a s s e d in t o t h e E A X r e gis t e r. T h e c a ll t o a d d it io n fu n c t io n a t lin e 2 6 o f A d d N u mb e r -C D E C L .a s m r e t u r n s t h e a d d it io n fu n c t io n r e t u r n v a lu e t o t h e E A X r e gis t e r, w h ic h is t h e n c o p ie d t o a d d t h e v a r ia b le lo c a t io n , – T h is c o p y o p e r a t io n is d o n e b y t h e in s t r u c t io n a t lin e 2 8 o f mo v D W O R D P T R _a d d $[e b p ], e a x S im ila r ly, t h e ma in fu n c t io n r e t u r n s 0 , w h ic h is a c h ie v e d b y x o r e a x , e a x in s t r u c t io n . If y o u a r e n o t a b le t o u n d e r s t a n d a n y in s t r u c t io n , p le a s e r e fe r t o C h a p t e r 4 , W a lk T h r o u g h O n A s s e m b ly S T D C A L L W e w ill c o m p ile t h e c o d e w it h n o o p t im iz a t io n a n d w it h S T D C A L L c a llin g c o n v e n t io n . W e w ill u s e t h e / G z s w it c h f o r t h is . R u n t h e c o m m a n d s giv e n b e lo w o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t f o r c l.e x e ( V S c o m p ile r ) a n d t h e n c o m p ile t h e c o d e w it h t h e f o llo w in g s w it c h e s : Us e t h is s w it c h f o r t h e S T D C A L L c a llin g c o n v e n t io n . N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e f o llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 5 .5 : S T D C A L L T h is w ill ge n e r a t e N o w w e w ill m o v e o n t o a n a ly z e t h e a s s e m b ly c o d e in To u n d e r s t a n d t h e S T D C A L L c a llin g c o n v e n t io n , w e w ill a ga in t a k e u p t h e ma in f u n c t io n c o d e a lo n g w it h t h e a d d it io n f u n c t io n c o d e t o t h e s e e c o n v e r s a t io n f r o m t h e C ++ c o d e t o a s s e m b ly. F ig u r e 5 .6: M a in & a d d it io n fu n c t io n c o d e in A d d N u m b e r.c p p In t h e S T D C A L L c a llin g c o n v e n t io n , t h e a s s e m b ly c o d e o f t h e ma in f u n c t io n a n d t h e a d d it io n f u n c t io n b e c o m e s : F ig u r e 5 .7 : M a in & a d d it io n p r o c a s s e m b ly c o d e in A d d N u m b e r - S T D C A L L .a s m L e t ’s a n a ly z e t h e a s s e m b ly c o d e w it h r e s p e c t t o S T D C A L L . M o s t o f t h e p o in t s w ill b e t h e s a m e a s t h a t o f C D C E L c a llin g c o n v e n t io n . W e w ill d is c u s s t h e f e w d iﬀ e r e n c e s h e r e : In A S M c o d e lin e 2 0 - 2 1 is f u n c t io n p r o lo n g. T h e s e a r e a s e q u e n c e o f in s t r u c t io n s t o s t a r t a f u n c t io n . In A S M c o d e lin e 2 2 , t h e o b je c t iv e o f P US H E C X a f t e r t h e f u n c t io n p r o lo gu e , is n o t t o s a v e E C X o n s t a c k b u t t o a llo c a t e 4 b y t e s o n t h e s t a c k f o r s t o r in g lo c a l v a r ia b le , w h ic h is A d d v a r ia b le c a n b e a c c e s s e d w it h t h e h e lp o f t h e _a d d $ w h ic h is e q u a l t o - 4 . S o A d d v a r ia b le c a n b e a c c e s s e d a t – F r o m lin e 2 4 w e w ill u n d e r s t a n d t h e c o n c e p t o f S T D C A L L . L e t ’s r e c a ll S T D C A L L p o in t s o n e b y o n e : A r gu m e n t s a r e p a s s e d in f r o m t h e r igh t t o le f t o r d e r, w h ic h is s a m e a s C D C E L A t lin e 1 2 o f A d d N u mb e r.c p p , w h ic h is in t w e a r e p a s s in g 4 ,5 p a r a m e t e r s t o t h e a d d it io n f u n c t io n . N o w f r o m r igh t t o f e f t m e a n s 5 w ill b e p u s h e d o n t h e s t a c k ﬁ r s t a n d t h e n 4 w ill b e p u s h e d o n t h e s t a c k . T h is c a n b e s e e n a t lin e 2 6 o f A d d N u mb e r - S T D C A L L .a s m b y P US H 5 & P US H 4 in s t r u c t io n s b e f o r e t h e a d d it io n f u n c t io n is c a lle d . C a lle d f u n c t io n , c a lle e c le a n s t h e s t a c k . T h is p o in t d iﬀ e r s f r o m t h a t in C D C E L . T h is c a n b e s e e n a t lin e 4 7 o f b y t h e R E T 8 in s t r u c t io n . T h e c a lle e c le a n s u p t h e s t a c k b y u s in g t h e R E T n B y t e s in s t r u c t io n , w h e r e t h e R E T in s t r u c t io n t r a n s f e r s c o n t r o l f r o m t h e c a lle e t o t h e c a lle r t o t h e r e t u r n a d d r e s s s a v e d o n t h e s t a c k . w h ic h in o u r c a s e , is 8 . S o , 8 b y t e s a r e r e le a s e d o n t h e s t a c k t o c le a n u p t h e s t a c k . T h e f u n c t io n r e t u r n v a lu e s a r e p a s s e d in t o t h e E A X r e gis t e r. T h e c a ll t o a d d it io n f u n c t io n a t lin e 2 6 o f A d d N u mb e r - S T D C A L L .a s m r e t u r n s t h e a d d it io n f u n c t io n r e t u r n v a lu e t o t h e E A X r e gis t e r, w h ic h is t h e n c o p ie d t o a d d t h e v a r ia b le lo c a t io n , – T h is c o p y o p e r a t io n is d o n e b y t h e f o llo w in g in s t r u c t io n : mo v D W O R D P T R _a d d $[e b p ], e a x a t lin e 2 7 o f A d d N u mb e r - S T D C A L L .a s m S im ila r ly, t h e ma in f u n c t io n r e t u r n s 0 , w h ic h is a c h ie v e d b y x o r e a x , e a x in s t r u c t io n . F A S T C A L L A s w e r e a d p r e v io u s ly, t h e F A S T C A L L c a llin g c o n v e n t io n d iﬀ e r s m a jo r ly in p a s s in g a r gu m e n t s . To u n d e r s t a n d t h is , w e w ill c o m p ile t h e c o d e w it h t h e o p t im iz a t io n o ﬀ a n d w it h t h e F A S T C A L L s w it c h . W e w ill u s e t h e / G r s w it c h f o r t h is . R u n t h e c o m m a n d s giv e n b e lo w o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t f o r c l.e x e ( V S c o m p ile r ) a n d t h e n c o m p ile t h e c o d e w it h t h e f o llo w in g s w it c h e s : Us e t h is s w it c h f o r t h e F A S T C A L L c a llin g c o n v e n t io n . N a m e o f o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e f o llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 5 .8: F A S T C A L L T h is w ill ge n e r a t e To a n a ly z e t h e a s s e m b ly c o d e in w e w ill o n c e a ga in s e e o u r C / C ++ c o d e . F ig u r e 5 .9: M a in & a d d it io n fu n c t io n c o d e in A d d N u m b e r.c p p L e t ’s s e e A d d N u mb e r - F A S T C A L L .a s m ge n e r a t e d a s f o llo w s : F ig u r e 5 .1 0 : M a in & a d d it io n p r o c a s s e m b ly c o d e in A d d N u m b e r - F A S T C A L L .a s m L e t ’s a n a ly z e t h e a s s e m b ly c o d e in t h e s a m e o r d e r w e d id f o r t h e o t h e r c a llin g c o n v e n t io n s . T h e f u n c t io n p r o lo n g in s t r u c t io n o n lin e 2 0 - 2 1 is a s e q u e n c e o f in s t r u c t io n s t o s t a r t a f u n c t io n . In A S M c o d e lin e 2 2 , P US H E C X is t h e s a m e . It is n o t t o s a v e E C X o n s t a c k b u t t o a llo c a t e 4 b y t e s o n t h e s t a c k f o r s t o r in g t h e lo c a l v a r ia b le , w h ic h is T h e a d d v a r ia b le c a n b e a c c e s s e d w it h t h e h e lp o f t h e _a d d $ w h ic h is e q u a l t o - 4 . S o , a d d c a n b e a c c e s s e d a t – F r o m lin e 2 4 , w e w ill s e e a d iﬀ e r e n t a p p r o a c h t o p a s s a r gu m e n t s t o f u n c t io n . To u n d e r s t a n d , le t ’s r e c a ll t h e F A S T C A L L c o n c e p t : In it ia l a r gu m e n t s a r e n o t p u s h e d o n s t a c k b u t r a t h e r p a s s e d in t h e r e gis t e r s . T h e ﬁ r s t t w o o r t h r e e a r gu m e n t s a r e p a s s e d in t h e r e gis t e r s E D X , E C X , o r E A X . A d d it io n a l a r gu m e n t s a r e p a s s e d o n t o t h e s t a c k . A r gu m e n t s a r e p a s s e d f r o m t h e r igh t t o le f t o r d e r. B y n o w , w e a r e c le a r w it h t h e r igh t t o le f t a p p r o a c h . T h e p o in t t o n o t e h e r e is t h a t a r gu m e n t 5 is m o v e d t o E D X a n d a r gu m e n t 4 is m o v e d t o E C X , a s d o n e a t lin e 2 4 - 2 5 o f O n c e t h e a r gu m e n t s a r e m o v e d t o r e gis t e r s , t h e c a ll t o a d d it io n f u n c t io n is m a d e a t lin e 2 6 o f D u r in g t h e a d d it io n f u n c t io n e x e c u t io n , w e c a n s e e t h a t t h e a r gu m e n t s in E D X , E C X a r e p a s s e d t o t h e s t a c k f o r f u r t h e r p r o c e s s in g b e t w e e n lin e s 4 5 - 4 9 o f C a llin g f u n c t io n , c a lle r c le a n s t h e s t a c k . A r gu m e n t s a r e p a s s e d t o E D X , E C X s o n o a r gu m e n t s a r e p a s s e d t o s t a c k , n o s t a c k c le a n u p is n e e d e d . F u n c t io n r e t u r n v a lu e s a r e p a s s e d in t o E A X r e gis t e r t h is is s a m e a s o t h e r 2 c a llin g c o n v e n t io n w e d is c u s s e d . R e s t a t in g s a m e p o in t a b o u t F A S T C A L L . C a ll t o a d d it io n f u n c t io n a t lin e 2 6 o f A d d N u mb e r - F A S T C A L L .a s m r e t u r n s t h e a d d it io n f u n c t io n r e t u r n v a lu e t o E A X r e gis t e r, w h ic h t h e n is c o p ie d t o a d d v a r ia b le lo c a t io n , – T h is c o p y o p e r a t io n is d o n e b y t h is in s t r u c t io n : mo v D W O R D P T R _a d d $[e b p ], e a x a t lin e 2 7 o f A d d N u mb e r - F A S T C A L L .a s m S im ila r ly, t h e ma in f u n c t io n r e t u r n s 0 , w h ic h is a c h ie v e d b y x o r e a x , e a x in s t r u c t io n a t lin e 2 9 o f C o n c lu s io n In t h is c h a p t e r, w e c o v e r e d t h r e e t y p e s o f c o d e c a llin g c o n v e n t io n s m a jo r ly u s e d : C D C E L , S T D C A L L , a n d F A S T C A L L . W e le a r n e d t h a t in C D C E L a n d S T D C A L L , a r gu m e n t s a r e p a s s e d fr o m t h e r igh t t o le f t o r d e r a n d t h e fu n c t io n r e t u r n v a lu e is p a s s e d in t o t h e E A X r e gis t e r. In t h e C D C E L c a llin g fu n c t io n , t h e c a lle r c le a n s t h e s t a c k a n d in S T D C A L L , c a lle e c le a n s t h e s t a c k . In F A S T C A L L , t h e in it ia l a r gu m e n t s a r e n o t p u s h e d o n t h e s t a c k b u t r a t h e r p a s s e d in t h e r e gis t e r s . T h e r e s t fu n c t io n r e t u r n v a lu e is p a s s e d in t o t h e E A X r e gis t e r a n d in c a llin g fu n c t io n , t h e c a lle r c le a n s t h e s t a c k if n e e d e d . In t h e n e x t c h a p t e r, w e w ill t a k e C / C ++ c o d e s a n d c o m p ile t h e m t o u n d e r s t a n d a s s e m b ly o u t p u t . C H A P T E R 6 R e v e r s e E n gin e e r in g P a t t e r n o f B a s ic C o d e In t h is c h a p t e r, w e w ill w r it e s m a ll p ie c e s o f c o d e a n d c o m p ile t h e m t o u n d e r s t a n d a s s e m b ly o u t p u t . W e w ill w a lk t h r o u gh s t e p - b y -s t e p in s t r u c t io n s in t h e a s s e m b ly c o d e a n d u n d e r s t a n d c o d e ﬂ o w fr o m t h e a s s e m b ly p o in t o f v ie w . T h r o u gh o u t t h is c h a p t e r o f c o m p ilin g s m a ll p ie c e s o f c o d e , w e w ill u s e M ic r o s o f t c o m p ile r o n t h e 3 2 -b it e n v ir o n m e n t . A ll t h e p r o gr a m s a r e c o m p ile d o n M ic r o s o f t Win d o w s 3 2 -b it e n v ir o n m e n t . W e w ill a ls o u s e c o d e o p t im iz a t io n d u r in g o u r a n a ly s is . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Wh a t is c o d e o p t im iz a t io n Un d e r s t a n d in g a s s e m b ly p a t t e r n o f t h e C / C ++ p r o gr a m C o n c e p t o f c o d e o p t im iz a t io n To o ls u s e d t o ge n e r a t e t h e a s s e m b ly p a t t e r n o f C / C ++ p r o gr a m O b je c t iv e A f t e r s t u d y in g t h is c h a p t e r, y o u s h o u ld b e a b le t o : Un d e r s t a n d c o d e o p t im iz a t io n a n d it s im p o r t a n c e A s s e m b ly c o d e w it h a n d w it h o u t o p t im iz a t io n Wh a t is C o d e O p t imiz a t io n ? O p t im iz a t io n m e a n s d o in g s o m e t h in g a t it s b e s t in o r d e r t o e ﬀ e c t iv e ly u t iliz e r e s o u r c e s . C o d e o p t im iz a t io n m e a n s t o t r a n s fo r m t h e c o d e t o r e m o v e u n n e c e s s a r y lin e s , s o a s t o c o n s u m e fe w e r r e s o u r c e s ( M e m o r y, C P U a n d o t h e r s ) d u r in g e x e c u t io n . Wh e n c o d e is o p t im iz e d b y c o m p ile r s , t h e fo llo w in g t h in gs a r e t a k e n c a r e o f: T h e m e a n in g o f t h e c o d e s h o u ld n o t b e c h a n ge d w h ile o p t im iz in g t h e c o d e . A n o p t im iz e d c o d e s h o u ld c o n s u m e fe w e r r e s o u r c e s . O p t im iz a t io n s h o u ld n o t im p a c t t h e c o m p ilin g t im e o f t h e p r o gr a m . L e t ’s b e gin w it h a s m a ll C / C ++ p r o gr a m a n d gr a d u a lly m o v e t o c o m p le x p r o gr a m s . T h is p r o c e s s w ill h e lp y o u u n d e r s t a n d t h e p a t t e r n o f c o d e in a s s e m b ly la n gu a ge w it h r e s p e c t t o C / C ++ a p p lic a t io n s . E mp t y fu n c t io n A n e m p t y fu n c t io n is s o m e t h in g t h a t d o e s n o t h in g. L e t ’s c r e a t e a n e m p t y fu n c t io n in C / C ++ c o d e . H e r e , w e a r e d e ﬁ n in g a n d d e c la r in g a n e m p t y fu n c t io n a s F ig u r e 6.1 : E m p t y F u n c t io n .c p p E mp t y F u n c t io n w it h o u t O p t imiz a t io n N o w , le t ’s c o m p ile it w it h o u t o p t im iz a t io n u s in g t h e M S V C c o m p ile r R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 6.2 : E m p t y F u n c t io n w it h o u t O p t im iz a t io n T h e a s s e m b ly c o d e ge n e r a t e d w it h o u t o p t im iz a t io n is a s fo llo w s : F ig u r e 6.3 : E m p t y F u n c t io n .a s m W e w ill w a lk t h r o u gh t h e a s s e m b ly c o d e lin e b y lin e t o u n d e r s t a n d t h e m e a n in g a n d w o r k in g o f t h e c o d e p a t t e r n . L in e 1 s a y s : ▼L in e 1 ; L is t in g ge n e r a t e d b y M ic r o s o f t ( R ) O p t im iz in g C o m p ile r V e r s io n 1 6 .0 0 .3 0 3 1 9 .0 1 T h is is a c o m m e n t a s it s t a r t s w it h a s e m ic o lo n . T h is c o m m e n t s t a t e s t h e c o m p ile r t h a t w e a r e u s in g t o ge n e r a t e t h e a s s e m b ly c o d e , M ic r o s o f t ( R ) 3 2 -b it C / C ++ O p t im iz in g C o m p ile r V e r s io n 1 6 .0 0 .3 0 3 1 9 .0 1 fo r 8 0 x 8 6 . T h e c o m p ile r b a s ic a lly t r a n s la t e s t h e p r o gr a m fr o m o n e la n gu a ge t o a n o t h e r. B u t w h e n w e t a lk a b o u t o p t im iz in g c o m p ile r, it im p r o v e s t h e c o d e t o r u n fa s t e r. ▼L in e 3 T ITL E C :\\ Jit e n d e r N \\ R E B o o k \\ E mp t y F u n c t io n \\ E m p t y F u n c t io n \\ E m p t y F u n c t io n .c p p T it le d e ﬁ n e s t h e n a m e o f t h e a b s o lu t e p a t h o f t h e C / C ++ p r o gr a m . ▼L in e 4 .6 8 6 P T h is e n a b le s a ll t h e in s t r u c t io n s fo r t h e P e n t iu m P r o p r o c e s s o r ( 3 2 -b it M A S M o n ly ) . ▼L in e 5 .X M M T h is m e a n s t h a t t h e p r o gr a m r e q u ir e s a C P U w it h t h e S t r e a m in g S IM D E x t e n s io n s in s t r u c t io n s e t . ▼L in e 6 in c lu d e lis t in g.in c T h is lis t in g .in c ﬁ le c o n t a in s t h e a s s e m b le r m a c r o s . M a c r o s a r e u s e d in a s s e m b ly la n gu a ge fo r m o d u la r p r o gr a m m in g. V is u a l C ++ d o e s n o t e m b e d t h e m a c r o c o d e in t h e a s s e m b ly c o d e t o im p r o v e p e r fo r m a n c e a n d a lign t h e c o d e . Yo u c a n ﬁ n d t h is ﬁ le in t h e V is u a l C ++ in c lu d e fo ld e r. F ig u r e 6.4 : lis t in g .in c p a t h ▼L in e 7 .m o d e l ﬂ a t T h is is d ir e c t iv e fo r e n a b lin g t h e ﬂ a t m e m o r y m o d e l. To u n d e r s t a n d m e m o r y m o d e ls , w e h a v e t o u n d e r s t a n d t h a t m e m o r y is a c c e s s e d u s in g 3 m e m o r y m o d e ls : T h is is a n o n -s e gm e n t e d m e m o r y m o d e l w h e r e t h e w h o le m e m o r y a p p e a r s t o a p r o gr a m a s o n e m a s s iv e a r r a y o f b y t e s . C o d e , d a t a , a n d s t a c k a ll r e s id e in t h e s a m e a d d r e s s s p a c e . In t h is m o d e l, m e m o r y is d iv id e d in t o gr o u p s o f s p a c e s c a lle d s e gm e n t s . T h e r e a l a d d r e s s m e m o r y m o d e l is a v e r y o ld m e m o r y m o d e l u s e d in t h e In t e l 8 0 8 6 p r o c e s s o r. ▼L in e 9 -1 0 IN C L UD E L IB L IB C M T IN C L UD E L IB O L D N A M E S Wit h IN C L UD E L IB d e r iv a t iv e , w e lin k L IB C M T.L IB a n d O L D N A M E S .L IB lib r a r ie s lo c a t e d in t h e fo llo w in g p a t h : F ig u r e 6.5 : L ib r a r ie s p a t h ▼L in e 1 2 P UB L IC _m a in P UB L IC is t h e d e r iv a t iv e w h ic h m a k e s t h e p r o c e d u r e p u b lic . A d e r iv a t iv e is a n in s t r u c t io n w h ic h is u s e d b y t h e a s s e m b le r t o a u t o m a t e t h e a s s e m b ly p r o c e s s ; it a ls o h e lp s im p r o v e t h e c o d e r e a d a b ilit y. a ll fu n c t io n s b e gin w it h a n u n d e r s c o r e . ma in fu n c t io n is la b e le d a s a p u b lic fu n c t io n , w h ic h m e a n s it c a n b e a c c e s s e d b y o t h e r m o d u le s . ▼L in e 1 3 ; F u n c t io n c o m p ile ﬂ a gs : / O d t p A ll t h e c o m m e n t s b e gin w it h s e m ic o lo n s . T h is lin e s t a t e s t h a t t h e c o d e is c o m p ile d w it h t h e / O d t p s w it c h . ▼L in e 1 4 _TEX T S E G M E N T T h is is t h e s t a r t o f t h e t e x t s e gm e n t o r, w e c a n s a y, t h e c o d e s e gm e n t . ▼L in e 1 5 _m a in P R O C P r o c e d u r e s a r e d e ﬁ n e d w it h t h e P R O C s t a t e m e n t a n d t h e y m u s t b e c lo s e d b y t h e E N D P s t a t e m e n t . W e c a n s e e _ma in E N D P o n lin e 2 5 . ▼ L in e 1 6 ; F ile c :\\ jit e n d e r n \\ r e b o o k \\ e m p t y fu n c t io n \\ e m p t y fu n c t io n \\ e m p t y fu n c t io n .c p p T h is is a c o m m e n t s t a t in g t h e ﬁ le p a t h o f t h e C / C ++ s o u r c e c o d e . ▼L in e 1 7 ; L in e 9 T h is is a c o m m e n t w h ic h s t a t e s t h a t lin e n u m b e r 9 o f t h e C / C ++ s o u r c e c o d e ﬁ le is m a p p e d w it h t h e in s t r u c t io n fo llo w in g t h is c o m m e n t . ▼L in e 1 8 -1 9 p u s h e b p m o v e b p , e s p T h is is fu n c t io n p r o lo gu e , w h ic h is t h e s e q u e n c e o f in s t r u c t io n s a t t h e s t a r t o f a fu n c t io n . ▼L in e 2 0 -2 1 ; L in e 1 0 x o r e a x , e a x X O R is a n e x c lu s iv e O R . T h e E A X r e gis t e r is u s e d fo r s t o r in g t h e r e t u r n v a lu e o f t h e fu n c t io n . T h e ma in fu n c t io n is r e t u r n in g 0 in t h e C / C ++ c o d e , s o X O R E A X w it h E A X w ill s e t t h e E A X r e gis t e r t o z e r o . A ls o , c o m p ile r s c a n u s e M O V E A X , 0 in p la c e o f X O R E A X , E A X . B u t X O R is p r e fe r r e d o v e r M O V a s X O R o c c u p ie s 2 - b y t e o p c o d e a n d a n M O V in s t r u c t io n o c c u p ie s 5 b y t e s . ▼L in e 2 2 ; L in e 1 1 T h is c o m m e n t s t a t e s t h a t lin e n u m b e r 1 2 o f t h e C / C ++ s o u r c e c o d e ﬁ le is m a p p e d w it h t h e in s t r u c t io n fo llo w in g t h is c o m m e n t . ▼L in e 2 3 p o p e b p P O P E B P is a fu n c t io n e p ilo gu e , w h ic h is t h e s e q u e n c e o f in s t r u c t io n s t o e n d a fu n c t io n . ▼L in e 2 4 r e t 0 R E T is t h e r e t u r n in s t r u c t io n . It r e t u r n s t h e in s t r u c t io n p o in t e r t o t h e c a lle r p r o c e d u r e . T h e s y n t a x o f t h e R E T in s t r u c t io n is : R E T n B y t e s T h e r e t u r n in s t r u c t io n h a s a n o p t io n a l n B y t e s o p e r a n d t h a t s p e c iﬁ e s t h e n u m b e r o f b y t e s t o b e a d d e d t o t h e v a lu e o f t h e E S P r e gis t e r a f t e r t h e r e t u r n . ▼L in e 2 5 -2 6 _m a in E N D P _TEX T E N D S T h is is t h e c lo s e o f t h e ma in p r o c e d u r e a n d t h e e n d o f t h e t e x t s e gm e n t o r c o d e s e gm e n t . ▼L in e 2 7 P UB L IC ? E m p t y F u n c t io n @@Y A X X Z      ; E m p t y F u n c t io n In t e r n a lly, fu n c t io n s a r e r e p r e s e n t e d b y t h e ir d e c o r a t e d n a m e s , w h ic h a r e e n c o d e d s t r in g c r e a t e d d u r in g t h e c o m p ila t io n p r o c e s s . It a p p e n d s t h e c a llin g c o n v e n t io n , fu n c t io n r e t u r n t y p e , fu n c t io n p a r a m e t e r s , a n d o t h e r in fo r m a t io n w it h t h e fu n c t io n n a m e . T h is p r o c e s s h e lp s t h e lin k e r ﬁ n d t h e c o r r e c t fu n c t io n w h e n lin k in g a n e x e c u t a b le . T h is p r o c e s s o f n a m e d e c o r a t io n is a ls o k n o w n a s n a m e m a n glin g. L ik e m a in , E mp t y F u n c t io n is m a d e p u b lic w it h t h e h e lp o f t h e P UB L IC d e r iv a t iv e . ▼L in e 2 8 ; F u n c t io n c o m p ile ﬂ a gs : / O d t p It is t h e s a m e a s e x p la in e d p r e v io u s ly. It s t a t e s t h a t t h e c o d e is c o m p ile d w it h t h e / O d t p s w it c h . ▼L in e 2 9 _TEX T S E G M E N T T h is is t h e s t a r t o f t h e t e x t s e gm e n t o r c o d e s e gm e n t . ▼L in e 3 0 ? E m p t y F u n c t io n @@Y A X X Z P R O C     ; E m p t y F u n c t io n S t a r t in g o f E mp t y F u n c t io n p r o c e d u r e w it h P R O C s t a t e m e n t ▼L in e 3 1 ; L in e 1 5 T h is c o m m e n t s t a t e s t h a t lin e n u m b e r 1 5 o f t h e C / C ++ s o u r c e c o d e ﬁ le is m a p p e d w it h t h e in s t r u c t io n fo llo w in g t h is c o m m e n t . ▼L in e 3 2 -3 3 p u s h e b p m o v e b p , e s p T h is is a fu n c t io n p r o lo gu e fo r ▼L in e 3 4 ; L in e 1 6 T h is c o m m e n t s t a t e s t h a t lin e n u m b e r 1 7 o f t h e C / C ++ s o u r c e c o d e ﬁ le is m a p p e d w it h t h e in s t r u c t io n fo llo w in g t h is c o m m e n t . ▼L in e 3 5 p o p e b p P O P E B P is a fu n c t io n e p ilo gu e o f ▼L in e 3 6 r e t 0 A s E mp t y F u n c t io n is d o in g n o t h in g, it ’s ju s t a n e m p t y / b la n k fu n c t io n . S o , it ’s r e t u n in g t h e in s t r u c t io n p o in t e r b a c k t o t h e c a lle r. 0 m e a n s t h a t t h e E S P w ill b e u n c h a n ge d . ▼L in e 3 7 -3 8 ? E m p t y F u n c t io n @@Y A X X Z E N D P     ; E m p t y F u n c t io n _TEX T E N D S T h is is t h e c lo s e o f t h e E mp t y F u n c t io n p r o c e d u r e a n d t h e e n d o f t h e t e x t s e gm e n t o r c o d e s e gm e n t . ▼L in e 3 9 E N D T h e E N D s t a t e m e n t e n d s t h e s o u r c e c o d e . E mp t y F u n c t io n w it h O p t imiz a t io n N o w le t ’s c o m p ile t h e c o d e w it h o p t im iz a t io n u s in g t h e / 0 x s w it c h o n t h e x 8 6 p la t fo r m . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 6.6: E m p t y F u n c t io n w it h O p t im iz a t io n T h e a s s e m b ly c o d e w e ge t is a s fo llo w s : F ig u r e 6.7 : E m p t y F u n c t io n -O p t im iz e d .a s m A s w e c a n s e e , w h e n t h e c o d e is o p t im iz e d , it t r a n s fo r m s t h e c o d e t o r e m o v e t h e u n n e c e s s a r y lin e s . D u r in g t h is o p t im iz a t io n , t h e m e a n in g o f t h e c o d e r e m a in s t h e s a m e . C o m p ile r s n o w a d a y s a r e go o d a t o p t im iz a t io n . S o a s a r e v e r s e e n gin e e r, it is a lw a y s a go o d p r a c t ic e t o u n d e r s t a n d t h e c o n c e p t o r t h e lo gic b e h in d t h e c o d e r a t h e r t h a n t h e o r igin a l c o d e . If w e c a n u n d e r s t a n d t h e lo gic t h e n w e c a n w r it e o u r p r o t o t y p e . C o m in g b a c k t o t h e c o d e , w e c a n s e e m o s t o f t h e lin e s o f t h e c o d e a r e t h e s a m e a s e x p la in e d in t h e e a r lie r s e c t io n . S o , w e w ill n o t r e s t a t e a ll o f t h e m . W e w ill t a k e u p in s t r u c t io n s t h a t a r e s p e c iﬁ c t o t h e c o d e o p t im iz a t io n . ▼L in e 1 8 x o r e a x , e a x ma in p r o c e d u r e is X O R ’in g E A X t o r e t u r n z e r o , a s t h e E A X r e gis t e r is u s e d fo r s t o r in g t h e r e t u r n v a lu e o f t h e fu n c t io n . ▼L in e 2 8 r e t 0 E mp t y F u n c t io n is r e t u r n in g t h e in s t r u c t io n p o in t e r t o t h e c a lle r w it h ju s t t h e R E T in s t r u c t io n . R e t u r n in g V a lu e In t h is s e c t io n , w e w ill c r e a t e a fu n c t io n in t h e C / C ++ c o d e t o r e t u r n a c o n s t a n t v a lu e . W e w ill d e ﬁ n e a n d d e c la r e a F ig u r e 6.8: R e t u r n in g V a lu e s .c p p R e t u r n in g V a lu e w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 6. 9: R e t u r n in g a V a lu e w it h o u t O p t im iz a t io n H e r e is w h a t w e ge t a f t e r c o m p ilin g: F ig u r e 6. 1 0 : R e t u r n in g V a lu e .a s m W e h a v e d is c u s s e d m o s t o f t h e lin e s in t h e c o d e in e a r lie r s e c t io n . S o , w e w ill fo c u s o n t h e m a in in s t r u c t io n s . ▼L in e 2 0 -2 4 ; L in e 1 0 x o r e a x , e a x ; L in e 1 1 p o p e b p r e t 0 T h is is t h e p a r t o f in s t r u c t io n s fr o m t h e ma in fu n c t io n , w h e r e w e a r e X O R ’in g E A X t o m a k e E A X e q u a l t o z e r o . O n c e t h e E A X is z e r o , w e a r e c a llin g fu n c t io n e p ilo gu e u s in g t h e P O P in s t r u c t io n . T h e R E T in s t r u c t io n r e t u r n s t h e e x e c u t io n b a c k t o t h e c a lle r, w h e r e t h e c a lle r c a n t a k e t h e r e t u r n v a lu e fr o m t h e E A X r e gis t e r. ▼L in e 3 4 -3 8 ; L in e 1 5 m o v e a x , 2 0 2 0     ; 0 0 0 0 0 7 e 4 H ; L in e 1 6 p o p e b p r e t 0 N o w , w e m o v e t o t h e R e t u r n in gV a lu e fu n c t io n , w h e r e E A X is ﬁ lle d w it h 2 0 2 0 , w h ic h is t h e r e t u r n v a lu e o f t h e R e t u r n in gV a lu e fu n c t io n . T h e P O P in s t r u c t io n is fu n c t io n e p ilo gu e a n d ﬁ n a lly, R E T p a s s e s t h e in s t r u c t io n p o in t e r b a c k t o t h e c a lle r, w h e r e t h e c a lle r w ill t a k e t h e r e s u lt fr o m t h e E A X r e gis t e r. R e t u r n in g V a lu e w it h O p t imiz a t io n C o m p ile t h e c o d e w it h o p t im iz a t io n ( w it h / 0 x s w it c h ) in t h e M S V C c o m p ile r o n t h e x 8 6 p la t fo r m . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l. e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 6.1 1 : R e t u r n in g V a lu e w it h O p t im iz a t io n A s s e m b ly c o d e ge n e r a t e d w ill b e : F ig u r e 6.1 2 : R e t u r n in g V a lu e -O p t im iz e d .a s m W e c a n o b s e r v e in t h e o p t im iz e d c o d e t h a t a ll t h e u n n e c e s s a r y c o d e lin e s a r e r e m o v e d . T h e ma in fu n c t io n s h o w s o n ly 2 in s t r u c t io n s : ▼L in e 1 8 , 2 0 x o r e a x , e a x r e t 0 E A X is X O R ’e d t o r e s e t E A X t o 0 , a n d t h e r e t u r n v a lu e is s t o r e d in E A X . T h e R E T in s t r u c t io n p a s s e s t h e in s t r u c t io n p o in t e r b a c k t o t h e c a lle r. T h e R e t u r n in gV a lu e fu n c t io n a ls o s h o w s o n ly 2 in s t r u c t io n s : ▼L in e 2 8 , 3 0 m o v e a x , 2 0 2 0     ; 0 0 0 0 0 7 e 4 H r e t 0 M O V ﬁ lls E A X w it h t h e r e t u r n v a lu e o f 2 0 2 0 a n d t h e R E T in s t r u c t io n p a s s e s t h e in s t r u c t io n p o in t e r b a c k t o t h e c a lle r. B a s ic “ H e llo , W o r ld ” P r o gr a m In t h is s im p le C / C ++ c o d e , w e a r e ju s t p r in t in g “ h e llo , w o r ld ” o n t h e c o n s o le . W e a r e p r in t in g it u s in g t h e p r in t f( ) fu n c t io n . F ig u r e 6.1 3 : H e llo W o r ld .c p p B a s ic “ H e llo , W o r ld ” P r o gr a m w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n w it h t h e M S V C c o m p ile r o n t h e x 8 6 p la t fo r m . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 6.1 4 : B a s ic “ H e llo , W o r ld ” p r o g r a m w it h o u t O p t im iz a t io n F o llo w in g is t h e ge n e r a t e d a s s e m b ly c o d e w h ic h w e s h a ll n o w a n a ly z e : F ig u r e 6.1 5 : H e llo W o r ld .a s m L e t ’s w a lk t h r o u gh t h e a s s e m b ly c o d e lin e b y lin e : ▼L in e 1 -1 0 W e h a v e a lr e a d y d is c u s s e d t h is in t h e E m p t y F u n c t io n s e c t io n . ▼L in e 1 2 -1 4 C O N S T S E G M E N T $S G 4 6 7 7 D B 'h e llo , w o r ld ', 0 a H , 0 0 H C O N S T E N D S T h e s t r in g c o n s t a n t , w h ic h in o u r c a s e is “ h e llo , w o r ld ”, is a llo c a t e d in t h e c o n s t a n t s e gm e n t . T h e C O N S T S E G M E N T d e r iv a t iv e is u s e d t o d e ﬁ n e t h e s t a r t o f t h e c o n s t a n t s e gm e n t in t h e m e m o r y. In o u r c a s e lin k e r r e n a m e d C O N S T S E G M E N T t o w h ic h c a n b e d u m p e d u s in g a n y d e b u gge r. In t h e fo llo w in g s c r e e n s h o t , y o u c a n s e e t h a t w e h a v e o p e n e d t h e E X E ﬁ le ( ge n e r a t e d a f t e r c o m p ila t io n ) in x 3 2 d b g a n d in t h is E X E ﬁ le , w e h a v e d is a b le d t h e A d d r e s s S p a c e L a y o u t R a n d o miz a t io n u s in g C F F E x p lo r e r. F o llo w t h e s t e p s m e n t io n e d in t h e A p p e n d ix t o d is a b le A S L R o n a n E X E ﬁ le . D is a b lin g A S L R o n a n E X E ﬁ le w ill h e lp u s lo a d t h e E X E ﬁ le o n t h e s a m e m e m o r y s p a c e e v e r y t im e t h e E X E ﬁ le is o p e n e d in t h e d e b u gge r : F ig u r e 6.1 6: .r d a t a $S G 4 6 7 7 is t h e in t e r n a l n a m e giv e n b y a c o m p ile r t o h a n d le t h e s t r in g c o n s t a n t . D B , D e ﬁ n e s t h e b y t e , w h ic h is t h e d a t a t y p e . 'h e llo , w o r ld ', 0 a H , 0 0 H is t h e s t r in g d a t a , w h ic h is n u ll t e r m in a t e d A S C II s t r in g. B y C O N S T t h e c o n s t a n t s e gm e n t is e n d e d . ▼L in e 1 5 P UB L IC _m a in P UB L IC is t h e d e r iv a t iv e w h ic h m a k e s t h e _ma in p r o c e d u r e p u b lic , t o b e a c c e s s e d b y o t h e r m o d u le s . ▼L in e 1 6 E X T R N _p r in t f:P R O C N o t e : A c o d e is p la c e d in t h e .c o d e s e gm e n t , a c o n s t a n t s t r in g is p la c e d in t h e C O N S T ( .r d a t a ) s e gm e n t a n d if it is n o t a c o n s t a n t , it is p la c e d in t h e .d a t a s e gm e n t . E X T R N d e r iv a t iv e d e c la r e s t h e e x t e r n fu n c t io n , w h ic h is p r in t f in o u r c a s e . A ll fu n c t io n s b e gin w it h a n u n d e r s c o r e . ▼L in e 1 8 _TEX T S E G M E N T T h is s t a r t s t h e _TEX T s e gm e n t o r c o d e s e gm e n t , w h e r e o u r ma in fu n c t io n c o d e r e s id e s . ▼L in e 1 9 _m a in P R O C T h is is t h e s t a r t o f t h e ma in p r o c e d u r e . ▼L in e 2 0 -2 3 ; F ile c :\\ jit e n d e r n \\ r e b o o k \\ h e llo w o r ld \\ h e llo w o r ld \\ h e llo w o r ld .c p p ; L in e 8 p u s h e b p m o v e b p , e s p H e r e , it ’s t h e s a m e a s w e d is c u s s e d e a r lie r t h a t a ll c o m m e n t s b e gin w it h s e m ic o lo n s . O n e c o m m e n t is s t a t in g t h e C / C ++ s o u r c e c o d e ﬁ le p a t h a n d t h e o t h e r c o m m e n t is d e ﬁ n in g t h e lin e n u m b e r in C / C ++ s o u r c e c o d e is m a p p e d w it h t h e in s t r u c t io n fo llo w in g t h is c o m m e n t . Wit h t h e ma in fu n c t io n p r o lo gu e c o d e s t a r t s . ▼L in e 2 5 -2 7 p u s h O F F S E T $S G 4 6 7 7 c a ll _p r in t f a d d e s p , 4 B e fo r e c a llin g t h e p r in t f fu n c t io n , w e p u s h t h e p o in t e r t o o u r c o n s t a n t s t r in g o n t o s t a c k w it h t h e h e lp o f t h e P US H in s t r u c t io n . T h e C A L L in s t r u c t io n is c a llin g t h e p r in t f fu n c t io n . A f t e r t h e e x e c u t io n o f t h e p r in t f fu n c t io n , t h e c o n t r o l is t r a n s fe r r e d b a c k t o t h e c a lle r, w h ic h is ma in fu n c t io n in o u r c a s e . T h r o u gh o u t t h e e x e c u t io n o f t h e p r in t f fu n c t io n , t h e p o in t e r t o t h e s t r in g w ill b e o n t h e s t a c k . S o , w h e n t h e e x e c u t io n is r e t u r n e d b a c k t o t h e ma in fu n c t io n , t h e s t a c k n e e d s t o b e c le a n e d a s w e d o n ’t n e e d t h e s t r in g p o in t e r a n y m o r e . S in c e w e a r e fo llo w in g t h e C D E C L c a llin g c o n v e n t io n , it is t h e c a lle r ’s r e s p o n s ib ilit y t o c le a n u p s t a c k , w h ic h in o u r c a s e is d o n e u s in g t h e a d d e s p , 4 in s t r u c t io n . A 3 2 -b it p r o gr a m u s e s 4 b y t e s fo r a d d r e s s in g. S o , w h e n w e a d d 4 b y t e s t o E S P, w e in c r e m e n t E S P b y 4 b y t e s t o c le a n u p t h e s t a c k a n d r e m o v e t h e c o n s t a n t s t r in g p o in t e r o n t h e s t a c k . A n e q u iv a le n t o f A D D in s t r u c t io n c a n a ls o b e P O P w h ic h is o f t e n u s e d b y o t h e r c o m p ile r s . ▼L in e 2 8 -2 9 ; L in e 1 0 x o r e a x , e a x A s ma in is r e t u r n in g 0 in C / C ++ c o d e a n d w e k n o w t h a t t h e r e t u r n v a lu e o f t h e fu n c t io n is s t o r e d in t h e E A X r e gis t e r, E A X is X O R ’e d t o r e t u r n 0 . ▼L in e 3 0 -3 2 ; L in e 1 1 p o p e b p r e t 0 It is c a llin g t h e ma in fu n c t io n e p ilo gu e c o d e a n d t h e R E T in s t r u c t io n r e t u r n s e x e c u t io n b a c k t o t h e c a lle r, w h e r e t h e c a lle r c a n t a k e t h e r e t u r n v a lu e fr o m t h e E A X r e gis t e r. ▼L in e 3 3 _m a in E N D P Wit h t h is , t h e _m a in fu n c t io n is c lo s e d . ▼L in e 3 4 -3 5 _TEX T E N D S E N D T h is is e n d in g t h e c o d e s e gm e n t a n d s o u r c e c o d e . B a s ic “ H e llo , W o r ld ” P r o gr a m w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l. e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 6.1 7 : B a s ic “ H e llo , W o r ld ” p r o g r a m w it h O p t im iz a t io n T h e ge n e r a t e a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 6.1 8: H e llo W o r ld -O p t im iz e d .a s m A ll t h e c o d e lin e s a r e t h e s a m e a s w e d is c u s s e d in p r e c e d in g s e c t io n . T h e o n ly d iﬀ e r e n c e is t h a t t h e fu n c t io n p r o lo gu e a n d t h e e p ilo gu e c o d e a r e r e m o v e d b y t h e c o m p ile r s t o c o n s u m e fe w e r r e s o u r c e s ( M e m o r y, C P U, a n d s o o n ) . A ll t h e r e s t o f t h e in s t r u c t io n s a r e t h e s a m e a s w e d is c u s s e d in t h e w it h o u t o p t im iz a t io n s e c t io n . P o in t t o n o t e h e r e is t h a t t h e m e a n in g o f t h e c o d e is t h e s a m e a s t h a t in t h e w it h o u t o p t im iz a t io n c o d e . W e a r e p u s h in g t h e p o in t e r t o t h e c o n s t a n t s t r in g o n t h e s t a c k t o c a ll t h e p r in t f fu n c t io n . T h e p r in t f fu n c t io n u p o n e x e c u t io n r e t u r n s t h e e x e c u t io n b a c k t o ma in ( c a lle r ) t o c le a n u p s t a c k a n d ﬁ ll E A X w it h 0 t o r e t u r n w h a t is in t h e E A X . C o n c lu s io n In t h is c h a p t e r w e u n d e r s t o o d t h e c o n c e p t o f c o d e o p t im iz a t io n . W e t o o k e x a m p le s o f e m p t y fu n c t io n , fu n c t io n r e t u r n in g v a lu e a n d p r in t in g “ h e llo , w o r ld ” p r o gr a m s t o u n d e r s t a n d t h e a s s e m b ly lis t in g o f o p t im iz e d a n d n o n -o p t im iz e d c o d e . In t h e n e x t c h a p t e r w e w ill t a lk a b o u t t h e c o d e o p t im iz a t io n c o n c e p t o n t h e p r o gr a m s w it h p r in t f fu n c t io n a n d a ls o w e w ill d is c u s s o n h o w In t e ge r, F lo a t a n d c h a r v a r ia b le s a r e s t o r e d in t h e m e m o r y. C H A P T E R 7 R e v e r s e E n gin e e r in g P a t t e r n o f P r in t f P r o gr a m E v e r y t im e w e w r it e a p r o gr a m , w e u s e t h e p r in t f fu n c t io n t o p r in t s o m e t h in g o r t h e o t h e r o n t h e o u t p u t s c r e e n . It c a n b e s o m e t h in g fo r t h e e n d u s e r o f t h e p r o gr a m o r it c a n b e s o m e t h in g fo r t h e d e b u ggin g p u r p o s e o r a s im p le w e lc o m e m e s s a ge . T h e s a m e lo gic is fo llo w e d b y m a lw a r e o r v ir u s w r it e r s . P r o gr a m s a r e c o d e d t o p r in t s o m e t h in g o r t h e o t h e r u s in g t h e p r in t f fu n c t io n . S o a s a r e v e r s e e n gin e e r, w e s h o u ld u n d e r s t a n d t h e p r in t f fu n c t io n p a t t e r n w h ile r e v e r s in g a n y p r o gr a m c o d e d t o b e h a v e a s a v ir u s o r a m a lw a r e . M o s t o f t h e v ir u s o r m a lw a r e w r it e r s w h ile c o d in g p r in t s o m e t h in g o r t h e o t h e r fo r t h e ir o w n p u r p o s e o r fo r t h e t a r ge t t o a c t u p o n . S o , it is im p o r t a n t t o u n d e r s t a n d t h e p r o gr a m s t h a t u s e t h e p r in t f fu n c t io n t o p r in t m e s s a ge s o n t h e c o n s o le . A lo n g w it h t h is , w e w ill a ls o d is c u s s t h e u s a ge o f p r in t f w it h d iﬀ e r e n t v a r ia b le s . D iﬀ e r e n t t y p e s o f v a r ia b le s a llo c a t e d iﬀ e r e n t a m o u n t s o f m e m o r y, w h ic h is q u it e in t e r e s t in g t o k n o w . In t h is c h a p t e r, w e t a k e C / C ++ p r o gr a m t h a t u s e s t h e p r in t f fu n c t io n t o p r in t in t e ge r, ﬂ o a t , a n d c h a r o n t h e c o n s o le . E a c h p r o gr a m w ill b e t a k e n s e p a r a t e ly t o u n d e r s t a n d t h e p a t t e r n o f t h e p r in t f p r o gr a m w h e n r e v e r s e e n gin e e r e d . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Un d e r s t a n d in g t h e a s s e m b ly p a t t e r n o f p r in t f w it h In t e ge r Un d e r s t a n d in g t h e a s s e m b ly p a t t e r n o f p r in t f w it h F lo a t Un d e r s t a n d in g t h e a s s e m b ly p a t t e r n o f p r in t f w it h C h a r O b je c t iv e A f t e r s t u d y in g t h is c h a p t e r, w e w ill b e a b le t o u n d e r s t a n d t h e c o d e o p t im iz a t io n c o n c e p t o n p r o gr a m s w it h t h e p r in t f fu n c t io n . W e w ill u n d e r s t a n d h o w a s s e m b ly c o d e , w it h o p t im iz a t io n , is d iﬀ e r e n t fr o m w it h o u t o p t im iz a t io n . D u r in g t h is , w e w ill a ls o d is c u s s h o w In t e ge r, F lo a t , a n d C h a r v a r ia b le s a r e s t o r e d in m e m o r y. A ﬂ o a t in g p o in t v a r ia b le t a k e s a d iﬀ e r e n t a p p r o a c h in w o r k in g a s c o m p a r e d t o in t e ge r o r c h a r. W e w ill c o v e r t h e a p p r o a c h w it h d e t a ile d e x a m p le s . F u n c t io n p r in t f w it h In t e ge r s In t h is s im p le C / C ++ c o d e , w e a r e p r in t in g 4 in t e ge r s o n t h e c o n s o le . W e a r e u s in g t h e p r in t f fu n c t io n t o p r in t in t e ge r s . F ig u r e 7 .1 : p r in t fWit h Int e g e r s .c p p F u n c t io n p r in t f P r in t in g In t e ge r s w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n w it h t h e M S V C c o m p ile r o n t h e x 8 6 p la t fo r m . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s C o m m a n d P r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 7 .2 : F u n c t io n p r in t f p r in t in g Int e g e r s w it h o u t o p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 7 .3 : p r in t fWit h Int e g e r s .a s m A s w e h a v e a lr e a d y d is c u s s e d t h e in it ia l in s t r u c t io n s o f a s s e m b ly c o d e ge n e r a t e d in C h a p t e r 6, R e v e r s e E n g in e e r in g P a t t e r n o f B a s ic s o w e w ill s t a r t w it h lin e 1 2 . ▼L in e 1 2 -1 4 C O N S T S E G M E N T $S G 4 6 7 7 D B 'in t e ge r 1 =%d; in t e ge r 2 =%d; in t e ge r 3 =%d, in t e ge r 4 =%d', 0 0 H C O N S T E N D S It is t h e s t a r t a n d t h e e n d o f C O N S T S E G M E N T in m e m o r y, w it h in w h ic h t h e s t r in g c o n s t a n t $S G 4 6 7 7 is d e ﬁ n e d . T h is c a n b e v ie w e d in t h e m e m o r y b y d u m p in g .r d a t a ( lin k e r r e n a m e d C O N S T S E G M E N T t o u s in g a n y d e b u gge r. Yo u c a n v ie w t h e s t r in g c o n s t a n t u s in g t h e x 3 2 d b g d e b u gge r a s fo llo w s : F ig u r e 7 .4 : .r d a t a ▼L in e 1 5 P UB L IC _m a in A ll fu n c t io n s b e gin w it h a n u n d e r s c o r e . T h e ma in fu n c t io n is la b e le d a s p u b lic fu n c t io n , w h ic h m e a n s it c a n b e a c c e s s e d b y o t h e r m o d u le s . ▼L in e 1 6 E X T R N _p r in t f:P R O C Wit h t h e E X T R N d e r iv a t iv e , it is d e ﬁ n in g t h e e x t e r n a l s y m b o l o f t h e n a m e _p r in t f a n d t h e t y p e p r o c e d u r e . T ip: Syntax of EXTRN derivative is label:type, where label can be variable/function and Label T ype can be as below: Label T ype Meaning BYTE Variable of 8 bits WORD Variable of 16 bits DWORD Variable of 32 bits QWORD Variable of 64 bits PROC Procedure Name Ta b le 7 .1 ▼L in e 1 8 , 1 9 _TEX T S E G M E N T _m a in P R O C T h is s t a r t s t h e _TEX T s e gm e n t w h e r e o u r ma in fu n c t io n c o d e r e s id e s . T h is c a n a ls o b e v is u a liz e d in t h e x 3 2 d b g d e b u gge r : .t e x t s e gm e n t o f p r in t fWit h In t e ge r s .e x e s t a r t s fr o m t h e 0 x 0 0 4 0 1 0 0 0 a d d r e s s a n d w e c a n s e e t h a t t h e ma in fu n c t io n / p r o c e d u r e c o d e s t a r t s fr o m t h e s a m e a d d r e s s . F ig u r e 7 .5 : .t e x t ▼L in e 2 0 -2 3 ; F ile c :\\ jit e n d e r n \\ r e b o o k \\ h e llo w o r ld \\ h e llo w o r ld \\ h e llo w o r ld .c p p ; L in e 8 p u s h e b p m o v e b p , e s p T h is is t h e s a m e a s e a r lie r. T h is c o m m e n t s t a t e s t h e C / C ++ s o u r c e c o d e ﬁ le p a t h a n d o t h e r d e ﬁ n in g lin e n u m b e r in C / C ++ s o u r c e c o d e t h a t is m a p p e d w it h t h e in s t r u c t io n fo llo w in g t h is c o m m e n t . Wit h P US H in s t r u c t io n , t h e ma in fu n c t io n p r o lo gu e c o d e s t a r t s . ▼L in e 2 5 -3 0 p u s h 4 p u s h 3 p u s h 2 p u s h 1 p u s h O F F S E T $S G 4 6 7 7 c a ll_p r in t f Fr o m h e r e , s o m e t h in g in t e r e s t in g b e gin s . A ll t h e a r gu m e n t s t o p r in t f fu n c t io n a r e p u s h e d o n t o t h e s t a c k in a r e v e r s e o r d e r. E a c h a r gu m e n t is o f t y p e in t e ge r. In a 3 2 -b it e n v ir o n m e n t , e a c h in t e ge r o c c u p ie s 4 b y t e s in s iz e . To u n d e r s t a n d t h e s t a c k s t a t e d u r in g e x e c u t io n , w e c a n p u t b r e a k p o in t o n t h e c a ll o f t h e p r in t f fu n c t io n in t h e x 3 2 d b g d e b u gge r. O n c e t h e b r e a k p o in t is s e t , w e w ill r u n t h e c o d e t o s e e t h e s t a c k s t a t e w h e n b r e a k p o in t is h it . T h is w ill h e lp u s v is u a liz e h o w t h e a r gu m e n t s t o p r in t f a r e p u s h e d o n t o t h e s t a c k . F ig u r e 7 .6: B r e a k p o in t o n t h e c a ll o f p r in t f W e c a n s e e t h a t t h e a r gu m e n t in t e ge r 4 is p u s h e d ﬁ r s t o n t h e s t a c k a n d t h e n 3 , 2 , a n d 1 a r e p u s h e d . T h e fo llo w in g is t h e e x p la n a t io n fo r t h e s t a c k s t a t e w h e n b r e a k p o in t is h it : 0 0 1 2 F F 2 C   0 0 4 0 8 1 4 0   \" in t e g e r 1 =%d; in t e ge r 2 =%d; in t e ge r 3 =%d, in t e ge r 4 =%d\" 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 1    A r gu m e n t 1 o f t y p e in t is p u s h e d o n s t a c k 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 2    A r gu m e n t 2 o f t y p e in t is p u s h e d o n s t a c k 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 3    A r gu m e n t 3 o f t y p e in t is p u s h e d o n s t a c k 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 4    A r gu m e n t 4 o f t y p e in t is p u s h e d o n s t a c k A t t h e 0 x 0 0 1 2 F F 2 C lo c a t io n , t h e p o in t e r t o t h e c o n s t a n t s t r in g ( w h ic h is is p u s h e d o n t h e s t a c k . W e c a n d u m p t h e lo c a t io n in x 3 2 d b g t o v ie w t h e c o n s t a n t s t r in g, F ig u r e 7 .7 : S t r in g d u m p e d O n c e a ll t h e a r gu m e n t s a r e p u s h e d o n t h e s t a c k , t h e c a ll t o t h e p r in t f fu n c t io n is m a d e b y : ▼L in e 3 0 c a ll _p r in t f T h is w ill e x e c u t e t h e p r in t f fu n c t io n a n d a f t e r t h e e x e c u t io n o f t h e p r in t f fu n c t io n , t h e in s t r u c t io n p o in t e r w ill r e t u r n t h e e x e c u t io n p o in t e r b a c k t o t h e c a lle r. ▼L in e 3 1 a d d e s p , 2 0      ; 0 0 0 0 0 0 1 4 H A s w e a r e u s in g t h e C D E C L c a llin g c o n v e n t io n , t h e c a lle r c le a n s u p t h e s t a c k . S o , a f t e r r e t u r n in g fr o m t h e p r in t f fu n c t io n , a d d e s p , 2 0 s h r in k s t h e s t a c k b y 0 x 2 0 . 2 0 b y t e s is c a lc u la t e d b y a d d in g t h e s iz e o f 4 a r gu m e n t s , 4 b y t e s e a c h p lu s o n e p o in t e r a r gu m e n t t o t h e c o n s t a n t s t r in g o f 4 b y t e s s iz e . T h is m a k e s a t o t a l o f 4 x 5 b y t e s , w h ic h is e q u a l t o 2 0 b y t e s in H e x ) . N o w , w e w ill u n d e r s t a n d s o m e t h in g m o r e in t e r e s t in g r e la t e d t o ga r b a ge o n t h e s t a c k . To u n d e r s t a n d t h e c o n c e p t o f ga r b a ge , w e p u t b r e a k p o in t o n t h e in s t r u c t io n n e x t t o a d d e s p , W e s e e s o m e t h in g lik e t h e fo llo w in g o n t h e s t a c k : F ig u r e 7 .8: G a r b a g e o n s t a c k T h e c a lle r, a s p e r t h e C D E C L c a llin g c o n v e n t io n , is r e s p o n s ib le fo r c le a n in g t h e s t a c k , w h ic h is d o n e u s in g t h e A D D in s t r u c t io n b y m o v in g E S P b a c k b y 2 0 b y t e s . A s w e c a n s e e , E S P is m o v e d b a c k e d t o b u t a ll t h e a r gu m e n t s a n d p o in t e r t o t h e c o n s t a n t s t r in g a r e s t ill o n t h e s t a c k . T h e s e v a lu e s a r e n o t c le a r e d o r s e t t o z e r o s . E v e r y t h in g a b o v e t h e E S P v a lu e is ga r b a ge w it h n o m e a n in g. ▼L in e 3 4 -3 9 ; L in e 9 x o r e a x , e a x ; L in e 1 0 p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D A ll t h e r e m a in in g in s t r u c t io n s a r e t h e s a m e a s w e d is c u s s e d in t h e c h a p t e r s b e fo r e . T h e ma in fu n c t io n is r e t u r n in g a z e r o b y m a k in g E A X t o z e r o . Wit h E N D , e v e r y t h in g is c lo s e d a n d t h e p r o gr a m is e n d e d . F u n c t io n p r in t f P r in t in g In t e ge r s w it h O p t imiz a t io n C o m p ile t h e c o d e w it h o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 7 .9: F u n c t io n p r in t f p r in t in g in t e g e r s w it h o p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 7 .1 0 : p r in t fWit h Int e g e r s -O p t im iz e d .a s m In t h e o p t im iz e d c o d e , e v e r y t h in g is t h e s a m e e x c e p t t h e ma in fu n c t io n p r o lo gu e a n d t h e e p ilo gu e c o d e is r e m o v e d b y c o m p ile r s t o c o n s u m e fe w e r r e s o u r c e s . F u n c t io n p r in t f w it h F lo a t M o s t o f t h e c a lc u la t io n s a r e d o n e u s in g in t e ge r s , b u t w h e n it c o m e s t o a c c u r a c y, ﬂ o a t in g p o in t p la y s a n im p o r t a n t r o le . T h e e a r lie r x 8 6 p r o c e s s o r fa m ily h a s s e p a r a t e c o p r o c e s s o r s fo r m a t h e m a t ic a l c a lc u la t io n s t h a t p r o c e s s ﬂ o a t in g p o in t n u m b e r s . B u t la t e r o n , t h e c a p a b ilit y o f h a n d lin g ﬂ o a t in g p o in t n u m b e r s w a s in t e gr a t e d in t o t h e m ic r o p r o c e s s o r it s e lf. T h is u n it w h ic h w a s in t e gr a t e d in t o t h e m ic r o p r o c e s s o r t o h a n d le t h e ﬂ o a t in g p o in t n u m b e r s is c a lle d t h e F lo a t in g P o in t Un it ( F P U) . N o w t o h a n d le t h e ﬂ o a t in g p o in t , t w o t h in gs a r e r e q u ir e d : T h e r e s h o u ld b e s p a c e t o s t o r e t h e ﬂ o a t in g p o in t n u m b e r s . T h e r e m u s t b e in s t r u c t io n s t o h a n d le a n d d o o p e r a t io n s o n t h e ﬂ o a t in g p o in t n u m b e r s . N o w , r e ga r d in g t h e s p a c e t o s t o r e ﬂ o a t in g p o in t n u m b e r s , F P U h a s 8 r e gis t e r s t h a t fo r m s a s t a c k , i.e ., fr o m S T 0 t o S T 7 . F P U is a ls o r e fe r r e d t o a s t h e “ x 8 7 ” s e c t io n o r “ F P U R e gis t e r S t a c k ” t h e \" x 8 7 S t a c k \". In s t r u c t io n s t o h a n d le t h e ﬂ o a t in g p o in t n u m b e r s a r e r e fe r r e d t o a s t h e \" x 8 7 in s t r u c t io n s e t \". T h e ﬂ o a t in g p o in t n u m b e r s a r e ge n e r a lly 3 2 -b it lo n g fo r ﬂ o a t t y p e a n d 6 4 -b it lo n g fo r d o u b le t y p e . S o , t o m a in t a in m a x im u m a c c u r a c y o f t h e ﬂ o a t in g n u m b e r s , t h e F P U s t a c k r e gis t e r s a r e 8 0 - b it w id e . To u n d e r s t a n d m o r e a b o u t ﬂ o a t in g p o in t , w e w ill t a k e a s im p le C / C ++ c o d e t o p r in t t w o ﬂ o a t in g n u m b e r s o n t h e c o n s o le . W e a r e u s in g p r in t f t o p r in t t h e ﬂ o a t in g n u m b e r s . F ig u r e 7 .1 1 : p r in t fWit h F lo a t .c p p F u n c t io n p r in t f P r in t in g F lo a t w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 7 .1 2 : F u n c t io n p r in t f p r in t in g F lo a t w it h o u t O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 7 .1 3 : p r in t fWit h F lo a t .a s m L e t ’s s t a r t u n d e r s t a n d in g t h e a s s e m b ly c o d e ge n e r a t e d lin e b y lin e : ▼L in e 1 -1 0 ; L is t in g ge n e r a t e d b y M ic r o s o f t ( R ) O p t im iz in g C o m p ile r V e r s io n 1 6 .0 0 .3 0 3 1 9 .0 1 T ITL E C :\\ Jit e n d e r N \\ R E B o o k \\ p r in t fWit h F lo a t \\ p r in t fWit h F lo a t \\ p r in t fW it h F lo a t .c p p .6 8 6 P .X M M in c lu d e lis t in g.in c .m o d e l ﬂ a t IN C L UD E L IB L IB C M T IN C L UD E L IB O L D N A M E S W e h a v e a lr e a d y d is c u s s e d t h is in t h e e a r lie r s e c t io n , s o w e w ill m o v e o n t o t h e n e x t in s t r u c t io n . ▼L in e 1 2 -1 4 C O N S T S E G M E N T $S G 4 6 7 7 D B 'ﬂ o a t 1 =%f, ﬂ o a t 2 =%f ', 0 0 H C O N S T E N D S T h is is t h e s t a r t o f C O N S T S E G M E N T n a m e d b y t h e lin k e r a s T h e c o m p ile r is u s in g t h e $S G 4 6 7 7 n a m e t o h a n d le t h e s t r in g c o n s t a n t . D B is t h e d a t a t y p e t o d e ﬁ n e b y t e a n d t h e s t r in g is t e r m in a t e d w it h n u ll, T h e .r d a t a c a n b e d u m p e d t o v ie w t h e c o n s t a n t s t r in g. F ig u r e 7 .1 4 : .r d a t a ▼L in e 1 5 -1 6 P UB L IC __r e a l@3 ﬀ 0 0 0 0 0 0 0 0 0 0 0 0 0 P UB L IC __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f F lo a t in g p o in t n u m b e r s c a n b e r e p r e s e n t e d in a b in a r y n u m b e r fo r m a t a n d t h is b in a r y n u m b e r in g fo r m a t is s t a n d a r d iz e d . R e a l n u m b e r fo r m a t , s h o r t / s in gle , a n d lo n g/ d o u b le r e a l n u m b e r s a r e a v a ila b le in t h r e e s iz e s : R E A L 4 , 3 2 -b it , s h o r t r e a l o r s in gle p r e c is io n R E A L 8 , 6 4 -b it , lo n g r e a l o r d o u b le p r e c is io n R E A L 1 0 , 8 0 -b it , t e m p o r a r y r e a l o r e x t e n d e d p r e c is io n R E A L 4 , R E A L 8 , R E A L 1 0 h a v e d iﬀ e r e n t fo r m a t s : T h e fo r m a t fo r R E A L 4 is : F ig u r e 7 .1 5 : R E A L 4 fo r m a t Wh e r e : S = s ign b it ( 0 =p o s it iv e , 1 =n e ga t iv e ) E = e x p o n e n t b it s F = fr a c t io n b it s o f t h e s ign iﬁ c a n d T h e fo r m a t fo r R E A L 8 is : F ig u r e 7 .1 6: R E A L 8 fo r m a t T h e fo r m a t fo r R E A L 1 0 is : F ig u r e 7 .1 7 : R E A L 1 0 fo r m a t To k e e p it s im p le a n d e a s y t o u n d e r s t a n d , w e w ill n o t d is c u s s in d e t a il t h e in d iv id u a l fo r m a t s . K e e p in g t h e r e a l n u m b e r in g fo r m a t ( R E A L 8 , w h ic h is 6 4 b it fo r lo n g r e a l o r d o u b le p r e c is io n is u s e d in o u r c o d e ) in m in d , w e w ill m o v e t o t h e s a m e in s t r u c t io n s : P UB L IC __r e a l@3 ﬀ 0 0 0 0 0 0 0 0 0 0 0 0 0 P UB L IC __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f P u b lic is a d e r iv a t iv e t h a t m a k e s a v a r ia b le p u b lic a n d m a k e it a v a ila b le a c r o s s m o d u le s . r e a l is r e p r e s e n t in g t h e r e a l n u m b e r fo r m a t fo llo w e d b y t h e h e x a d e c im a l v a lu e o f o u r fu n c t io n p a r a m e t e r. L e t ’s c o n v e r t t h is h e x v a lu e s in t o ﬂ o a t in g n u m b e r u s in g a n o n lin e lin e c o n v e r t e r F ig u r e 7 .1 8: H e x v a lu e in t o ﬂ o a t 1 T h is h e x a d e c im a l 3 ﬀ 0 0 0 0 0 0 0 0 0 0 0 0 0 is e q u iv a le n t t o o u r ﬂ o a t 1 ( 1 .0 ) a r gu m e n t in C / C ++ c o d e . F ig u r e 7 .1 9: H e x v a lu e in t o ﬂ o a t 2 T h is h e x a d e c im a l 4 0 0 1 1 e b 8 5 1 e b 8 5 1 f is e q u iv a le n t t o o u r ﬂ o a t 2 ( 2 .1 4 ) a r gu m e n t in C / C ++ c o d e . ▼L in e 1 7 P UB L IC _m a in T h e ma in fu n c t io n is la b e le d a s a p u b lic fu n c t io n , w h ic h m e a n s it c a n b e a c c e s s e d b y o t h e r m o d u le s . ▼L in e 1 8 -2 0 E X T R N _p r in t f:P R O C E X T R N __ﬂ t u s e d :D W O R D ; C O M D A T __r e a l@3 ﬀ 0 0 0 0 0 0 0 0 0 0 0 0 0 E X T R N d e r iv a t iv e d e c la r e s t h e e x t e r n a l fu n c t io n , w h ic h is p r in t f in o u r c a s e . A ll fu n c t io n s b e gin w it h a n u n d e r s c o r e . ▼L in e 2 2 -2 9 C O N S T S E G M E N T __r e a l@3 ﬀ 0 0 0 0 0 0 0 0 0 0 0 0 0 D Q 0 3 ﬀ 0 0 0 0 0 0 0 0 0 0 0 0 0 r ; 1 C O N S T E N D S ; C O M D A T __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f C O N S T S E G M E N T __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f D Q 0 4 0 0 1 1 e b 8 5 1 e b 8 5 1 fr ; 2 .1 4 ; F u n c t io n c o m p ile ﬂ a gs : / O d t p C O N S T E N D S T h is is t h e s t a r t / e n d o f C O N S T Wit h in t h is s e gm e n t , o u r fu n c t io n a r gu m e n t 2 .1 4 r e p r e s e n t e d b y 4 0 0 1 1 e b 8 5 1 e b 8 5 1 f h e x a d e c im a l n o t a t io n is s t o r e d in C O N S T S E G M E N T o r w e c a n s a y L e t ’s d u m p .r d a t a t o v ie w o u r ﬂ o a t 2 a r gu m e n t in C / C ++ c o d e u s in g a n y d e b u gge r. A s w e d e a l w it h lit t le -e n d ia n , t h e ﬂ o a t in g p o in t a r gu m e n t ’s h e x a d e c im a l r e p r e s e n t a t io n w ill b e s t o r e d in a r e v e r s e o r d e r. 4 0 0 1 1 e b 8 5 1 e b 8 5 1 f w ill b e s t o r e d a s 1 F 8 5 E B 5 1 B 8 1 E 0 1 4 0 in t h e .r d a t a s e gm e n t , a s w e c a n s e e in x 3 2 d b g a t 0 x 0 0 4 0 C 1 5 8 m e m o r y lo c a t io n . If y o u a r e t h in k in g a b o u t o t h e r ﬂ o a t in g v a r ia b le s in .r d a t a s e gm e n t , t h e n w a it . T h in gs w ill b e c le a r a f t e r a fe w in s t r u c t io n s . F ig u r e 7 .2 0 : F lo a t in g p o in t a r g u m e n t in .r d a t a ▼L in e 3 0 -3 4 _TEX T S E G M E N T _m a in P R O C ; L in e 7 p u s h e b p m o v e b p , e s p In t h e T E X T s e gm e n t , w e h a v e t h e ma in p r o c e d u r e w h ic h s t a r t s w it h a fu n c t io n p r o lo gu e . ▼L in e 3 6 s u b e s p , 8 A llo c a t in g 8 b y t e s o n t h e s t a c k fo r t h e ma in fu n c t io n lo c a l v a r ia b le , w h ic h is t h ir d a r gu m e n t ( 2 .1 4 ) t o t h e p r in t f fu n c t io n . ▼L in e 3 7 ﬂ d Q W O R D P T R __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f F L D s t a n d s fo r F lo a t in g P o in t L o a d . T h is in s t r u c t io n p u s h e s t h e ﬂ o a t in g p o in t v a lu e o n F P U s t a c k , w h ic h is fr o m S T 0 t o S T 7 . Yo u c a n s e e t h e d e b u gge r o u t p u t b e fo r e a n d a f t e r r u n n in g t h is in s t r u c t io n a s fo llo w s : Yo u c a n in s e r t b r e a k p o in t a t t h e s t a r t o f To in s e r t b r e a k p o in t , s c r o ll t o t h e t o p o f .t e x t s e gm e n t , y o u w ill ﬁ n d t h e s a m e s e t o f in s t r u c t io n s a s in o u r a s s e m b ly ﬁ le O n c e b r e a k p o in t is s e t y o u c a n s t e p in t o t h e in s t r u c t io n s o n e b y o n e . x 3 2 d b g o u t p u t b e fo r e in s t r u c t io n e x e c u t io n o f t h is in s t r u c t io n : ﬂ d Q W O R D P T R __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f F ig u r e 7 .2 1 : S T 0 b e fo r e A f t e r in s t r u c t io n e x e c u t io n : F ig u r e 7 .2 2 : S T 0 a f t e r ▼L in e 3 8 fs t p Q W O R D P T R [e s p ] F S T P m e a n s F lo a t in g P o in t S t o r e a n d P O P. It m o v e s t h e ﬂ o a t in g p o in t v a lu e fr o m S T 0 t o t h e t o p o f t h e s t a c k P T R [e s p ] a n d P O P t h e v a lu e fr o m S T 0 c o m p le t e ly. F ig u r e 7 .2 3 : F lo a t in g p o in t S t o r e a n d P O P ▼L in e 3 9 s u b e s p , 8 A ga in a llo c a t in g 8 b y t e s o n t h e s t a c k fo r t h e ma in fu n c t io n lo c a l v a r ia b le , w h ic h is t h e s e c o n d p a r a m e t e r 1 .0 t o t h e p r in t f fu n c t io n . L e t ’s s e e w h a t it lo o k s lik e in x 3 2 d b g. F ig u r e 7 .2 4 : A llo c a t in g s p a c e o n s t a c k ▼L in e 4 0 ﬂ d 1 T h is in s t r u c t io n lo a d s t h e ﬂ o a t in g p o in t v a lu e 1 .0 o n t h e F P U s t a c k . F ig u r e 7 .2 5 : L o a d s ﬂ o a t in g p o in t v a lu e 1 .0 ▼L in e 4 1 fs t p Q W O R D P T R [e s p ] F S T P m e a n s F lo a t in g P o in t S t o r e a n d P O P, it m o v e s t h e ﬂ o a t in g p o in t v a lu e w h ic h is 1 .0 fr o m S T 0 t o t h e t o p o f t h e s t a c k P T R [e s p ] a n d P O P t h e v a lu e fr o m S T 0 c o m p le t e ly. F ig u r e 7 .2 6: F lo a t in g P o in t S t o r e a n d P O P ▼L in e 4 2 p u s h O F F S E T $S G 4 6 7 7 N o w b e fo r e c a llin g t h e p r in t f fu n c t io n , w e h a v e t o p a s s t h e r e m a in in g s t r in g c o n s t a n t t o t h e s t a c k . T h is P US H in s t r u c t io n is p u s h in g t h e s t r in g c o n s t a n t $S G 4 6 7 7 o n t o t h e s t a c k .F ig u r e 7 .2 7 : P u s h s t r in g ▼L in e 4 3 c a ll _p r in t f A ll t h e p a r a m e t e r s t o t h e p r in t f fu n c t io n a r e p u s h e d o n t o t h e s t a c k b e fo r e t h e C A L L in s t r u c t io n t o t h e p r in t f fu n c t io n . A f t e r t h is in s t r u c t io n e x e c u t io n , b o t h t h e v a r ia b le s w ill b e p r in t e d o n t h e c o n s o le . ▼L in e 4 4 a d d e s p , 2 0      ; 0 0 0 0 0 0 1 4 H A s w e a r e fo llo w in g t h e C D E C L c a llin g c o n v e n t io n , it ’s t h e c a lle r w h o c le a n s t h e s t a c k . O n r e t u r n in g fr o m t h e p r in t f fu n c t io n , t h e m a in c le a n s t h e s t a c k b y m o v in g t h e s t a c k p o in t b a c k b y 2 0 b y t e s ( w e u s e d 4 b y t e s fo r p u s h in g t h e s t r in g c o n s t a n t , 8 b y t e s fo r p u s h in g t h e 1 .0 ﬂ o a t in g h e x v a lu e a n d a n o t h e r 8 b y t e s w e r e u s e d fo r p u s h in g t h e 2 .1 4 ﬂ o a t in g h e x v a lu e ) . B e fo r e t h is in s t r u c t io n , t h e x 3 2 d b g s c r e e n lo o k s a s fo llo w s : To m o v e d ir e c t ly t o a d d in s t r u c t io n , y o u c a n u s e s t e p o v e r t o e x e c u t e p r in t fu n c t io n a n d s t o p a t a d d in s t r u c t io n . O r y o u c a n in s e r t b r e a k p o in t a t t h e a d d in s t r u c t io n t o s t o p e x e c u t io n a t a d d in s t r u c t io n . F ig u r e 7 .2 8: A f t e r c a ll p r in t f A f t e r t h is in s t r u c t io n : F ig u r e 7 .2 9: S t a c k c le a n e d ▼L in e 4 5 -5 2 ; L in e 9 x o r e a x , e a x ; L in e 1 0 p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D T h e r e m a in in g in s t r u c t io n s a r e m a k in g E A X z e r o a s ma in is r e t u r n in g 0 in t h e C / C ++ c o d e . In t h e la s t it is c a llin g fu n c t io n e p ilo gu e t o e n d m a in , T E X T s e gm e n t , a n d c o d e . F u n c t io n p r in t f P r in t in g F lo a t w it h O p t imiz a t io n C o m p ile t h e c o d e w it h o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : / O x : E n a b le m a x im u m o p t im iz a t io n / F a : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le / F e : N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s :F ig u r e 7 .3 0 : F u n c t io n p r in t f p r in t in g F lo a t w it h O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 7 .3 1 : p r in t fWit h F lo a t -O p t im iz e d .a s m A ll t h e in s t r u c t io n s in t h e lis t in g a r e t h e s a m e e x c e p t lin e 3 3 . A s t h e c o d e is o p t im iz e d , t h e fu n c t io n p r o lo gu e a n d e p ilo gu e a r e r e m o v e d , w h ic h w e w ill d is c u s s in t h is s e c t io n . ▼L in e 3 3 ﬂ d Q W O R D P T R __r e a l@4 0 0 1 1 e b 8 5 1 e b 8 5 1 f It is t h e s a m e a s b e fo r e . T h is in s t r u c t io n p u s h e s t h e ﬂ o a t in g p o in t v a lu e 2 .1 4 o n t h e F P U s t a c k , S T 0 . ▼L in e 3 4 s u b e s p , 1 6      ; 0 0 0 0 0 0 1 0 H A s w e s a w in t h e n o n -o p t im iz e d c o d e , S UB is c a lle d t w ic e t o a llo c a t e m e m o r y fo r t h e ma in fu n c t io n lo c a l v a r ia b le . B u t in o p t im iz a t io n , b o t h in s t r u c t io n s a r e c o m b in e d t o s u b t r a c t 1 6 b y t e s fr o m E S P t o a llo c a t e 8 +8 b y t e s fo r ﬂ o a t in g v a r ia b le s 1 .0 a n d 2 .1 4 . ▼L in e 3 5 fs t p Q W O R D P T R [e s p +8 ] It m o v e s t h e ﬂ o a t in g p o in t v a lu e , w h ic h is 2 .1 4 fr o m S T 0 t o t h e t o p o f t h e s t a c k P T R [e s p +8 ] a n d P O P t h e v a lu e fr o m S T 0 c o m p le t e ly. ▼L in e 3 6 ﬂ d 1 It is t h e s a m e a s e a r lie r. T h is in s t r u c t io n lo a d s t h e ﬂ o a t in g p o in t v a lu e 1 .0 o n t h e F P U s t a c k . ▼L in e 3 7 fs t p Q W O R D P T R [e s p ] It m o v e s t h e ﬂ o a t in g p o in t v a lu e , w h ic h is 1 .0 fr o m S T 0 t o t h e t o p o f t h e s t a c k P T R [e s p ] a n d P O P t h e v a lu e fr o m S T 0 c o m p le t e ly. ▼L in e 3 8 -3 9 p u s h O F F S E T $S G 4 6 7 7 c a ll _p r in t f P u s h e s t h e s t r in g c o n s t a n t o ﬀ s e t o n t h e s t a c k t o c a ll t h e p r in t f fu n c t io n . ▼L in e 4 0 -4 7 a d d e s p , 2 0      ; 0 0 0 0 0 0 1 4 H ; L in e 9 x o r e a x , e a x ; L in e 1 0 r e t 0 _m a in E N D P _TEX T E N D S E N D T h e c a lle r c le a n s t h e s t a c k a s p e r t h e C D E C L c a llin g c o n v e n t io n . T h e r e m a in in g in s t r u c t io n s r e t u r n 0 b y X O R in g t h e E A X r e gis t e r, a n d e n d t h e m a in p r o c e d u r e , t e x t s e gm e n t , a n d c o d e in lin e 4 5 - 4 7 . F u n c t io n p r in t f w it h c h a r In t h is s im p le C / C ++ c o d e , w e a r e p r in t in g 2 c h a r o n t h e c o n s o le . W e a r e u s in g t h e p r in t f fu n c t io n t o p r in t t h e c h a r. F ig u r e 7 .3 2 : p r in t fWit h C h a r.c p p F u n c t io n p r in t f P r in t in g C h a r w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 7 .3 3 : F u n c t io n p r in t f p r in t in g C h a r w it h o u t O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 7 .3 4 : p r in t fWit h C h a r.a s m M o s t o f t h e p a r t o f t h e a s s e m b ly lis t in g h a s a lr e a d y b e e n d is c u s s e d in t h e p r e c e d in g s e c t io n . L e t ’ s m o v e o n t o lin e 2 5 . ▼L in e 2 5 -2 8 p u s h 9 8      ; 0 0 0 0 0 0 6 2 H p u s h 9 7      ; 0 0 0 0 0 0 6 1 H p u s h O F F S E T $S G 4 6 7 7 c a ll _p r in t f B e fo r e c a llin g t h e p r in t f fu n c t io n , t h r e e p a r a m e t e r s a r e p u s h e d o n t o t h e s t a c k . T h e ﬁ r s t P US H in s t r u c t io n is P US H w h e r e 9 8 is t h e A S C II v a lu e o f c h a r ‘ b ’ a n d t h e h e x e q u iv a le n t is 6 2 H . R e fe r t o t h e A S C II t a b le in t h e a p p e n d ix fo r a c o m p le t e A S C II lis t in g. T h e s e c o n d P US H in s t r u c t io n is P US H w h e r e 9 7 is t h e A S C II v a lu e o f ‘ a ’ a n d t h e h e x e q u iv a le n t is 6 1 H . A n d t h e t h ir d p a r a m e t e r t o p r in t f is t h e s t r in g c o n s t a n t d e ﬁ n e d in t h e C O N S T T h is is h o w t h e s t a c k lo o k s in x 3 2 d b g b e fo r e t h e C A L L in s t r u c t io n . Yo u c a n c h e c k t h e s t a c k s t a t e b y in s e r t in g b r e a k p o in t a t t h e C A L L t o t h e p r in t f fu n c t io n . F ig u r e 7 .3 5 : S t a c k s t a t e 1 : [e s p ] 0 0 4 0 8 1 4 0 M e m o r y lo c a t io n o f $S G 4 6 7 7 , \"c h a r 1 =%c , c h a r 2 =%c \" 2 : [e s p +4 ] 0 0 0 0 0 0 6 1 H e x v a lu e o f c h a r ‘ a ’ is P US H e d 3 : [e s p +8 ] 0 0 0 0 0 0 6 2 H e x v a lu e o f c h a r ‘ b ’ is P US H e d 4 : [e s p +C ] 0 0 1 2 F F 8 8 [E B P ] 5 : [e s p +1 0 ] 0 0 4 0 1 2 0 9 r e t u r n t o p r in t fw it h c h a r.0 0 4 0 1 2 0 9 fr o m p r in t fw it h c h a r.0 0 4 0 1 0 0 0 A f t e r r e t u r n in g fr o m t h e c a lle r c le a n s t h e s t a c k w it h t h e A D D E S P, 1 2 in s t r u c t io n a s w e d is c u s s e d in t h e C D E C L c a llin g c o n v e n t io n . F u r t h e r, t h e c o d e is e n d e d w it h 0 in E A X , w h ic h is a c h ie v e d b y X O R ’ in g E A X . A s w e d is c u s s e d e a r lie r, t h a t fu n c t io n r e t u r n v a lu e is s t o r e d in E A X . F u n c t io n p r in t f p r in t in g C h a r w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s :F ig u r e 7 .3 6: F u n c t io n p r in t f p r in t in g C h a r w it h O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 7 .3 7 : p r in t fWit h C h a r -O p t im iz e d .a s m E v e r y t h in g in t h e o p t im iz e d c o d e is t h e s a m e e x c e p t t h a t t h e fu n c t io n p r o lo gu e a n d e p ilo gu e a r e e lim in a t e d in t h e o p t im iz e d c o d e . C o n c lu s io n In t h is c h a p t e r, w e le a r n e d t o r e v e r s e e n gin e e r p r o gr a m s o r a p p lic a t io n s w it h t h e p r in t f fu n c t io n . W e a ls o s p o k e a b o u t t h e c o d e o p t im iz a t io n c o n c e p t in p r o gr a m s w it h t h e p r in t f fu n c t io n . W e a ls o d is c u s s e d h o w in t e ge r, ﬂ o a t , a n d c h a r v a r ia b le s a r e s t o r e d in m e m o r y. T h e ﬂ o a t in g p o in t v a r ia b le t a k e s a d iﬀ e r e n t a p p r o a c h in w o r k in g a s c o m p a r e d t o in t e ge r o r c h a r. In t h e n e x t c h a p t e r, w e w ill t a lk a b o u t p o in t e r s a n d h o w t h e y a r e h a n d le d in r e v e r s e e n gin e e r in g. C H A P T E R 8 R e v e r s e E n gin e e r in g P a t t e r n o f P o in t e r P r o gr a m M o s t o f u s ﬁ n d it d iﬃ c u lt t o u n d e r s t a n d p o in t e r s , b u t it is t h e o n e o f t h e m o s t in t e r e s t in g s u b je c t s in p r o gr a m m in g. In o u r r e a l life , h a v e y o u e v e r im a gin e d t h a t p o in t e r s a r e e v e r y w h e r e ? Wh e n w e w a t c h t h e t e le v is io n w it h a c a b le c o n n e c t io n , w e h a v e s o m a n y c h a n n e ls t o w a t c h . E a c h c h a n n e l is a s s o c ia t e d w it h a n u m b e r w e o f t e n c a ll t h e c h a n n e l n u m b e r. Wh e n t h is c h a n n e l n u m b e r is p r e s s e d o n t h e r e m o t e o f o u r c a b le m o d e m , t h e r e s p e c t iv e c h a n n e l b r o a d c a s t in g s t a r t s o n t h e t e le v is io n . In t h e c o n t e x t o f p o in t e r s , t h is c h a n n e l n u m b e r is t h e p o in t e r t o t h e c h a n n e l. T h is is t h e n u m b e r w h e r e t h e c h a n n e l is s t o r e d a n d p la y e d w h e n p r e s s e d o n t h e r e m o t e c o n t r o l. S o n o w , t o u n d e r s t a n d t h e c o n c e p t o f p o in t e r s , w e w ill w a lk t h r o u gh it s c o n c e p t in p r o gr a m m in g. In C / C ++, t h e r e a r e v a r io u s t y p e s o f v a r ia b le s t o h o ld t h e d iﬀ e r e n t t y p e s o f v a lu e s . W e h a v e t h e In t e ge r v a r ia b le s t h a t s t o r e t h e In t e ge r v a lu e , t h e F lo a t in g v a r ia b le s t o s t o r e r e a l n u m b e r s , C h a r t o s t o r e c h a r a c t e r s , a n d o t h e r s . S im ila r ly, a p o in t e r is a v a r ia b le t h a t s t o r e s t h e m e m o r y a d d r e s s o f o t h e r v a r ia b le s . In t h is c h a p t e r, w e w ill u n d e r s t a n d t h e p a t t e r n o f p o in t e r s in a s s e m b ly c o d e . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : P o in t e r s P o in t e r s w it h o u t O p t im iz a t io n P o in t e r s w it h O p t im iz a t io n O b je c t iv e A f t e r s t u d y in g t h is c h a p t e r, w e s h o u ld b e a b le t o u n d e r s t a n d h o w p o in t e r s a r e u s e d in p r o gr a m m in g. W e w ill s t u d y t h e b a s ic s o f p o in t e r s fr o m in t e ge r t o ﬂ o a t a n d c h a r. T h is w ill h e lp y o u u n d e r s t a n d t h e w a y p o in t e r s a r e h a n d le d w it h r e s p e c t t o m e m o r y a llo c a t io n . A f t e r u n d e r s t a n d in g p o in t e r s , w e w ill w r it e a s im p le C / C ++ p r o gr a m t o ge n e r a t e o p t im iz e d a n d n o n -o p t im iz e d A S M c o d e a n d c h e c k p o in t e r a s s e m b ly p a t t e r n w it h a n d w it h o u t o p t im iz a t io n . P o in t e r s To u n d e r s t a n d p o in t e r s , le t ’s t a k e a s im p le d e c la r a t io n : in t iN u m b e r = 3 ; H e r e , w e a r e d e ﬁ n in g a n in t e ge r v a r ia b le o f t h e n a m e , W e a r e u s in g t h e H u n ga r ia n N o t a t io n a s t h e v a r ia b le n a m in g c o n v e n t io n . T h is d e c la r a t io n is u s e d b y t h e c o m p ile r t o : R e v e r s e s p a c e fo r a n in t e ge r v a r ia b le in m e m o r y A s s o c ia t e t h e n a m e w it h t h e m e m o r y lo c a t io n S t o r e 3 o n t h e r e s e r v e d m e m o r y lo c a t io n Yo u c a n im a gin e t h is a s : 0 x 0 0 1 2 F F 3 C is t h e m e m o r y lo c a t io n a d d r e s s w h ic h is h o ld in g 0 x 0 0 0 0 0 0 0 3 a s a v a lu e . S o w e s a w h o w a v a r ia b le is s t o r e d in m e m o r y. N o w , w e w ill t a k e a C / C ++ p r o gr a m t o u n d e r s t a n d p o in t e r s a n d t h e c o n c e p t s a s s o c ia t e d w it h t h e m : F ig u r e 8.1 : P o in t e r s .c p p L in e 8 o f C / C ++ c o d e d e ﬁ n e s a v a r ia b le o f t y p e in t e ge r. In lin e s 9 a n d 1 0 , w e s e e t w o o p e r a t o r s , * a n d F ir s t , w e w ill d is c u s s t h e & o p e r a t o r. It m e a n s t h e a d d r e s s o f t h e o p e r a t o r. S o , & iN u mb e r r e t u r n s t h e m e m o r y a d d r e s s o f t h e v a r ia b le w h ic h in t h e p r e c e d in g c a s e w a s S e c o n d is t h e * o p e r a t o r. It is c a lle d t h e v a lu e a t a d d r e s s o p e r a t o r. It giv e s t h e v a lu e s t o r e d a t t h e p a r t ic u la r a d d r e s s . S o , * ( & iN u mb e r ) r e t u r n s t h e v a lu e a t 0 x 0 0 1 2 F F 3 C m e m o r y lo c a t io n , w h ic h is 3 . O n lin e 9 , p iN u mb e r is d e c la r e d a s t h e p o in t e r v a r ia b le , w h ic h m e a n s it is c a p a b le o f h o ld in g m e m o r y a d d r e s s e s . D e c la r in g in t *p iN u mb e r d o e s n o t m e a n t h a t p iN u mb e r c o n t a in s a n in t e ge r v a lu e . Wh a t it m e a n s is t h a t p iN u mb e r w ill h o ld t h e m e m o r y a d d r e s s o f a n in t e ge r v a r ia b le . S im ila r ly, F lo a t *p f m e a n s t h a t p f w ill h o ld t h e a d d r e s s o f a ﬂ o a t in g p o in t v a r ia b le . T h e o u t p u t o f t h e p r e c e d in g C / C ++ p r o gr a m is : A d d r e s s o f iN u mb e r = 0 x 0 0 1 2 F F 3 C A d d r e s s o f iN u mb e r = 0 x 0 0 1 2 F F 3 C A d d r e s s o f p iN u mb e r = 0 x 0 0 1 2 F F 3 8 V a lu e o f p iN u mb e r = 0 0 1 2 F F 3 C V a lu e o f iN u mb e r = 3 V a lu e o f iN u mb e r = 3 V a lu e o f iN u mb e r = 3 F ig u r e 8.2 : P o in t e r s .e x e o u t p u t Yo u w ill ge t d iﬀ e r e n t o u t p u t w h ile e x e c u t in g t h e p r e c e d in g c o d e . L e t u s s e e w h a t w e ge t o n c o m p ilin g t h e c o d e w it h a n d w it h o u t o p t im iz a t io n . P o in t e r w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 8.3 : P o in t e r w it h o u t O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 8.4 : P o in t e r s .a s m -P a r t 1 F ig u r e 8.5 : P o in t e r s .a s m -P a r t 2 F ig u r e 8.6: P o in t e r s .a s m -P a r t 3 T h e c o d e ge n e r a t e d c o n t a in s t w o s e gm e n t s : C O N S T n a m e d b y lin k e r ) a n d _TEX T s e gm e n t ( fo r c o d e ) . L e t ’s w a lk t h r o u gh t h e s e gm e n t s in t h e a s s e m b ly lis t in g: ▼L in e 1 2 -2 4 C O N S T S E G M E N T $S G 4 6 7 9 D B 0 a H , 'A d d r e s s o f iN u m b e r = 0 x %p ', 0 0 H O R G $+1 $S G 4 6 8 0 D B 0 a H , 'A d d r e s s o f iN u m b e r = 0 x %p ', 0 0 H O R G $+1 $S G 4 6 8 1 D B 0 a H , 'A d d r e s s o f p iN u m b e r = 0 x %p ', 0 0 H $S G 4 6 8 2 D B 0 a H , 'V a lu e o f p iN u m b e r = %p ', 0 0 H $S G 4 6 8 3 D B 0 a H , 'V a lu e o f iN u m b e r = %d', 0 0 H O R G $+1 $S G 4 6 8 4 D B 0 a H , 'V a lu e o f iN u m b e r = %d', 0 0 H O R G $+1 $S G 4 6 8 5 D B 0 a H , 'V a lu e o f iN u m b e r = %d', 0 0 H C O N S T E N D S C o n s t a n t s t r in gs in t h e c o d e a r e t e r m in a t e d b y z e r o b y t e a n d a r e a llo c a t e d in t h e C O N S T s e gm e n t , w h ic h c a n b e s e e n b y d u m p in g .r d a t a u s in g x 3 2 d b g. F ig u r e 8.7 : .r d a t a ▼L in e 2 8 -3 0 _TEX T S E G M E N T _p iN u m b e r $ = -8       ; s iz e = 4 _iN u m b e r $ = -4       ; s iz e = 4 To a c c e s s t h e lo c a l v a r ia b le o n t h e s t a c k fr a m e , w e h a v e t o a d d _ $ t o t h e E B P a d d r e s s . S o , t o a c c e s s t h e p iN u mb e r v a r ia b le o n s t a c k , w e h a v e t o a d d -8 t o t h e E B P a d d r e s s a n d a d d -4 t o E B P t o a c c e s s t h e iN u mb e r v a r ia b le . ▼L in e 3 1 -3 8 _m a in P R O C ; F ile c :\\ jit e n d e r n \\ r e b o o k \\ p o in t e r s \\ p o in t e r s \\ p o in t e r s .c p p ; L in e 7 p u s h e b p m o v e b p , e s p s u b e s p , 8 ; L in e 8 m o v D W O R D P T R _iN u m b e r $[e b p ], 3 L e t u s u n d e r s t a n d t h e ma in p r o c e d u r e b y p la c in g t h e b r e a k p o in t a t t h e s t a r t o f t h e ma in c a ll c a n b e lo c a t e d b y s c r o llin g t o t h e t o p o f t h e d is a s s e m b le d c o d e ) . O n c e t h e b r e a k p o in t is s e t , r u n t h e p r o gr a m a n d s t e p in t o t h e in s t r u c t io n s o n e b y o n e . T h e ma in p r o c e d u r e s t a r t s w it h a u s u a l fu n c t io n p r o lo gu e a n d t h e n w it h a S UB in s t r u c t io n . T h e S UB in s t r u c t io n is a llo c a t in g 8 b y t e s o n t h e s t a c k fo r t h e ma in fu n c t io n lo c a l v a r ia b le s . O n c e t h e s p a c e is a llo c a t e d o n s t a c k , t h e M O V in s t r u c t io n w ill p u s h 3 o n t h e m a in s t a c k fr a m e a t [E B P -0 x 4 ] a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.8: S t a c k s t a t e L in e 3 9 -4 0 ; L in e 1 0 le a e a x , D W O R D P T R _iN u m b e r $[e b p ] L o a d E ﬀ e c t iv e A d d r e s s lo a d s t h e a d d r e s s o f [E B P -0 x 4 ] in t o E A X . A s w e k n o w t h a t iN u mb e r = w h ic h is s t o r e d o n s t a c k a t [E B P - 0 x 4 ] = 0 x 0 0 1 2 F F 3 C m e m o r y lo c a t io n . T h is in s t r u c t io n lo a d s E A X w it h a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.9: L E A o u t p u t ▼L in e 4 1 m o v D W O R D P T R _p iN u m b e r $[e b p ], e a x T h is w ill m o v e t h e m e m o r y lo c a t io n s t o r e d in E A X o n t o t h e s t a c k a t [E B P -0 x 8 ]. N o w w e h a v e b o t h v a lu e s s t o r e d o n t h e s t a c k , in t e ge r v a lu e w h ic h is 0 x 0 0 0 0 0 0 0 3 a n d t h e p o in t e r t o t h e in t e ge r v a lu e , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 0 : p iN u m b e r o n s t a c k ▼L in e 4 2 -4 5 ; L in e 1 2 le a e c x , D W O R D P T R _iN u m b e r $[e b p ] p u s h e c x B e fo r e c a llin g t h e ﬁ r s t p r in t f fu n c t io n , w e w ill h a v e t o p u s h t h e a r gu m e n t s o n t o t h e s t a c k . T h e ﬁ r s t p a r a m e t e r t h a t w ill b e p u s h e d o n t h e s t a c k w ill b e t h e a d d r e s s o f L E A w ill lo a d t h e a d d r e s s o f iN u mb e r in t o E C X , w h ic h is la t e r p u s h e d o n t h e s t a c k , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 1 : B e fo r e c a llin g ﬁ r s t p r in t f fu n c t io n ▼L in e 4 5 -4 6 p u s h O F F S E T $S G 4 6 7 9 c a ll _p r in t f T h is p u s h in s t r u c t io n is p u s h in g a n o t h e r a r gu m e n t t o w h ic h is a s t r in g c o n s t a n t r e fe r r e d t o b y O n c e b o t h t h e p a r a m e t e r s a r e p u s h e d , c a ll t o t h e p r in t f fu n c t io n is m a d e . Wh ile d e b u ggin g in x 3 2 d b g, w e a r e s t e p p in g o v e r ( u s in g D e b u g > S t e p O v e r o p t io n ) d u r in g t h e p r in t f c a ll. R e t u r n fr o m t h e p r in t f fu n c t io n c a ll w ill p r in t o n t h e c o n s o le t h e A d d r e s s o f a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 2 : P o in t e r.e x e o u t p u t ▼L in e 4 7 a d d e s p , 8 O n r e t u r n in g fr o m t h e p r in t f p r o c e d u r e , t h e s t a c k is c le a n e d b y a d d in g 8 b y t e s t o E S P, a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 3 : S t a c k c le a n ▼L in e 4 8 -5 0 ; L in e 1 3 m o v e d x , D W O R D P T R _p iN u m b e r $[e b p ] p u s h e d x N o w t h is is p r e p a r in g t h e s t a c k fo r t h e s e c o n d p r in t f fu n c t io n c a ll. It w ill ﬁ r s t M O V t h e v a lu e s t o r e d a t [E B P -0 x 8 ] t o t h e E D X r e gis t e r a n d t h e n p u s h E D X o n t o t h e s t a c k , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 4 : E D X o n t o t h e s t a c k ▼L in e 5 1 -5 3 p u s h O F F S E T $S G 4 6 8 0 c a ll _p r in t f a d d e s p , 8 T h is is p u s h in g a n o t h e r a r gu m e n t t o t h e p r in t f fu n c t io n , w h ic h is a s t r in g c o n s t a n t o n t o t h e s t a c k . N o w a ga in , b o t h t h e a r gu m e n t s t o p r in t f a r e p u s h e d o n t h e s t a c k . T h e c a ll t o t h e p r in t f fu n c t io n is m a d e . O n r e t u r n , p r in t f w ill p r in t A d d r e s s o f iN u mb e r = p iN u mb e r a n d t h e s t a c k w ill a ga in b e c le a n e d a f t e r t h e r e t u r n . ▼L in e 5 4 -5 9 ; L in e 1 4 le a e a x , D W O R D P T R _p iN u m b e r $[e b p ] p u s h e a x p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f a d d e s p , 8 In t h ir d t h e p r in t f c a ll, w e h a v e t o p r in t t h e a d d r e s s o f w h ic h is F o r t h is , L E A is u s e d t o lo a d t h e a d d r e s s o f [E B P -0 x 8 ] t o E A X a n d t h e n p u s h e d o n t h e s t a c k b e fo r e t h e p r in t f c a ll. T h e s t r in g c o n s t a n t , r e p r e s e n t e d b y is a ls o p u s h e d o n t h e s t a c k b e fo r e a n o t h e r p r in t f c a ll, a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 5 : P r in t a d d r e s s o f p iN u m b e r ▼L in e 6 0 -6 2 ; L in e 1 5 m o v e c x , D W O R D P T R _p iN u m b e r $[e b p ] p u s h e c x N o w w e h a v e t o p r in t , v a lu e o f S o t h e M O V in s t r u c t io n w ill m o v e t h e p iN u mb e r v a r ia b le v a lu e a t [E B P -0 x 8 ] in t o E C X . In t h e n e x t in s t r u c t io n , it w ill p u s h E C X o n t o t h e s t a c k b e fo r e t h e p r in t f c a ll. ▼L in e 6 3 -6 5 p u s h O F F S E T $S G 4 6 8 2 c a ll _p r in t f a d d e s p , 8 T h e s e a r e t h e s a m e a s w e d id in t h e e a r lie r p r in t f c a ll. It t h e n c le a n s u p t h e s t a c k w it h t h e A D D in s t r u c t io n . ▼L in e 6 6 -7 1 ; L in e 1 6 m o v e d x , D W O R D P T R _iN u m b e r $[e b p ] p u s h e d x p u s h O F F S E T $S G 4 6 8 3 c a ll _p r in t f a d d e s p , 8 T h is in s t r u c t io n w ill m o v e t h e iN u mb e r v a r ia b le v a lu e a t [E B P -0 x 4 ] in t o E D X . B e fo r e t h e p r in t f c a ll, it p u s h e s b o t h t h e a r gu m e n t s ( s t r in g c o n s t a n t a n d E D X v a lu e ) o n t h e s t a c k . Wh a t e v e r is p u s h e d o n t o t h e s t a c k b e fo r e p u s h in g t h e s t r in g c o n s t a n t w ill b e p r in t e d o n t h e o u t p u t c o n s o le , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 6: P r in t in g iN u m b e r ▼L in e 7 2 -7 7 ; L in e 1 7 m o v e a x , D W O R D P T R _iN u m b e r $[e b p ] p u s h e a x p u s h O F F S E T $S G 4 6 8 4 c a ll _p r in t f a d d e s p , 8 T h e s e in s t r u c t io n s a r e d o in g t h e s a m e a s t h e e a r lie r o n e s , e x c e p t t h a t t h e y a r e u s in g E A X fo r p u s h in g t h e iN u mb e r v a r ia b le v a lu e a t [E B P -0 x 4 ] o n t o t h e s t a c k . ▼L in e 7 8 -8 0 ; L in e 1 8 m o v e c x , D W O R D P T R _p iN u m b e r $[e b p ] m o v e d x , D W O R D P T R [e c x ] T h e ﬁ r s t M O V in s t r u c t io n w ill m o v e t h e p iN u mb e r v a r ia b le v a lu e a t [E B P -0 x 8 ] in t o E C X . T h e s e c o n d in s t r u c t io n w ill m o v e t h e v a lu e s t o r e d a t a m e m o r y lo c a t io n p o in t e d b y E C X in t o E D X , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 7 : M O V [E C X ] in t o E D X ▼L in e 8 1 -8 4 p u s h e d x p u s h O F F S E T $S G 4 6 8 5 c a ll _p r in t f a d d e s p , 8 T h e p u s h in s t r u c t io n is p u s h in g t h e a r gu m e n t s o n t h e s t a c k b e fo r e t h e p r in t f c a ll. O n r e t u r n fr o m t h e p r in t f fu n c t io n , t h e v a lu e o f iN u mb e r w ill b e p r in t e d o n t h e c o n s o le . S t a c k c le a n in g is d o n e w it h t h e A D D in s t r u c t io n , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 8.1 8: iN u m b e r w ill b e p r in t e d ▼L in e 8 5 -9 2 ; L in e 1 9 x o r e a x , e a x m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D T h e r e m a in in g in s t r u c t io n s a r e t h e s a m e a s w h a t w e d is c u s s e d in t h e e a r lie r s e c t io n s . T h e m a in fu n c t io n e p ilo gu e is c a lle d t o e n d t h e s e gm e n t a n d c o d e . P o in t e r w it h O p t imiz a t io n C o m p ile t h e c o d e w it h o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 8.1 9: P o in t e r w it h O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 8.2 0 : P o in t e r s -O p t im iz e d .a s m -P a r t 1 F ig u r e 8.2 1 : P o in t e r s -O p t im iz e d .a s m -P a r t 2 F ir s t , w e w ill t a lk a b o u t t h e d iﬀ e r e n c e in t h e o p t im iz e d a n d n o n - o p t im iz e d c o d e ge n e r a t e d . In o p t im iz e d c o d e , t h e fu n c t io n p r o lo gu e is r e m o v e d , s o a ll t h e p la c e s w h e r e E B P is r e fe r r e d is r e p la c e d w it h E S P. S o , in t h e o p t im iz e d a s s e m b ly lis t in g, w e w ill o b s e r v e t h e E S P r e fe r e n c e in p la c e o f E B P a s w e o b s e r v e d in t h e n o n -o p t im iz e d a s s e m b ly lis t in g. To e x p la in t h is c o n c e p t , w e w ill c h e c k t h e s t a c k s t a t e in d e t a il fo r a b e t t e r u n d e r s t a n d in g. L e t ’s w a lk t h r o u gh t h e a s s e m b ly lis t in g b y p la c in g b r e a k p o in t a t t h e s t a r t o f t h e ma in p r o c e d u r e : ▼L in e 3 3 -3 4 ; L in e 7 s u b e s p , 8 T h is is t h e s t a r t o f t h e ma in p r o c e d u r e , w h e r e E S P is s u b t r a c t e d b y 8 b y t e s t o c r e a t e r o o m fo r t h e ma in fu n c t io n lo c a l v a r ia b le s , w h ic h a r e in t e ge r v a r ia b le a n d p o in t e r t o t h a t in t e ge r v a r ia b le B e fo r e t h e e x e c u t io n o f t h is in s t r u c t io n , t h e s t a c k w ill lo o k a s fo llo w s : F ig u r e 8.2 2 : S t a r t o f t h e m a in p r o c e d u r e ▼L in e 3 5 -3 6 ; L in e 1 0 le a e a x , D W O R D P T R _iN u m b e r $[e s p +8 ] T h e L o a d e ﬀ e c t iv e a d d r e s s w ill lo a d E A X w it h t h e a d d r e s s o f w h ic h is e v a lu a t e d t o : le a e a x , D W O R D P T R s s :[e s p ] a s _iN u m b e r $ = -8 A s w e c a n s e e , E A X is ﬁ lle d w it h 0 x 0 0 1 2 F F 3 C , w h ic h is E S P it s e lf. N o w , E A X a ls o p o in t s t o t h e t o p o f t h e s t a c k a s fo llo w s : F ig u r e 8.2 3 : E A X a ls o p o in t s t o t h e t o p o f s t a c k ▼L in e 3 7 -3 9 ; L in e 1 2 m o v e c x , e a x p u s h e c x M o v e E A X t o E C X . N o w , E C X is a ls o ﬁ lle d w it h w h ic h is p u s h e d o n t h e s t a c k w it h t h e p u s h e c x in s t r u c t io n . Wit h t h is , o u r o n e a r gu m e n t t o t h e p r in t f fu n c t io n is p u s h e d o n t h e s t a c k . ▼L in e 4 0 p u s h O F F S E T $S G 4 6 7 9 T h is w ill p u s h t h e s t r in g c o n s t a n t o n t h e s t a c k , w h ic h is a n o t h e r a r gu m e n t t o t h e p r in t f fu n c t io n . A s w e c a n s e e , b o t h t h e a r gu m e n t s t o t h e p r in t f fu n c t io n a r e p u s h e d o n t h e s t a c k . T h e s t a c k s t a t e is s h o w n in t h e fo llo w in g s c r e e n s h o t a n d c a n b e u n d e r s t o o d in t h e fo llo w in g m a n n e r : [E S P ]  0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0    “ \\ n A d d r e s s o f iN u mb e r = 0 x %p ” , a r g t o p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 8 ] 0 0 1 2 F F 3 C   JUN K JUN K    T h is w h e r e w e w ill s t o r e iN u mb e r [E S P +0 x C ] 0 0 1 2 F F 4 0   JUN K JUN K    T h is w h e r e w e w ill s t o r e & iN u mb e r [E S P +0 x 1 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.2 4 : S t a c k s t a t e ▼L in e 4 1 -4 2 m o v D W O R D P T R _iN u m b e r $[e s p +1 6 ], 3 m o v D W O R D P T R _p iN u m b e r $[e s p +1 6 ], e a x B o t h in s t r u c t io n s a r e e v a lu a t e d t o : m o v d w o r d p t r s s :[e s p +0 x 8 ], 0 x 3 m o v d w o r d p t r s s :[e s p +0 x C ], e a x E a r lie r, in t h e s t a c k s t a t e , w e a llo c a t e d r o o m fo r lo c a l v a r ia b le s o f t h e ma in fu n c t io n o n t h e s t a c k ( s h o w n a s in s t a c k s t a t e ) . N o w , u s in g t h e s e in s t r u c t io n s , w e a r e s t o r in g t h e in t e ge r v a r ia b le 0 x 0 0 0 0 0 0 0 3 a t [E S P +0 x 8 ] a n d t h e p o in t e r t o t h is v a r ia b le a t [E S P +0 x C ]. N o w , t h e s t a c k w ill lo o k lik e a s fo llo w s : [E S P ]  0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0    \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 1 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.2 5 : A f t e r L in e 4 1 -4 2 e x e c u t io n ▼L in e 4 3 c a ll _p r in t f O n c e t h e a r gu m e n t s a r e p u s h e d o n t h e s t a c k , c a ll t o p r in t f is m a d e . A s p e r t h e C / C ++ c o d e a t lin e 1 2 : p r in t f ( \" \\ n A d d r e s s o f iN u m b e r = 0 x %p \", & iN u m b e r ) ; S o , o n r e t u r n in g fr o m t h e p r in t f c a ll, t h e fo llo w in g w ill b e p r in t e d o n t h e c o n s o le : F ig u r e 8.2 6: A f t e r p r in t f e x e c u t io n ▼L in e 4 4 -4 8 ; L in e 1 3 m o v e d x , D W O R D P T R _p iN u m b e r $[e s p +1 6 ] p u s h e d x p u s h O F F S E T $S G 4 6 8 0 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 3 p r in t s w h ic h is t h e m e m o r y lo c a t io n o f p r in t f ( \" \\ n A d d r e s s o f iN u m b e r = 0 x %p \", p iN u m b e r ) ; In o u r a s s e m b ly c o d e , a r gu m e n t s t o t h e p r in t f fu n c t io n a r e p u s h e d o n t h e s t a c k b y ﬁ r s t m o v in g E D X w it h t h e p o in t e r t o t h e In t e ge r v a r ia b le . T h e s a m e E D X is t h e n p u s h e d o n t o s t a c k w it h a n o t h e r p u s h o f s t r in g c o n s t a n t . O n c e w e h a v e b o t h a r gu m e n t s t o p r in t f fu n c t io n o n s t a c k , c a ll t o p r in t f fu n c t io n is m a d e . A s s h o w n in t h e s t a c k s t a t e a n d t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 2 C   0 0 4 0 8 1 5 C   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 3 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 C ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x 1 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 1 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.2 7 : A f t e r t h e s e c o n d p r in t f e x e c u t io n ▼L in e 4 9 -5 3 ; L in e 1 4 le a e a x , D W O R D P T R _p iN u m b e r $[e s p +2 4 ] p u s h e a x p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 4 p r in t s w h ic h is t h e m e m o r y lo c a t io n o f p r in t f ( \" \\ n A d d r e s s o f p iN u m b e r = 0 x %p \", & p iN u m b e r ) ; In o u r a s s e m b ly c o d e , t h e L E A in s t r u c t io n w ill b e e v a lu a t e d t o : le a e a x , s s :[e s p +0 x 1 4 ] L E A w ill lo a d E A X w it h t h e m e m o r y a d d r e s s o f w h ic h is t h e a d d r e s s o f O n c e E A X is lo a d e d w it h t h e a d d r e s s , it is p u s h e d o n t o t h e s t a c k w it h a n o t h e r p u s h o f t h e s t r in g c o n s t a n t . O n c e w e h a v e b o t h a r gu m e n t s t o t h e p r in t f fu n c t io n o n t h e s t a c k , c a ll t o t h e p r in t f fu n c t io n is m a d e . T h is is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 2 4   0 0 4 0 8 1 7 8   \" \\ n A d d r e s s o f p iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0   & p iN u m b e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] 0 0 1 2 F F 2 C   0 0 4 0 8 1 5 C   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 C ] 0 0 1 2 F F 3 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x 1 C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 2 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.2 8: A f t e r t h r id p r in t f e x e c u t io n ▼L in e 5 4 -5 8 ; L in e 1 5 m o v e c x , D W O R D P T R _p iN u m b e r $[e s p +3 2 ] p u s h e c x p u s h O F F S E T $S G 4 6 8 2 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 5 p r in t s w h ic h is t h e m e m o r y lo c a t io n o f p r in t f ( \" \\ n V a lu e o f p iN u m b e r = %p \", p iN u m b e r ) ; In o u r a s s e m b ly c o d e , t h e M O V in s t r u c t io n w ill b e e v a lu a t e d t o : m o v e c x , d w o r d p t r s s :[e s p +0 x 1 C ] M O V w ill m o v e t h e v a lu e a t s s :[e s p +0 x 1 C ] t o E C X , w h ic h p o in t s t o t h e m e m o r y lo c a t io n o f N o w , t h e a r gu m e n t s a r e a ga in p u s h e d t o t h e s t a c k fo r c a ll t o t h e p r in t f fu n c t io n . T h is is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 1 C   0 0 4 0 8 1 9 4   \" \\ n V a lu e o f p iN u mb e r = %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 2 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] 0 0 1 2 F F 2 4   0 0 4 0 8 1 7 8   \" \\ n A d d r e s s o f p iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 C ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0   & p iN u m b e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 2 C   0 0 4 0 8 1 5 C   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 4 ] 0 0 1 2 F F 3 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 8 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 C ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 0 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x 2 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 2 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.2 9: A f t e r fo u r t h p r in t f e x e c u t io n ▼L in e 5 9 -6 3 ; L in e 1 6 m o v e d x , D W O R D P T R _iN u m b e r $[e s p +4 0 ] p u s h e d x p u s h O F F S E T $S G 4 6 8 3 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 6 p r in t s w h ic h is t h e v a lu e o f p r in t f ( \" \\ n V a lu e o f iN u m b e r = %d\", iN u m b e r ) ; In o u r a s s e m b ly c o d e , t h e M O V in s t r u c t io n w ill b e e v a lu a t e d t o : m o v e d x , d w o r d p t r s s :[e s p +0 x 2 0 ] M O V w ill m o v e t h e v a lu e a t s s :[e s p +0 x 2 0 ] t o E D X , w h ic h is t h e v a lu e o f N o w , t h e a r gu m e n t s a r e a ga in p u s h e d t o t h e s t a c k fo r c a ll t o t h e p r in t f fu n c t io n . T h is is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 1 4   0 0 4 0 8 1 A C    \" \\ n V a lu e o f iN u mb e r = %d \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 4 0 8 1 9 4   \" \\ n V a lu e o f p iN u mb e r = %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 C ] 0 0 1 2 F F 2 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 2 4   0 0 4 0 8 1 7 8   \" \\ n A d d r e s s o f p iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 4 ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0   & p iN u m b e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 4 0 8 1 5 C   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.3 0 : A f t e r ﬁ f t h p r in t f e x e c u t io n ▼L in e 6 4 -6 8 ; L in e 1 7 m o v e a x , D W O R D P T R _iN u m b e r $[e s p +4 8 ] p u s h e a x p u s h O F F S E T $S G 4 6 8 4 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 7 p r in t s w h ic h it s e lf is t h e v a lu e o f p r in t f ( \" \\ n V a lu e o f iN u m b e r = %d\", *( & iN u m b e r ) ) ; In o u r a s s e m b ly c o d e , t h e M O V in s t r u c t io n w ill b e e v a lu a t e d t o : m o v e a x , d w o r d p t r s s :[e s p +0 x 2 8 ] M O V w ill m o v e t h e v a lu e a t s s :[e s p +0 x 2 8 ] t o E A X , w h ic h is t h e v a lu e o f N o w , t h e a r gu m e n t s a r e a ga in p u s h e d t o t h e s t a c k fo r c a ll t o t h e p r in t f fu n c t io n . A s s h o w n in t h e s t a c k s t a t e a n d t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 0 C   0 0 4 0 8 1 C 4   \" \\ n V a lu e o f iN u mb e r = %d \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 3   *( & iN u m b e r ) is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] 0 0 1 2 F F 1 4   0 0 4 0 8 1 A C   \" \\ n V a lu e o f iN u mb e r = %d \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 1 C   0 0 4 0 8 1 9 4   \" \\ n V a lu e o f p iN u mb e r = %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 4 ] 0 0 1 2 F F 2 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 8 ] 0 0 1 2 F F 2 4   0 0 4 0 8 1 7 8   \" \\ n A d d r e s s o f p iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 C ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0   & p iN u m b e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 0 ] 0 0 1 2 F F 2 C   0 0 4 0 8 1 5 C   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 2 4 ] 0 0 1 2 F F 3 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 8 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 2 C ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 3 0 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x 3 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 3 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.3 1 : A f t e r s ix t h p r in t f e x e c u t io n ▼L in e 6 9 -7 4 ; L in e 1 8 m o v e c x , D W O R D P T R _p iN u m b e r $[e s p +5 6 ] m o v e d x , D W O R D P T R [e c x ] p u s h e d x p u s h O F F S E T $S G 4 6 8 5 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 7 p r in t s w h ic h it s e lf is t h e v a lu e o f p r in t f ( \" \\ n V a lu e o f iN u m b e r = %d\", *p iN u m b e r ) ; In o u r a s s e m b ly c o d e , w e s e e t w o M O V in s t r u c t io n s , w h e r e o n e m o v e in s t r u c t io n t a k e s t h e m e m o r y lo c a t io n o f iN u mb e r a n d t h e o t h e r fe t c h e s t h e v a lu e s t o r e d a t t h a t m e m o r y a d d r e s s . T h e ﬁ r s t M O V in s t r u c t io n is r e s o lv e d t o : m o v e c x , d w o r d p t r s s :[e s p +0 x 3 4 ] T h is M O V w ill m o v e t h e v a lu e a t s s :[e s p +0 x 3 4 ] t o E C X , w h ic h is t h e m e m o r y lo c a t io n o f T h e s e c o n d M O V fe t c h e s t h e v a lu e s t o r e d a t t h e m e m o r y a d d r e s s in E C X a n d m o v e s it t o E D X . N o w , t h e a r gu m e n t s a r e a ga in p u s h e d t o t h e s t a c k fo r c a ll t o t h e p r in t f fu n c t io n . T h is is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 0 4   0 0 4 0 8 1 D C   \" \\ n V a lu e o f iN u mb e r = %d \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 3   *p iN u m b e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] 0 0 1 2 F F 0 C   0 0 4 0 8 1 C 4   \" \\ n V a lu e o f iN u mb e r = %d \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 C ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 3   *( & iN u m b e r ) is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 1 4   0 0 4 0 8 1 A C   \" \\ n V a lu e o f iN u mb e r = %d \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 1 8 ] 0 0 1 2 F F 1 C   0 0 4 0 8 1 9 4   \" \\ n V a lu e o f p iN u mb e r = %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 1 C ] 0 0 1 2 F F 2 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 0 ] 0 0 1 2 F F 2 4   0 0 4 0 8 1 7 8   \" \\ n A d d r e s s o f p iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 2 4 ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0   & p iN u m b e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 2 8 ] 0 0 1 2 F F 2 C   0 0 4 0 8 1 5 C   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 2 C ] 0 0 1 2 F F 3 0   0 0 1 2 F F 3 C   p iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 3 0 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   \" \\ n A d d r e s s o f iN u mb e r = 0 x %p \", a r gu me n t t o p r in t f( ) [E S P +0 x 3 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e , a r gu me n t t o p r in t f( ) [E S P +0 x 3 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u mb e r is s t o r e d h e r e    [E S P +0 x 3 C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 3 C   & iN u mb e r is s t o r e d h e r e    [E S P +0 x 4 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2   r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.3 2 : A f t e r s e v e n t h p r in t f e x e c u t io n ▼L in e 7 5 -8 1 ; L in e 1 9 x o r e a x , e a x a d d e s p , 6 4      ; 0 0 0 0 0 0 4 0 H r e t 0 _m a in E N D P _TEX T E N D S E N D X O R a n d A D D w ill c le a n u p t h e E A X a n d s t a c k , r e s p e c t iv e ly a n d E N D t h e c o d e b y r e t u r n in g 0 . T h e A D D in s t r u c t io n c le a n e d u p t h e s t a c k in o n e go , w h ic h is d iﬀ e r e n t fr o m t h a t in t h e n o n - o p t im iz e d c o d e , w h e r e in w e c le a n e d t h e s t a c k a f t e r e a c h p r in t f c a ll. T h is is s h o w n in t h e s t a c k s t a t e b e lo w a n d t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 7 2    r e t u r n t o 0 x 0 0 4 0 1 2 7 2 fr o m 0 x 4 0 1 0 0 0 F ig u r e 8.3 3 : C le a n in g s t a c k C o n c lu s io n In t h is c h a p t e r, w e le a r n e d t h e c o n c e p t u a l k n o w le d ge a b o u t p o in t e r s . W e a ls o le a r n e d h o w p o in t e r s a r e s t o r e d in m e m o r y w it h r e s p e c t t o in t e ge r, ﬂ o a t , a n d c h a r p o in t e r s . W e a ls o fo u n d o u t h o w n o n -o p t im iz e d c o d e is d iﬀ e r e n t fr o m o p t im iz e d a s s e m b ly c o d e . T h e n o n -o p t im iz e d c o d e u s e s E B P t o r e fe r t o a r gu m e n t s o n t h e s t a c k a n d t h e s t a c k c le a n in g is d o n e a f t e r e v e r y p r in t f c a ll. B u t in c a s e o f o p t im iz e d c o d e , E S P is u s e d t o r e fe r t o t h e a r gu m e n t s a n d t h e s t a c k c le a n in g is d o n e in o n e go t o w a r d s t h e E N D o f t h e c o d e . In t h e n e x t c h a p t e r, w e w ill t a lk a b o u t a n o t h e r in t e r e s t in g t o p ic , w h ic h is d e c is io n . W e w ill s e e h o w d e c is io n s s t a t e m e n t s a r e h a n d le d in a s s e m b ly p r o gr a m m in g. C H A P T E R 9 R e v e r s e E n gin e e r in g P a t t e r n o f D e c is io n C o n t r o l S t r u c t u r e In o u r d a y -t o -d a y life , w e t a k e m a n y d e c is io n s a n d e v e r y d e c is io n is r e la t e d t o a n o u t c o m e . L e t ’s t a k e a n e x a m p le . B e fo r e le a v in g h o m e fo r o ﬃ c e , w e a ll p r e fe r t o c h e c k G o o gle m a p s a n d if t h e t r a ﬃ c is h igh , w e m a y a s k o u r b o s s fo r p e r m is s io n t o w o r k fr o m h o m e . A n o t h e r e x a m p le is if I e a r n m o r e , I w ill p u r c h a s e a n ic e lu x u r y c a r a n d a b ig h o u s e . A ll t h e s e d e c is io n s a r e lin k e d w it h s o m e c o n d it io n a n d r e s u lt in c e r t a in o u t c o m e s . S im ila r t o t h is , c o m p u t e r s a r e a ls o p r o gr a m m e d t o m a k e d e c is io n s b a s e d o n c o n d it io n s . C / C ++ p r o gr a m m in g a ls o p r o v id e s d e c is io n - m a k in g s t a t e m e n t s , w h ic h h e lp p r o gr a m m e r s t o w r it e c o d e t h a t in v o lv e s d e c is io n s b a s e d o n t h e c o n d it io n s . D iﬀ e r e n t c o n d it io n s a r e lin k e d t o t h e o u t c o m e s t o b e h a v e in t h e n a t u r a l m a n n e r. T h is c h a p t e r w ill h e lp y o u u n d e r s t a n d t h e p a t t e r n o f t h e s e c o n d it io n s in a s s e m b lin g lis t in g fr o m t h e r e v e r s e e n gin e e r in g p o in t o f v ie w . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : If-e ls e s t a t e m e n t If-e ls e s t a t e m e n t w it h o u t O p t im iz a t io n If-e ls e s t a t e m e n t w it h O p t im iz a t io n O b je c t iv e T h e o b je c t iv e o f t h is c h a p t e r is t o u n d e r s t a n d t h e c o n c e p t o f a s s e m b ly in s t r u c t io n s u s e d t o m a k e d e c is io n s in a p r o gr a m ﬂ o w . W e w ill le a r n a b o u t C M P a n d Ju m p in s t r u c t io n s in t h e a s s e m b ly c o d e . A s w e t e n d t o t a k e s e v e r a l d e c is io n s fo r a s in gle p r o b le m in o u r d a y -t o -d a y life , s im ila r ly t o h a n d le p r o b le m s o r c o n d it io n s in a s s e m b ly w e h a v e C M P a n d ju m p in s t r u c t io n s in a s s e m b ly. W e w ill a ls o u n d e r s t a n d t h e d iﬀ e r e n t ia t io n b e t w e e n o p t im iz e d a n d n o n -o p t im iz e d a s s e m b ly c o d e o f d e c is io n c o n t r o l s t r u c t u r e s . If-e ls e s t a t e me n t In t h is s e c t io n , w e w ill c o v e r s im p le C / C ++ c o d e w it h if-e ls e s t a t e m e n t , w h e r e in w e w ill a s k t h e u s e r t o e n t e r t w o in t e ge r n u m b e r s . If b o t h t h e n u m b e r s a r e e q u a l, it p r in t s s a y in g t h a t b o t h t h e n u m b e r s a r e e q u a l o n t h e c o n s o le . B u t if b o t h t h e e n t e r e d n u m b e r s a r e n o t e q u a l, t h e c o d e w ill u s e e ls e s t a t e m e n t t o p r in t , t h e n u m b e r s a r e n o t e q u a l. T h is c o d e a ls o in c lu d e s s c a n f a n d p r in t f in o u r C / C ++ c o d e . It is r e c o m m e n d e d t o go t h r o u gh C h a p t e r 7 , R e v e r s e E n g in e e r in g P a t t e r n o f P r in t f fo r a c le a r u n d e r s t a n d in g. F ig u r e 9.1 : ife ls e .c p p If-e ls e s t a t e me n t w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 9.2 : If-e ls e s t a t e m e n t w it h o u t O p t im iz a t io n T h is w ill ge n e r a t e t h e a s s e m b ly c o d e a n d t h e E X E ﬁ le . F o r a n a ly s is p u r p o s e , w e w ill d is a b le t h e A d d r e s s S p a c e L a y o u t R a n d o miz a t io n It is a s e c u r it y m e c h a n is m b y w h ic h t h e b a s e a d d r e s s o f t h e P E ﬁ le is r a n d o m iz e d o n e v e r y lo a d o f t h e P o r t a b le E x e c u t a b le ﬁ le ge n e r a t e d w it h o u r M S V C c o m p ile r. To d is a b le A S L R , fo llo w t h e s a m e s t e p s b y u s in g t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n F o r m o r e d e t a ils , r e fe r t o t h e A p p e n d ix . N o w , le t u s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 9.3 : ife ls e .a s m -P a r t -1 F ig u r e 9.4 : ife ls e .a s m -P a r t -2 L e t ’ s w a lk t h r o u gh t h e a s s e m b ly c o d e lin e b y lin e . A s w e h a v e d is c u s s e d m o s t o f t h e in it ia l a s s e m b ly lis t in g in t h e e a r lie r c h a p t e r s , w e w ill m o v e o n t o t h e in s t r u c t io n s fr o m t h e s t a r t o f t h e ma in p r o c e d u r e . ▼L in e 3 4 -3 7 ; L in e 7 p u s h e b p m o v e b p , e s p s u b e s p , 8 It s t a r t s w it h t h e ma in fu n c t io n p r o lo gu e . Wit h t h e S UB in s t r u c t io n , w e a r e c r e a t in g r o o m fo r t h e lo c a l v a r ia b le s o f w h ic h a r e iN u mb e r 1 a n d E a c h n u m b e r w ill o c c u p y 4 b y t e s o f s p a c e , m a k in g it a t o t a l o f 8 b y t e s . To a n a ly z e t h e s t a c k s t a t e , le t u s o p e n t h e P E ﬁ le ge n e r a t e d in x 3 2 d b g a n d p la c e a b r e a k p o in t a t t h e s t a r t o f t h e ma in p r o c e d u r e . W e w ill s t e p in t o t h e c o d e t o s e e t h e s t a c k s t a t e a f t e r t h e S UB in s t r u c t io n . [E S P ]  0 0 1 2 F F 3 8   0 0 4 0 3 8 D D    [EB P -8 ] n o w JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 4 ] 0 0 1 2 F F 3 C   0 0 4 0 4 4 5 A   [EB P -4 ] n o w JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 8 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 iN u mb e r 1 c a n b e a c c e s s e d w it h t h e h e lp o f t h e _iN u mb e r 1 $ m a c r o , w h ic h is e q u a l t o -8 . S o , iN u mb e r 1 c a n b e a c c e s s e d b y a d d in g E B P w it h t h e _iN u mb e r 1 $ m a c r o , w h ic h is e q u a l t o [E B P - 8 ]. F ig u r e 9.5 : C r e a t in g r o o m fo r o u r lo c a l v a r ia b le ▼L in e 3 8 -4 1 ; L in e 1 0 p u s h O F F S E T $S G 4 6 7 9 c a ll _p r in t f a d d e s p , 4 T h e C / C ++ c o d e o n lin e 1 0 p r in t s t h e s t r in g o n t h e c o n s o le : p r in t f( \" In p u t N u m b e r 1 : \" ) ; In o u r a s s e m b ly c o d e , t h e a r gu m e n t t o t h e p r in t f fu n c t io n is ﬁ r s t p u s h e d o n t o t h e s t a c k . T h e a r gu m e n t o f p r in t f is a s t r in g c o n s t a n t s t o r e d in t h e .r d a t a s e gm e n t a n d in t e r n a lly d e ﬁ n e d a s A c a ll t o p r in t f w ill p r in t $S G 4 6 7 9 o n t h e c o n s o le a n d t h e A D D in s t r u c t io n a f t e r c a ll t o p r in t f is c le a n in g t h e s t a c k b y 4 b y t e s . [E S P -0 x 4 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 4 0   \" In p u t N u mb e r 1 : \", p a r a me t e r t o 1 s t p r in t f( ) [E S P ]  0 0 1 2 F F 3 8   0 0 4 0 3 8 D D    [EB P -8 ] n o w JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 4 ] 0 0 1 2 F F 3 C   0 0 4 0 4 4 5 A   [EB P -4 ] n o w JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 8 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.6: C a ll t o p r in t f ▼L in e 4 2 -4 7 ; L in e 1 1 le a e a x , D W O R D P T R _iN u m b e r 1 $[e b p ] p u s h e a x p u s h O F F S E T $S G 4 6 8 0 c a ll _s c a n f a d d e s p , 8 T h e C / C ++ c o d e o n lin e 1 1 t a k e s t h e in p u t in t e ge r fr o m t h e u s e r a n d s t o r e s it a t t h e & iN u mb e r 1 m e m o r y lo c a t io n : s c a n f( \" %d\", & iN u m b e r 1 ) ; In o u r a s s e m b ly c o d e , L E A w ill e ﬀ e c t iv e ly lo a d t h e a d d r e s s o f w h ic h is in t o t h e E A X r e gis t e r. T h e p u r p o s e o f lo a d in g E A X w it h t h e a d d r e s s o f _iN u mb e r 1 $[e b p ] is t o p u s h t h e E A X r e gis t e r o n t h e s t a c k a lo n g w it h t h e s t r in g c o n s t a n t B o t h t h e a d d r e s s a n d s t r in g $S G 4 6 8 0 a r e a r gu m e n t s t o t h e s c a n f fu n c t io n . To c h e c k t h e s t a c k s t a t e a f t e r t h e s c a n f fu n c t io n c a ll, p u t a n o t h e r b r e a k p o in t a t A D D in s t r u c t io n a f t e r t h e s c a n f c a ll. N o w s t e p in t o t h e in s t r u c t io n s o n e b y o n e a n d o n c a ll t o d o a s t e p o v e r. It w ill p r o m p t y o u t o e n t e r t h e ﬁ r s t n u m b e r o n t h e c o n s o le . W e w ill e n t e r n u m b e r 7 a n d p r e s s A f t e r p r e s s in g n u m b e r 7 w ill b e s a v e d o n t o t h e s t a c k a t t h e in p u t p la c e h o ld e r fo r t h e iN u mb e r 1 m e m o r y lo c a t io n , Wit h t h e s c a n f c a ll, t h e n u m b e r in p u t b y t h e u s e r is s a v e d o n t o t h e s t a c k . A f t e r t h e c a ll, it is t im e t o a ga in c le a n u p t h e s t a c k w it h t h e A D D in s t r u c t io n . A D D w ill m o v e t h e s t a c k p o in t e r b y 8 b y t e s fo r c le a n in g. T h e s t a c k s t a t e is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x 8 ] 0 0 1 2 F F 3 0   0 0 4 0 A 1 5 4   \" %d \", p a r a me t e r t o 1 s t s c a n f( ) [E S P -0 x 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 8   Me mo r y lo c a t io n o f p la c e h o ld e r fo r iN u mb e r 1 [E S P ]  0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7    [EB P -8 ] 7 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x C ] 0 0 1 2 F F 3 C   0 0 4 0 4 4 5 A   [EB P -4 ] n o w JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.7 : A f t e r s c a n f ▼L in e 4 8 -5 1 ; L in e 1 2 p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f a d d e s p , 4 T h e C / C ++ c o d e o n lin e 1 2 p r in t s t h e s t r in g o n t h e c o n s o le : p r in t f( \" In p u t N u m b e r 2 : \" ) ; It is t h e s a m e a s t h e e a r lie r. T h e a r gu m e n t t o t h e p r in t f fu n c t io n is ﬁ r s t p u s h e d o n t o t h e s t a c k . T h e a r gu m e n t o f p r in t f is a s t r in g c o n s t a n t s t o r e d in t h e .r d a t a s e gm e n t a n d in t e r n a lly d e ﬁ n e d a s A c a ll t o p r in t f w ill p r in t $S G 4 6 8 1 o n t h e c o n s o le a n d t h e A D D in s t r u c t io n fo llo w in g t h e c a ll t o p r in t f w ill c le a n t h e s t a c k b y 4 b y t e s . T h e s t a c k s t a t e is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x 4 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 5 8   \" In p u t N u mb e r 2 : \", p a r a me t e r t o 2 n d p r in t f( ) [E S P ]  0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7    [EB P -8 ] 7 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x C ] 0 0 1 2 F F 3 C   0 0 4 0 4 4 5 A   [EB P -4 ] n o w JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.8: A g a in c a ll t o p r in t f ▼L in e 5 2 -5 7 ; L in e 1 3 le a e c x , D W O R D P T R _iN u m b e r 2 $[e b p ] p u s h e c x p u s h O F F S E T $S G 4 6 8 2 c a ll _s c a n f a d d e s p , 8 T h e C / C ++ c o d e o n lin e 1 3 t a k e s t h e in p u t in t e ge r fr o m t h e u s e r a n d s t o r e s it a t t h e & iN u mb e r 2 m e m o r y lo c a t io n : s c a n f( \" %d\", & iN u m b e r 2 ) ; It is s a m e a s t h e e a r lie r s c a n f c o d e . L E A w ill e ﬀ e c t iv e ly lo a d t h e a d d r e s s o f w h ic h is in t o t h e E C X r e gis t e r. T h e p u r p o s e o f lo a d in g E C X w it h t h e a d d r e s s o f _iN u mb e r 2 $[e b p ] is t o p u s h t h e E C X r e gis t e r o n t h e s t a c k a lo n g w it h t h e s t r in g c o n s t a n t B o t h t h e a d d r e s s a n d s t r in g $S G 4 6 8 2 a r e a r gu m e n t s t o t h e s c a n f fu n c t io n . To c h e c k t h e s t a c k s t a t e a f t e r t h e s c a n f fu n c t io n c a ll, p u t a n o t h e r b r e a k p o in t a t A D D in s t r u c t io n a f t e r t h e s c a n f c a ll. N o w s t e p in t o t h e in s t r u c t io n s o n e b y o n e a n d o n c a ll t o d o a s t e p o v e r. It w ill p r o m p t y o u t o e n t e r t h e s e c o n d n u m b e r o n t h e c o n s o le . W e w ill e n t e r n u m b e r 8 a n d p r e s s A f t e r p r e s s in g n u m b e r 8 w ill b e s a v e d o n t o t h e s t a c k a t t h e in p u t p la c e h o ld e r fo r t h e iN u mb e r 2 m e m o r y lo c a t io n , Wit h t h e s c a n f c a ll, t h e n u m b e r in p u t b y t h e u s e r is s a v e d o n t o t h e s t a c k . A f t e r t h e c a ll, it is t im e t o a ga in c le a n u p t h e s t a c k w it h t h e A D D in s t r u c t io n . A D D w ill m o v e t h e s t a c k p o in t e r b y 8 b y t e s fo r c le a n in g. T h e s t a c k s t a t e is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x 8 ] 0 0 1 2 F F 3 0   0 0 4 0 A 1 6 C   \" %d \", p a r a me t e r t o 2 n d s c a n f( ) [E S P -0 x 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 C   Me mo r y lo c a t io n o f p la c e h o ld e r fo r iN u mb e r 2 [E S P ]  0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7    [EB P -8 ] 7 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 8   [EB P -4 ] 8 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.9: A g a in a f t e r a n o t h e r s c a n f ▼L in e 5 8 -6 1 ; L in e 1 4 m o v e d x , D W O R D P T R _iN u m b e r 1 $[e b p ] c m p e d x , D W O R D P T R _iN u m b e r 2 $[e b p ] jn e S H O R T $L N 2 @m a in T h e C / C ++ c o d e o n lin e 1 4 c o m p a r e s t h e t w o n u m b e r s : if ( iN u m b e r 1 == iN u m b e r 2 ) N o w w e h a v e b o t h t h e n u m b e r s iN u mb e r 1 a n d iN u mb e r 2 s t o r e d a t [E B P -8 ] a n d [E B P -4 ], r e s p e c t iv e ly. To c o m p a r e t h e s e t w o n u m b e r s , t h e ﬁ r s t M O V in s t r u c t io n w ill m o v e t h e v a lu e s t o r e d a t [E B P -8 ] t o t h e E D X r e gis t e r, w h ic h is n u m b e r 0 x 0 0 0 0 0 0 0 7 a n d t h e n u s e t h e C M P in s t r u c t io n t o c o m p a r e t h e v a lu e s t o r e d a t [E B P -4 ] w it h t h a t o f t h e E D X r e gis t e r. In o u r c a s e , E D X = 0 x 0 0 0 0 0 0 0 7 is c o m p a r e d w it h [E B P -8 ] = T h e C M P in s t r u c t io n c a n b e v is u a liz e d a s a S UB in s t r u c t io n a n d a s it is a c o n d it io n a l it w ill w o r k a s fo llo w s : [E D X ] - [E B P -8 ], b a s e d o n t h e s u b t r a c t io n r e s u lt , t h e c o n t r o l ﬂ a g is s e t 0 x 0 0 0 0 0 0 0 7 - 0 x 0 0 0 0 0 0 0 8 != 0 , s o it s e t s Z F ( Z e r o F la g) = 0 F o llo w in g t h e C M P is t h e w h ic h is Ju mp if N o t A s b o t h n u m b e r s a r e n o t e q u a l a n d t h e ju m p w ill o c c u r t o t h e lo c a t io n s p e c iﬁ e d a f t e r t h e JN E in s t r u c t io n , w h ic h is L e t ’ s c h e c k t h e s t a c k s t a t e a n d a s c r e e n s h o t o f x 3 2 d b g b e fo r e t h e JN E in s t r u c t io n : [E S P -0 x 8 ] 0 0 1 2 F F 3 0   0 0 4 0 A 1 6 C   \" %d \", p a r a me t e r t o 2 n d s c a n f( ) [E S P -0 x 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 C   Me mo r y lo c a t io n o f p la c e h o ld e r fo r iN u mb e r 2 [E S P ]  0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7    [EB P -8 ] 7 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 8   [EB P -4 ] 8 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.1 0 : B e fo r e JN E in s t r u c t io n In o u r c a s e , JN E w ill m o v e t h e in s t r u c t io n p o in t e r t o t h e $L N 2 @ma in lo c a t io n . If in c a s e t h e u s e r e n t e r s t h e s a m e n u m b e r s , t h e C M P in s t r u c t io n w ill r e s u lt in Z F ( Z e r o F la g) = T h a t w ill m o v e t h e in s t r u c t io n p o in t e r t o p r in t “ N u mb e r 1 a n d N u mb e r 2 a r e e q u a l” o n t h e c o n s o le , fo llo w e d b y t h e u n c o n d it io n a l ju m p in s t r u c t io n t o $L N 3 @ma in S H O R T $L N 3 @ma in a t lin e 6 7 ) , w h e r e $L N 3 @ma in is t h e c lo s in g o f t h e fu n c t io n a n d t h e c o d e . T h e s t a c k s t a t e is s h o w n in t h e fo llo w in g s c r e e n s h o t : ▼L in e 6 8 -7 2 $L N 2 @m a in : ; L in e 1 7 p u s h O F F S E T $S G 4 6 8 6 c a ll _p r in t f a d d e s p , 4 T h e C / C ++ e q u iv a le n t is : p r in t f( \" N u m b e r 1 a n d N u m b e r 2 a r e n o t e q u a l\\ n \" ) ; It p r in t s ‘ N u m b e r 1 a n d N u m v e r 2 a r e n o t e q u a l’ . T h e A S M c o d e p u s h e s t h e s t r in g c o n s t a n t $S G 4 6 8 6 o n t h e s t a c k t o b e u s e d b y t h e p r in t f fu n c t io n a s a n a r gu m e n t . T h is w ill p r in t ‘ N u mb e r 1 a n d N u mb e r 2 a r e n o t e q u a l’ o n t h e c o n s o le . F o llo w in g t h is is t h e A D D in s t r u c t io n w h ic h w ill c le a n t h e s t a c k b y 4 b y t e s , w h ic h w a s u s e d b y s t r in g c o n s t a n t $S G 4 6 8 6 in P US H o p e r a t io n . T h e s t a c k s t a t e a f t e r t h is w ill b e a s fo llo w s : [E S P -0 x 4 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 9 0   \" N u mb e r 1 a n d N u mb e r 2 a r e n o t e q u a l\\ n \", a r g t o p r in t f [E S P ]  0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7    [EB P -8 ] 7 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 8   [EB P -4 ] 8 is s t o r e d , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7   r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.1 1 : P r in t “ N u m b e r 1 a n d N u m b e r 2 a r e n o t e q u a l” ▼L in e 7 3 -8 1 $L N 3 @m a in : ; L in e 1 8 x o r e a x , e a x m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D X O R a n d t h e fu n c t io n e p ilo gu e w ill c le a n u p E A X a n d s t a c k , r e s p e c t iv e ly. E N D w ill e n d t h e c o d e b y r e t u r n in g 0 . T h e s t a c k s t a t e is s h o w n in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 9 0   JUN K [E S P -0 x C ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7   JUN K [E S P -0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 8   JUN K [E S P -0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] p o p p e d u p [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 F 7    r e t u r n t o ife ls e .0 0 4 0 1 2 F 7 fr o m ife ls e .0 0 4 0 1 0 0 0 F ig u r e 9.1 2 : S t a c k c le a n e d If-e ls e s t a t e me n t w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 9.1 3 : If-e ls e s t a t e m e n t w it h O p t im iz a t io n T h is w ill ge n e r a t e t h e a s s e m b ly c o d e a n d t h e E X E ﬁ le . F o r a n a ly s is p u r p o s e , w e w ill d is a b le t h e A S L R . It is a s e c u r it y m e c h a n is m b y w h ic h t h e b a s e a d d r e s s o f t h e P E ﬁ le is r a n d o m iz e d o n e v e r y lo a d o f t h e P E ﬁ le ge n e r a t e d w it h o u r M S V C c o m p ile r. To d is a b le A S L R , fo llo w t h e s a m e s t e p s b y u s in g t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n F o r s t e p -b y -s t e p r e fe r e n c e t o d is a b le A S L R , r e fe r t o t h e A p p e n d ix . N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 9.1 4 : ife ls e -O p t im iz e d .a s m -P a r t -1 F ig u r e 9.1 5 : ife ls e -O p t im iz e d .a s m -P a r t -2 T h is a s s e m b ly c o d e is o p t im iz e d b y r e m o v in g u n n e c e s s a r y lin e s t o c o n s u m e fe w e r r e s o u r c e s . In t h is c o d e , w e w ill n o t s e e t h e fu n c t io n p r o lo gu e a n d e p ilo gu e . W e c a n a ls o o b s e r v e t h a t E S P is u s e d a s a r e fe r e n c e r a t h e r t h a n E B P ; t h is is b e c a u s e o f t h e a b s e n c e o f t h e fu n c t io n p r o lo gu e a n d e p ilo gu e . L e t u s s t a r t t h e a n a ly s is a n d t h is t im e , w e w ill e n t e r t h e s a m e n u m b e r. ▼L in e 3 4 -3 5 ; L in e 7 s u b e s p , 8 T h e S UB in s t r u c t io n is c r e a t in g r o o m fo r t h e lo c a l v a r ia b le s o f t h e ma in fu n c t io n o n t h e s t a c k , iN u mb e r 1 a n d To c h e c k t h e s t a c k s t a t e , w e w ill o p e n t h e P E ﬁ le in x 3 2 d b g a n d p la c e o u r ﬁ r s t b r e a k p o in t a t t h e s t a r t o f t h e ma in p r o c e d u r e . T h e s t a c k s t a t e a n d t h e x 3 2 d b g s c r e e n s h o t a f t e r t h e S UB in s t r u c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F F 3 C   0 0 4 0 4 4 4 A    r ig h t n o w is JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   r igh t n o w is JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 9.1 6: C r e a t in g r o o m fo r o u r lo c a l v a r ia b le ▼L in e 3 6 -3 8 ; L in e 1 0 p u s h O F F S E T $S G 4 6 7 9 c a ll _p r in t f T h e C / C ++ e q u iv a le n t o f t h e A S M is : p r in t f( “ In p u t N u m b e r 1 : “ ) ; It w ill p r in t t h e s t r in g c o n s t a n t $S G 4 6 7 9 o n t h e c o n s o le . $S G 4 6 7 9 w a s p u s h e d o n t h e s t a c k b e fo r e t h e p r in t f fu n c t io n c a ll. T h e s t a c k s t a t e a f t e r t h e C A L L in s t r u c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F F 3 8   0 0 4 0 A 1 4 0    “ In p u t N u mb e r 1 : “ , p a r a me t e r t o p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 C   0 0 4 0 4 4 4 A r igh t n o w is JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 8 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   r igh t n o w is JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 ▼L in e 3 9 -4 3 ; L in e 1 1 le a e a x , D W O R D P T R _iN u m b e r 1 $[e s p +1 2 ] p u s h e a x p u s h O F F S E T $S G 4 6 8 0 c a ll _s c a n f T h e C / C ++ c o d e o n lin e 1 1 a s k s t h e u s e r t o in p u t t h e ﬁ r s t n u m b e r, T h is n u m b e r w ill b e s t o r e d a t t h e & iN u mb e r 1 lo c a t io n . s c a n f( \" %d\", & iN u m b e r 1 ) ; In A S M , t h e L E A in s t r u c t io n is e v a lu a t e d t o : le a e a x , s s :[e s p +0 x 4 ] T h is w ill lo a d t h e e ﬀ e c t iv e a d d r e s s o f E S P +0 x 4 t o T h is is t h e m e m o r y lo c a t io n o n t h e s t a c k w h e r e t h e iN u mb e r 1 in p u t b y t h e u s e r w ill b e s t o r e d . A s t h e s c a n f fu n c t io n e x p e c t s t w o a r gu m e n t s , s o b o t h t h e a r gu m e n t s t o s c a n f a r e p u s h e d o n t o t h e s t a c k b e fo r e t h e C A L L in s t r u c t io n . A r gu m e n t s t o s c a n f a r e m e m o r y lo c a t io n , o n w h ic h iN u mb e r 1 is s t o r e d , a n d t h e s t r in g c o n s t a n t Wh e n a c a ll t o s c a n f is d o n e , it w ill a s k t h e u s e r t o e n t e r t h e n u m b e r. W e h a v e in s e r t e d o n e m o r e b r e a k p o in t a f t e r t h e s c a n f fu n c t io n t o v ie w t h e s t a c k a f t e r t h e s c a n f c a ll. R e fe r t o t h e s t a c k s t a t e a n d x 3 2 d b g in t h e fo llo w in g s c r e e n s h o t : [E S P ]  0 0 1 2 F F 3 0   0 0 4 0 A 1 5 4    “ %d ” , p a r a me t e r t o s c a n f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 C   Me mo r y lo c a t io n o f In p u t p la c e h o ld e r fo r iN u mb e r 1    [E S P +0 x 8 ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 4 0   “ In p u t N u mb e r 1 : “ , p a r a me t e r t o p r in t f( ) [E S P +0 x C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7   7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 1 0 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   r igh t n o w is JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 9.1 7 : B r e a k p o in t a f t e r t h e ﬁ r s t s c a n f ▼L in e 4 4 -4 6 ; L in e 1 2 p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 2 p r in t s t h e fo llo w in g m e s s a ge o n t h e c o n s o le : p r in t f( “ In p u t N u m b e r 2 : “ ) ; In A S M , it d o e s t h e s a m e b y p u s h in g t h e s t r in g c o n s t a n t $S G 4 6 8 1 o n t h e s t a c k a n d t h e c a ll p r in t f fu n c t io n . [E S P ]  0 0 1 2 F F 2 C   0 0 4 0 A 1 5 8    “ In p u t N u mb e r 2 : “ , p a r a me t e r t o p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 0   0 0 4 0 A 1 5 4   “ %d ” , p a r a me t e r t o s c a n f( ) [E S P +0 x 8 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 C   Me mo r y lo c a t io n o f In p u t p la c e h o ld e r fo r iN u mb e r 1    [E S P +0 x C ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 4 0   “ In p u t N u mb e r 1 : “ , p a r a me t e r t o p r in t f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7   7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 1 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   r igh t n o w is JUN K , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 1 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 ▼L in e 4 7 -5 1 ; L in e 1 3 le a e c x , D W O R D P T R _iN u m b e r 2 $[e s p +2 4 ] p u s h e c x p u s h O F F S E T $S G 4 6 8 2 c a ll _s c a n f T h e C / C ++ c o d e o n lin e 1 3 a s k s t h e u s e r t o in p u t t h e s e c o n d n u m b e r, T h is n u m b e r w ill b e s t o r e d a t t h e & iN u mb e r 2 lo c a t io n . s c a n f( \" %d\", & iN u m b e r 2 ) ; In A S M , t h e L E A in s t r u c t io n is e v a lu a t e d t o : le a e c x , s s :[e s p +0 x 1 4 ] T h is w ill lo a d t h e e ﬀ e c t iv e a d d r e s s o f E S P +0 x 1 4 t o T h is is m e m o r y lo c a t io n o n t h e s t a c k w h e r e t h e iN u mb e r 2 in p u t b y t h e u s e r w ill b e s t o r e d . A s t h e s c a n f fu n c t io n e x p e c t s t w o a r gu m e n t s , s o b o t h t h e a r gu m e n t s t o s c a n f a r e p u s h e d o n t o t h e s t a c k b e fo r e t h e C A L L t o t h e s c a n f fu n c t io n . A r gu m e n t s t o s c a n f a r e iN u mb e r 2 a n d t h e s t r in g c o n s t a n t Wh e n a c a ll t o s c a n f is d o n e , it w ill a s k t h e u s e r t o e n t e r t h e n u m b e r. T h is t im e , w e h a v e e n t e r e d t h e s a m e n u m b e r, 7 . W e h a v e in s e r t e d o n e m o r e b r e a k p o in t a f t e r t h e s c a n f fu n c t io n t o v ie w t h e s t a c k a f t e r t h e s c a n f c a ll. R e fe r t o t h e s t a c k s t a t e a n d x 3 2 d b g in t h e fo llo w in g s c r e e n s h o t :. [E S P ]  0 0 1 2 F F 2 4   0 0 4 0 A 1 6 C   \" %d \" [E S P +0 x 4 ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0 [E S P +0 x 8 ] 0 0 1 2 F F 2 C   0 0 4 0 A 1 5 8   \" In p u t N u mb e r 2 : \", p a r a me t e r t o p r in t f( ) [E S P +0 x C ] 0 0 1 2 F F 3 0   0 0 4 0 A 1 5 4   \" %d \", p a r a me t e r t o s c a n f( ) [E S P +0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 C   Me mo r y lo c a t io n o f In p u t p la c e h o ld e r fo r iN u mb e r 1    [E S P +0 x 1 4 ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 4 0   \" In p u t N u mb e r 1 : \", p a r a me t e r t o p r in t f( ) [E S P +0 x 1 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7   7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 1 C ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 2 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 9.1 8: B r e a k p o in t a f t e r t h e s e c o n d s c a n f ▼L in e 5 1 -5 6 ; L in e 1 4 m o v e d x , D W O R D P T R _iN u m b e r 1 $[e s p +3 2 ] a d d e s p , 2 4      ; 0 0 0 0 0 0 1 8 H c m p e d x , D W O R D P T R _iN u m b e r 2 $[e s p +8 ] jn e S H O R T $L N 2 @m a in T h e C / C ++ c o d e o n lin e 1 4 c o m p a r e s t h e t w o n u m b e r s : if ( iN u m b e r 1 == iN u m b e r 2 ) In A S M , t h e M O V in s t r u c t io n w ill m o v e iN u mb e r 1 s t o r e d a t s s : [e s p +0 x 1 8 ] t o T h e A D D in s t r u c t io n w ill c le a n t h e s t a c k b y a d d in g 2 4 b y t e s t o O n c e t h e s t a c k is c le a n e d , t h e C M P in s t r u c t io n c o m p a r e s t h e v a lu e a t E D X w it h s s :[e s p +0 x 4 ]. A s b o t h t h e n u m b e r s a r e e q u a l, it w ill s e t A s Ju mp if N o t E q u a l c o n d it io n is n o t m e t , t h e in s t r u c t io n p o in t e r w ill m o v e t o t h e n e x t in s t r u c t io n fo llo w in g t h e R e fe r t o t h e s t a c k s t a t e a f t e r t h e JN E in s t r u c t io n e x e c u t io n a n d x 3 2 d b g in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x 1 8 ] 0 0 1 2 F F 2 4   0 0 4 0 A 1 6 C   JUN K [E S P -0 x 1 4 ] 0 0 1 2 F F 2 8   0 0 1 2 F F 4 0   JUN K [E S P -0 x 1 0 ] 0 0 1 2 F F 2 C   0 0 4 0 A 1 5 8   JUN K [E S P -0 x C ] 0 0 1 2 F F 3 0   0 0 4 0 A 1 5 4   JUN K [E S P -0 x 8 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 3 C   JUN K [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 4 0   JUN K [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7    7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 9.1 9: S t a c k s t a t e a f t e r JN E ▼L in e 5 7 -6 1 ; L in e 1 5 p u s h O F F S E T $S G 4 6 8 4 ; L in e 1 7 c a ll _p r in t f a d d e s p , 4 T h is w ill p u s h t h e s t r in g c o n s t a n t $S G 4 6 8 4 o n t h e s t a c k fo r t h e p r in t f fu n c t io n t o p r in t o n t h e c o n s o le . T h e A D D in s t r u c t io n w ill p e r fo r m t h e s t a c k c le a n in g. R e fe r t o t h e s t a c k s t a t e a n d x 3 2 d b g a f t e r t h e A D D in s t r u c t io n in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 7 0   N o w JUN K , \" N u mb e r 1 a n d N u mb e r 2 a r e e q u a l\\ n \" [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7    7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 1 [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   7 is s t o r e d h e r e , In p u t p la c e h o ld e r fo r iN u mb e r 2 [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 9.2 0 : S t a c k s t a t e a f t e r t h e A D D in s t r u c t io n ▼L in e 6 2 -6 5 ; L in e 1 8 x o r e a x , e a x a d d e s p , 8 r e t 0 _m a in E N D P _TEX T E N D S E N D X O R a n d t h e fu n c t io n e p ilo gu e w ill c le a n u p t h e E A X a n d s t a c k , r e s p e c t iv e ly. E N D w ill e n d t h e c o d e b y r e t u r n in g 0 . R e fe r t o t h e s t a c k s t a t e a n d x 3 2 d b g a f t e r t h e s t a c k c le a n in g in t h e fo llo w in g s c r e e n s h o t : [E S P -0 x C ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 7 0   N o w JUN K , \" N u mb e r 1 a n d N u mb e r 2 a r e e q u a l\\ n \" [E S P -0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7   N o w JUN K , iN u mb e r 1 n u mb e r 7 e n t e r e d w a s s t o r e d h e r e [E S P -0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   N o w JUN K , iN u mb e r 1 n u mb e r 7 e n t e r e d w a s s t o r e d h e r e [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 F 3   r e t u r n t o 0 x 0 0 4 0 1 2 F 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 9.2 1 : S t a c k c le a n e d C o n c lu s io n In t h is c h a p t e r, w e le a r n e d t h e c o n c e p t o f a s s e m b ly in s t r u c t io n s u s e d t o m a k e d e c is io n s in a p r o gr a m ﬂ o w . W e a ls o le a r n e d a b o u t t h e u s a ge o f C M P a n d Ju m p in s t r u c t io n s in a s s e m b ly c o d e . A lo n g w it h t h is , w e a ls o u n d e r s t o o d t h e d iﬀ e r e n t ia t in g p a t t e r n b e t w e e n o p t im iz e d a n d n o n -o p t im iz e d a s s e m b ly c o d e o f d e c is io n c o n t r o l s t r u c t u r e s . In t h e n e x t c h a p t e r, w e w ill le a r n a b o u t t h e d is a s s e m b ly o f p r o gr a m s w it h lo o p in g c o n t r o l s t a t e m e n t s . C H A P T E R 1 0 R e v e r s e E n gin e e r in g P a t t e r n o f L o o p C o n t r o l S t r u c t u r e In t h e la s t c h a p t e r, w e d is c u s s e d a b o u t t h e p r o gr a m s t h a t a r e a s s o c ia t e d w it h s o m e d e c is io n c o n t r o l s t a t e m e n t s . In o u r d a y -t o - d a y life , w e t e n d t o d o s o m a n y t h in gs o v e r a n d o v e r a ga in . L ik e w e ge t r e a d y e v e r y m o r n in g a n d go t o s le e p in t h e n igh t a r o u n d t h e s a m e t im e e v e r y d a y. T h is is w h e r e w e s e e o u r r o u t in e h a p p e n in g in a lo o p e v e r y d a y. E v e r y p r o gr a m m in g la n gu a ge is e q u ip p e d w it h a s im ila r lo o p c o n t r o l s t r u c t u r e , w h e r e t h e p r o gr a m s a r e c o d e d in s u c h a w a y t h a t t h e y r u n in a lo o p w it h s o m e c o n d it io n s . A s a r e v e r s e e n gin e e r, t h is t o p ic c a n b e u n d e r s t o o d fr o m a m a lw a r e w r it e r ’s p o in t o f v ie w , w h e r e in m a lw a r e ’s a r e c o d e d in s u c h a w a y t h a t t h e y in fe c t a ll t h e ﬁ le s o n t h e t a r ge t c o m p u t e r. Wh e n a m a lw a r e ge t s e x e c u t e d , ﬁ le s in t h e c o m p u t e r a r e r u n t h r o u gh a lo o p c o n d it io n s o a s t o t a r ge t t h e w h o le c o m p u t e r d a t a . Un d e r s t a n d in g t o id e n t if y lo o p p a t t e r n s in a s s e m b ly w ill h e lp y o u d e c o d e p r o gr a m s u s in g lo o p c o n t r o l s t r u c t u r e s . M o s t o f t h e c o m p u t e r p r o gr a m s a r e c o d e d w it h t h e s e lo o p c o n t r o l s t r u c t u r e s . It is im p o r t a n t fo r u s t o s h o u ld u n d e r s t a n d t h e p a t t e r n o f t h e s e p r o gr a m s w h e n r e v e r s e e n gin e e r e d . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Un d e r s t a n d in g a b o u t a lo o p c o n t r o l s t r u c t u r e H o w lo o p s a r e h a n d le d in a s s e m b ly O b je c t iv e T h e o b je c t iv e o f t h is c h a p t e r is t o le a r n a b o u t d iﬀ e r e n t lo o p s t a t e m e n t s in C / C ++ a n d u n d e r s t a n d in g t h e c o d e p a t t e r n in a d is a s s e m b le d c o d e . W e w ill a ls o le a r n t o p u t a c o n d it io n a l b r e a k p o in t in c o d e e x e c u t io n . In a n a s s e m b ly lis t in g ge n e r a t e d fr o m lo o p s t a t e m e n t p r o gr a m s , w e w ill c h e c k t h e C M P a n d JM P in s t r u c t io n p a t t e r n s in a s s e m b ly a n d n o t e t h e ir d iﬀ e r e n c e s in o p t im iz e d a n d n o n -o p t im iz e d c o d e . Wh ile C o n d it io n In t h is C / C ++ c o d e , w e w ill u s e t h e w h ile c o n d it io n t o p r in t n u m b e r s fr o m 1 t o 1 0 o n t h e c o n s o le / s c r e e n . T h is w ill a ls o in c lu d e t h e p r in t f fu n c t io n in o u r C / C ++ c o d e . F ig u r e 1 0 .1 : w h ile .c p p Wh ile c o n d it io n w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 0 .2 : While c o n d it io n w it h o u t o p t im iz a t io n T h is w ill ge n e r a t e t h e a s s e m b ly c o d e a n d t h e E X E ﬁ le . F o r fu r t h e r a n a ly s is , w e h a v e d is a b le d t h e A S L R m a n u a lly. To d is a b le A S L R , fo llo w t h e s a m e s t e p s b y u s in g t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n F o r s t e p -b y -s t e p in s t r u c t io n s , r e fe r t o t h e N o w le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 0 .3 : w h ile .a s m L e t ’s w a lk t h r o u gh t h e a s s e m b ly c o d e lin e b y lin e . A s w e h a v e d is c u s s e d m o s t o f t h e in it ia l in s t r u c t io n s o f t h e a s s e m b ly lis t in g in t h e e a r lie r c h a p t e r s , w e w ill m o v e o n t o t h e in s t r u c t io n s fr o m t h e s t a r t o f t h e ma in p r o c e d u r e . ▼L in e 2 2 -2 5 ; L in e 7 p u s h e b p m o v e b p , e s p p u s h e c x T h e a s s e m b ly c o d e s t a r t s w it h t h e ma in fu n c t io n p r o lo gu e ﬁ r s t w it h t h e P US H in s t r u c t io n a n d t h e n w it h t h e M O V in s t r u c t io n . E C X is p u s h e d o n t o t h e s t a c k t o c r e a t e r o o m fo r t h e iN u mb e r in t e ge r v a r ia b le o f s iz e 4 b y t e s . ▼L in e 2 6 -2 7 ; L in e 8 m o v D W O R D P T R _iN u m b e r $[e b p ], 1 T h e C / C ++ c o d e fo r t h is is a s fo llo w s : in t iN u m b e r = 1 ; T h e iN u mb e r in t e ge r v a r ia b le is in it ia liz e d t o 1 . In t h e A S M c o d e , w e c r e a t e d r o o m fo r t h e iN u mb e r lo c a l v a r ia b le t o ma in fu n c t io n b y p u s h in g E C X o n t o t h e s t a c k . 1 is m o v e d t o t h is m e m o r y lo c a t io n o n s t a c k [E B P -4 ] ( W e ge t t h is b y a d d in g iN u mb e r m a c r o , w h ic h is _iN u mb e r $ = -4 w it h L e t ’s c h e c k t h e s t a c k s t a t e b y p la c in g t h e b r e a k p o in t a t t h e s t a r t o f t h e ma in p r o c e d u r e a n d t h e n s t e p p in g in t o t h e in s t r u c t io n s . R e fe r t o t h e fo llo w in g s t a c k s t a t e a n d a s c r e e n s h o t o f x 3 2 d b g: [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    iN u m b e r is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 4   r e t u r n t o w h ile .0 0 4 0 1 2 2 4 fr o m w h ile .0 0 4 0 1 0 0 0 F ig u r e 1 0 .4 : iN u m b e r is s t o r e d o n s t a c k ▼L in e 2 8 -3 1 $L N 2 @m a in : ; L in e 9 c m p D W O R D P T R _iN u m b e r $[e b p ], 1 0   ; 0 0 0 0 0 0 0 a H jg S H O R T $L N 3 @m a in T h e C / C ++ c o d e fo r t h is is a s fo llo w s : w h ile ( iN u m b e r <= 1 0 ) A s w e s e e in t h e C / C ++ c o d e w h ile c o n d it io n c h e c k s iN u mb e r v a lu e , fo r le s s t h a n o r e q u a l t o 1 0 ( 0 x 0 A ) . In t h e A S M c o d e , t h e v a lu e s t o r e d o n t h e s t a c k a t [E B P -4 ] is c o m p a r e d w it h t h e v a lu e 1 0 w it h t h e C M P in s t r u c t io n . A s b o t h t h e o p e r a n d s a r e n o t e q u a l in t h e c u r r e n t s t a t e , e x e c u t in g t h e C M P in s t r u c t io n w ill s e t Z F =0 . Wh e n t h e v a lu e a t [E B P -4 ] w ill b e gr e a t e r t h a n 1 0 , t h e n JG ( Ju mp G r e a t e r ) w ill ju m p t o t h e la b e l $L N 3 @ma in a n d t h e la b e l $L N 3 @ma in w ill p o in t t o w a r d s t h e c lo s u r e o f t h e ma in fu n c t io n . C o n s id e r in g t h e c u r r e n t c a s e w h e r e iN u mb e r is 1 , t h e s t a c k s t a t e a n d t h e s c r e e n s h o t o f x 3 2 d b g w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    iN u m b e r is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 4   r e t u r n t o w h ile .0 0 4 0 1 2 2 4 fr o m w h ile .0 0 4 0 1 0 0 0 F ig u r e 1 0 .5 : A f t e r c o m p a r e in s t r u c t io n w h e n iN u m b e r =1 ▼L in e 3 2 -3 7 ; L in e 1 1 m o v e a x , D W O R D P T R _iN u m b e r $[e b p ] p u s h e a x p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f a d d e s p , 8 O n lin e 1 1 o f t h e C / C ++ c o d e is t h e p r in t f fu n c t io n t o p r in t iN u mb e r o n t h e c o n s o le . T h e A S M c o d e m o v e s t h e v a lu e s t o r e d o n t h e s t a c k a t [E B P -4 ] t o t h e E A X r e gis t e r, w h ic h is la t e r in t h e n e x t in s t r u c t io n p u s h e d o n t o t h e s t a c k a lo n g w it h t h e o t h e r a r gu m e n t , s t r in g c o n s t a n t Wh e n b o t h t h e a r gu m e n t s t o t h e p r in t f fu n c t io n a r e p a s s e d o n t o t h e s t a c k , t h e c a ll t o p r in t f is m a d e . O n r e t u r n fr o m t h e p r in t f fu n c t io n , A D D is e x e c u t e d t o c le a n t h e s t a c k b y a d d in g 8 b y t e s t o T h e s t a c k s t a t e a n d x 3 2 d b g s c r e e n s h o t b e fo r e t h e A D D in s t r u c t io n w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0    \" %d \\ n \", a s a p a r a me t e r t o p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 1   iN u mb e r is p u s h e d a s a p a r a me t e r t o p r in t f( ) [E S P +0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1   iN u m b e r is s t o r e d h e r e [E S P +0 x C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 4   r e t u r n t o w h ile .0 0 4 0 1 2 2 4 fr o m w h ile .0 0 4 0 1 0 0 0 F ig u r e 1 0 .6: A f t e r p r in t f ▼L in e 3 8 -4 1 ; L in e 1 2 m o v e c x , D W O R D P T R _iN u m b e r $[e b p ] a d d e c x , 1 m o v D W O R D P T R _iN u m b e r $[e b p ], e c x L in e 1 2 o f t h e C / C ++ c o d e in c r e m e n t s t h e iN u mb e r v a lu e b y 1 . iN u m b e r = iN u m b e r + 1 ; In A S M , w e a r e in c r e m e n t in g t h e iN u mb e r v a lu e b y ﬁ r s t m o v in g t h e iN u mb e r v a lu e s t o r e d a t [E B P -4 ] t o a n d t h e n in c r e m e n t in g E C X b y 1 . O n c e in c r e m e n t e d , w e w ill m o v e E C X b a c k t o [E B P -4 ] m e m o r y lo c a t io n . T h is p r o c e s s o r it e r a t io n is r e p e a t e d e v e r y t im e u n t il iN u mb e r is le s s t h a n o r e q u a l t o 1 0 ( 0 x 0 A ) . T h e s t a c k s t a t e a n d t h e s c r e e n s h o t o f x 3 2 d b g w h e n iN u mb e r is in c r e m e n t e d b y 1 w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 2   iN u m b e r is s t o r e d h e r e , n o w it s in c r e me n t e d b y 1 [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 4   r e t u r n t o w h ile .0 0 4 0 1 2 2 4 fr o m w h ile .0 0 4 0 1 0 0 0 F ig u r e 1 0 .7 : Whe n iN u m b e r is in c r e m e n t e d b y 1 ▼L in e 4 2 -4 3 ; L in e 1 3 jm p S H O R T $L N 2 @m a in T h is is a n u n c o n d it io n a l ju m p t o t h e $L N 2 @ma in la b e l, w h e r e t h e v a lu e s t o r e d a t [E B P -4 ] is a ga in c o m p a r e d w it h t h e v a lu e 1 0 ( 0 x 0 A ) . If t h e v a lu e is le s s t h a n o r e q u a l t o 1 0 , t h e n t h e s a m e in s t r u c t io n s w ill p r in t iN u mb e r o n s c r e e n , a lo n g w it h in c r e m e n t in g t h e iN u mb e r v a lu e a t [E B P -4 ] b y 1 . T h e s t a c k s t a t e w ill b e t h e s a m e a s e a r lie r a f t e r [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 2   iN u m b e r is s t o r e d h e r e , n o w it s in c r e me n t e d b y 1 [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 4   r e t u r n t o w h ile .0 0 4 0 1 2 2 4 fr o m w h ile .0 0 4 0 1 0 0 0 In s t r u c t io n p o in t e r w ill b e p o in t e d t o 0 x 0 0 4 0 1 0 0 B a s fo llo w s : F ig u r e 1 0 .8: u n c o n d it io n a l ju m p t o $L N 2 @ma in N o w , w e w ill s e e w h a t h a p p e n s w h e n iN u mb e r b e c o m e s 1 0 ( 0 x 0 A ) . T h e r e a r e t w o w a y s t o a n a ly z e t h e c o d e : M a n u a lly s t e p in t o t h e c o d e in s t r u c t io n b y in s t r u c t io n . T h is is a t im e -c o n s u m in g p r o c e s s . S e t t h e b r e a k p o in t o n t h e c o n d it io n w h e n e it h e r t h e v a lu e s t o r e d a t [E B P -4 ] b e c o m e s 0 x 0 A o r E C X == W e w ill s e t t h e c o n d it io n a l b r e a k p o in t in x 3 2 d b g, w h e n E C X == N o w , t o s e t t h e c o n d it io n a l b r e a k p o in t , s e t t h e s o f t w a r e b r e a k p o in t ( p r e s s k e y ﬁ r s t a t : 0 x 0 0 4 0 1 0 2 5    a d d e c x , 1 T h e n r igh t -c lic k o n t h e in s t r u c t io n a n d s e le c t t h e E d it B r e a k p o in t c o m m a n d fr o m t h e c o n t e x t m e n u . F ill in t h e fo llo w in g c o n d it io n a l e x p r e s s io n a n d t h e n c o n ﬁ r m a n d c lo s e t h e d ia lo g b o x , a s s h o w n in t h e fo llo w in g s c r e e n s h o t : F ig u r e 1 0 .9: S e t t h e b r e a k p o in t o n t h e c o n d it io n R u n t h e c o d e u n t il y o u h it t h e c o n d it io n a l b r e a k p o in t . Fr o m t h e r e , w e c a n m a n u a lly s t e p in t o t h e in s t r u c t io n s . T h e s t a c k s t a t e a n d t h e s c r e e n s h o t o f x 3 2 d b g a t t h is p o in t w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 A   iN u m b e r is s t o r e d h e r e , n o w it s in c r e me n t e d t o 0 x A [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 4   r e t u r n t o w h ile .0 0 4 0 1 2 2 4 fr o m w h ile .0 0 4 0 1 0 0 0 F ig u r e 1 0 .1 0 : Whe n iN u m b e r is in c r e m e n t e d t o 0 x 0 A A s w e s t e p E C X a n d [E B P -4 ] w ill b e c o m e 0 x 0 B . F ig u r e 1 0 .1 1 : Whe n iN u m b e r is in c r e m e n t e d t o 0 x 0 B In t h e n e x t it e r a t io n , t h e JG in s t r u c t io n w ill ju m p t h e in s t r u c t io n p o in t e r t o t h e $L N 3 @ma in la b e l, w h ic h w e w ill d is c u s s n e x t . ▼L in e 4 4 -5 2 $L N 3 @m a in : ; L in e 1 4 x o r e a x , e a x m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D T h is w ill z e r o t h e E A X a n d c a ll t h e ma in fu n c t io n e p ilo gu e . Wit h t h is , t h e T E X T s e gm e n t a n d c o d e is e n d e d . Wh ile c o n d it io n w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 0 .1 2 : While c o n d it io n w it h O p t im iz a t io n It w ill ge n e r a t e t h e a s s e m b ly c o d e a n d t h e E X E ﬁ le . F o llo w t h e s a m e p r o c e s s t o d is a b le t h e A S L R m a n u a lly. To d is a b le A S L R , fo llo w t h e s a m e s t e p s b y u s in g t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n F o r a s t e p -b y -s t e p p r o c e s s t o d is a b le A S L R , r e fe r t o t h e N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 0 .1 3 : w h ile -O p t im iz e d .a s m W e w ill w a lk t h r o u gh t h e ge n e r a t e d a s s e m b ly c o d e in s t r u c t io n b y in s t r u c t io n : ▼L in e 2 1 -2 2 ; L in e 7 p u s h e s i T h e ma in p r o c e d u r e s t a r t s b y p u s h in g t h e E S I r e gis t e r. B y p u s h in g E S I o n t o t h e s t a c k , w e a r e p r e s e r v in g t h e E S I r e gis t e r v a lu e . E S I is r e s t o r e d b a c k w it h P O P E S I in s t r u c t io n a t t h e e n d o f t h e ma in p r o c e d u r e . S o , it is b a s ic a lly p e r s e v e r in g a n d r e s t o r in g t h e r e gis t e r v a lu e a t t h e s t a r t a n d e n d o f t h e fu n c t io n w it h t h e u s e o f t h e P US H & P O P in s t r u c t io n s , r e s p e c t iv e ly. ▼L in e 2 3 -2 5 ; L in e 8 m o v e s i, 1 n p a d 1 0 L in e 8 o f t h e C / C ++ c o d e in it ia liz e s t h e iN u mb e r v a r ia b le : in t iN u m b e r = 1 ; In t h e A S M c o d e , t h e E S I r e gis t e r w ill b e u s e d t o h o ld t h e iN u mb e r v a lu e a n d fo r s u b s e q u e n t o p e r a t io n s . T h e M O V in s t r u c t io n in it ia liz e s iN u mb e r b y m o v in g 0 x 0 1 in t o t h e E S I r e gis t e r. N e x t is t h e n p a d m a c r o w h ic h in s e r t s n o n -d e s t r u c t iv e a n d n o n - o p e r a t io n a l in s t r u c t io n s . It m e a n s t h a t it w ill in s e r t a n in s t r u c t io n t h a t d o e s n o t h in g. F o r in fo r m a t io n o n p le a s e r e fe r t o t h e A p p e n d ix s e c t io n . O u r a s s e m b ly lis t in g is u s in g n p a d w h ic h is d e ﬁ n e d in L IS T IN G .IN C a s jmp .+A ; .n p a d 7 ; .n p a d w h e r e n p a d 1 0 is F ig u r e 1 0 .1 4 : n p a d 1 0 n p a d 7 is F ig u r e 1 0 .1 5 : n p a d 7 n p a d 1 is F ig u r e 1 0 .1 6: n p a d 1 To ge t h e r, n p a d 1 0 m a k e s : jm p .+A -> It w ill a d d 0 x 0 A t o in s t r u c t io n lo c a t io n ( 0 x 0 0 4 0 1 0 0 6 + 0 x 0 A ) le a e s p , [e s p +0 0 0 0 0 0 0 0 ] n o p L e t ’s s e e h o w t h e n p a d 1 0 m a c r o is r e s o lv e d in t h e x 3 2 d b g s c r e e n s h o t : F ig u r e 1 0 .1 7 : n p a d 1 0 in x 3 2 d b g A ll t h e t h r e e in s t r u c t io n s m a r k e d in R E D h a v e n o e ﬀ e c t o n t h e c o d e ﬂ o w ; t h e y a r e ju s t e q u iv a le n t t o a s e r ie s o f N O P s o f s iz e 1 0 b y t e s . T h e c o m p ile r p a d s 1 0 b y t e s b e t w e e n t h e mo v e s i,1 in s t r u c t io n a n d t h e la b e l $L L 2 @ma in ( d e ﬁ n e d n e x t ) . ▼L in e 2 6 -3 0 $L L 2 @m a in : ; L in e 1 1 p u s h e s i p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f T h e $L L 2 @ma in la b e l is d e ﬁ n e d fo llo w e d b y t h e c o m m e n t a s lin e 1 1 . L in e 1 1 o f t h e C / C ++ c o d e p r in t s t h e iN u mb e r o n t h e s c r e e n u s in g t h e p r in t f fu n c t io n . p r in t f( \" %d\\ n \", iN u m b e r ) ; In t h e A S M c o d e , b e fo r e c a llin g t h e p r in t f fu n c t io n , t w o a r gu m e n t s t o p r in t f a r e p u s h e d o n t o s t a c k . T h e ﬁ r s t o n e is E S I h o ld in g t h e iN u mb e r a n d t h e o t h e r is t h e s t r in g c o n s t a n t d e ﬁ n e d b y T h e s t a c k s t a t e a f t e r t h e p r in t f c a ll is s h o w n a s fo llo w s , a lo n g w it h t h e x 3 2 d b g s c r e e n s h o t fo r a b e t t e r u n d e r s t a n d in g: [E S P ]  0 0 1 2 F F 3 8   0 0 4 0 8 1 4 0   \" %d \\ n \", p a r a me t e r t o p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1   iN u m b e r is p u s h e d a s a p a r a me t e r t o p r in t f( ) [E S P +0 x 8 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   O ld v a lu e o f E S I is p r e s e r v e d [E S P +0 x C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 1 9   r e t u r n t o 0 x 0 0 4 0 1 2 1 9 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 0 .1 8: A f t e r p r in t f ▼L in e 3 1 -3 5 ; L in e 1 2 in c e s i a d d e s p , 8 c m p e s i, 1 0      ; 0 0 0 0 0 0 0 a H jle S H O R T $L L 2 @m a in T h e C / C ++ c o d e o n lin e 1 2 in c r e m e n t s t h e iN u mb e r b y 1 . iN u m b e r = iN u m b e r + 1 ; In A S M , w e a r e in c r e m e n t in g t h e iN u mb e r s t o r e d in E S I b y u s in g t h e IN C in s t r u c t io n . IN C a d d s 1 t o E S I a n d s t o r e s t h e r e s u lt b a c k in t h e E S I r e gis t e r. T h e A D D in s t r u c t io n c le a n s t h e s t a c k b y a d d in g 8 b y t e s t o O n c e t h e s t a c k is c le a n e d , t h e v a lu e in E S I is c o m p a r e d w it h 1 0 ( 0 x 0 A ) . It w ill p e r fo r m a s ign e d c o m p a r is o n ju m p a f t e r a C M P in s t r u c t io n , if t h e v a lu e in E S I is le s s t h a n o r e q u a l t o 1 0 ( 0 x 0 A ) . In o u r c a s e , t h e c u r r e n t v a lu e o f E S I = 0 x 0 2 a f t e r in c r e m e n t in g. S o , t h e in s t r u c t io n p o in t e r w ill b e ju m p e d t o t h e $L L 2 @ma in la b e l. T h e E S I is a ga in p r in t e d o n t h e c o n s o le . T h is lo o p it e r a t e s u n t il E S I b e c o m e s 0 x 0 B . Wh e n E S I is in c r e m e n t e d t o 0 x 0 B , a s ign e d c o m p a r is o n ju m p a f t e r a C M P in s t r u c t io n w ill n o t t a k e p la c e . S o , t h e in s t r u c t io n p o in t e r w ill m o v e t o t h e e n d o f t h e a s s e m b ly c o d e . T h e s t a c k s t a t e a t t h is p o in t : [E S P -0 x 8 ] 0 0 1 2 F F 3 8   0 0 4 0 8 1 4 0   N O W JUN K [E S P -0 x 4 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 A   N O W JUN K [E S P ]  0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   O ld v a lu e o f E S I is p r e s e r v e d [E S P +0 x C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 1 9   r e t u r n t o 0 x 0 0 4 0 1 2 1 9 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 0 .1 9: E S I is in c r e m e n t e d t o 0 x 0 B ▼L in e 3 6 -4 2 ; L in e 1 4 x o r e a x , e a x p o p e s i r e t 0 _m a in E N D P _TEX T E N D S E N D It is t h e s a m e a s e x p la in e d in t h e o t h e r s e c t io n s . E A X is X O R ’e d t o r e t u r n 0 . A p o in t t o n o t e h e r e is t h a t t h e v a lu e o f E S I is r e s t o r e d b a c k u s in g t h e P O P E S I in s t r u c t io n . Wit h t h is , o u r ma in p r o c e d u r e , T E X T s e gm e n t , a n d c o d e e n d s . T h e s t a c k s t a t e a f t e r p o p p in g E S I is a s fo llo w s : [E S P -0 x 8 ] 0 0 1 2 F F 3 8   0 0 4 0 8 1 4 0   N O W JUN K [E S P -0 x 4 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 A   N O W JUN K [E S P ]  0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   N O W JUN K [E S P +0 x C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 1 9   r e t u r n t o 0 x 0 0 4 0 1 2 1 9 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 0 .2 0 : S t a c k c le a n e d F o r L o o p In t h is s e c t io n , w e w ill u s e fo r lo o p in t h e C / C ++ c o d e , w h ic h in it ia liz e s a n in t e ge r v a r ia b le a n d in c r e m e n t s it b y 2 t o p r in t it o n t h e s c r e e n o r c o n s o le . F ig u r e 1 0 .2 1 : fo r.c p p F o r L o o p w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 0 .2 2 : F o r L o o p w it h o u t O p t im iz a t io n T h e c o m p ila t io n ge n e r a t e s t h e a s s e m b ly c o d e a n d t h e E X E ﬁ le . To m a n u a lly d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 0 .2 3 : fo r.a s m ▼L in e 2 2 -2 5 ; L in e 7 p u s h e b p m o v e b p , e s p p u s h e c x T h e A S M c o d e s t a r t s w it h t h e ma in fu n c t io n p r o lo gu e . T h e ﬁ r s t P US H E C X w ill c r e a t e r o o m fo r t h e iN u mb e r in t e ge r v a r ia b le o n t h e s t a c k . ▼L in e 2 6 -2 7 ; L in e 8 m o v D W O R D P T R _iN u m b e r $[e b p ], 1 T h e fo llo w in g lin e 8 o f t h e C / C ++ c o d e in it ia liz e s t h e iN u mb e r v a r ia b le t o 1 , w h ic h c o r r e s p o n d s t o t h e p r e c e d in g A S M c o d e : in t iN u m b e r = 1 ; In t h e A S M c o d e , iN u mb e r m a c r o is d e ﬁ n e d a s : _iN u m b e r $ = -4 ; s iz e = 4 S o , t h e p r e c e d in g A S M c o d e r e s o lv e s t o t h e fo llo w in g in s t r u c t io n in x 3 2 d b g: m o v d w o r d p t r s s :[e b p -0 x 4 ], 0 x 1 M O V in it ia liz e s t h e iN u mb e r v a r ia b le o n t h e s t a c k a t s s :[e b p -0 x 4 ] t o 0 x 0 1 . T h is is t h e s a m e p la c e in m e m o r y w h e r e E C X w a s p u s h e d fo r c r e a t in g r o o m fo r t h e iN u mb e r v a r ia b le . T h e s t a c k s t a t e a f t e r t h is in s t r u c t io n e x e c u t io n is a s fo llo w s : [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    iN u m b e r v a r ia b le is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 D   r e t u r n t o fo r.0 0 4 0 1 2 2 D fr o m fo r.0 0 4 0 1 0 0 0 F ig u r e 1 0 .2 4 : iN u m b e r o n s t a c k ▼L in e 2 8 -3 0 ; L in e 9 m o v D W O R D P T R _iN u m b e r $[e b p ], 1 jm p S H O R T $L N 3 @m a in T h is A S M c o d e c o r r e s p o n d s t o t h e C / C ++ c o d e lin e 9 , w h e r e iN u mb e r is a ga in in it ia liz e d a n d t h e lo o p is s t a r t e d . fo r ( iN u m b e r = 1 ; iN u m b e r <= 1 0 ; iN u m b e r = iN u m b e r + 2 ) In A S M , t h e M O V in s t r u c t io n a ga in in it ia liz e s t h e iN u mb e r v a r ia b le . A s t h e c o d e is n o t o p t im iz e d , t h e c o m p ile r d o e s n o t r e m o v e t h e u n w a n t e d o r d u p lic a t e in s t r u c t io n s . JM P is a n u n c o n d it io n a l ju m p t o $L N 3 @ma in la b e l, w h e r e t h e iN u mb e r is c o m p a r e d t o 1 0 ( 0 x 0 A ) t o ge t in t o t h e lo o p . W e w ill s e e t h e $L N 3 @ma in la b e l in t h e n e x t A S M e x p la n a t io n . T h e s t a c k s t a t e a f t e r t h is u n c o n d it io n a l JM P w ill b e t h e s a m e : [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    iN u m b e r v a r ia b le is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 D   r e t u r n t o fo r.0 0 4 0 1 2 2 D fr o m fo r.0 0 4 0 1 0 0 0 ▼L in e 3 5 -4 4 $L N 3 @m a in : c m p D W O R D P T R _iN u m b e r $[e b p ], 1 0   ; 0 0 0 0 0 0 0 a H jg S H O R T $L N 4 @m a in ; L in e 1 0 m o v e c x , D W O R D P T R _iN u m b e r $[e b p ] p u s h e c x p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f a d d e s p , 8 jm p S H O R T $L N 2 @m a in T h e p r e c e d in g A S M c o d e c o r r e s p o n d s t o t h e fo llo w in g C / C ++ c o d e lin e s 9 -1 0 , w h ic h c o m p a r e iN u mb e r w it h 1 0 ( 0 x 0 A ) . fo r ( iN u m b e r = 1 ; iN u m b e r <= 1 0 ; iN u m b e r = iN u m b e r + 2 ) p r in t f ( \" %d\\ n \", iN u m b e r ) ; L e t ’s w a lk t h r o u gh t h e A S M c o d e . T h e C M P in s t r u c t io n c o m p a r e s t h e iN u mb e r v a lu e s t o r e d o n t h e s t a c k w it h 1 0 ( 0 x 0 A ) . It w ill p e r fo r m a s ign e d c o m p a r is o n ju m p if t h e iN u mb e r a t [E B P -0 x 0 4 ] is gr e a t e r t h a n 1 0 ( 0 x 0 A ) . C u r r e n t ly, t h e iN u mb e r is 1 s o t h e ju m p w ill n o t h a p p e n a n d t h e in s t r u c t io n p o in t e r w ill m o v e t o t h e n e x t s e c t io n a f t e r t h e lin e 1 0 c o m m e n t in t h e a s s e m b ly lis t in g. T h e C M P in s t r u c t io n a ls o s e t s Z F =0 . In s t r u c t io n s a f t e r t h e lin e 1 0 c o m m e n t m o v e t h e iN u mb e r v a lu e a t [E B P -4 ] t o t h e E C X r e gis t e r s o t h a t E C X c a n b e p u s h e d b a c k t o t h e s t a c k a lo n g w it h t h e s t r in g c o n s t a n t $S G 4 6 8 1 a s a r gu m e n t t o O n c a ll t o t h e p r in t f fu n c t io n , iN u mb e r v a lu e = 1 w ill b e p r in t e d o n t h e s c r e e n . O n r e t u r n fr o m t h e p r in t f c a ll, t h e s t a c k is c le a n e d w it h t h e A D D in s t r u c t io n b y a d d in g 8 b y t e s t o T h e w h ic h is a n u n c o n d it io n a l ju m p , m a k e s t h e in s t r u c t io n p o in t e r m o v e t o t h e $L N 2 @ma in la b e l, w h e r e t h e iN u mb e r is in c r e m e n t e d b y 2 . T h e s t a c k s t a t e a f t e r t h e u n c o n d it io n a l ju m p is a s fo llo w s : [E S P -0 x 8 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   N o w JUN K , \" %d \\ n \", p a r a me t e r t o p r in t ( ) w a s p u s h e d [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 1   N o w JUN K , iN u mb e r p a r a me t e r t o p r in t ( ) w a s p u s h e d [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    iN u m b e r v a r ia b le is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 D   r e t u r n t o fo r.0 0 4 0 1 2 2 D fr o m fo r.0 0 4 0 1 0 0 0 F ig u r e 1 0 .2 5 : S t a c k s t a t e a f t e r u n c o n d it io n a l ju m p ▼L in e 3 1 -3 4 $L N 2 @m a in : m o v e a x , D W O R D P T R _iN u m b e r $[e b p ] a d d e a x , 2 m o v D W O R D P T R _iN u m b e r $[e b p ], e a x T h is A S M c o d e c o r r e s p o n d s t o t h e fo llo w in g C / C ++ c o d e lin e 9 , w h e r e t h e iN u mb e r is in c r e m e n t e d b y 2 . fo r ( iN u m b e r = 1 ; iN u m b e r <= 1 0 ; iN u m b e r = iN u m b e r + 2 ) In A S M , t h e M O V in s t r u c t io n t a k e s t h e iN u mb e r v a lu e fr o m [E B P - 0 x 4 ] t o t h e E A X r e gis t e r, w h e r e E A X is in c r e m e n t e d b y 2 u s in g t h e A D D in s t r u c t io n a n d m o v e d b a c k t o t h e m e m o r y p la c e h o ld e r fo r F o llo w in g t h is in s t r u c t io n is t h e s a m e in s t r u c t io n w h e n iN u mb e r is c o m p a r e d w it h 1 0 ( 0 x 0 A ) , a s d is c u s s e d p r e v io u s ly. T h e s t a c k s t a t e a f t e r t h e in c r e m e n t is a s fo llo w s : [E S P -0 x 8 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   N o w JUN K , \" %d \\ n \", p a r a me t e r t o p r in t ( ) w a s p u s h e d [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 1   N o w JUN K , iN u mb e r p a r a me t e r t o p r in t ( ) w a s p u s h e d [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 3   iN u m b e r v a r ia b le is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 D   r e t u r n t o fo r.0 0 4 0 1 2 2 D fr o m fo r.0 0 4 0 1 0 0 0 F ig u r e 1 0 .2 6: iN u m b e r o n s t a c k is in c r e m e n t e d ▼L in e 3 5 -3 7 $L N 3 @m a in : c m p D W O R D P T R _iN u m b e r $[e b p ], 1 0   ; 0 0 0 0 0 0 0 a H jg S H O R T $L N 4 @m a in T h is A S M c o d e c o r r e s p o n d s t o t h e fo llo w in g C / C ++ c o d e lin e 9 , w h ic h c o m p a r e s t h e iN u mb e r w it h t h e 1 0 ( 0 x 0 A ) . fo r ( iN u m b e r = 1 ; iN u m b e r <= 1 0 ; iN u m b e r = iN u m b e r + 2 ) N o w , w e w ill t a k e t h a t it e r a t io n w h e r e in t h e iN u mb e r is in c r e m e n t e d t o 1 1 ( 0 x B ) . A t t h is p o in t , it w ill p e r fo r m a s ign e d c o m p a r is o n ju m p a s t h e iN u mb e r a t [E B P -0 x 0 4 ] is gr e a t e r t h a n 1 0 ( 0 x 0 A ) . T h e iN u mb e r is 1 1 ( 0 x B ) , s o t h e ju m p w ill h a p p e n t o t h e $L N 4 @ma in la b e l. T h e s t a c k s t a t e a f t e r t h e JG ( JUMP if G r e a t e r ) is a s fo llo w s : [E S P -0 x 8 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   N o w JUN K , \" %d \\ n \", p a r a me t e r t o p r in t ( ) w a s p u s h e d [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 9   N o w JUN K , la s t iN u mb e r v a lu e p u s h e d a s a r g t o p r in t [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 B   iN u m b e r v a r ia b le is s t o r e d h e r e [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 2 D   r e t u r n t o fo r.0 0 4 0 1 2 2 D fr o m fo r.0 0 4 0 1 0 0 0 F ig u r e 1 0 .2 7 : iN u m b e r is in c r e m e n t e d t o 1 1 ( 0 x 0 B ) ▼L in e 4 5 -5 3 $L N 4 @m a in : ; L in e 1 1 x o r e a x , e a x m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D In t h is $L N 4 @ma in la b e l, E A X is z e r o e d t o r e t u r n 0 . T h e fu n c t io n e p ilo gu e is c a lle d t o E N D t h e ma in fu n c t io n , T E X T s e gm e n t , a n d c o d e . T h e s t a c k s t a t e w ill b e a s fo llo w s : [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 4 0 8 1 4 0   N o w JUN K , \" %d \\ n \", p a r a me t e r t o p r in t ( ) w a s p u s h e d [E S P -0 x C ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 9   N o w JUN K , la s t iN u mb e r v a lu e p u s h e d a s a r g t o p r in t [E S P -0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 B N o w JUN K ,  iN u mb e r v a r ia b le is s t o r e d h e r e [E S P -0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   N o w JUN K , E B P p o p p e d [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 2 D   r e t u r n t o fo r.0 0 4 0 1 2 2 D fr o m fo r.0 0 4 0 1 0 0 0 F ig u r e 1 0 .2 8: S t a c k c le a n e d F o r L o o p w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 0 .2 9: F o r L o o p w it h O p t im iz a t io n To m a n u a lly d is a b le t h e A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 0 .3 0 : F o r -O p t im iz e d .a s m L e t ’s w a lk t h r o u gh t h e ge n e r a t e d A S M c o d e u s in g t h e o p t im iz a t io n ﬂ a g. ▼L in e 2 1 -2 2 ; L in e 7 p u s h e s i In t h e fu n c t io n p r o lo gu e , E S I is p u s h e d o n t o t h e s t a c k a n d in t h e fu n c t io n e p ilo gu e , E S I is p o p p e d u p . E S I w ill b e u s e d a s t h e iN u mb e r p la c e h o ld e r. S o b e fo r e u s in g it a s a p la c e h o ld e r fo r t h e t h e o ld v a lu e E S I is p r e s e r v e d o n t o t h e s t a c k a n d in t h e ma in p r o c e d u r e e p ilo gu e , t h e E S I v a lu e is r e s t o r e d t o t h e o ld v a lu e u s in g P O P ▼L in e 2 3 -2 5 ; L in e 9 m o v e s i, 1 n p a d 1 0 L in e 9 o f t h e C / C ++ c o d e in it ia liz e s t h e iN u mb e r v a r ia b le : fo r ( iN u m b e r = 1 ; iN u m b e r <= 1 0 ; iN u m b e r = iN u m b e r + 2 ) In t h e A S M c o d e , t h e E S I r e gis t e r w ill b e u s e d a s a p la c e h o ld e r fo r t h e iN u mb e r v a lu e . S o , 0 x 0 1 is m o v e d t o t h e E S I r e gis t e r t o in it ia liz e t h e n p a d m a c r o in s e r t s n o n -d e s t r u c t iv e n o n -o p e r a t io n a l in s t r u c t io n s . F o r in fo r m a t io n o n p le a s e r e fe r t o t h e A p p e n d ix s e c t io n . T h e c o m p ile r in s e r t s t h r e e in s t r u c t io n s t h a t w ill h a v e n o e ﬀ e c t o n t h e c o d e ﬂ o w ; t h e y a r e ju s t e q u iv a le n t t o a s e r ie s o f N O P s o f s iz e 1 0 b y t e s . In x 3 2 d b g, n p a d m a c r o is r e s o lv e d a s m a r k e d w it h in t h e R E D b o x : F ig u r e 1 0 .3 1 : n p a d 1 0 T h e c o m p ile r p a d s 1 0 b y t e s b e t w e e n t h e mo v e s i,1 in s t r u c t io n a n d t h e la b e l $L L 3 @ma in ( d e ﬁ n e d n e x t ) . ▼L in e 2 6 -3 4 $L L 3 @m a in : ; L in e 1 0 p u s h e s i p u s h O F F S E T $S G 4 6 8 1 c a ll _p r in t f a d d e s i, 2 a d d e s p , 8 c m p e s i, 1 0      ; 0 0 0 0 0 0 0 a H jle S H O R T $L L 3 @m a in L in e 9 -1 0 o f t h e C / C ++ c o d e in it ia liz e s t h e iN u mb e r v a lu e t o e n t e r in t o t h e lo o p t o p r in t iN u mb e r a n d in c r e m e n t e v e r y iN u mb e r it e r a t io n b y 2 . fo r ( iN u m b e r = 1 ; iN u m b e r <= 1 0 ; iN u m b e r = iN u m b e r + 2 ) p r in t f ( \" %d\\ n \", iN u m b e r ) ; In A S M , it is d o n e b y p u s h in g E S I a n d t h e s t r in g c o n s t a n t $S G 4 6 8 1 o n t o t h e s t a c k . O n c e w e h a v e b o t h t h e a r gu m e n t s t o t h e p r in t f fu n c t io n o n t h e s t a c k , t h e c a ll t o t h e p r in t f fu n c t io n is m a d e . T h is w ill p r in t t h e c u r r e n t v a lu e o f iN u mb e r s t o r e d in t h e E S I r e gis t e r o n t h e s c r e e n . N o w , E S I is in c r e m e n t e d b y 2 b y a d d in g 0 x 0 2 t o t h e E S I r e gis t e r. T h is is t o in c r e m e n t t h e iN u mb e r v a lu e b y 2 . N e x t , t h e A D D in s t r u c t io n c le a n s u p t h e s t a c k b y a d d in g 8 b y t e s t o t h e E S P r e gis t e r. C M P w ill c o m p a r e t h e v a lu e in E S I w it h 0 x 1 0 . It w ill p e r fo r m a s ign e d c o m p a r is o n ju m p a f t e r a C M P in s t r u c t io n if t h e v a lu e in E S I is le s s t h a n o r e q u a l t o 1 0 ( 0 x 0 A ) . In o u r c a s e , t h e c u r r e n t v a lu e o f E S I = 0 x 0 3 a f t e r in c r e m e n t in g, w h ic h is le s s t h a n 1 0 ( 0 x 0 A ) . S o , t h e in s t r u c t io n p o in t e r w ill ju m p t o t h e $L L 3 @ma in la b e l. T h e s t a c k s t a t e a n d x 3 2 d b g s c r e e n s h o t a t t h is p o in t w ill b e a s fo llo w s : [E S P -0 x 8 ] 0 0 1 2 F F 3 8   0 0 4 0 8 1 4 0   \" %d \\ n \", p a r a me t e r t o p r in t f( ) [E S P -0 x 4 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1   ES I h o ld in g iN u mb e r is p u s h e d , a s a r g t o p r in t f [E S P ]  0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   O ld v a lu e o f E S I is p r e s e r v e d o n s t a c k [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 1 B   r e t u r n t o 0 x 0 0 4 0 1 2 1 B fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 0 .3 2 : A f t e r JM P T h is lo o p it e r a t e s u n t il E S I b e c o m e s 0 x 0 B . Wh e n E S I is in c r e m e n t e d t o 0 x 0 B , a s ign e d c o m p a r is o n ju m p a f t e r a C M P in s t r u c t io n w ill n o t t a k e p la c e . S o , t h e in s t r u c t io n p o in t e r w ill m o v e t o t h e e n d o f t h e a s s e m b ly c o d e . T h e s t a c k s t a t e a t t h is p o in t is a s fo llo w s : [E S P -0 x 8 ] 0 0 1 2 F F 3 8   0 0 4 0 8 1 4 0   \" %d\\ n \", p a r a m e t e r t o p r in t f( ) [E S P -0 x 4 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 9   ES I h o ld in g iN u m b e r is p u s h e d , a s a r g t o p r in t f [E S P ]  0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   O ld v a lu e o f E S I is p r e s e r v e d o n s t a c k [E S P +0 x 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 1 B   r e t u r n t o 0 x 0 0 4 0 1 2 1 B fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 0 .3 3 : E S I is in c r e m e n t e d t o 0 x 0 B ▼L in e 3 5 -4 1 ; L in e 1 1 x o r e a x , e a x p o p e s i r e t 0 _m a in E N D P _TEX T E N D S E N D Wit h t h is , t h e ma in fu n c t io n , T E X T s e gm e n t , a n d c o d e is e n d e d b y X O R ’in g E A X t o r e t u r n 0 a n d t h e o ld v a lu e o f E S I is r e s t o r e d fr o m t h e s t a c k b y t h e P O P E S I in s t r u c t io n . T h e s t a c k s t a t e a t t h is p o in t w ill b e a s fo llo w s : [E S P -0 x C ] 0 0 1 2 F F 3 8   0 0 4 0 8 1 4 0   N o w JUN K [E S P -0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 9   N o w JUN K [E S P -0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 0   N o w JUN K [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 1 B    r e t u r n t o 0 x 0 0 4 0 1 2 1 B fr o m 0 x 0 0 4 0 1 0 0 0 C o n c lu s io n In t h is c h a p t e r, w e le a r n e d a b o u t t h e d iﬀ e r e n t lo o p s t a t e m e n t s in C / C ++ a n d h o w t h e c o d e p a t t e r n o f d iﬀ e r e n t lo o p s t a t e m e n t s c a n b e id e n t iﬁ e d in a d is a s s e m b le d c o d e . W e a ls o fo u n d o u t h o w t o p u t t a c o n d it io n a l b r e a k p o in t t o c h e c k t h e s t a c k s t a t e a n d t h e m a jo r ﬂ a g b it s . In t h e a s s e m b ly lis t in g ge n e r a t e d fr o m lo o p s t a t e m e n t p r o gr a m s , w e c h e c k e d C M P a n d Ju m p in s t r u c t io n p a t t e r n s in a s s e m b ly a n d le a r n e d t h e d iﬀ e r e n c e b e t w e e n o p t im iz e d a n d n o n -o p t im iz e d c o d e . In t h e s u b s e q u e n t c h a p t e r s , w e w ill t a lk a b o u t r e a l-w o r ld p r o b le m s a n d t h e ir s o lu t io n s . C H A P T E R 1 1 A r r a y C o d e P a t t e r n in R e v e r s e E n gin e e r in g Im a gin e y o u a r e a p r o gr a m m e r w o r k in g in s o m e c o m p a n y t o d e v e lo p s o f t w a r e t o m a r k t h e a t t e n d a n c e o f 5 0 s t u d e n t s in a c la s s . N o w , a s a s o f t w a r e d e v e lo p e r, y o u h a v e a n o p t io n t o d e ﬁ n e s e p a r a t e v a r ia b le s fo r s t u d e n t s , w h ic h is q u it e d iﬃ c u lt t o m a n a ge a n d n o t a p p r o p r ia t e in c a s e t h e s t u d e n t c o u n t in c r e a s e s in t h e fu t u r e . To m a n a ge t h e s e s it u a t io n s w h e r e y o u h a v e s im ila r d a t a t y p e v a r ia b le s , e v e r y p r o gr a m m in g la n gu a ge is e q u ip p e d w it h t h e c o n c e p t o f a r r a y s . A r r a y s a r e s e t s o f s im ila r e le m e n t s s t o r e d in c o n t igu o u s m e m o r y lo c a t io n s . S o , in d e v e lo p in g t h e a t t e n d a n c e s o f t w a r e fo r a c la s s , a n a r r a y w ill b e t h e m o s t a p p r o p r ia t e . W e h a v e a lr e a d y s t u d ie d t h e p a t t e r n o f p o in t e r s in t h e e a r lie r c h a p t e r. P o in t e r s a n d a r r a y a r e c o r r e la t e d t o e a c h o t h e r. T h e im p o r t a n c e o f a r r a y in r e v e r s e e n gin e e r in g is v e r y im p o r t a n t . S o m e t im e s , m a lw a r e w r it e r s c o d e m a lw a r e in s u c h a w a y t h a t t h e y in fe c t t h e lis t o f ﬁ le s w it h a s p e c iﬁ c e x t e n s io n . In m o s t o f t h e s e c a s e s , a ll t h e s p e c iﬁ c ﬁ le e x t e n s io n s a r e d e ﬁ n e d in a n a r r a y. S o , a d d in g a n y o t h e r e x t e n s io n in t h e fu t u r e t o t h e m a lw a r e b e c o m e s e a s y fo r m a lw a r e c o d e r s . In t h is c h a p t e r, w e w ill w o r k o n t h is r e a l-w o r ld p r o b le m b y c o d in g t h e s a m e p r o gr a m u s in g a r r a y a n d t h e n r e v e r s in g it t o u n d e r s t a n d it s p a t t e r n . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Un d e r s t a n d in g a n a r r a y A r r a y lo o p w it h o u t O p t im iz a t io n A r r a y lo o p w it h O p t im iz a t io n O b je c t iv e T h e o b je c t iv e o f t h is c h a p t e r is t o u n d e r s t a n d t h e w o r k in g o f a n a r r a y w it h r e s p e c t t o r e v e r s e e n gin e e r in g. W e w ill t a lk a b o u t t h e a r r a y c o d e p a t t e r n in a d is a s s e m b le d c o d e a n d h o w a r r a y s a r e s t o r e d in m e m o r y. A r r a y s a r e s t o r e d in c o n t igu o u s m e m o r y lo c a t io n s a n d d e p e n d in g o n t h e d a t a t y p e s o f t h e a r r a y, t h e s t o r a ge is a llo c a t e d in m e m o r y. W e w ill a ls o le a r n t o p u t a c o n d it io n a l b r e a k p o in t in c o d e e x e c u t io n . W e w ill a ls o c o v e r a n a r r a y p r o gr a m p a t t e r n w h e n t h e c o d e is o p t im iz e d a n d n o t o p t im iz e d . Un d e r s t a n d in g a n a r r a y In t h is e x a m p le , w e h a v e d e c la r e d a n d d e ﬁ n e d a n a r r a y n a m e d W e w ill it e r a t e t h r o u gh t h e a r r a y u p t o it s le n gt h a n d p r in t e a c h e le m e n t a lo n g w it h t h e in d e x o n t h e s c r e e n . F ig u r e 1 1 .1 : A r r a y.c p p A r r a y L o o p w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 1 .2 : A r r a y L o o p w it h o u t O p t im iz a t io n C o m p ila t io n ge n e r a t e s t h e E X E ﬁ le a n d a s s e m b ly c o d e . D is a b le A S L R m a n u a lly. To d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n F o r d e t a ile d s t e p s t o u n d e r s t a n d h o w t o d is a b le A S L R , p le a s e r e fe r t o t h e A p p e n d ix . N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 1 .3 : A r r a y.a s m -P a r t -1 F ig u r e 1 1 .4 : A r r a y.a s m -P a r t -2 ▼L in e 1 2 -1 4 C O N S T S E G M E N T $S G 4 6 8 2 D B 'iA r r a y [%d]=%d', 0 a H , 0 0 H C O N S T E N D S T h e c o d e d e ﬁ n e s t w o s e gm e n t s , o n e b e in g C O N S T T h is d e r iv a t iv e is u s e d t o d e ﬁ n e t h e s t a r t o f t h e c o n s t a n t s e gm e n t in t h e m e m o r y. T h e lin k e r r e n a m e s C O N S T S E G M E N T t o .r d a t a t h e c o d e is p la c e d in t h e .c o d e s e gm e n t , t h e c o n s t a n t s t r in g is p la c e d in t h e C O N S T ( .r d a t a ) s e gm e n t a n d if n o t c o n s t a n t , it is p la c e d in t h e .d a t a s e gm e n t ], w h ic h c a n b e d u m p e d u s in g a n y d e b u gge r. B e lo w s c r e e n s h o t s h o w s $S G 4 6 8 2 in t h e m e m o r y d u m p : F ig u r e 1 1 .5 : .r d a t a T h e $S G 4 6 8 2 is t h e in t e r n a l n a m e giv e n b y t h e c o m p ile r t o h a n d le t h e s t r in g c o n s t a n t . D B , d e ﬁ n e s t h e b y t e w h ic h is t h e d a t a t y p e . 'iA r r a y [%d ]=%d ', 0 a H , 0 0 H is t h e s t r in g d a t a , w h ic h is n u ll t e r m in a t e d A S C II s t r in g. B y C O N S T t h e c o n s t a n t s e gm e n t is e n d e d . ▼L in e 1 5 -1 6 P UB L IC __$A r r a y P a d $ P UB L IC _m a in P UB L IC is t h e d e r iv a t iv e w h ic h m a k e s t h e _ma in p r o c e d u r e a n d __$A r r a y P a d $ m a c r o p u b lic , w h ic h m a k e s it a c c e s s ib le t o o t h e r m o d u le s . ▼L in e 1 7 -1 9 E X T R N _p r in t f:P R O C E X T R N ___s e c u r it y _c o o k ie :D W O R D E X T R N @__s e c u r it y _c h e c k _c o o k ie @4 :P R O C T h e E X T R N d e r iv a t iv e d e c la r e s t h e e x t e r n fu n c t io n , w h ic h is p r in t f in o u r c a s e . A ll fu n c t io n s b e gin w it h a n u n d e r s c o r e . ▼L in e 2 1 -2 4 _TEX T S E G M E N T _iA r r a y $ = -4 8       ; s iz e = 4 0 __$A r r a y P a d $ = -8      ; s iz e = 4 _iL o o p $ = -4       ; s iz e = 4 T h is is t h e s t a r t o f t h e _TEX T s e gm e n t , w h e r e o u r m a in fu n c t io n c o d e r e s id e s . A f t e r w e h a v e t h e d iﬀ e r e n t v a r ia b le m a c r o d e ﬁ n e d . To a c c e s s t h e lo c a l v a r ia b le o n t h e s t a c k fr a m e , w e h a v e t o a d d _ $ t o t h e E B P a d d r e s s . ▼L in e 2 5 _m a in P R O C T h is is t h e s t a r t o f t h e ma in p r o c e d u r e . ▼L in e 2 7 -3 0 ; L in e 7 p u s h e b p m o v e b p , e s p s u b e s p , 4 8 ; 0 0 0 0 0 0 3 0 H L in e 7 o f t h e C / C ++ c o d e s t a r t s t h e ma in fu n c t io n . in t m a in ( ) { T h e A S M c o d e s t a r t s w it h t h e ma in fu n c t io n p r o lo gu e o f P US H a n d S UB is c r e a t in g r o o m fo r v a r ia b le s o n t h e s t a c k b y s u b t r a c t in g 4 8 ( 0 x 3 0 ) fr o m E S P. ▼L in e 3 1 -3 3 m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e b p m o v D W O R D P T R __$A r r a y P a d $[e b p ], e a x To u n d e r s t a n d a ll t h e s e t h r e e in s t r u c t io n s , w e w ill ﬁ r s t h a v e t o u n d e r s t a n d t h e c o n c e p t o f s t a c k c o o k ie . A s t a c k c o o k ie is t h e p r o t e c t io n m e c h a n is m a ga in s t b u ﬀ e r o v e r ﬂ o w a t t a c k s . To u n d e r s t a n d b u ﬀ e r o v e r ﬂ o w in la y m a n t e r m s , im a gin e s o m e b o d y p o u r s m o r e c o ﬀ e e in a c u p ; t h e c o ﬀ e e p o u r e d in e x c e s s w ill s p ill o n t h e t a b le . S im ila r ly, w h e n a b u ﬀ e r s t o r e d in m e m o r y is ﬁ lle d w it h m o r e d a t a t h a n it s s iz e , t h e e x c e s s d a t a w ill b e s p ille d c a u s in g t h e c r it ic a l m e m o r y lo c a t io n s t o b e o v e r w r it t e n . A s t a c k c o o k ie is a r a n d o m v a lu e ge n e r a t e d a t e a c h e x e c u t io n . T h is v a lu e is X O R ’e d w it h E B P a n d t h e n p la c e d o n t h e s t a c k . T h is v a lu e s t o r e d o n t h e s t a c k is p la c e d b e t w e e n lo c a l v a r ia b le s ( b u ﬀ e r o r a r r a y in o u r c a s e ) a n d E B P. F ig u r e 1 1 .6: S t a c k c o o k ie O n c e t h is v a lu e is s t o r e d o n t h e s t a c k a f t e r t h e fu n c t io n p r o lo gu e , t o p r e v e n t a ga in s t b u ﬀ e r o v e r ﬂ o w a t t a c k s , t h is v a lu e is c h e c k e d b e fo r e t h e fu n c t io n e p ilo gu e . If t h is v a lu e is n o t t h e s a m e b e fo r e t h e fu n c t io n e p ilo gu e , t h e n it m e a n s t h a t a b u ﬀ e r o v e r ﬂ o w e x p lo it h a s o c c u r r e d . N o w c o m in g b a c k t o t h e ﬁ r s t M O V in s t r u c t io n , it m o v e s t h e v a lu e s t o r e d a t t h e s t a c k c o o k ie lo c a t io n t o E A X . E A X is X O R ’e d w it h E B P a n d t h e r e s u lt o f X O R is s t o r e d in E A X . T h is X O R v a lu e s t o r e d in E A X is m o v e d t o t h e s t a c k a t s s :[e b p -0 x 8 ] lo c a t io n . T h is is w h e r e o u r s t a c k c o o k ie is s t o r e d o n t h e s t a c k . L e t ’s s e e t h e s t a c k s t a t e a n d t h e s t a c k c o o k ie v a lu e in t h e m e m o r y d u m p . S t a c k C o o k ie s t o r e d a t 0 x 0 0 4 0 B 0 0 0 lo c a t io n is = 0 x E D 4 B 8 B C F E B P = 0 x 0 0 1 2 F F 4 0 S t a c k C o o k ie X O R E B P = 0 x E D 4 B 8 B C F X O R 0 x 0 0 1 2 F F 4 0 = 0 x E D 5 9 7 4 8 F [E S P ]  0 0 1 2 F F 1 0   0 0 1 2 F E F C [E B P -0 x 3 0 ] JUN K R igh t N o w [E S P +0 x 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 4 [E B P -0 x 2 C ] JUN K R igh t N o w [E S P +0 x 8 ] 0 0 1 2 F F 1 8   0 0 1 2 F F 7 8 [E B P -0 x 2 8 ] JUN K R igh t N o w [E S P +0 x C ] 0 0 1 2 F F 1 C   0 0 4 0 2 4 E 0 [E B P -0 x 2 4 ] JUN K R igh t N o w [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   ED 0 B 1 0 1 7 [E B P -0 x 2 0 ] JUN K R igh t N o w [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   F F F F F F F E [E B P -0 x 1 C ] JUN K R igh t N o w    [E S P +0 x 1 8 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 8 C [E B P -0 x 1 8 ] JUN K R igh t N o w [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 A 0 [E B P -0 x 1 4 ]  JUN K R igh t N o w [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 3 B [E B P -0 x 1 0 ] JUN K R igh t N o w [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8 [E B P -0 x 0 C ] JUN K R igh t N o w [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F [E B P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 3 B [E B P -0 x 0 4 ] JUN K R igh t N o w [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8 [E B P ] [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9 r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .7 : S t a c k c o o k ie o n s t a c k ▼L in e 3 4 -4 4 ; L in e 8 m o v D W O R D P T R _iA r r a y $[e b p ], 0 m o v D W O R D P T R _iA r r a y $[e b p +4 ], 1 m o v D W O R D P T R _iA r r a y $[e b p +8 ], 2 m o v D W O R D P T R _iA r r a y $[e b p +1 2 ], 3 m o v D W O R D P T R _iA r r a y $[e b p +1 6 ], 4 m o v D W O R D P T R _iA r r a y $[e b p +2 0 ], 5 m o v D W O R D P T R _iA r r a y $[e b p +2 4 ], 6 m o v D W O R D P T R _iA r r a y $[e b p +2 8 ], 7 m o v D W O R D P T R _iA r r a y $[e b p +3 2 ], 8 m o v D W O R D P T R _iA r r a y $[e b p +3 6 ], 9 L in e 8 o f t h e C / C ++ c o d e d e ﬁ n e s iA r r a y o f t y p e in t iA r r a y [1 0 ] = { 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 , 9 } ; In A S M , iA r r a y is o f t y p e in t e ge r, s o e a c h e le m e n t o f t h e a r r a y w ill o c c u p y 4 b y t e s o f s p a c e a s r e q u ir e d fo r t h a t in t e ge r. A ll t h e s e m o v e in s t r u c t io n s w ill p la c e t h e e le m e n t s o f iA r r a y o n t h e s t a c k . iA r r a y m a c r o is d e ﬁ n e d a s : _iA r r a y $ = -4 8 ( -0 x 3 0 ) S o _iA r r a y $[e b p ] w ill c o r r e s p o n d t o s s :[e b p -0 x 3 0 ]. S im ila r ly, o t h e r iA r r a y e le m e n t s c a n b e a c c e s s e d o n t h e s t a c k b y a d d in g _ $ t o t h e E B P a d d r e s s . T h e s t a c k s t a t e a f t e r t h e e x e c u t io n o f t h e p r e c e d in g in s t r u c t io n s is a s fo llo w s : [E S P ]  0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    [EB P -0 x 3 0 ] iA r r a y ﬁ r s t e le me n t [E S P +0 x 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   [EB P -0 x 2 C ] iA r r a y s e c o n d e le me n t [E S P +0 x 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   [EB P -0 x 2 8 ] iA r r a y t h ir d e le me n t [E S P +0 x C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   [EB P -0 x 2 4 ] iA r r a y fo r t h e le me n t [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   [EB P -0 x 2 0 ] iA r r a y ﬁ f t h e le me n t [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   [EB P -0 x 1 C ] iA r r a y s ix t h e le me n t [E S P +0 x 1 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   [EB P -0 x 1 8 ] iA r r a y s e v e n t h e le me n t [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   [EB P -0 x 1 4 ]  iA r r a y e igh t h e le me n t [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   [EB P -0 x 1 0 ] iA r r a y n in t h e le me n t [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   [EB P -0 x 0 C ] iA r r a y t e n t h e le me n t [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   [EB P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 3 B   [EB P -0 x 0 4 ] JUN K R igh t N o w [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .8: iA r r a y o n s t a c k ▼L in e 3 5 -4 7 ; L in e 1 1 m o v D W O R D P T R _iL o o p $[e b p ], 0 jm p S H O R T $L N 3 @m a in L in e 1 1 o f t h e C / C ++ c o d e in it ia liz e s t h e iL o o p v a r ia b le t o it e r a t e o v e r t h e iA r r a y e le m e n t s . T h e M O V in s t r u c t io n is p la c in g 0 x 0 0 o n t h e iL o o p v a r ia b le p la c e h o ld e r o n t h e s t a c k a t s s :[e b p -0 x 4 ]. T h e JM P in s t r u c t io n m a k e s a n u n c o n d it io n a l ju m p t o t h e $L N 3 @ma in la b e l. ▼L in e 5 2 -5 4 $L N 3 @m a in : c m p D W O R D P T R _iL o o p $[e b p ], 1 0   ; 0 0 0 0 0 0 0 a H jge S H O R T $L N 1 @m a in T h e C M P in s t r u c t io n c o m p a r e s t h e iL o o p v a lu e s t o r e d o n t h e s t a c k w it h 1 0 ( 0 x 0 A ) . It w ill p e r fo r m a s ign e d c o m p a r is o n ju m p if t h e iL o o p a t [E B P -0 x 0 4 ] is gr e a t e r t h a n o r e q u a l t o 1 0 ( 0 x 0 A ) . C u r r e n t ly, iL o o p is 0 , s o t h e ju m p w ill n o t h a p p e n a n d t h e in s t r u c t io n p o in t e r w ill m o v e t o t h e n e x t in s t r u c t io n . T h e s t a c k s t a t e w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    [EB P -0 x 3 0 ] iA r r a y ﬁ r s t e le me n t [E S P +0 x 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   [EB P -0 x 2 C ] iA r r a y s e c o n d e le me n t [E S P +0 x 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   [EB P -0 x 2 8 ] iA r r a y t h ir d e le me n t [E S P +0 x C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   [EB P -0 x 2 4 ] iA r r a y fo r t h e le me n t [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   [EB P -0 x 2 0 ] iA r r a y ﬁ f t h e le me n t [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   [EB P -0 x 1 C ] iA r r a y s ix t h e le me n t [E S P +0 x 1 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   [EB P -0 x 1 8 ] iA r r a y s e v e n t h e le me n t [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   [EB P -0 x 1 4 ]  iA r r a y e igh t h e le me n t [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   [EB P -0 x 1 0 ] iA r r a y n in t h e le me n t [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   [EB P -0 x 0 C ] iA r r a y t e n t h e le me n t [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   [EB P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 0   [EB P -0 x 0 4 ] iL o o p p la c e h o ld e r h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .9: iL o o p is 0 ▼L in e 5 5 -6 4 ; L in e 1 2 m o v e c x , D W O R D P T R _iL o o p $[e b p ] m o v e d x , D W O R D P T R _iA r r a y $[e b p +e c x *4 ] p u s h e d x m o v e a x , D W O R D P T R _iL o o p $[e b p ] p u s h e a x p u s h O F F S E T $S G 4 6 8 2 c a ll _p r in t f a d d e s p , 1 2      ; 0 0 0 0 0 0 0 c H jm p S H O R T $L N 2 @m a in L in e 1 2 o f t h e C / C ++ c o d e p r in t s t h e e le m e n t o f iA r r a y a r r a y a lo n g w it h t h e in d e x o n t h e s c r e e n . p r in t f ( \" iA r r a y [%d]=%d\\ n \", iL o o p , iA r r a y [iL o o p ]) ; A s t h e p r in t f fu n c t io n t a k e s t h r e e a r gu m e n t s t o p r in t o n t h e s c r e e n , a ll t h e s e t h r e e a r gu m e n t s n e e d t o b e p u s h e d o n t o t h e s t a c k b e fo r e t h e c a ll t o t h e p r in t f fu n c t io n . In t h e A S M c o d e , t h e ﬁ r s t a r gu m e n t t o b e p u s h e d o n t h e s t a c k w ill b e iA r r a y [iL o o p ]. To p u s h t h is v a lu e o n t h e s t a c k , t h e iL o o p v a lu e s t o r e d a t [E B P -0 x 0 4 ] is m o v e d t o E C X is t h e c u r r e n t v a lu e o f a r r a y in d e x . It is m u lt ip lie d b y 4 ( t h e s iz e o f t h e in t e ge r ) a n d t h e n a d d e d t o t h e iA r r a y m a c r o t o c a lc u la t e t h e m e m o r y lo c a t io n o f t h e e le m e n t s t o r e d fo r t h e p a r t ic u la r a r r a y in d e x . T h is w ill giv e u s t h e v a lu e o f t h e ﬁ r s t a r r a y e le m e n t in t h e E D X r e gis t e r. S o , b y p u s h in g E D X o n t o t h e s t a c k , w e p u s h e d t h e ﬁ r s t a r gu m e n t t o p r in t f o n t o t h e s t a c k . N e x t a r gu m e n t , iL o o p is p u s h e d o n t o t h e s t a c k b y ﬁ r s t p u s h in g t h e iL o o p v a lu e s t o r e d a t [E B P -0 x 0 4 ] t o a n d t h e p u s h E A X w h ic h is s e c o n d a r gu m e n t t o L a s t a r gu m e n t , t h e s t r in g c o n s t a n t is p u s h e d b y p u s h O F F S E T N o w , t h e t h r e e a r gu m e n t s a r e o n t h e s t a c k . S o a c a ll t o p r in t f is m a d e . T h e s t a c k s t a t e a t t h is p o in t in t im e is a s fo llo w s : [E S P ]  0 0 1 2 F F 0 4   0 0 4 0 8 1 4 0   [EB P -0 x 4 0 ] \" iA r r a y [%d ]=%d \\ n \", a r gu me n t t o p r in t f [E S P +0 x 4 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0   [EB P -0 x 3 8 ] iL o o p v a lu e is p u s h e d a s p r in t f a r gu me n t [E S P +0 x 8 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0   [EB P -0 x 3 4 ] iA r r a y ﬁ r s t e le me n t p u s h e d a s p r in t f a r g E S P +0 x C ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   [EB P -0 x 3 0 ] iA r r a y ﬁ r s t e le me n t [E S P +0 x 1 0 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   [EB P -0 x 2 C ] iA r r a y s e c o n d e le me n t [E S P +0 x 1 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   [EB P -0 x 2 8 ] iA r r a y t h ir d e le me n t [E S P +0 x 1 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   [EB P -0 x 2 4 ] iA r r a y fo r t h e le me n t [E S P +0 x 1 C ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   [EB P -0 x 2 0 ] iA r r a y ﬁ f t h e le me n t [E S P +0 x 2 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   [EB P -0 x 1 C ] iA r r a y s ix t h e le me n t [E S P +0 x 2 4 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   [EB P -0 x 1 8 ] iA r r a y s e v e n t h e le me n t [E S P +0 x 2 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   [EB P -0 x 1 4 ]  iA r r a y e igh t h e le me n t [E S P +0 x 2 C ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   [EB P -0 x 1 0 ] iA r r a y n in t h e le me n t [E S P +0 x 3 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   [EB P -0 x 0 C ] iA r r a y t e n t h e le me n t [E S P +0 x 3 4 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   [EB P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d [E S P +0 x 3 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 0   [EB P -0 x 0 4 ] iL o o p p la c e h o ld e r h e r e [E S P +0 x 3 C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .1 0 : P r in t f a r g o n s t a c k O n r e t u r n fr o m c a ll t o t h e p r in t f fu n c t io n , t h e s t a c k is c le a n e d b y 1 2 b y t e s b y t h e A D D in s t r u c t io n . N e x t , a n u n c o n d it io n a l ju m p t o $L N 2 @ma in la b e l is m a d e . T h e s t a c k s t a t e a f t e r t h e u n c o n d it io n a l ju m p is a s fo llo w s : [E S P -0 x 0 C ] 0 0 1 2 F F 0 4   0 0 4 0 8 1 4 0   [EB P -0 x 4 0 ] N O W JUN K [E S P -0 x 8 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0   [EB P -0 x 3 8 ] N O W JUN K [E S P -0 x 4 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0   [EB P -0 x 3 4 ]  N O W JUN K [E S P ]  0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    [EB P -0 x 3 0 ] iA r r a y ﬁ r s t e le me n t [E S P +0 x 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   [EB P -0 x 2 C ] iA r r a y s e c o n d e le me n t [E S P +0 x 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   [EB P -0 x 2 8 ] iA r r a y t h ir d e le me n t [E S P +0 x C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   [EB P -0 x 2 4 ] iA r r a y fo r t h e le me n t [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   [EB P -0 x 2 0 ] iA r r a y ﬁ f t h e le me n t [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   [EB P -0 x 1 C ] iA r r a y s ix t h e le me n t [E S P +0 x 1 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   [EB P -0 x 1 8 ] iA r r a y s e v e n t h e le me n t [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   [EB P -0 x 1 4 ]  iA r r a y e igh t h e le me n t [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   [EB P -0 x 1 0 ] iA r r a y n in t h e le me n t [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   [EB P -0 x 0 C ] iA r r a y t e n t h e le me n t [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   [EB P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 0   [EB P -0 x 0 4 ] iL o o p p la c e h o ld e r h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .1 1 : S t a c k c le a n e d ▼L in e 4 8 -5 1 $L N 2 @m a in : m o v e a x , D W O R D P T R _iL o o p $[e b p ] a d d e a x , 1 m o v D W O R D P T R _iL o o p $[e b p ], e a x A t t h is la b e l, t h e iL o o p v a lu e fr o m [E B P -0 x 0 4 ] is m o v e d t o E A X a n d in c r e m e n t e d b y 1 . T h is in c r e m e n t is p la c e d b a c k t o [E B P -0 x 4 ]. T h e in s t r u c t io n p o in t e r w ill a ga in it e r a t e o v e r t h e la b e l $L N 3 @ma in t o c o m p a r e t h e iL o o p v a lu e w it h 1 0 ( 0 x 0 A ) . ▼L in e 5 2 -5 4 $L N 3 @m a in : c m p D W O R D P T R _iL o o p $[e b p ], 1 0   ; 0 0 0 0 0 0 0 a H jge S H O R T $L N 1 @m a in N o w , im a gin e t h a t w e it e r a t e d 9 t im e s o v e r t h e in s t r u c t io n s a n d t h e iL o o p v a lu e h a s b e c o m e 1 0 A t t h is p o in t , t h e C M P in s t r u c t io n w ill p e r fo r m a s ign e d c o m p a r is o n ju m p a s t h e iL o o p a t [E B P - 0 x 0 4 ] is e q u a l t o 1 0 ( 0 x 0 A ) a n d it w ill a ls o s e t Z F =1 . A s iL o o p is 1 0 ( 0 x A ) , s o t h e ju m p w ill h a p p e n t o t h e $L N 1 @ma in la b e l. T h e s t a c k s t a t e a f t e r JUMP if gr e a t e r e q u a l is a s fo llo w s : [E S P -0 x 0 C ] 0 0 1 2 F F 0 4   0 0 4 0 8 1 4 0   [EB P -0 x 4 0 ] N O W JUN K [E S P -0 x 8 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 9   [EB P -0 x 3 8 ] N O W JUN K [E S P -0 x 4 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 9   [EB P -0 x 3 4 ] N O W JUN K [E S P ]  0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    [EB P -0 x 3 0 ] iA r r a y ﬁ r s t e le me n t [E S P +0 x 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   [EB P -0 x 2 C ] iA r r a y s e c o n d e le me n t [E S P +0 x 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   [EB P -0 x 2 8 ] iA r r a y t h ir d e le me n t [E S P +0 x C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   [EB P -0 x 2 4 ] iA r r a y fo r t h e le me n t [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   [EB P -0 x 2 0 ] iA r r a y ﬁ f t h e le me n t [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   [EB P -0 x 1 C ] iA r r a y s ix t h e le me n t [E S P +0 x 1 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   [EB P -0 x 1 8 ] iA r r a y s e v e n t h e le me n t [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   [EB P -0 x 1 4 ] iA r r a y e igh t h e le me n t [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   [EB P -0 x 1 0 ] iA r r a y n in t h e le me n t [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   [EB P -0 x 0 C ] iA r r a y t e n t h e le me n t [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   [EB P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 A   [EB P -0 x 0 4 ] iL o o p p la c e h o ld e r h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .1 2 : T h e s t a c k s t a t e a f t e r JG E ▼L in e 6 5 -7 7 $L N 1 @m a in : ; L in e 1 4 x o r e a x , e a x ; L in e 1 5 m o v e c x , D W O R D P T R __$A r r a y P a d $[e b p ] x o r e c x , e b p c a ll @__s e c u r it y _c h e c k _c o o k ie @4 m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D A t t h is la b e l, E A X is z e r o e d u s in g X O R t o r e t u r n 0 a s p e r lin e 1 4 o f t h e C / C ++ c o d e . S e c u r it y C o o k ie is c h e c k e d b e fo r e t h e fu n c t io n e p ilo gu e b y ﬁ r s t m o v in g t h e S e c u r it y C o o k ie s t o r e d a t [E B P -0 x 0 8 ] t o E C X a n d t h e n X O R E C X w it h E B P. A c a ll t o t h e s e c u r it y _c h e c k _c o o k ie p r o c e d u r e is m a d e t o p r e v e n t t h e b u ﬀ e r o v e r ﬂ o w a t t a c k . S e c u r it y C o o k ie s t o r e d a t [E B P -0 x 0 8 ] = 0 x E D 5 9 7 4 8 F E B P = 0 x 0 0 1 2 F F 4 0 E C X X O R E B P = 0 x E D 5 9 7 4 8 F X O R 0 x 0 0 1 2 F F 4 0 = 0 x E D 4 B 8 B C F T h e r e s u lt w ill b e s a v e d in E C X . A s w e c a n s e e , t h is v a lu e is t h e s a m e a s t h e v a lu e ge n e r a t e d a n d s t o r e d a t t h e 0 x 0 0 4 0 B 0 0 0 m e m o r y lo c a t io n . A s w e a r e d e a lin g w it h lit t le -e n d ia n , t h e v a lu e is s t o r e d in t h e r e v e r s e d o r d e r. T h e s t a c k s t a t e a t t h is p o in t is t h e s a m e a s e a r lie r : [E S P -0 x 0 C ] 0 0 1 2 F F 0 4   0 0 4 0 8 1 4 0   [EB P -0 x 4 0 ] N O W JUN K [E S P -0 x 8 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 9   [EB P -0 x 3 8 ] N O W JUN K [E S P -0 x 4 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 9   [EB P -0 x 3 4 ] N O W JUN K [E S P ]  0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    [EB P -0 x 3 0 ] iA r r a y ﬁ r s t e le me n t [E S P +0 x 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   [EB P -0 x 2 C ] iA r r a y s e c o n d e le me n t [E S P +0 x 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   [EB P -0 x 2 8 ] iA r r a y t h ir d e le me n t [E S P +0 x C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   [EB P -0 x 2 4 ] iA r r a y fo r t h e le me n t [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   [EB P -0 x 2 0 ] iA r r a y ﬁ f t h e le me n t [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   [EB P -0 x 1 C ] iA r r a y s ix t h e le me n t [E S P +0 x 1 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   [EB P -0 x 1 8 ] iA r r a y s e v e n t h e le me n t [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   [EB P -0 x 1 4 ]  iA r r a y e igh t h e le me n t [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   [EB P -0 x 1 0 ] iA r r a y n in t h e le me n t [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   [EB P -0 x 0 C ] iA r r a y t e n t h e le me n t [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   [EB P -0 x 0 8 ] S t a c k C o o k ie x o r E B P v a lu e p la c e d [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 A   [EB P -0 x 0 4 ] iL o o p p la c e h o ld e r h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .1 3 : C a ll t o s e c u r it y _c h e c k _c o o k ie If w e s t e p in t o t h e c a ll w e c a n s e e t h a t o u r X O R r e s u lt s a v e d in E C X is c o m p a r e d w it h t h e s e c u r it y c o o k ie s t o r e d a t F ig u r e 1 1 .1 4 : S e c u r it y _c h e c k _c o o k ie fu n c t io n A s o u r s e c u r it y c o o k ie s t o r e d a t 0 x 0 0 4 0 B 0 0 0 is t h e s a m e a s t h a t in E C X , Z F =1 , t h e in s t r u c t io n p o in t e r w ill r e t u r n b a c k t o t h e ma in fu n c t io n . O n r e t u r n , t h e fu n c t io n e p ilo gu e is c a lle d t o e n d t h e ma in fu n c t io n , T E X T s e gm e n t , a n d c o d e . B e lo w is t h e s t a c k s t a t e e x p la in e d b e fo r e r e t u r n in s t r u c t io n : [E S P -0 x 3 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   N O W JUN K [E S P -0 x 3 0 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 1   N O W JUN K [E S P -0 x 2 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 2   N O W JUN K [E S P -0 x 2 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 3   N O W JUN K [E S P -0 x 2 4 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 4   N O W JUN K [E S P -0 x 2 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 5   N O W JUN K [E S P -0 x 1 C ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 6   N O W JUN K [E S P -0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 7   N O W JUN K [E S P -0 x 1 4 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 8   N O W JUN K [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 9   N O W JUN K [E S P -0 x 0 C ] 0 0 1 2 F F 3 8   ED 5 9 7 4 8 F   N O W JUN K [E S P -0 x 0 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 A   N O W JUN K [E S P -0 x 0 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   N O W JUN K [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 9 9   r e t u r n t o a r r a y.0 0 4 0 1 2 9 9 fr o m a r r a y.0 0 4 0 1 0 0 0 F ig u r e 1 1 .1 5 : S t a c k c le a n e d A r r a y L o o p w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 1 .1 6: A r r a y L o o p w it h O p t im iz a t io n T h e c o m p ila t io n ge n e r a t e s t h e E X E ﬁ le a n d a s s e m b ly c o d e . D is a b le A S L R m a n u a lly. To d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n F o r d e t a ile d s t e p s t o d is a b le A S L R , p le a s e r e fe r t o t h e N o w , le t u s m o v e o n t o ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 1 .1 7 : A r r a y -O p t im iz e d .a s m -P a r t -1 F ig u r e 1 1 .1 8: A r r a y -O p t im iz e d .a s m -P a r t -2 Wit h o p t im iz a t io n e n a b le d , a ll o f t h e u n w a n t e d c o d e is r e m o v e d in t h e A S M lis t in g. A s w e w a lk t h r o u gh t h e A S M c o d e , w e s e e t h a t t h e s t a n d a r d fu n c t io n p r o lo gu e a n d t h e e p ilo gu e a r e n o t in t h e o p t im iz e d c o d e . S o , t h e E B P r e fe r e n c e is r e p la c e d w it h E S P in a ll t h e in s t r u c t io n s . W e w ill d ir e c t ly ju m p t o t h e in s t r u c t io n s a s w e h a v e c o v e r e d s o m e o f t h e c o m m o n A S M lis t in gs in t h e e a r lie r s e c t io n . ▼L in e 2 6 -3 1 ; L in e 7 s u b e s p , 4 4      ; 0 0 0 0 0 0 2 c H m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e s p m o v D W O R D P T R __$A r r a y P a d $[e s p +4 4 ], e a x p u s h e s i T h e S UB in s t r u c t io n c r e a t e s r o o m fo r t h e lo c a l v a r ia b le s o n t h e s t a c k b y a d d in g 4 4 ( 0 x 2 C ) b y t e s t o E S P. 4 4 b y t e s a r e c o m in g fr o m t h e 1 0 e le m e n t s o f iA r r a y w h e r e in e a c h e le m e n t is o f 4 b y t e s e a c h a n d 4 b y t e s a r e u s e d fo r s t o r in g t h e s t a c k c o o k ie o n t h e s t a c k t o p r e v e n t b u ﬀ e r o v e r ﬂ o w a s e x p la in e d e a r lie r. T h e in s t r u c t io n m o v e s t h e s t a c k c o o k ie s t o r e d in t h e .d a t a s e gm e n t t o t h e E A X r e gis t e r, w h e r e it is X O R ’e d w it h T h e X O R ’e d r e s u lt is p la c e d o n t h e s t a c k t o p r e v e n t a b u ﬀ e r o v e r ﬂ o w e x p lo it t o h a p p e n . T h is X O R v a lu e w ill b e c h e c k e d b e fo r e t h e ma in fu n c t io n e p ilo gu e . E S I w ill b e u s e d fo r t h e p la c e h o ld e r o f t h e iL o o p v a r ia b le ; t h e o ld v a lu e o f E S I is p r e s e r v e d o n t h e s t a c k u s in g t h e P US H in s t r u c t io n . T h e s t a c k s t a t e a f t e r p u s h in g t h e E S I r e gis t e r is a s fo llo w s : [E S P ]  0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0    o ld E S I v a lu e is p r e s e r v e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   0 0 1 2 F F 7 8   JUN K [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 4 0 2 4 D 0   JUN K [E S P +0 x 0 C ] 0 0 1 2 F F 2 0   1 3 2 A F D F 8   JUN K [E S P +0 x 0 1 0 ] 0 0 1 2 F F 2 4   F F F F F F F E   JUN K [E S P +0 x 0 1 4 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 7 C   JUN K [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 9 0   JUN K [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 2 B   JUN K [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 A E   JUN K [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 2 B   JUN K [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   1 3 7 8 9 9 3 8   X O R o f s t a c k c o o k ie a n d E S P is s t o r e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 8 B   ES P b e fo r e ‘ s u b e s p , 4 4 ’ in s t r u c t io n F ig u r e 1 1 .1 9: O ld E S I v a lu e is p r e s e r v e d ▼L in e 3 2 -4 4 ; L in e 8 x o r e s i, e s i m o v D W O R D P T R _iA r r a y $[e s p +4 8 ], e s i m o v D W O R D P T R _iA r r a y $[e s p +5 2 ], 1 m o v D W O R D P T R _iA r r a y $[e s p +5 6 ], 2 m o v D W O R D P T R _iA r r a y $[e s p +6 0 ], 3 m o v D W O R D P T R _iA r r a y $[e s p +6 4 ], 4 m o v D W O R D P T R _iA r r a y $[e s p +6 8 ], 5 m o v D W O R D P T R _iA r r a y $[e s p +7 2 ], 6 m o v D W O R D P T R _iA r r a y $[e s p +7 6 ], 7 m o v D W O R D P T R _iA r r a y $[e s p +8 0 ], 8 m o v D W O R D P T R _iA r r a y $[e s p +8 4 ], 9 n p a d 3 L in e 8 o f t h e C / C ++ c o d e in it ia liz e s in t iA r r a y [1 0 ] = { 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 , 9 } ; In t h e A S M c o d e , t h e X O R in s t r u c t io n r e s e t s t h e E S I r e gis t e r t o 0 x 0 0 a n d t h e n m o v e s E S I t o t h e [E S P +0 x 0 4 ] lo c a t io n a s t h e ﬁ r s t e le m e n t o f iA r r a y. A ll t h e o t h e r M O V in s t r u c t io n s p u s h t h e r e m a in in g e le m e n t s o f iA r r a y o n t h e s t a c k . W e s e e t h e n p a d m a c r o , w h ic h in s e r t s t h e n o n -d e s t r u c t iv e a n d n o n -o p e r a t io n a l in s t r u c t io n s r a t h e r t h a n a s e r ie s o f N O P in s t r u c t io n s . N p a d 3 c o r r e s p o n d s t o le a e c x , F o r m o r e d e t a ils r e la t e d t o r e fe r t o t h e A p p e n d ix . T h e s t a c k s t a t e im m e d ia t e ly a f t e r t h e n p a d m a c r o is a s fo llo w s : [E S P ]  0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0     o ld E S I v a lu e is p r e s e r v e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    iA r r a y ﬁ r s t e le me n t p u s h e d h e r e [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 1    iA r r a y s e c o n d e le me n t p u s h e d h e r e [E S P +0 x 0 C ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 2    iA r r a y t h ir d e le me n t p u s h e d h e r e [E S P +0 x 0 1 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 3    iA r r a y fo r t h e le me n t p u s h e d h e r e [E S P +0 x 0 1 4 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 4    iA r r a y ﬁ f t h e le me n t p u s h e d h e r e [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 5    iA r r a y s ix t h e le me n t p u s h e d h e r e [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 6    iA r r a y s e v e n t h e le me n t p u s h e d h e r e [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 7    iA r r a y e igh t h e le me n t p u s h e d h e r e [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 8    iA r r a y n in t h e le me n t p u s h e d h e r e [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 9    iA r r a y t e n t h e le me n t p u s h e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   1 3 7 8 9 9 3 8    X O R o f s t a c k c o o k ie a n d E S P is s t o r e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 8 B    E S P b e fo r e ‘ s u b e s p , 4 4 ’ in s t r u c t io n F ig u r e 1 1 .2 0 : T h e s t a c k s t a t e a f t e r n p a d ▼L in e 4 5 -5 5 $L L 3 @m a in : ; L in e 1 2 m o v e a x , D W O R D P T R _iA r r a y $[e s p +e s i*4 +4 8 ] p u s h e a x p u s h e s i p u s h O F F S E T $S G 4 6 8 2 c a ll _p r in t f in c e s i a d d e s p , 1 2      ; 0 0 0 0 0 0 0 c H c m p e s i, 1 0      ; 0 0 0 0 0 0 0 a H jl S H O R T $L L 3 @m a in L in e 1 2 o f t h e C / C ++ c o d e p r in t s t h e e le m e n t s o f iA r r a y a lo n g w it h t h e in d e x o n t h e s c r e e n . p r in t f ( \" iA r r a y [%d]=%d\\ n \", iL o o p , iA r r a y [iL o o p ]) ; T h is s a m e c o n c e p t w a s d is c u s s e d in t h e p r e v io u s s e c t io n w it h o u t o p t im iz a t io n . T h e p r in t f fu n c t io n t a k e s t h r e e a r gu m e n t s t o t h e p r in t iA r r a y e le m e n t s a n d in d e x e s o n t h e s c r e e n . S o , a ll t h e s e t h r e e a r gu m e n t s n e e d t o b e p u s h e d o n t o t h e s t a c k b e fo r e t h e c a ll t o t h e p r in t f fu n c t io n . In t h e A S M c o d e , t h e ﬁ r s t a r gu m e n t t o b e p u s h e d o n t h e s t a c k w ill b e To p u s h t h is v a lu e o n t h e s t a c k , t h e iL o o p v a lu e s t o r e d in t h e E S I r e gis t e r is m u lt ip lie d b y 4 ( t h e s iz e o f t h e in t e ge r ) a n d t h e n a d d e d t o t h e iA r r a y m a c r o a n d o ﬀ s e t o f 4 8 b y t e s t o c a lc u la t e t h e m e m o r y lo c a t io n o f t h e e le m e n t s t o r e d fo r t h e p a r t ic u la r iL o o p v a lu e . S o , d u r in g t h e ﬁ r s t it e r a t io n w h e n t h e iL o o p s t o r e d a t E S I = 0 , t h e ﬁ r s t M O V in s t r u c t io n w ill r e s u lt in : m o v e a x , D W O R D P T R _iA r r a y $[e s p +e s i*4 +4 8 ] m o v e a x , d w o r d p t r s s :[e s p +e s i*4 +0 x 4 ], a s E S I = 0 m o v e a x , d w o r d p t r s s :[e s p +0 x 4 ] T h is w ill giv e u s t h e v a lu e o f t h e ﬁ r s t a r r a y e le m e n t in t h e E A X r e gis t e r. S o , b y p u s h in g E A X o n t o t h e s t a c k , w e p u s h e d t h e ﬁ r s t a r gu m e n t t o p r in t f o n t o t h e s t a c k . T h e n e x t a r gu m e n t t o p r in t f is t h e iL o o p v a lu e . It is p u s h e d o n t o t h e s t a c k b y p u s h in g t h e E S I r e gis t e r. L a s t a r gu m e n t , w h ic h is s t r in g c o n s t a n t is p u s h e d b y p u s h O F F S E T N o w t h a t t h e t h r e e a r gu m e n t s a r e o n t h e s t a c k , a c a ll t o p r in t f is m a d e . S t a c k a t t h is p o in t in t im e is a s fo llo w s : [E S P ]  0 0 1 2 F F 0 8   0 0 4 0 8 1 4 0     \" iA r r a y [%d ]=%d \\ n \", s t r in g a r gu me n t t o p r in t f [E S P +0 x 0 4 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0    iL o o p v a lu e , E S I is p u s h e d a s p r in t f a r gu me n t [E S P +0 x 0 8 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    iA r r a y ﬁ r s t e le me n t is p u s h e d a s p r in t f a r gu me n t [E S P +0 x 0 C ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0    o ld E S I v a lu e is p r e s e r v e d h e r e [E S P +0 x 1 0 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    iA r r a y ﬁ r s t e le me n t p u s h e d h e r e [E S P +0 x 1 4 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 1    iA r r a y s e c o n d e le me n t p u s h e d h e r e [E S P +0 x 1 8 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 2    iA r r a y t h ir d e le me n t p u s h e d h e r e [E S P +0 x 1 C ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 3    iA r r a y fo r t h e le me n t p u s h e d h e r e [E S P +0 x 2 0 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 4    iA r r a y ﬁ f t h e le me n t p u s h e d h e r e [E S P +0 x 2 4 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 5    iA r r a y s ix t h e le me n t p u s h e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 6    iA r r a y s e v e n t h e le me n t p u s h e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 7    iA r r a y e igh t h e le me n t p u s h e d h e r e [E S P +0 x 3 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 8    iA r r a y n in t h e le me n t p u s h e d h e r e F ig u r e 1 1 .2 1 : A r g t o p r in t f o n s t a c k T h e IN C in s t r u c t io n w ill in c r e m e n t t h e E S I r e gis t e r. T h is m e a n s t h a t it in c r e m e n t s t h e iL o o p v a lu e s t o r e d in E S I. T h e A D D in s t r u c t io n c le a n s t h e s t a c k b y 1 2 b y t e s . N e x t , E S I is c o m p a r e d w it h 1 0 ( 0 x 0 A ) . A t t h is p o in t , t h e C M P in s t r u c t io n w ill p e r fo r m a s ign e d c o m p a r is o n ju m p t o t h e la b e l $L L 3 @ma in a s t h e iL o o p a t E S I le s s t h a n 1 0 ( 0 x 0 A ) . T h e s t a c k s t a t e a f t e r JUMP if L e s s t h a n is a s fo llo w s : [E S P -0 x 0 C ] 0 0 1 2 F F 0 8   0 0 4 0 8 1 4 0    N o w JUN K [E S P -0 x 0 8 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 0 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    N o w JUN K [E S P ]  0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0     o ld E S I v a lu e is p r e s e r v e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    iA r r a y ﬁ r s t e le me n t p u s h e d h e r e [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 1    iA r r a y s e c o n d e le me n t p u s h e d h e r e [E S P +0 x 0 C ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 2    iA r r a y t h ir d e le me n t p u s h e d h e r e [E S P +0 x 0 1 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 3    iA r r a y fo r t h e le me n t p u s h e d h e r e [E S P +0 x 0 1 4 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 4    iA r r a y ﬁ f t h e le me n t p u s h e d h e r e [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 5    iA r r a y s ix t h e le me n t p u s h e d h e r e [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 6    iA r r a y s e v e n t h e le me n t p u s h e d h e r e [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 7    iA r r a y e igh t h e le me n t p u s h e d h e r e [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 8    iA r r a y n in t h e le me n t p u s h e d h e r e [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 9    iA r r a y t e n t h e le me n t p u s h e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   1 3 7 8 9 9 3 8    X O R o f s t a c k c o o k ie a n d E S P is s t o r e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 8 B    E S P b e fo r e ‘ s u b e s p , 4 4 ’ in s t r u c t io n F ig u r e 1 1 .2 2 : T h e s t a c k s t a t e a f t e r JL N o w , im a gin e t h a t w e it e r a t e d 1 0 t im e s o v e r t h e in s t r u c t io n s a n d t h e iL o o p v a lu e a t E S I h a s b e c o m e 1 0 ( 0 x 0 A ) . A t t h is p o in t , t h e C M P in s t r u c t io n w ill r e s u lt in Z F =1 a n d t h e ju m p w ill n o t h a p p e n t o t h e $L L 3 @ma in la b e l. T h e in s t r u c t io n p o in t e r w ill m o v e t o t h e n e x t in s t r u c t io n . T h e s t a c k s t a t e a t t h is s t a ge w ill b e : [E S P -0 x 0 C ] 0 0 1 2 F F 0 8   0 0 4 0 8 1 4 0    N o w JUN K [E S P -0 x 0 8 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 9    N o w JUN K [E S P -0 x 0 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 9    N o w JUN K [E S P ]  0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0     o ld E S I v a lu e is p r e s e r v e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    iA r r a y ﬁ r s t e le me n t p u s h e d h e r e [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 1    iA r r a y s e c o n d e le me n t p u s h e d h e r e [E S P +0 x 0 C ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 2    iA r r a y t h ir d e le me n t p u s h e d h e r e [E S P +0 x 0 1 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 3    iA r r a y fo r t h e le me n t p u s h e d h e r e [E S P +0 x 0 1 4 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 4    iA r r a y ﬁ f t h e le me n t p u s h e d h e r e [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 5    iA r r a y s ix t h e le me n t p u s h e d h e r e [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 6    iA r r a y s e v e n t h e le me n t p u s h e d h e r e [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 7    iA r r a y e igh t h e le me n t p u s h e d h e r e [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 8    iA r r a y n in t h e le me n t p u s h e d h e r e [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 9    iA r r a y t e n t h e le me n t p u s h e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   1 3 7 8 9 9 3 8    X O R o f s t a c k c o o k ie a n d E S P is s t o r e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 8 B    E S P b e fo r e ‘ s u b e s p , 4 4 ’ in s t r u c t io n F ig u r e 1 1 .2 3 : T h e s t a c k s t a t e a f t e r E S I is 0 x 0 A ▼L in e 5 6 -6 6 ; L in e 1 5 m o v e c x , D W O R D P T R __$A r r a y P a d $[e s p +4 8 ] p o p e s i x o r e c x , e s p x o r e a x , e a x c a ll @__s e c u r it y _c h e c k _c o o k ie @4 a d d e s p , 4 4      ; 0 0 0 0 0 0 2 c H r e t 0 _m a in E N D P _TEX T E N D S E N D T h e M O V in s t r u c t io n w ill m o v e t h e s t a c k c o o k ie s t o r e d a t [E S P +0 x 2 C ] t o T h e P O P in s t r u c t io n r e s t o r e s t h e v a lu e o f E S I fr o m t h e s t a c k . T h e X O R in s t r u c t io n w ill X O R t h e s t a c k c o o k ie m o v e d t o E C X w it h a n d t h e r e s u lt o f X O R w ill b e s t o r e d b a c k in t h e E C X r e gis t e r. O n t h e c a ll t o t h e s e c u r it y _c h e c k _c o o k ie p r o c e d u r e , t h is E C X v a lu e is c o m p a r e d w it h t h e s t a c k c o o k ie s t o r e d in t h e .d a t a s e c t io n . F ig u r e 1 1 .2 4 : C a ll t o s e c u r it y _c h e c k _c o o k ie A s t h e s t a c k c o o k ie v a lu e is u n c h a n ge d , t h e in s t r u c t io n p o in t e r w ill r e t u r n b a c k t o O n r e t u r n , E A X is X O R w it h E A X t o r e t u r n 0 a n d t h e A D D in s t r u c t io n w ill c le a n u p t h e s t a c k t o e n d t h e ma in p r o c e d u r e , T E X T s e gm e n t , a n d c o d e . T h e s t a c k s t a t e in t h e e n d w ill b e a s fo llo w s : [E S P -0 x 3 C ] 0 0 1 2 F F 0 8   0 0 4 0 8 1 4 0    N o w JUN K [E S P -0 x 3 8 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 9    N o w JUN K [E S P -0 x 3 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 9    N o w JUN K E S P -0 x 3 0 ] 0 0 1 2 F F 1 4   0 0 4 0 1 0 8 7    N o w JUN K [E S P -0 x 2 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 1    N o w JUN K [E S P -0 x 2 4 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 2    N o w JUN K [E S P -0 x 2 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 3    N o w JUN K [E S P -0 x 1 C ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 4    N o w JUN K [E S P -0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 5    N o w JUN K [E S P -0 x 1 4 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 6    N o w JUN K [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 7    N o w JUN K [E S P -0 x 0 C ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 8    N o w JUN K [E S P -0 x 0 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 9    N o w JUN K [E S P -0 x 0 4 ] 0 0 1 2 F F 4 0   1 3 7 8 9 9 3 8    N o w JUN K [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 8 B    E S P a t t h e s t a r t o f ma in fu n c t io n F ig u r e 1 1 .2 5 : T h e s t a c k s t a t e in t h e e n d C o n c lu s io n In t h is c h a p t e r, w e d is c u s s e d a b o u t t h e w o r k in g o f a n a r r a y w it h r e s p e c t t o r e v e r s e e n gin e e r in g. W e s a w t h e a r r a y c o d e p a t t e r n in a d is a s s e m b le d c o d e a n d u n d e r s t o o d h o w a r r a y s a r e s t o r e d in c o n t igu o u s m e m o r y lo c a t io n s . A s a n in t e ge r o c c u p ie s 4 b y t e s o f m e m o r y, s o t h e in t e ge r a r r a y o c c u p ie s 4 b y t e s m u lt ip lie d b y t h e n u m b e r o f e le m e n t s in a n a r r a y. W e s a w h o w c o n t igu o u s m e m o r y lo c a t io n s a r e a llo c a t e d in s t a c k . W e a ls o c o v e r e d t h e a r r a y p r o gr a m p a t t e r n w h e n a c o d e is o p t im iz e d a n d n o t o p t im iz e d . In t h e n e x t c h a p t e r, w e w ill t a lk a b o u t r e v e r s in g s t r u c t u r e s t h a t c a n h a n d le d is s im ila r d a t a t y p e s . C H A P T E R 1 2 S t r u c t u r e C o d e P a t t e r n in R e v e r s e E n gin e e r in g In t h e r e a l w o r ld , w e c a n d e s c r ib e a n in d iv id u a l u s in g s e v e r a l a t t r ib u t e s . T h e s e a t t r ib u t e s , o r w e c a n s a y p a r a m e t e r s o r c h a r a c t e r is t ic s , h e lp u s id e n t if y a n in d iv id u a l u n iq u e ly. T h e a t t r ib u t e s u s in g w h ic h w e c a n u n iq u e ly id e n t if y a n in d iv id u a l c a n b e t h e ir n a m e , a ge , s e x , h e igh t , w e igh t , n a t io n a lit y, a n d m a n y m o r e . A ll t h e s e a t t r ib u t e s c o r r e la t e t o d iﬀ e r e n t t y p e s o f d a t a . It m e a n s t h a t t h e a ge is a n in t e ge r, t h e s e x is a s t r in g, t h e w e igh t c a n b e ﬂ o a t , a n d t h e n a t io n a lit y is a s t r in g. N o w , a s a c o m p u t e r p r o gr a m m e r, if w e h a v e t o c o d e a n a p p lic a t io n t o r e c o r d t h e d e t a ils o f a ll t h e in d iv id u a ls p r e s e n t in a ge o gr a p h ic a l lo c a t io n , t h e n w e h a v e t o w r it e a n a p p lic a t io n in s u c h a w a y t h a t it c a n h a n d le t h e d a t a o f t h e in d iv id u a ls in a w e ll-m a n a ge d a n d e a s y m a n n e r. In t h e e a r lie r c h a p t e r, w e h a v e a lr e a d y s e e n o r d in a r y v a r ia b le s t h a t c a n h o ld a s in gle p ie c e o f in fo r m a t io n . W e h a v e a ls o s e e n h o w a n a r r a y c a n h o ld d a t a o f a s im ila r d a t a t y p e . B u t in t h e c a s e o f r e c o r d in g in d iv id u a l d a t a , w e h a v e t o u s e s t r u c t u r e s , w h ic h a r e u s e d t o r e c o r d d a t a o f d is s im ila r d a t a t y p e s . In t h is c h a p t e r, w e w ill b e r e v e r s in g a s t r u c t u r e w h ic h is u s e d in m a n y a p p lic a t io n s . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Un d e r s t a n d in g o f s t r u c t u r e s S t r u c t u r e w it h o u t O p t im iz a t io n S t r u c t u r e w it h O p t im iz a t io n O b je c t iv e In t h is c h a p t e r, w e w ill s t u d y a b o u t p o in t e r s t o s t r u c t u r e s w it h r e s p e c t t o r e v e r s e e n gin e e r in g. W e w ill t a lk a b o u t s t r u c t u r e s c o d e p a t t e r n in d is a s s e m b le d c o d e a n d h o w s t r u c t u r e s a r e s t o r e d in m e m o r y. W e w ill a ls o c o v e r s t r u c t u r e s p r o gr a m w it h o p t im iz e d a n d n o t o p t im iz e d c o d e . Un d e r s t a n d in g o f s t r u c t u r e s In t h is e x a m p le , le t ’s d e m o n s t r a t e t h e s t r u c t u r e p o in t e r. A s w e h a v e a p o in t e r t o a n in t e ge r o r a p o in t e r t o a c h a r, s im ila r ly, w e h a v e a p o in t e r t o s t r u c t u r e s . In C , w e h a v e a n a r r o w o p e r a t o r t h a t r e fe r s t o t h e e le m e n t s o f a s t r u c t u r e . F ig u r e 1 2 .1 : S t r u c t u r e s .c p p S t r u c t u r e w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 2 .2 : S t r u c t u r e w it h o u t O p t im iz a t io n T h e c o m p ila t io n ge n e r a t e s t h e E X E ﬁ le a n d a s s e m b ly c o d e . D is a b le A S L R m a n u a lly. To d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n N o w , le t u s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 2 .3 : S t r u c t u r e s .a s m -P a r t -1 F ig u r e 1 2 .4 : S t r u c t u r e s .a s m -P a r t -2 F ig u r e 1 2 .5 : S t r u c t u r e s .a s m -P a r t -3 L e t ’s m o v e o n t o t h e e x p la n a t io n o f t h e A S M c o d e : ▼L in e 3 0 -3 3 ; L in e 9 p u s h e b p m o v e b p , e s p s u b e s p , 6 4     ; 0 0 0 0 0 0 4 0 H It s t a r t s w it h t h e ma in fu n c t io n p r o lo gu e , w h e r e in t h e o ld E B P is p u s h e d o n t o t h e s t a c k a n d t h e c u r r e n t E S P is m o v e d t o a n e w T h e S UB in s t r u c t io n c r e a t e s r o o m fo r t h e s e c u r it y c o o k ie a n d t h e lo c a l v a r ia b le b y s u b t r a c t in g 6 4 b y t e s fr o m t h e E S P r e gis t e r. S p a c e a llo c a t e d fo r v a r ia b le s o n s t a c k c a n b e s e gr e ga t e d a s fo llo w s : c h a r r gN a m e [4 0 ]; = 4 0 b y t e s in t   iA ge ;  = 4 b y t e s u n s ign e d lo n g lo n g u M o b ile ; = 8 b y t e s s t r u c t S S u b s c r ib e r *p u s e r ; = 4 b y t e s S t a c k C o o k ie = 4 b y t e s ▼L in e 3 4 -3 6 m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e b p m o v D W O R D P T R __$A r r a y P a d $[e b p ], e a x A s s h o w n in t h e fo llo w in g s c r e e n s h o t , t h e s t a c k c o o k ie s t o r e d a t 0 x 0 0 4 0 B 0 0 0 is m o v e d t o E A X w h e r e it is X O R ’e d w it h T h e r e s u lt o f X O R fr o m E A X is m o v e d b a c k t o w h ic h is [E B P -0 x 0 8 ]. T h e s t a c k a t t h is p o in t in t im e is a s fo llo w s : [E S P ]  0 0 1 2 F F 0 0   0 0 0 0 0 0 0 0   R ig h t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 0 4 ] 0 0 1 2 F F 0 4   0 0 0 0 0 0 0 0   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 0 8 ] 0 0 1 2 F F 0 8   7 F F D E 0 0 0   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 0 C ] 0 0 1 2 F F 0 C   0 0 4 0 3 4 5 B   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 1 0 ] 0 0 1 2 F F 1 0   0 0 1 2 F E F C   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 1 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 4   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 1 8 ] 0 0 1 2 F F 1 8   0 0 1 2 F F 7 8   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 1 C ] 0 0 1 2 F F 1 C   0 0 4 0 2 5 0 0   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 2 0 ] 0 0 1 2 F F 2 0   0 1 8 5 B 2 2 A   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 2 4 ] 0 0 1 2 F F 2 4   F F F F F F F E   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 2 8 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 A C   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 2 C ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 3 0 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 5 B   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 3 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 3 8 ] 0 0 1 2 F F 3 8   0 1 D 7 D 6 8 2   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 3 C ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 5 B   R igh t n o w JUN K , s p a c e fo r lo c a l v a r ia b le s [E S P +0 x 4 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 3   r e t u r n t o s t r u c t u r e s .0 0 4 0 1 2 B 3 F ig u r e 1 2 .6: S t a c k c o o k ie ▼L in e 3 7 -5 6 ; L in e 1 8 m o v e a x , D W O R D P T R $S G 5 6 6 0 m o v D W O R D P T R _u s e r $[e b p ], e a x m o v e c x , D W O R D P T R $S G 5 6 6 0 +4 m o v D W O R D P T R _u s e r $[e b p +4 ], e c x m o v d l, B YTE P T R $S G 5 6 6 0 +8 m o v B YTE P T R _u s e r $[e b p +8 ], d l x o r e a x , e a x m o v D W O R D P T R _u s e r $[e b p +9 ], e a x m o v D W O R D P T R _u s e r $[e b p +1 3 ], e a x m o v D W O R D P T R _u s e r $[e b p +1 7 ], e a x m o v D W O R D P T R _u s e r $[e b p +2 1 ], e a x m o v D W O R D P T R _u s e r $[e b p +2 5 ], e a x m o v D W O R D P T R _u s e r $[e b p +2 9 ], e a x m o v D W O R D P T R _u s e r $[e b p +3 3 ], e a x m o v W O R D P T R _u s e r $[e b p +3 7 ], a x m o v B YTE P T R _u s e r $[e b p +3 9 ], a l m o v D W O R D P T R _u s e r $[e b p +4 0 ], 3 0   ; 0 0 0 0 0 0 1 e H m o v D W O R D P T R _u s e r $[e b p +4 8 ], -6 9 1 1 6 8 9 4 7 ; d 6 c d 9 9 4 d H m o v D W O R D P T R _u s e r $[e b p +5 2 ], 1 ; L in e 1 8 T h is is a c o m m e n t w h ic h s t a t e s t h a t t h e A S M in s t r u c t io n s p r e c e d in g it w ill r e p r e s e n t lin e 1 8 o f t h e C / C ++ c o d e , w h ic h is : s t r u c t S S u b s c r ib e r u s e r = { \" Jit e n d e r \", 3 0 , 7 8 9 8 7 6 5 6 4 5 } ;    // S t r u c t u r e V a r ia b le In t h e A S M c o d e , w e s e e s e v e r a l M O V in s t r u c t io n s . To u n d e r s t a n d t h e s e in s t r u c t io n s , w e w ill h a v e t o u n d e r s t a n d t h a t t h e e le m e n t s o f s t r u c t u r e a r e a lw a y s s t o r e d in c o n t igu o u s m e m o r y lo c a t io n s . A ll t h e M O V in s t r u c t io n s w ill s t o r e t h e e le m e n t s o f s t r u c t u r e o n t o t h e s t a c k . To u n d e r s t a n d t h e s t a c k s t a t e , le t ’s ﬁ r s t t a k e e a c h e le m e n t o f s t r u c t u r e in a h e x r e p r e s e n t a t io n a s fo llo w s : c h a r r gN a m e [4 0 ]; = 4 0 b y t e s = Jit e n d e r ( 0 x 4 A 6 9 7 4 6 5 6 E 6 4 6 5 7 2 ) ( 0 x 4 A 6 9 7 4 6 5 6 E 6 4 6 5 7 2 ) ( 0 x 4 A 6 9 7 4 6 5 6 E 6 4 6 5 7 2 ) in t iA ge ; = 4 b y t e s = 3 0 ( 0 x 0 0 0 0 0 0 1 E ) ( 0 x 0 0 0 0 0 0 1 E ) u n s ign e d lo n g lo n g u M o b ile ; = 8 b y t e s = 7 8 9 8 7 6 5 6 4 5 ( 0 x 0 0 0 0 0 0 0 1 D 6 C D 9 9 4 D ) ( 0 x 0 0 0 0 0 0 0 1 D 6 C D 9 9 4 D ) T h e s t a c k s t a t e a f t e r a ll t h e M O V in s t r u c t io n s w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 0 0   6 5 7 4 6 9 4 A    4 b y t e s o f a r r a y, r gN a me in lit t le - e n d ia n e t iJ [E S P +0 x 0 4 ] 0 0 1 2 F F 0 4   7 2 6 5 6 4 6 E   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n r e d n [E S P +0 x 0 8 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0   S t r in g t e r min a t o r w it h N UL L in r e ma in in g a r r a y [E S P +0 x 0 C ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 0 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0   a r r a y fr o m 0 x 0 0 1 2 F F 0 0 t o 0 x 0 0 1 2 F F 2 8 , t o t a l 4 0 b y t e s [E S P +0 x 2 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 1 E   S e c o n d e le me n t o f S t r u c t u r e , iA ge is s t o r e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0   r e t u r n t o 0 x 0 0 4 0 5 4 C 0 fr o m 0 x 0 0 4 0 5 4 7 7 [E S P +0 x 3 0 ] 0 0 1 2 F F 3 0   D 6 C D 9 9 4 D   4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 3 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 1   r e ma in in g 4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 3 8 ] 0 0 1 2 F F 3 8   0 1 D 7 D 6 8 2   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 3 C ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 5 B   s t r u c t u r e s .0 0 4 0 3 4 5 B [E S P +0 x 4 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 3   r e t u r n t o 0 x 0 0 4 0 1 2 B 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 2 .7 : S t a c k a f t e r a ll t h e M O V in s t r u c t io n s ▼L in e 5 7 -5 9 ; L in e 2 1 le a e c x , D W O R D P T R _u s e r $[e b p ] m o v D W O R D P T R _p u s e r $[e b p ], e c x T h is is a c o m m e n t w h ic h s t a t e s t h a t t h e A S M in s t r u c t io n s p r e c e d in g it w ill r e p r e s e n t lin e 2 1 o f t h e C / C ++ c o d e , w h ic h is : p u s e r = & u s e r ; In t h e A S M c o d e , t h e p o in t e r t o s t r u c t u r e is p u s h e d o n t o t h e E C X r e gis t e r u s in g t h e L o a d E ﬀ e c t iv e A d d r e s s in s t r u c t io n . T h e p o in t e r t o t h e s t r u c t u r e p o in t s t o t h e ﬁ r s t e le m e n t o f t h e s t r u c t u r e , a s s t r u c t u r e s a r e a lw a y s s t o r e d in c o n t igu o u s m e m o r y lo c a t io n s . T h e M O V in s t r u c t io n w ill p u s h t h e p o in t e r t o s t r u c t u r e o n t h e s t a c k a t [E B P -0 x 0 4 ]. T h e s t a c k s t a t e a f t e r t h is in s t r u c t io n w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 0 0   6 5 7 4 6 9 4 A    4 b y t e s o f a r r a y, r gN a me in lit t le - e n d ia n e t iJ [E S P +0 x 0 4 ] 0 0 1 2 F F 0 4   7 2 6 5 6 4 6 E   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n r e d n [E S P +0 x 0 8 ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0   S t r in g t e r min a t o r w it h N UL L in r e ma in in g a r r a y [E S P +0 x 0 C ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 0 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 1 C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0   r gN a me fr o m 0 x 0 0 1 2 F F 0 0 t o 0 x 0 0 1 2 F F 2 8 , t o t a l 4 0 b y t e s      [E S P +0 x 2 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 1 E   S e c o n d e le me n t o f S t r u c t u r e , iA ge is s t o r e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0   r e t u r n t o 0 x 0 0 4 0 5 4 C 0 fr o m 0 x 0 0 4 0 5 4 7 7 [E S P +0 x 3 0 ] 0 0 1 2 F F 3 0   D 6 C D 9 9 4 D   4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 3 4 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 1   r e ma in in g 4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 3 8 ] 0 0 1 2 F F 3 8   0 1 D 7 D 6 8 2   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 3 C ] 0 0 1 2 F F 3 C   0 0 1 2 F F 0 0   P o in t e r t o s t r u c t u r e is s t o r e d h e r e , p u s e r [E S P +0 x 4 0 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 4 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 3    r e t u r n t o 0 x 0 0 4 0 1 2 B 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 2 .8: P o in t e r t o s t r u c t u r e o n s t a c k ▼L in e 6 0 -7 1 ; L in e 2 2 m o v e d x , D W O R D P T R _u s e r $[e b p +5 2 ] p u s h e d x m o v e a x , D W O R D P T R _u s e r $[e b p +4 8 ] p u s h e a x m o v e c x , D W O R D P T R _u s e r $[e b p +4 0 ] p u s h e c x le a e d x , D W O R D P T R _u s e r $[e b p ] p u s h e d x p u s h O F F S E T $S G 5 6 6 2 c a ll _p r in t f a d d e s p , ; 0 0 0 0 0 0 1 4 H T h is is a c o m m e n t w h ic h s t a t e s t h a t t h e A S M in s t r u c t io n s p r e c e d in g it w ill r e p r e s e n t lin e 2 2 o f t h e C / C ++ c o d e , w h ic h is : p r in t f( \" \\ n %s %d %llu \", u s e r.r gN a m e , u s e r.iA ge , u s e r.u M o b ile ) ; In t h e A S M c o d e , w e a r e p u s h in g a ll t h e a r gu m e n t s t o t h e s t a c k o n e b y o n e a n d t h e n a c a ll t o t h e p r in t f fu n c t io n is m a d e . T h e s t a c k s t a t e ju s t b e fo r e t h e c a ll t o t h e p r in t f fu n c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F E E C   0 0 4 0 8 1 4 C    \" \\ n %s %d %llu \", a r gu me n t t o p r in t f( ) is p u s h e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F E F 0   0 0 1 2 F F 0 0   p o in t e r t o r gN a me a r r a y is p u s h e d h e r e [E S P +0 x 0 8 ] 0 0 1 2 F E F 4   0 0 0 0 0 0 1 E   iA ge v a lu e is p u s h e d h e r e [E S P +0 x 0 C ] 0 0 1 2 F E F 8   D 6 C D 9 9 4 D   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 0 ] 0 0 1 2 F E F C   0 0 0 0 0 0 0 1   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 4 ] 0 0 1 2 F F 0 0   6 5 7 4 6 9 4 A   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n e t iJ [E S P +0 x 1 8 ] 0 0 1 2 F F 0 4   7 2 6 5 6 4 6 E   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n r e d n [E S P +0 x 1 C ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0   S t r in g t e r min a t o r w it h N UL L in r e ma in in g a r r a y [E S P +0 x 2 0 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 8 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 0 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 4 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 8 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0   r gN a me fr o m 0 x 0 0 1 2 F F 0 0 t o 0 x 0 0 1 2 F F 2 8 , t o t a l 4 0 b y t e s      [E S P +0 x 3 C ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 1 E   S e c o n d e le me n t o f S t r u c t u r e , iA ge is s t o r e d h e r e [E S P +0 x 4 0 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0   r e t u r n t o 0 x 0 0 4 0 5 4 C 0 fr o m 0 x 0 0 4 0 5 4 7 7 [E S P +0 x 4 4 ] 0 0 1 2 F F 3 0   D 6 C D 9 9 4 D   4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 4 8 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 1   r e ma in in g 4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 5 0 ] 0 0 1 2 F F 3 8   0 1 D 7 D 6 8 2   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 5 4 ] 0 0 1 2 F F 3 C   0 0 1 2 F F 0 0   P o in t e r t o s t r u c t u r e is s t o r e d h e r e , p u s e r [E S P +0 x 5 8 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 5 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 3    r e t u r n t o 0 x 0 0 4 0 1 2 B 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 2 .9: B e fo r e t h e c a ll t o p r in t f A f t e r t h e c a ll t o t h e p r in t f fu n c t io n , t h e s t a c k is c le a n e d u s in g t h e A D D in s t r u c t io n . ▼L in e 7 2 -8 5 ; L in e 2 3 m o v e a x , D W O R D P T R _p u s e r $[e b p ] m o v e c x , D W O R D P T R [e a x +5 2 ] p u s h e c x m o v e d x , D W O R D P T R [e a x +4 8 ] p u s h e d x m o v e a x , D W O R D P T R _p u s e r $[e b p ] m o v e c x , D W O R D P T R [e a x +4 0 ] p u s h e c x m o v e d x , D W O R D P T R _p u s e r $[e b p ] p u s h e d x p u s h O F F S E T $S G 5 6 6 3 c a ll _p r in t f a d d e s p , 2 0      ; 0 0 0 0 0 0 1 4 H T h is is a c o m m e n t w h ic h s t a t e s t h a t t h e A S M in s t r u c t io n s p r e c e d in g it w ill r e p r e s e n t lin e 2 3 o f t h e C / C ++ c o d e , w h ic h is : p r in t f( \" \\ n %s %d %llu \", p u s e r ->r gN a m e , p u s e r ->iA ge , p u s e r - >u M o b ile ) ; In t h e C / C ++ c o d e , w e a r e a c c e s s in g a ll t h e e le m e n t s o f s t r u c t u r e u s in g p o in t e r t o t h e s t r u c t u r e a n d u s in g -> o p e r a t o r. S o , in A S M , w e c a n o b s e r v e t h a t in t h e ﬁ r s t M O V in s t r u c t io n , p o in t e r t o s t r u c t u r e is p u s h e d o n t o t h e E A X r e gis t e r a n d t h e n a ll t h e s u b s e q u e n t M O V in s t r u c t io n s a r e r e fe r r in g t o t h e e le m e n t s u s in g t h e E A X r e gis t e r, a s E A X p o in t s t o t h e s t a r t o f t h e s t r u c t u r e m e m o r y. In a ll t h e s u b s e q u e n t in s t r u c t io n s , w e a r e p u s h in g t h e s t r u c t u r e e le m e n t s o n t o t h e s t a c k u s in g a c o m b in a t io n o f M O V a n d P US H in s t r u c t io n s . A ll t h e M O V in s t r u c t io n s a r e a c c e s s in g v a r ia b le s u s in g E A X +o ﬀ s e t ( w h e r e o ﬀ s e t is t h e n u m b e r o f b y t e s . Wh e n a d d e d t o it giv e s t h e lo c a t io n o f t h e e le m e n t v a lu e s t o r e d o n t h e s t a c k ) a n d m o v in g it t o a n a v a ila b le r e gis t e r. N e x t , t h e P US H in s t r u c t io n p u s h e s t h e s t r u c t u r e e le m e n t v a lu e o n t o t h e s t a c k . O n c e a ll t h e e le m e n t s a r e p u s h e d o n t o t h e s t a c k , a c a ll t o t h e p r in t f fu n c t io n is m a d e . T h e s t a c k s t a t e b e fo r e t h e c a ll t o t h e s e c o n d p r in t f fu n c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F E E C   0 0 4 0 8 1 5 8   \" \\ n %s %d %llu \", a r gu me n t t o p r in t f( ) is p u s h e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F E F 0   0 0 1 2 F F 0 0   p o in t e r t o r gN a me a r r a y is p u s h e d h e r e [E S P +0 x 0 8 ] 0 0 1 2 F E F 4   0 0 0 0 0 0 1 E   iA ge v a lu e is p u s h e d h e r e [E S P +0 x 0 C ] 0 0 1 2 F E F 8   D 6 C D 9 9 4 D   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 0 ] 0 0 1 2 F E F C   0 0 0 0 0 0 0 1   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 4 ] 0 0 1 2 F F 0 0   6 5 7 4 6 9 4 A   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n e t iJ [E S P +0 x 1 8 ] 0 0 1 2 F F 0 4   7 2 6 5 6 4 6 E   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n r e d n [E S P +0 x 1 C ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0   S t r in g t e r min a t o r w it h N UL L in r e ma in in g a r r a y [E S P +0 x 2 0 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 8 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 0 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 4 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 8 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0   r gN a me fr o m 0 x 0 0 1 2 F F 0 0 t o 0 x 0 0 1 2 F F 2 8 , t o t a l 4 0 b y t e s      [E S P +0 x 3 C ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 1 E   S e c o n d e le me n t o f S t r u c t u r e , iA ge is s t o r e d h e r e [E S P +0 x 4 0 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0   r e t u r n t o 0 x 0 0 4 0 5 4 C 0 fr o m 0 x 0 0 4 0 5 4 7 7 [E S P +0 x 4 4 ] 0 0 1 2 F F 3 0   D 6 C D 9 9 4 D   4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 4 8 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 1   r e ma in in g 4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 5 0 ] 0 0 1 2 F F 3 8   0 1 D 7 D 6 8 2   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 5 4 ] 0 0 1 2 F F 3 C   0 0 1 2 F F 0 0   P o in t e r t o s t r u c t u r e is s t o r e d h e r e , p u s e r [E S P +0 x 5 8 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 5 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 3     r e t u r n t o 0 x 0 0 4 0 1 2 B 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 2 .1 0 : B e fo r e c a ll t o s e c o n d p r in t f A f t e r t h e c a ll t o t h e p r in t f fu n c t io n , t h e s t a c k is c le a n e d u s in g t h e A D D in s t r u c t io n . ▼L in e 8 6 -8 7 ; L in e 2 5 x o r e a x , e a x T h is is a c o m m e n t w h ic h s t a t e s t h a t t h e A S M in s t r u c t io n s p r e c e d in g it w ill r e p r e s e n t lin e 2 5 o f t h e C / C ++ c o d e , w h ic h is : r e t u r n 0 ; In t h e A S M c o d e , E A X is z e r o e d t o r e t u r n 0 , a s w e d is c u s s e d e a r lie r t h a t t h e r e t u r n v a lu e o f a fu n c t io n is s t o r e d in t h e E A X r e gis t e r. ▼L in e 8 8 -9 7 ; L in e 2 6 m o v e c x , D W O R D P T R __$A r r a y P a d $[e b p ] x o r e c x , e b p c a ll @__s e c u r it y _c h e c k _c o o k ie @4 m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D T h is A S M c o d e t h a t r e t r ie v e s t h e s t a c k c o o k ie v a lu e fr o m [E B P - 0 x 0 8 ] a n d X O R w it h E B P t o m a t c h t h e s t a c k c o o k ie v a lu e s t o r e d a t O n r e t u r n fr o m t h e s e c u r it y _c h e c k _c o o k ie p r o c e d u r e , t h e fu n c t io n e p ilo gu e is c a lle d t o r e t u r n 0 a n d e n d t h e ma in p r o c e d u r e , T E X T s e gm e n t , a n d c o d e . T h e s t a c k s t a t e b e fo r e t h e r e t u r n is a s fo llo w s : [E S P -0 x 4 4 ] 0 0 1 2 F F 0 0   6 5 7 4 6 9 4 A    N o w JUN K [E S P -0 x 4 0 ] 0 0 1 2 F F 0 4   7 2 6 5 6 4 6 E    N o w JUN K [E S P -0 x 3 C ] 0 0 1 2 F F 0 8   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 3 8 ] 0 0 1 2 F F 0 C   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 3 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 3 0 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 4 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 1 C ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 1 E    N o w JUN K [E S P -0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0    r e t u r n t o 0 x 0 0 4 0 5 4 C 0 fr o m 0 x 0 0 4 0 5 4 7 7 [E S P -0 x 1 4 ] 0 0 1 2 F F 3 0   D 6 C D 9 9 4 D    N o w JUN K [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 0 0 0 0 0 1    N o w JUN K [E S P -0 x 0 C ] 0 0 1 2 F F 3 8   0 1 D 7 D 6 8 2    N o w JUN K [E S P -0 x 0 8 ] 0 0 1 2 F F 3 C   0 0 1 2 F F 0 0    N o w JUN K [E S P -0 x 0 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8    N o w JUN K [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 B 3    r e t u r n t o 0 x 0 0 4 0 1 2 B 3 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 2 .1 1 : S t a c k c le a n e d S t r u c t u r e w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 2 .1 2 : S t r u c t u r e w it h O p t im iz a t io n T h e c o m p ila t io n ge n e r a t e s t h e E X E ﬁ le a n d a s s e m b ly c o d e . D is a b le A S L R m a n u a lly. To d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 2 .1 3 : S t r u c t u r e s -O p t im iz e d .a s m -P a r t -1 F ig u r e 1 2 .1 4 : S t r u c t u r e s -O p t im iz e d .a s m -P a r t -2 L e t ’s a n a ly z e t h e A S M c o d e : ▼L in e 2 9 -3 3 ; L in e 9 s u b e s p , 6 0      ; 0 0 0 0 0 0 3 c H m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e s p m o v D W O R D P T R __$A r r a y P a d $[e s p +6 0 ], e a x In t h e A S M c o d e , 6 0 b y t e s a r e s u b t r a c t e d fr o m E S P t o c r e a t e r o o m fo r t h e v a r ia b le s o n t h e s t a c k . T h e M O V in s t r u c t io n m o v e s t h e s t a c k c o o k ie s t o r e d a t 0 x 0 0 4 0 B 0 0 0 t o w h e r e it is X O R ’e d w it h E S P a n d t h e r e s u lt is m o v e d t o t h e s t a c k a t [E S P +0 x 3 8 ]. A s in s t r u c t io n : m o v D W O R D P T R __$A r r a y P a d $[e s p +6 0 ], e a x Wh e n t h is in s t r u c t io n is v ie w e d in x 3 2 d b g it w ill b e s h o w n a s b e lo w : m o v d w o r d p t r s s :[e s p +0 x 3 8 ], e a x T h e s t a c k s t a t e a f t e r t h is in s t r u c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F F 0 8   7 F F D F 0 0 0   JUN K [E S P +0 x 4 ] 0 0 1 2 F F 0 C   0 0 4 0 3 4 5 B   JUN K [E S P +0 x 8 ] 0 0 1 2 F F 1 0   0 0 1 2 F E F C   JUN K [E S P +0 x C ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 4   JUN K [E S P +0 x 1 0 ] 0 0 1 2 F F 1 8   0 0 1 2 F F 7 8   JUN K [E S P +0 x 1 4 ] 0 0 1 2 F F 1 C   0 0 4 0 2 5 0 0   JUN K [E S P +0 x 1 8 ] 0 0 1 2 F F 2 0   8 5 8 B F A 6 B   JUN K [E S P +0 x 1 C ] 0 0 1 2 F F 2 4   F F F F F F F E   JUN K [E S P +0 x 2 0 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 A C   JUN K [E S P +0 x 2 4 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 C 0   JUN K [E S P +0 x 2 8 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 5 B   JUN K [E S P +0 x 2 C ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K [E S P +0 x 3 0 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 D E   JUN K [E S P +0 x 3 4 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 5 B   JUN K [E S P +0 x 3 8 ] 0 0 1 2 F F 4 0   8 5 D 9 9 E 8 B   X O R o f S t a c k C o o k ie a n d E S P is s t o r e d h e r e [E S P +0 x 3 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 4   r e t u r n t o s t r u c t u r e s - o p t imiz e d .0 0 4 0 1 2 B 4 F ig u r e 1 2 .1 5 : S t a c k c o o k ie ▼L in e 3 4 -3 7 ; L in e 1 8 m o v e a x , D W O R D P T R $S G 5 6 6 0 m o v e c x , D W O R D P T R $S G 5 6 6 0 +4 m o v d l, B YTE P T R $S G 5 6 6 0 +8 T h e s e in s t r u c t io n s m o v e t h e ﬁ r s t 4 b y t e s o f t h e r gN a me a r r a y in t o t h e E A X r e gis t e r in t h e lit t le -e n d ia n fo r m a t a n d t h e n e x t 4 b y t e s in t h e E C X r e gis t e r. T h e n u ll t e r m in a t e d c h a r a c t e r is m o v e d t o t h e D L r e gis t e r. ▼L in e 3 8 -6 1 ; L in e 2 2 p u s h 1 m o v D W O R D P T R _u s e r $[e s p +6 4 ], e a x x o r e a x , e a x p u s h -6 9 1 1 6 8 9 4 7     ; d 6 c d 9 9 4 d H m o v D W O R D P T R _u s e r $[e s p +7 7 ], e a x m o v D W O R D P T R _u s e r $[e s p +8 1 ], e a x m o v D W O R D P T R _u s e r $[e s p +8 5 ], e a x m o v D W O R D P T R _u s e r $[e s p +8 9 ], e a x m o v D W O R D P T R _u s e r $[e s p +9 3 ], e a x m o v D W O R D P T R _u s e r $[e s p +9 7 ], e a x m o v D W O R D P T R _u s e r $[e s p +1 0 1 ], e a x m o v W O R D P T R _u s e r $[e s p +1 0 5 ], a x m o v B YTE P T R _u s e r $[e s p +1 0 7 ], a l p u s h 3 0      ; 0 0 0 0 0 0 1 e H le a e a x , D W O R D P T R _u s e r $[e s p +7 2 ] p u s h e a x p u s h O F F S E T $S G 5 6 6 2 m o v D W O R D P T R _u s e r $[e s p +8 4 ], e c x m o v B YTE P T R _u s e r $[e s p +8 8 ], d l m o v D W O R D P T R _u s e r $[e s p +1 2 0 ], 3 0   ; 0 0 0 0 0 0 1 e H m o v D W O R D P T R _u s e r $[e s p +1 2 8 ], -6 9 1 1 6 8 9 4 7 ; d 6 c d 9 9 4 d H m o v D W O R D P T R _u s e r $[e s p +1 3 2 ], 1 c a ll _p r in t f In t h e n o n -o p t im iz e d s e c t io n , w e s a w h o w E B P is r e fe r r e d t o a c c e s s t h e s t r u c t u r e e le m e n t s o n t h e s t a c k . In t h e p r e c e d in g A S M c o d e , t h e s t a c k is s im ila r ly ﬁ lle d w it h t h e e le m e n t s o f s t r u c t u r e b y r e fe r r in g t o t h e s t a c k m e m o r y w it h A ls o , fo r t h e ﬁ r s t p r in t f fu n c t io n c a ll, t h e a r gu m e n t s a r e p u s h e d o n t o t h e s t a c k . T h e s t a c k s t a t e b e fo r e t h e c a ll t o p r in t f w ill b e : [E S P ]  0 0 1 2 F E F 4   0 0 4 0 8 1 4 C    \" \\ n %s %d %llu \", a r gu me n t t o p r in t f( ) is p u s h e d h e r e [E S P +0 x 4 ] 0 0 1 2 F E F 8   0 0 1 2 F F 0 8   p o in t e r t o r gN a me a r r a y is p u s h e d h e r e [E S P +0 x 8 ] 0 0 1 2 F E F C   0 0 0 0 0 0 1 E   iA ge v a lu e is p u s h e d h e r e [E S P +0 x C ] 0 0 1 2 F F 0 0   D 6 C D 9 9 4 D   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 0 ] 0 0 1 2 F F 0 4   0 0 0 0 0 0 0 1   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 4 ] 0 0 1 2 F F 0 8   6 5 7 4 6 9 4 A   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n e t iJ [E S P +0 x 1 8 ] 0 0 1 2 F F 0 C   7 2 6 5 6 4 6 E   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n r e d n [E S P +0 x 1 C ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   S t r in g t e r min a t o r w it h N UL L v a lu e s in a r r a y [E S P +0 x 2 0 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 4 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 2 C ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 4 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 0   r gN a m e fr o m 0 x 0 0 1 2 F F 0 8 t o 0 x 0 0 1 2 F F 3 0 , t o t a l 4 0 b y t e s [E S P +0 x 3 C ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 1 E   S e c o n d e le me n t o f S t r u c t u r e , iA ge is s t o r e d h e r e [E S P +0 x 4 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   P o in t e r t o s t r u c t u r e is s t o r e d h e r e , p u s e r [E S P +0 x 4 4 ] 0 0 1 2 F F 3 8   D 6 C D 9 9 4 D   4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 4 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1   r e ma in in g 4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 4 C ] 0 0 1 2 F F 4 0   8 5 D 9 9 E 8 B   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 5 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 4   r e t u r n t o s t r u c t u r e s - o p t imiz e d .0 0 4 0 1 2 B 4 F ig u r e 1 2 .1 6: T h e s t a c k s t a t e b e fo r e t h e c a ll t o p r in t f ▼L in e 6 2 -7 2 ; L in e 2 3 m o v e c x , D W O R D P T R _u s e r $[e s p +1 3 2 ] m o v e d x , D W O R D P T R _u s e r $[e s p +1 2 8 ] m o v e a x , D W O R D P T R _u s e r $[e s p +1 2 0 ] p u s h e c x p u s h e d x p u s h e a x le a e c x , D W O R D P T R _u s e r $[e s p +9 2 ] p u s h e c x p u s h O F F S E T $S G 5 6 6 3 c a ll _p r in t f T h e ﬁ r s t t h r e e M O V a n d P US H in s t r u c t io n s p u s h t h e u M o b ile a n d iA ge v a lu e s o n t h e s t a c k . L o a d E ﬀ e c t iv e A d d r e s s m o v e s t h e p o in t e r t o s t r u c t u r e o n t h e E C X r e gis t e r a n d t h e n t o t h e s t a c k . N o w , w e h a v e a ll t h r e e a r gu m e n t s t o p r in t f o n t h e s t a c k . W e c a n c a ll t h e p r in t f fu n c t io n . T h e s t a c k s t a t e b e fo r e t h e c a ll t o t h e s e c o n d p r in t f w ill b e : [E S P ]  0 0 1 2 F E E 0   0 0 4 0 8 1 5 8    \" \\ n %s %d %llu \", a r g t o 2 n d p r in t f( ) p u s h e d h e r e [E S P +0 x 4 ] 0 0 1 2 F E E 4   0 0 1 2 F F 0 8   p o in t e r t o r gN a me a r r a y is p u s h e d h e r e [E S P +0 x 8 ] 0 0 1 2 F E E 8   0 0 0 0 0 0 1 E   iA ge v a lu e is p u s h e d h e r e [E S P +0 x 0 C ] 0 0 1 2 F E E C   D 6 C D 9 9 4 D   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 0 ] 0 0 1 2 F E F 0   0 0 0 0 0 0 0 1   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 1 4 ] 0 0 1 2 F E F 4   0 0 4 0 8 1 4 C   \" \\ n %s %d %llu \", a r g t o 1 s t p r in t f( ) p u s h e d h e r e [E S P +0 x 1 8 ] 0 0 1 2 F E F 8   0 0 1 2 F F 0 8   p o in t e r t o r gN a me a r r a y is p u s h e d h e r e [E S P +0 x 1 C ] 0 0 1 2 F E F C   0 0 0 0 0 0 1 E   iA ge v a lu e is p u s h e d h e r e [E S P +0 x 2 0 ] 0 0 1 2 F F 0 0   D 6 C D 9 9 4 D   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 2 4 ] 0 0 1 2 F F 0 4   0 0 0 0 0 0 0 1   u M o b ile v a lu e is p u s h e d h e r e [E S P +0 x 2 8 ] 0 0 1 2 F F 0 8   6 5 7 4 6 9 4 A   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n e t iJ [E S P +0 x 2 C ] 0 0 1 2 F F 0 C   7 2 6 5 6 4 6 E   4 b y t e s o f a r r a y, r gN a me in lit t le -e n d ia n r e d n [E S P +0 x 3 0 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0   S t r in g t e r min a t o r w it h N UL L in r e ma in in g a r r a y [E S P +0 x 3 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 8 ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 3 C ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 4 0 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 4 4 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 4 8 ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 0   N UL L v a lu e s in c h a r a r r a y o f s iz e 4 0 b y t e s [E S P +0 x 4 C ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 0   r gN a m e fr o m 0 x 0 0 1 2 F F 0 8 t o 0 x 0 0 1 2 F F 3 0 , t o t a l 4 0 b y t e s [E S P +0 x 5 0 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 1 E   S e c o n d e le me n t o f S t r u c t u r e , iA ge is s t o r e d h e r e [E S P +0 x 5 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   P o in t e r t o s t r u c t u r e is s t o r e d h e r e , p u s e r [E S P +0 x 5 8 ] 0 0 1 2 F F 3 8   D 6 C D 9 9 4 D   4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 6 C ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1   r e ma in in g 4 b y t e s o f u M o b ile s t o r e d h e r e [E S P +0 x 6 4 ] 0 0 1 2 F F 4 0   8 5 D 9 9 E 8 B   X O R o f S t a c k C o o k ie a n d E A X is s t o r e d h e r e [E S P +0 x 6 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B 4   r e t u r n t o s t r u c t u r e s - o p t imiz e d .0 0 4 0 1 2 B 4 F ig u r e 1 2 .1 7 : S t a c k s t a t e b e fo r e c a ll t o s e c o n d p r in t f ▼L in e 7 3 -8 3 ; L in e 2 6 m o v e c x , D W O R D P T R __$A r r a y P a d $[e s p +1 0 0 ] a d d e s p , 4 0      ; 0 0 0 0 0 0 2 8 H x o r e c x , e s p x o r e a x , e a x c a ll @__s e c u r it y _c h e c k _c o o k ie @4 a d d e s p , 6 0      ; 0 0 0 0 0 0 3 c H r e t 0 _m a in E N D P _TEX T E N D S E N D T h e r e s t o f t h e A S M c o d e is t h e s a m e , w h e r e t h e s t a c k is c le a n e d u s in g t h e A D D in s t r u c t io n t o m a t c h t h e s t a c k c o o k ie fo r t h e b u ﬀ e r o v e r ﬂ o w . F in a lly, a f t e r a c a ll t o t h e s e c u r it y _c h e c k _c o o k ie p r o c e d u r e , t h e s t a c k is a ga in c le a n e d t o r e t u r n 0 t o e n d t h e m a in fu n c t io n , T E X T s e gm e n t , a n d c o d e . T h e s t a c k s t a t e x 3 2 d b g w ill b e a s fo llo w s : [E S P -0 x 4 0 ] 0 0 1 2 F F 0 8   6 5 7 4 6 9 4 A    N o w JUN K [E S P -0 x 3 8 ] 0 0 1 2 F F 0 C   7 2 6 5 6 4 6 E    N o w JUN K [E S P -0 x 3 4 ] 0 0 1 2 F F 1 0   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 3 0 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 C ] 0 0 1 2 F F 1 8   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 8 ] 0 0 1 2 F F 1 C   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 4 ] 0 0 1 2 F F 2 0   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 2 0 ] 0 0 1 2 F F 2 4   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 1 C ] 0 0 1 2 F F 2 8   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 0 0 0 0 0 0    N o w JUN K [E S P -0 x 1 4 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 1 E    N o w JUN K [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8    N o w JUN K [E S P -0 x 0 C ] 0 0 1 2 F F 3 8   D 6 C D 9 9 4 D    N o w JUN K [E S P -0 x 0 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    N o w JUN K [E S P -0 x 0 4 ] 0 0 1 2 F F 4 0   8 5 D 9 9 E 8 B    N o w JUN K [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 B 4     r e t u r n t o s t r u c t u r e s - o p t imiz e d .0 0 4 0 1 2 B 4 F ig u r e 1 2 .1 8: T h e s t a c k is c le a n e d C o n c lu s io n In t h is c h a p t e r, w e le a r n e d p o in t e r s t o s t r u c t u r e s w it h r e s p e c t t o r e v e r s e e n gin e e r in g. W e d is c u s s e d a b o u t s t r u c t u r e s c o d e p a t t e r n in d is a s s e m b le d c o d e a n d h o w s t r u c t u r e s a r e s t o r e d in m e m o r y. T h e m a in p o in t t o u n d e r s t a n d is t h a t , p o in t e r t o t h e s t r u c t u r e p o in t s t o t h e ﬁ r s t e le m e n t o f s t r u c t u r e a s s t r u c t u r e s a r e a lw a y s s t o r e d in c o n t igu o u s m e m o r y lo c a t io n s . W e a ls o c o v e r e d s t r u c t u r e s p r o gr a m w it h o p t im iz e d a n d n o n -o p t im iz e d c o d e . C H A P T E R 1 3 S c a n f P r o gr a m P a t t e r n in R e v e r s e E n gin e e r in g Im a gin e y o u d o w n lo a d e d s o m e h a c k in g s o f t w a r e fr o m t h e in t e r n e t . O n r u n n in g t h is s o f t w a r e , it a s k s y o u t o e n t e r t h e p a s s w o r d . T h e p a s s w o r d is n o t m e n t io n e d a n y w h e r e o n t h e s it e fr o m w h e r e y o u d o w n lo a d e d t h is s o f t w a r e . Us in g r e v e r s e e n gin e e r in g, w e c a n b r e a k t h e p a s s w o r d . B r e a k in g a p a s s w o r d is u n e t h ic a l a n d a ga in s t la w s u n t il a n d u n le s s w e a r e p e r m it t e d t o d o s o . N o w y o u m u s t b e t h in k in g h o w o n e c a n b r e a k a p a s s w o r d . B r e a k in g a p a s s w o r d is d e p e n d e n t o n t h e q u a lit y o f t h e s o f t w a r e c o d e . If t h e c o d e is w r it t e n w it h s e c u r it y in m in d , c h a n c e s a r e t h a t a s t r o n ge r m e c h a n is m m u s t h a v e b e e n u s e d . In t h is c h a p t e r, w e w ill d is c u s s t h e r e v e r s e e n gin e e r in g p a r t o f t h e m e c h a n is m u s e d b y a s o f t w a r e d e v e lo p e r t o c a p t u r e u s e r in p u t . W e w ill b e t a lk in g a b o u t s c a n f fu n c t io n , w h ic h is u s e d t o c a p t u r e t h e u s e r in p u t fr o m t h e c o n s o le . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : F u n c t io n s c a n f w it h In t e ge r s F u n c t io n s c a n f w it h o u t O p t im iz a t io n F u n c t io n s c a n f w it h O p t im iz a t io n O b je c t iv e In t h is c h a p t e r, w e w ill u n d e r s t a n d t h e s c a n f fu n c t io n w it h r e s p e c t t o r e v e r s e e n gin e e r in g. W e w ill t a lk a b o u t t h e s c a n f c o d e p a t t e r n in t h e d is a s s e m b le d c o d e a n d u n d e r s t a n d h o w s c a n f in p u t s a r e s t o r e d in m e m o r y. W e w ill a ls o c o v e r t h e s c a n f p r o gr a m w it h b o t h o p t im iz e d a n d n o n -o p t im iz e d c o d e . F u n c t io n s c a n f w it h In t e ge r s In t h is s im p le C / C ++ c o d e , w e a s k t h e u s e r t o in p u t a n u m b e r o f t y p e in t e ge r a n d p r in t it o n t h e c o n s o le . W e u s e s c a n f t o c a p t u r e u s e r in p u t a n d p r in t f t o p r in t t h e n u m b e r e n t e r e d b y t h e u s e r in o u r C / C ++ c o d e : F ig u r e 1 3 .1 : s c a n fWit h Int e g e r s .c p p F u n c t io n s c a n f w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 3 .2 : F u n c t io n s c a n f w it h o u t O p t im iz a t io n T h is w ill ge n e r a t e t h e a s s e m b ly c o d e a n d t h e E X E ﬁ le . T h is t im e , b e fo r e a n a ly z in g, w e w ill d is a b le t h e A d d r e s s S p a c e L a y o u t R a n d o miz a t io n It ’s a s e c u r it y m e c h a n is m b y w h ic h t h e b a s e a d d r e s s o f t h e P E ﬁ le is r a n d o m iz e d o n e v e r y lo a d o f t h e P o r t a b le E x e c u t a b le ﬁ le ge n e r a t e d w it h o u r M S V C c o m p ile r. T h is w ill h e lp u s r e lo a d t h e P E ﬁ le w it h o u t r a n d o m iz in g it s b a s e a d d r e s s . To d is a b le A S L R , r e fe r t o t h e W e w ill n o w u s e t h e P E ﬁ le w it h t h e d is a b le d A S L R fo r fu r t h e r a n a ly s is u s in g x 3 2 d b g. L e t ’s m o v e t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 3 .3 : s c a n fWit h Int e g e r s .a s m -P a r t -1 F ig u r e 1 3 .4 : s c a n fWit h Int e g e r s .a s m -P a r t -2 L e t ’s w a lk t h r o u gh t h e c o d e : ▼L in e 2 7 -3 0 ; L in e 7 p u s h e b p m o v e b p , e s p p u s h e c x T h e c o d e s t a r t s w it h a s im p le ma in fu n c t io n p r o lo gu e . ▼L in e 3 1 -3 4 ; L in e 9 p u s h O F F S E T $S G 4 6 7 8 c a ll _p r in t f a d d e s p , 4 T h e C / C ++ c o d e o n lin e 9 p r in t s t h e s t r in g c o n s t a n t o n t h e c o n s o le : p r in t f ( \" E n t e r a N u m b e r : \" ) ; In o u r a s s e m b ly c o d e , b e fo r e c a llin g t h e p r in t f fu n c t io n , t h e s t r in g c o n s t a n t $S G 4 6 7 8 s t o r e d in t h e .r d a t a s e gm e n t is p u s h e d o n t o t h e s t a c k . O n c e t h e a r gu m e n t s t o t h e p r in t f fu n c t io n s a r e p u s h e d o n t o t h e s t a c k , t h e c a ll t o t h e p r in t f fu n c t io n is m a d e . O n r e t u r n , 4 b y t e s a r e a d d e d t o E S P fo r s t a c k c le a n in g. F o r a n a ly z in g t h e a s s e m b ly in s t r u c t io n , w e w ill lo a d t h e P E ﬁ le in x 3 2 d b g, a n d t h e n p u t t w o b r e a k p o in t s . T h e ﬁ r s t b r e a k p o in t is a t t h e s t a r t o f t h e .T E X T s e gm e n t a n d t h e o t h e r b r e a k p o in t is ju s t a f t e r t h e s c a n f fu n c t io n r e t u r n . N o w , a f t e r lo a d in g t h e P E ﬁ le in x 3 2 d b g, r u n t h e c o d e . T h e e x e c u t io n w ill s t o p a t t h e ﬁ r s t b r e a k p o in t . Fr o m t h e ﬁ r s t b r e a k p o in t s t e p in t o t h e c o d e u s in g x 3 2 d b g, u n t il y o u h it t h e p r e c e d in g a d d e s p ,4 in s t r u c t io n . T h e A D D in s t r u c t io n c le a n s t h e s t a c k a n d t h e fo llo w in g is h o w t h e s t a c k lo o k s a f t e r e x e c u t in g t h e A D D in s t r u c t io n : [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 4 0 A 1 4 0   \" E n t e r a N u mb e r : \", a r g t o 1 s t p r in t f [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 1    EC X p u s h e d , la t e r t o s t o r e In t e ge r in p u t p a s s e d [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 C 4   r e t u r n t o 0 x 0 0 4 0 1 2 C 4 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .5 : S t a c k a f t e r A D D in s r u c t io n ▼L in e 3 5 -4 0 ; L in e 1 0 le a e a x , D W O R D P T R _iIn p u t $[e b p ] p u s h e a x p u s h O F F S E T $S G 4 6 7 9 c a ll _s c a n f a d d e s p , 8 T h e C / C ++ c o d e o n lin e 1 0 c a lls t h e s c a n f fu n c t io n , w h ic h a c c e p t s t h e fo llo w in g t w o a r gu m e n t s : s c a n f ( \" %d\", & iIn p u t ) ; In t h e a s s e m b ly c o d e , t h e L E A in s t r u c t io n is e v a lu a t e d t o : le a e a x , s s :[e b p -0 x 4 ] L E A w ill s t o r e t h e in p u t p la c e h o ld e r m e m o r y lo c a t io n in B y 'in p u t p la c e h o ld e r m e m o r y lo c a t io n ’, w e m e a n t h e m e m o r y lo c a t io n w h ic h w ill b e u s e d t o s t o r e t h e in t e ge r in p u t b y t h e u s e r. O n c e t h is in p u t p la c e h o ld e r m e m o r y lo c a t io n is s t o r e d in t h e n it is p u s h e d o n t o t h e s t a c k a s a p a r a m e t e r t o t h e s c a n f fu n c t io n . T h e n a n o t h e r p u s h in s t r u c t io n p u s h e s t h e s t r in g c o n s t a n t $S G 4 6 7 9 o n t h e s t a c k . T h e c a ll t o s c a n f is m a d e a f t e r p u s h in g b o t h t h e a r gu m e n t s . O n r e t u r n , 8 b y t e s a r e a d d e d t o E S P fo r s t a c k c le a n in g. T h e b r e a k p o in t is a d d e d a t t h e 0 x 0 0 4 0 1 0 1 F m e m o r y lo c a t io n . T h e s t a c k s t a t e a t b r e a k p o in t is a s fo llo w s : [E S P ]  0 0 1 2 F F 3 4   0 0 4 0 A 1 5 4    \" %d \", p a r a me t e r t o s c a n f ( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 3 C   In p u t p la c e h o ld e r me mo r y lo c a t io n [E S P +0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7   In p u t p la c e h o ld e r, N u mb e r 7 is e n t e r e d b y u s e r [E S P +0 x C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 1 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 C 4   r e t u r n t o 0 x 0 0 4 0 1 2 C 4 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .6: Us e r e n t e r e d n u m b e r o n s t a c k ▼L in e 4 1 -4 6 ; L in e 1 1 m o v e c x , D W O R D P T R _iIn p u t $[e b p ] p u s h e c x p u s h O F F S E T $S G 4 6 8 0 c a ll _p r in t f a d d e s p , 8 T h e C / C ++ c o d e o n lin e 1 1 c a lls t h e p r in t f fu n c t io n . T h is w ill p r in t t h e n u m b e r e n t e r e d b y t h e u s e r : p r in t f ( \" N u m b e r y o u e n t e r e d is %d\\ n \", iIn p u t ) ; In t h e a s s e m b ly c o d e , t h e M O V in s t r u c t io n is e v a lu a t e d t o : m o v e c x , d w o r d p t r s s :[e b p -0 x 4 ] T h e M O V in s t r u c t io n w ill m o v e t h e u s e r in p u t s t o r e d a t s s :[e b p - 0 x 4 ] t o N o w , b o t h t h e a r gu m e n t s t h e ﬁ r s t is t h e s t r in g c o n s t a n t a n d t h e s e c o n d is t h e n u m b e r t h a t t h e u s e r e n t e r e d t o t h e p r in t f fu n c t io n a r e p u s h e d o n t h e s t a c k : [E S P -0 x 8 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 5 8   \" N u mb e r y o u e n t e r e d is %d \\ n \", a r g t o 2 n d p r in t f( ) [E S P -0 x 4 ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7   N u mb e r 7 is e n t e r e d b y u s e r, a r g t o 2 n d p r in t f( ) [E S P ]  0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7    In p u t p la c e h o ld e r, N u mb e r 7 is e n t e r e d b y u s e r    [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 C 4   r e t u r n t o 0 x 0 0 4 0 1 2 C 4 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .7 : A f t e r p r in t f fu n c t io n ▼L in e 4 7 -5 5 ; L in e 1 2 x o r e a x , e a x ; L in e 1 3 m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D X O R a n d fu n c t io n e p ilo gu e w ill c le a n u p E A X a n d s t a c k , r e s p e c t iv e ly. E A X is X O R ’e d t o r e t u r n 0 . E N D P w ill e n d t h e ma in p r o c e d u r e a n d E N D S w ill e n d t h e t e x t s e gm e n t . T h e s t a c k w ill b e a s fo llo w s : [E S P +0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 5 8   JUN K [E S P +0 x C ] 0 0 1 2 F F 3 8   0 0 0 0 0 0 0 7   JUN K [E S P +0 x 8 ] 0 0 1 2 F F 3 C   0 0 0 0 0 0 0 7   JUN K [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8   [EB P ] p o p p e d u p [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 C 4    r e t u r n t o 0 x 0 0 4 0 1 2 C 4 fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .8: S t a c k c le a n e d F u n c t io n s c a n f w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 3 .9: F u n c t io n s c a n f w it h o p t im iz a t io n L e t ’s m o v e t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 3 .1 0 : s c a n fWit h Int e g e r s -O p t im iz e d .a s m -P a r t -1 F ig u r e 1 3 .1 1 : s c a n fWit h Int e g e r s -O p t im iz e d .a s m -P a r t -2 T h e m a in d iﬀ e r e n c e b e t w e e n o p t im iz e d a n d n o n -o p t im iz e d c o d e is t h a t in o p t im iz e d c o d e , t h e fu n c t io n p r o lo gu e a n d e p ilo gu e a r e e lim in a t e d . S e c o n d ly, t h e s t a c k c le a n in g is n o t d o n e a f t e r e a c h a n d e v e r y fu n c t io n c a ll b u t t o w a r d s t h e e n d o f t h e ma in fu n c t io n . W e w ill w a lk t h r o u gh t h e a s s e m b ly in s t r u c t io n in t h e s a m e w a y w e d id in t h e n o n -o p t im iz a t io n s e c t io n b y p u t t in g b r e a k p o in t s in x 3 2 d b g: ▼L in e 2 7 -3 1 ; L in e 7 p u s h e c x ; L in e 9 p u s h O F F S E T $S G 4 6 7 8 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 9 p r in t s t h e s t r in g c o n s t a n t o n t h e c o n s o le : p r in t f ( \" E n t e r a N u m b e r : \" ) ; T h e s t r in g c o n s t a n t $S G 4 6 7 8 s t o r e d in t h e .r d a t a s e gm e n t is p u s h e d o n t o t h e s t a c k b e fo r e c a llin g t h e p r in t f fu n c t io n . N o t e t h a t t h e fu n c t io n p r o lo gu e a s w e ll a s t h e s t a c k c le a n in g a f t e r t h e p r in t f fu n c t io n c a ll a r e e lim in a t e d . W e w ill a ls o s e e t h a t t h e s t a c k is c le a n e d t o w a r d s t h e e n d . T h e fo llo w in g is t h e s t a c k s t a t e a f t e r e x e c u t in g t h e p r e c e d in g in s t r u c t io n : [E S P ]  0 0 1 2 F F 3 C   0 0 4 0 A 1 4 0    \" E n t e r a N u mb e r : \", p a r a me t e r t o 1 s t p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 1   EC X is p u s h e d , u s e d la t e r t o s t o r e In t e ge r in p u t [E S P +0 x 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B A   r e t u r n t o 0 x 0 0 4 0 1 2 B A fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .1 2 : A f t e r p r in t f ▼L in e 3 2 -3 6 ; L in e 1 0 le a e a x , D W O R D P T R _iIn p u t $[e s p +8 ] p u s h e a x p u s h O F F S E T $S G 4 6 7 9 c a ll _s c a n f T h e C / C ++ c o d e o n lin e 1 0 c a lls t h e s c a n f fu n c t io n , w h ic h a c c e p t s t h e fo llo w in g t w o a r gu m e n t s : s c a n f ( \" %d\", & iIn p u t ) ; In t h e a s s e m b ly c o d e , t h e L E A in s t r u c t io n is e v a lu a t e d t o : le a e a x , s s :[e s p +0 x 4 ] L E A w ill lo a d t h e e ﬀ e c t iv e a d d r e s s o f t h e in p u t p la c e h o ld e r m e m o r y lo c a t io n in E A X . A s a lr e a d y s t a t e d in n o n -o p t im iz e d s e c t io n , in p u t p la c e h o ld e r m e m o r y lo c a t io n m e a n s , t h e m e m o r y lo c a t io n w h ic h w ill b e u s e d t o s t o r e t h e In t e ge r in p u t b y u s e r. T h e S c a n f fu n c t io n t a k e s t w o a r gu m e n t s , o n e is t h e m e m o r y lo c a t io n w h e r e t h e u s e r ’s in p u t w ill b e s t o r e d a n d t h e o t h e r is t h e s t r in g c o n s t a n t O n c e b o t h t h e p a r a m e t e r s a r e p u s h e d o n t o t h e s t a c k , t h e c a ll t o s c a n f is m a d e . D u r in g t h e c a ll, t h e u s e r is a s k e d t o e n t e r t h e n u m b e r. T h e in t e ge r n u m b e r s u p p lie d b y t h e u s e r w ill b e s t o r e d a t t h e in p u t p la c e h o ld e r m e m o r y lo c a t io n . W e c a n a ls o n o t ic e t h a t t h e s t a c k c le a n in g is n o t d o n e a f t e r t h e fu n c t io n c a ll. T h e b r e a k p o in t is a d d e d a t t h e 0 x 0 0 4 0 1 0 1 A m e m o r y lo c a t io n . T h e s t a c k s t a t e a t b r e a k p o in t is a s fo llo w s : [E S P ]  0 0 1 2 F F 3 4   0 0 4 0 A 1 5 4    \" %d\", p a r a m e t e r t o s c a n f ( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 8   0 0 1 2 F F 4 0   In p u t p la c e h o ld e r m e m o r y lo c a t io n [E S P +0 x 8 ] 0 0 1 2 F F 3 C   0 0 4 0 A 1 4 0   \" E n t e r a N u m b e r : \", p a r a m e t e r t o 1 s t p r in t f( ) [E S P +0 x C ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   In p u t p la c e h o ld e r, N u m b e r 7 is e n t e r e d b y u s e r [E S P +0 x 1 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B A   r e t u r n t o 0 x 0 0 4 0 1 2 B A fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .1 3 : A f t e r s c a n f ▼L in e 3 7 -4 1 ; L in e 1 1 m o v e c x , D W O R D P T R _iIn p u t $[e s p +1 6 ] p u s h e c x p u s h O F F S E T $S G 4 6 8 0 c a ll _p r in t f T h e C / C ++ c o d e o n lin e 1 1 c a lls t h e p r in t f fu n c t io n . T h is w ill p r in t t h e n u m b e r t h a t t h e u s e r e n t e r e d : p r in t f ( \" N u m b e r y o u e n t e r e d is %d\\ n \", iIn p u t ) ; In t h e a s s e m b ly c o d e , t h e M O V in s t r u c t io n is e v a lu a t e d t o : m o v e c x , d w o r d p t r s s :[e s p +0 x C ] T h e M O V in s t r u c t io n w ill m o v e t h e u s e r in t e ge r in p u t s t o r e d a t s s :[e s p +0 x C ] t o N o w , b o t h t h e a r gu m e n t s ( ﬁ r s t is t h e s t r in g c o n s t a n t a n d t h e s e c o n d is t h e in t e ge r n u m b e r t h a t t h e u s e r e n t e r e d ) o f t h e p r in t f fu n c t io n a r e p u s h e d o n t h e s t a c k b e fo r e t h e p r in t f c a ll. T h e s t a c k s t a t e a f t e r t h e C A L L in s t r u c t io n w ill b e : [E S P ]  0 0 1 2 F F 2 C   0 0 4 0 A 1 5 8    \" N u m b e r y o u e n t e r e d is %d \\ n \", a r g t o 2 n d p r in t f( ) [E S P +0 x 4 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 7   N u mb e r 7 is e n t e r e d b y u s e r, a r g t o 2 n d p r in t f( ) [E S P +0 x 8 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 5 4   \" %d \", p a r a me t e r t o s c a n f ( ) [E S P +0 x C ] 0 0 1 2 F F 3 8   0 0 1 2 F F 4 0   In p u t p la c e h o ld e r me mo r y lo c a t io n [E S P +0 x 1 0 ] 0 0 1 2 F F 3 C   0 0 4 0 A 1 4 0   \" E n t e r a N u mb e r : \", p a r a me t e r t o 1 s t p r in t f( ) [E S P +0 x 1 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   In p u t p la c e h o ld e r, N u mb e r 7 is e n t e r e d b y u s e r [E S P +0 x 1 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 B A   r e t u r n t o 0 x 0 0 4 0 1 2 B A fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .1 4 : A f t e r s e c o n d p r in t f ▼L in e 4 2 -4 9 ; L in e 1 2 x o r e a x , e a x ; L in e 1 3 a d d e s p , 2 4      ; 0 0 0 0 0 0 1 8 H r e t 0 _m a in E N D P _TEX T E N D S E N D X O R w ill c le a n u p E A X t o r e t u r n 0 . Yo u c a n n o t ic e t h a t t h e s t a c k is c le a n e d t o w a r d s t h e e n d o f t h e ma in fu n c t io n w it h t h e A D D in s t r u c t io n . T h e A D D in s t r u c t io n c le a n s t h e s t a c k b y a d d in g 2 4 b y t e s t o T h e E N D d e r iv a t iv e e n d s t h e c o d e . T h e s t a c k s t a t e w ill b e a s fo llo w s : [E S P -0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 4 0 A 1 5 8   JUN K [E S P -0 x 1 4 ] 0 0 1 2 F F 3 0   0 0 0 0 0 0 0 7   JUN K [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 4 0 A 1 5 4   JUN K [E S P -0 x C ] 0 0 1 2 F F 3 8   0 0 1 2 F F 4 0   JUN K [E S P -0 x 8 ] 0 0 1 2 F F 3 C   0 0 4 0 A 1 4 0   JUN K [E S P -0 x 4 ] 0 0 1 2 F F 4 0   0 0 0 0 0 0 0 7   JUN K [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 B A    r e t u r n t o 0 x 0 0 4 0 1 2 B A fr o m 0 x 0 0 4 0 1 0 0 0 F ig u r e 1 3 .1 5 : S t a c k c le a n e d C o n c lu s io n In t h is c h a p t e r, w e u n d e r s t o o d h o w t h e in p u t c a p t u r e d fr o m a u s e r is s t o r e d in m e m o r y u s in g t h e s c a n f fu n c t io n . W e s a w t h e s c a n f c o d e p a t t e r n in a d is a s s e m b le d c o d e fo r b o t h o p t im iz e d a n d n o n -o p t im iz e d c o d e . In t h e n e x t c h a p t e r, w e w ill s t u d y t h e s t r c p y fu n c t io n a n d h o w it s p a t t e r n lo o k s w h ile r e v e r s e e n gin e e r in g. C H A P T E R 1 4 S t r c p y P r o gr a m P a t t e r n in R e v e r s e E n gin e e r in g W e h a v e u n d e r s t o o d t h e p a t t e r n s o f a r r a y s a n d p o in t e r s in t h e e a r lie r c h a p t e r s . N o w w e w ill t a lk a b o u t s o m e r e a l-w o r ld e x a m p le s o f c o d e t h a t u s e a ll t h e s e a s a p a r t o f a s in gle p r o gr a m . T h e r e a r e t im e s w h e n y o u w a n t t o c o p y d a t a fr o m o n e p la c e t o a n o t h e r p la c e . To d o s o , w e u s e s o m e s t a n d a r d p r e d e ﬁ n e d fu n c t io n s . B u t in t h is c h a p t e r, w e w ill t a lk a b o u t t h e im p le m e n t a t io n o f s t r c p y, w h ic h is u s e d t o c o p y d a t a fr o m t h e s o u r c e t o t h e d e s t in a t io n . T h e im p le m e n t a t io n o f s t r c p y w ill h e lp y o u le a r n t h e c o m b in a t io n o f p o in t e r s a n d a r r a y s in a s in gle p r o gr a m a n d u n d e r s t a n d t h e c o d e p a t t e r n in a s s e m b ly. T h e s e p a t t e r n s c a n b e s e e n in m a n y a p p lic a t io n s o r s o f t w a r e a n d y o u w ill ﬁ n d it in t e r e s t in g t o k n o w t h a t t h is w ill a llo w y o u t o ﬁ n d v u ln e r a b ilit ie s in t h e m . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : Un d e r s t a n d s t r c p y fu n c t io n S t r c p y w it h o u t O p t im iz a t io n S t r c p y w it h O p t im iz a t io n O b je c t iv e In t h is c h a p t e r, w e w ill t a lk a b o u t t h e s t r c p y fu n c t io n im p le m e n t a t io n w it h r e s p e c t t o r e v e r s e e n gin e e r in g. T h is fu n c t io n is v e r y p o p u la r in s o f t w a r e im p le m e n t a t io n t o p e r fo r m t h e s t r in g c o p y o p e r a t io n fr o m t h e s o u r c e lo c a t io n t o t h e d e s t in a t io n . W e w ill a ls o t a lk a b o u t b y t e -b y -b y t e o p e r a t io n s t h a t h a p p e n d u r in g t h e s t r c p y e x e c u t io n . W e w ill a ls o c o v e r s t r c p y p r o gr a m a s s e m b ly p a t t e r n w it h o p t im iz e d a n d n o n -o p t im iz e d c o d e . S t r c p y In t h is e x a m p le , w e w ill t a k e u p t h e s t r c p y fu n c t io n w it h t h e n a m e o f x s t r c p y t o c o p y a s t r in g. F ig u r e 1 4 .1 : s t r c p y.c p p S t r c p y w it h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 4 .2 : S t r c p y w it h o u t O p t im iz a t io n T h e c o m p ila t io n ge n e r a t e s t h e E X E ﬁ le a n d a s s e m b ly c o d e . D is a b le A S L R m a n u a lly. To d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 4 .3 : s t r c p y.a s m -P a r t -1 F ig u r e 1 4 .4 : s t r c p y.a s m -P a r t -2 F ig u r e 1 4 .5 : s t r c p y.a s m -P a r t -3 F ig u r e 1 4 .6: s t r c p y.a s m -P a r t -4 ▼L in e 1 2 -1 5 C O N S T S E G M E N T $S G 4 6 8 8 D B 'R e v e r s e E n gg', 0 0 H $S G 4 6 9 0 D B '%s ', 0 a H , 0 0 H C O N S T E N D S C o n s t a n t S e gm e n t d e ﬁ n e s t w o s t r in g c o n s t a n t s , $S G 4 6 8 8 a n d T h e lin k e r r e n a m e s C O N S T S E G M E N T t o .r d a t a ( t h e c o d e is p la c e d in t h e .c o d e s e gm e n t , t h e c o n s t a n t s t r in gs a r e p la c e d in C O N S T s e gm e n t a n d if n o t , t h e c o n s t a n t is p la c e d in t h e .d a t a s e gm e n t ) , w h ic h c a n b e v ie w e d in t h e m e m o r y d u m p u s in g x 3 2 d b g, s h o w n a s fo llo w s : F ig u r e 1 4 .7 : .r d a t a $S G 4 6 8 8 a n d $S G 4 6 9 0 a r e in t e r n a l n a m e s giv e n b y t h e c o m p ile r t o h a n d le t h e s t r in g c o n s t a n t . D B d e ﬁ n e s t h e b y t e , w h ic h is t h e d a t a t y p e . 'R e v e r s e E n gg ', 0 0 H is t h e s t r in g d a t a , w h ic h is n u ll t e r m in a t e d A S C II s t r in g. '%s ', 0 a H , 0 0 H is a ls o a s t r in g d a t a . B y C O N S T t h e c o n s t a n t s e gm e n t is e n d e d . F ir s t , w e w ill t a k e t h e m a in c o d e s t a r t in g w it h : ▼L in e 7 2 -7 3 P UB L IC __$A r r a y P a d $ P UB L IC _m a in P UB L IC is t h e d e r iv a t iv e w h ic h m a k e s t h e _ma in p r o c e d u r e a n d t h e __$A r r a y P a d $ m a c r o p u b lic , w h ic h c a n b e a c c e s s e d b y o t h e r m o d u le s : ▼L in e 7 4 -7 6 E X T R N _p r in t f:P R O C E X T R N ___s e c u r it y _c o o k ie :D W O R D E X T R N @__s e c u r it y _c h e c k _c o o k ie @4 :P R O C T h e E X T R N d e r iv a t iv e d e c la r e s t h e e x t e r n fu n c t io n , w h ic h is p r in t f in o u r c a s e . A ll fu n c t io n s b e gin w it h a n u n d e r s c o r e . ▼L in e 7 8 -8 1 _TEX T S E G M E N T _s r c $ = -4 4       ; s iz e = 1 2 _de s t $ = -3 2       ; s iz e = 2 5 __$A r r a y P a d $ = -4      ; s iz e = 4 T h is is t h e s t a r t o f t h e _TEX T s e gm e n t , w h e r e o u r ma in fu n c t io n c o d e r e s id e s . A f t e r w e h a v e t h e d iﬀ e r e n t v a r ia b le m a c r o d e ﬁ n e d . T h e lo c a l v a r ia b le o n t h e s t a c k fr a m e c a n b e a c c e s s e d b y a d d in g _ $ t o t h e E B P a d d r e s s . ▼L in e 8 2 _m a in P R O C T h is is t h e s t a r t o f t h e ma in p r o c e d u r e . ▼L in e 8 3 -8 9 ; L in e 3 5 p u s h e b p m o v e b p , e s p s u b e s p , 4 4      ; 0 0 0 0 0 0 2 c H m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e b p m o v D W O R D P T R __$A r r a y P a d $[e b p ], e a x L in e 3 5 o f t h e C / C ++ c o d e s t a r t s t h e ma in fu n c t io n : in t m a in ( ) { T h e A S M c o d e s t a r t s w it h t h e ma in fu n c t io n p r o lo gu e o f P US H a n d M O V in s t r u c t io n . T h e S UB in s t r u c t io n c r e a t e s r o o m fo r v a r ia b le s o n t h e s t a c k b y s u b t r a c t in g 4 4 ( 0 x 2 C ) b y t e s fr o m 4 4 b y t e s c a n b e v is u a liz e d a s 4 b y t e s fo r t h e 1 2 b y t e s fo r t h e s r c a r r a y, a n d 2 8 b y t e s fo r t h e d e s t a r r a y. T h e s r c a n d d e s t a r r a y s iz e s h a v e b e e n r o u n d o ﬀ t o t h e m u lt ip le o f 4 b y t e s . ▼L in e 8 7 -8 9 m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e b p m o v D W O R D P T R __$A r r a y P a d $[e b p ], e a x W e h a v e a lr e a d y d is c u s s e d t h e c o n c e p t o f a s t a c k c o o k ie . In t h e p r e c e d in g in s t r u c t io n , t h e s t a c k c o o k ie is m o v e d fr o m E A X t o X O R w it h E B P a n d t h e r e s u lt a n t X O R v a lu e is p la c e d o n t h e s t a c k . T h is v a lu e is s t o r e d o n t h e s t a c k r igh t a b o v e t h e o ld T h is v a lu e w ill b e v a lid a t e d b e fo r e t h e ma in fu n c t io n e p ilo gu e t o c h e c k t h e b u ﬀ e r o v e r ﬂ o w c o n d it io n . N o w , le t ’s m o v e o n t o t h e n e x t in s t r u c t io n s : ▼L in e 9 0 -9 6 ; L in e 3 6 m o v e a x , D W O R D P T R $S G 4 6 8 8 m o v D W O R D P T R _s r c $[e b p ], e a x m o v e c x , D W O R D P T R $S G 4 6 8 8 +4 m o v D W O R D P T R _s r c $[e b p +4 ], e c x m o v e d x , D W O R D P T R $S G 4 6 8 8 +8 m o v D W O R D P T R _s r c $[e b p +8 ], e d x L in e 3 6 o f t h e C / C ++ c o d e is : c h a r s r c [] = \" R e v e r s e E n gg\" ; In t h e A S M c o d e , w e c a n s e e t h a t t h e s t r in g $S G 4 6 8 8 is m o v e d t o t h e s t a c k in t h r e e s t e p s a n d w it h s ix M O V in s t r u c t io n s . T h e ﬁ r s t t w o M O V in s t r u c t io n s m o v e t h e ﬁ r s t 4 b y t e s o f s t r in g ( “ R e v e ” ) t o E A X a n d t h e n fr o m it is p u s h e d t o t h e s t a c k a t t h e [E B P - 0 x 2 C ] lo c a t io n . S im ila r ly, t h e n e x t 4 b y t e s o f s t r in g ( “ r s e E ” ) a r e m o v e d t o E C X a n d t h e n fr o m it is p u s h e d t o t h e s t a c k a t t h e [E B P - 0 x 2 8 ] lo c a t io n . T h e n in t h e r e m a in in g b y t e s , p a d d e d w it h N UL L ( “ n gg” + “ 0 x 0 0 ” ) a r e m o v e d t o E D X a n d t h e n fr o m E D X t o t h e s t a c k a t t h e [E B P - 0 x 2 4 ] lo c a t io n . T h e s t a c k s t a t e a f t e r t h e e x e c u t io n o f t h e p r e c e d in g in s t r u c t io n in x 3 2 d b g w ill b e a s fo llo w s : [E S P ]  0 0 1 2 F F 1 4   6 5 7 6 6 5 5 2    [E B P -0 x 2 C ]  “ e v e R ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   4 5 6 5 7 3 7 2    [E B P -0 x 2 8 ]  “ E e s r ” is p u s h e d h e r e , lit t le e n d ia n [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 6 7 6 7 6 E    [E B P -0 x 2 4 ]  “ ggn ” is p u s h e d h e r e , lit t le e n d ia n [E S P +0 x 0 C ] 0 0 1 2 F F 2 0    A C 9 8 0 2 C F    [E B P -0 x 2 0 ]  JUN K H E R E [E S P +0 x 1 0 ] 0 0 1 2 F F 2 4   F F F F F F F E    [E B P -0 x 1 C ]  JUN K H E R E [E S P +0 x 1 4 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 9 C    [E B P -0 x 1 8 ]  JUN K H E R E [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 B 0    [E B P -0 x 1 4 ]  JUN K H E R E [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B    [E B P -0 x 1 0 ]  JUN K H E R E [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8    [E B P -0 x 0 C ]  JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E    [E B P -0 x 0 8 ]  JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C    A C C A 6 6 5 7    [E B P -0 x 0 4 ]  X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8    [E B P ]       E B P o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 8    [E B P +0 x 0 4 ]  r e t u r n t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .8: $S G 4 688 is m o v e d t o t h e s t a c k ▼L in e 9 7 -1 0 2 ; L in e 3 9 le a e a x , D W O R D P T R _s r c $[e b p ] p u s h e a x le a e c x , D W O R D P T R _de s t $[e b p ] p u s h e c x c a ll ? x s t r c p y @@Y A P A D P A D P B D @Z    ; x s t r c p y L in e 3 9 o f t h e C / C ++ c o d e is : p r in t f( \" %s \\ n \", x s t r c p y ( d e s t , s r c ) ) ; In t h e A S M c o d e , b e fo r e m a k in g t h e p r in t f fu n c t io n c a ll, w e n e e d t o p u s h t h e r e t u r n v a lu e o f t h e x s t r c p y fu n c t io n a n d t h e s t r in g $S G 4 6 9 0 o n t o t h e s t a c k . To e v a lu a t e t h e r e t u r n v a lu e o f t h e x s t r c p y fu n c t io n , a r gu m e n t s t o t h e fu n c t io n a r e p u s h e d o n t o t h e s t a c k . S o , t h e ﬁ r s t L E A ( L o a d E ﬀ e c t iv e A d d r e s s ) lo a d s t h e a d d r e s s o n t h e s t a c k ( w h ic h is [E B P - 0 x 2 C ], p o in t in g t o t h e s o u r c e a r r a y in t h e E A X r e gis t e r. Fr o m it is fu r t h e r p u s h e d o n t o t h e s t a c k . S im ila r ly, t h e s e c o n d L E A in s t r u c t io n lo a d s t h e a d d r e s s o n t h e s t a c k ( w h ic h is [E B P - p o in t in g t o t h e d e s t in a t io n a r r a y in t h e E C X r e gis t e r. Fr o m it is fu r t h e r p u s h e d o n t o t h e s t a c k . A s t h e d e s t in a t io n a r r a y is n o t in it ia liz e d in t h e C / C ++ c o d e , it is p o in t in g t o t h e u n in it ia liz e d m e m o r y lo c a t io n ( w h ic h is [E B P - t h e o n s t a c k . O n c e b o t h t h e a r gu m e n t s t o t h e x s t r c p y fu n c t io n a r e p u s h e d o n t o t h e s t a c k , a c a ll t o t h e x s t r c p y fu n c t io n is m a d e . T h e s t a c k s t a t e b e fo r e t h e c a ll t o t h e x s t r c p y fu n c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F F 0 C   0 0 1 2 F F 2 0    [E B P -0 x 3 4 ]  2 n d a r g t o x s t r c p y, p t r t o d e s t a r r a y [E S P +0 x 0 4 ] 0 0 1 2 F F 1 0   0 0 1 2 F F 1 4    [E B P -0 x 3 0 ]  1 s t a r g t o x s t r c p y ( ) ,p t r t o s r c a r r a y [E S P +0 x 0 8 ] 0 0 1 2 F F 1 4   6 5 7 6 6 5 5 2    [E B P -0 x 2 C ] “ e v e R ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 C ] 0 0 1 2 F F 1 8   4 5 6 5 7 3 7 2    [E B P -0 x 2 8 ]  “ E e s r ” is p u s h e d h e r e , lit t le e n d ia n [E S P +0 x 1 0 ] 0 0 1 2 F F 1 C   0 0 6 7 6 7 6 E    [E B P -0 x 2 4 ]  “ ggn ” is p u s h e d h e r e , lit t le e n d ia n [E S P +0 x 1 4 ] 0 0 1 2 F F 2 0    A C 9 8 0 2 C F    [E B P -0 x 2 0 ]  d e s t a r r a y s t a r t , u n in it ia liz e d JUN K [E S P +0 x 1 8 ] 0 0 1 2 F F 2 4   F F F F F F F E    [E B P -0 x 1 C ]  JUN K H E R E [E S P +0 x 1 C ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 9 C    [E B P -0 x 1 8 ]  JUN K H E R E [E S P +0 x 2 0 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 B 0    [E B P -0 x 1 4 ]  JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B    [E B P -0 x 1 0 ]  JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8    [E B P -0 x 0 C ]  JUN K H E R E [E S P +0 x 2 C ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E    [E B P -0 x 0 8 ]  JUN K H E R E [E S P +0 x 3 0 ] 0 0 1 2 F F 3 C    A C C A 6 6 5 7    [E B P -0 x 0 4 ]  X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 3 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8    [E B P ]       E B P o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 3 8 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 8    [E B P +0 x 0 4 ]   r e t u r n t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .9: B e fo r e c a ll t o x s t r c p y T h e fo llo w in g is t h e s t a r t o f t h e x s t r c p y fu n c t io n : ▼L in e 2 4 -2 7 ; L in e 9 p u s h e b p m o v e b p , e s p p u s h e c x T h e x s t r c p y fu n c t io n p r o lo gu e is c a lle d . T h e E C X r e gis t e r h a s t h e p o in t e r t o t h e d e s t a r r a y, s o it is s a v e d o n t o t h e s t a c k b y p u s h in g t h e E C X r e gis t e r. T h e s t a c k s t a t e a f t e r p u s h in g t h e E C X r e gis t e r is a s fo llo w s . Fr o m t h is p o in t o n w a r d s , t h e t w o s t a c k fr a m e s h a v e b e e n d iﬀ e r e n t ia t e d w it h E B P m a r k e d w it h s u p e r s c r ip t , t h a t is , E B P fo r ma in a n d x s t r c p y. t o d e s t [E S P +0 x 0 4 ] E B P o f ma in ( ) s t a c k fr a me [E S P +0 x 0 8 ] r e t u r n t o ma in ( ) [E S P +0 x 0 C ] a r g t o x s t r c p y [E S P +0 x 1 0 ] a r g t o x s t r c p y [E S P +0 x 1 4 ] “ e v e R ” is p u s h e d h e r e [E S P +0 x 1 8 ] “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 C ] “ ggn ” is p u s h e d h e r e [E S P +0 x 2 0 ] u n in it ia liz e d d e s t a r r a y [E S P +0 x 2 4 ] JUN K H E R E [E S P +0 x 2 8 ] JUN K H E R E [E S P +0 x 2 C ] JUN K H E R E [E S P +0 x 3 0 ] JUN K H E R E [E S P +0 x 3 4 ] JUN K H E R E [E S P +0 x 3 8 ] JUN K H E R E [E S P +0 x 3 C ] X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 4 0 ] o f e a r lie r s t a c k fr a me [E S P +0 x 4 4 ] r e t u r n t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .1 0 : S t a c k s t a t e a f t e r p u s h in g E C X ▼L in e 2 8 -3 0 ; L in e 1 1 c m p D W O R D P T R _de s t $[e b p ], 0 jn e S H O R T $L N 3 @x s t r c p y L in e 1 1 o f t h e C / C ++ c o d e is : if ( d e s t == N UL L ) T h e A S M c o d e c o m p a r e s t h e v a lu e a t w it h N UL L . A ju m p w ill t a k e p la c e w h e n t h e v a lu e a t is n o t e q u a l t o N UL L . A s m e m o r y is a lr e a d y a llo c a t e d t o t h e d e s t a r r a y a t w h ic h is n o t e q u a l t o N UL L , s o t h e ju m p w ill t a k e p la c e t o t h e $L N 3 @x s t r c p y la b e l. T h e s t a c k s t a t e a f t e r t h e ju m p in s t r u c t io n w ill b e t h e s a m e a s e a r lie r. ▼L in e 3 4 -3 7 $L N 3 @x s t r c p y : ; L in e 1 5 m o v e a x , D W O R D P T R _de s t $[e b p ] m o v D W O R D P T R _p t r $[e b p ], e a x L in e 1 1 o f t h e C / C ++ c o d e is : c h a r *p t r = d e s t ; In t h e A S M c o d e it is ju s t t a k in g t h e p o in t e r t o t h e d e s t a r r a y in t o E A X a n d t h e n p u s h in g it o n t o t h e s t a c k a t If y o u r e m e m b e r, w e s a v e d E C X a t t h e s t a r t o f t h e x s t r c p y fu n c t io n o n -t o t h e s t a c k a t t h e s a m e lo c a t io n E C X w a s h a v in g t h e s a m e p o in t e r t o t h e d e s t a r r a y. S o b a s ic a lly in t h e s e t w o in s t r u c t io n s w e a r e o v e r w r it in g w it h t h e s a m e v a lu e . S o t h e s t a c k s t a t e w ill b e t h e s a m e a s e a r lie r : F ig u r e 1 4 .1 1 : S t a c k s t a t e a f t e r lin e 3 7 ▼L in e 3 8 -4 3 $L N 2 @x s t r c p y : ; L in e 1 9 m o v e c x , D W O R D P T R _s r c $[e b p ] m o v s x e d x , B YTE P T R [e c x ] t e s t e d x , e d x je S H O R T $L N 1 @x s t r c p y L in e 1 9 o f t h e C / C ++ c o d e is : w h ile ( *s r c != '\\ 0 ') In t h e A S M c o d e , t h e M O V in s t r u c t io n is m o v in g t h e p o in t e r t o t h e s r c a r r a y in t h e E C X r e gis t e r. T h e n e x t M O V in s t r u c t io n m o v e s t h e ﬁ r s t b y t e o f t h e s r c a r r a y in t o m a k in g ( a s c ii “ R ” ) . T h e T E S T in s t r u c t io n w ill p e r fo r m a n A N D o p e r a t io n o f E D X w it h it s e lf, r e s u lt in g in a n o n -z e r o v a lu e in E D X a n d Z F =0 . S o , a ju m p t o t h e la b e l $L N 1 @x s t r c p y w ill n o t t a k e p la c e . T h e in s t r u c t io n p o in t e r w ill m o v e t o t h e n e x t in s t r u c t io n . T h e s t a c k s t a t e w ill b e t h e s a m e a s e a r lie r : F ig u r e 1 4 .1 2 : S t a c k s t a t e a f t e r je ▼L in e 4 4 -4 8 ; L in e 2 1 m o v e a x , D W O R D P T R _de s t $[e b p ] m o v e c x , D W O R D P T R _s r c $[e b p ] m o v d l, B YTE P T R [e c x ] m o v B YTE P T R [e a x ], d l L in e 2 1 o f t h e C / C ++ c o d e is : *de s t = *s r c ; A s t h is A S M c o d e is n o n -o p t im iz e d , w e w ill c o m e a c r o s s m a n y in s t r u c t io n s w h ic h a r e d u p lic a t in g o p e r a t io n s . W e c a n s e e t h a t t h e M O V in s t r u c t io n is a ga in m o v in g t h e p o in t e r fr o m t h e d e s t a r r a y t o E A X r e gis t e r a n d p o in t e r t o s r c a r r a y is m o v e d t o t h e E C X r e gis t e r. N o w , in t h e r e m a in in g t w o M O V in s t r u c t io n s , w e a r e c o p y in g t h e ﬁ r s t b y t e fr o m t h e s r c a r r a y t o t h e d e s t a r r a y u s in g t h e D L r e gis t e r. T h is is d o n e b y c o p y in g a b y t e fr o m t h e m e m o r y p o in t e d b y t h e E C X r e gis t e r ( w h ic h is p o in t in g t o t h e s r c a r r a y ) t o t h e D L r e gis t e r a n d t h e n fr o m t h e D L r e gis t e r t o t h e m e m o r y p o in t e d b y t h e E A X r e gis t e r ( w h ic h is p o in t in g t o t h e d e s t a r r a y ) . T h e s t a c k s t a t e a f t e r t h e s e in s t r u c t io n s w ill b e : t o d e s t [E S P +0 x 0 4 ] E B P o f ma in ( ) s t a c k fr a me [E S P +0 x 0 8 ] r e t u r n t o ma in ( ) [E S P +0 x 0 C ] a r g t o x s t r c p y [E S P +0 x 1 0 ] a r g t o x s t r c p y [E S P +0 x 1 4 ] “ e v e R ” is p u s h e d h e r e [E S P +0 x 1 8 ] “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 C ] “ ggn ” is p u s h e d h e r e [E S P +0 x 2 0 ] o n ly “ R ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 4 ] JUN K H E R E [E S P +0 x 2 8 ] JUN K H E R E [E S P +0 x 2 C ] JUN K H E R E [E S P +0 x 3 0 ] JUN K H E R E [E S P +0 x 3 4 ] JUN K H E R E [E S P +0 x 3 8 ] JUN K H E R E [E S P +0 x 3 C ] X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 4 0 ] o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 4 4 ] r e t u r n t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .1 3 : S t a c k s t a t e a f t e r lin e 4 8 ▼L in e 4 9 -5 2 ; L in e 2 2 m o v e a x , D W O R D P T R _de s t $[e b p ] a d d e a x , 1 m o v D W O R D P T R _de s t $[e b p ], e a x L in e 2 2 o f t h e C / C ++ c o d e is : d e s t ++; In t h is A S M s e c t io n , t h e p o in t e r t o t h e d e s t a r r a y is a ga in m o v e d t o t h e E A X r e gis t e r s o t h a t it c a n b e in c r e m e n t e d t o 1 b y t h e A D D in s t r u c t io n . T h is in c r e m e n t e d p o in t e r v a lu e t o t h e d e s t a r r a y is m o v e d b a c k o n t h e s t a c k a t t h e lo c a t io n . T h e s t a c k s t a t e a f t e r t h e s e in s t r u c t io n s w ill b e a s fo llo w s : t o d e s t    [E S P +0 x 0 4 ] E B P o f ma in ( ) s t a c k fr a me [E S P +0 x 0 8 ] r e t u r n t o ma in ( ) [E S P +0 x 0 C ] d e s t a r r a y in c r e me n t e d [E S P +0 x 1 0 ] F ir s t a r g t o x s t r c p y [E S P +0 x 1 4 ] “ e v e R ” is p u s h e d h e r e [E S P +0 x 1 8 ] “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 C ] “ ggn ” is p u s h e d h e r e [E S P +0 x 2 0 ] o n ly “ R ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 4 ] JUN K H E R E [E S P +0 x 2 8 ] JUN K H E R E [E S P +0 x 2 C ] JUN K H E R E [E S P +0 x 3 0 ] JUN K H E R E [E S P +0 x 3 4 ] JUN K H E R E [E S P +0 x 3 8 ] JUN K H E R E [E S P +0 x 3 C ] X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 4 0 ] o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 4 4 ] r e t u r n t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .1 4 : D e s t a r r a y in c r e m e n t e d ▼L in e 5 3 -5 6 ; L in e 2 3 m o v e c x , D W O R D P T R _s r c $[e b p ] a d d e c x , 1 m o v D W O R D P T R _s r c $[e b p ], e c x L in e 2 3 o f t h e C / C ++ c o d e is : s r c ++; In t h is A S M s e c t io n , t h e s a m e s t e p s a s t h e p r e c e d in g o n e s a r e d o n e w it h t h e s r c a r r a y. T h e s r c a r r a y is m o v e d t o t h e E C X r e gis t e r s o t h a t it c a n b e in c r e m e n t e d t o 1 b y t h e A D D in s t r u c t io n . T h is in c r e m e n t e d p o in t e r v a lu e t o t h e s r c a r r a y is m o v e d b a c k o n t h e s t a c k a t t h e lo c a t io n . T h e s t a c k s t a t e a f t e r t h e s e in s t r u c t io n s w ill b e a s fo llo w s : t o d e s t a r r a y [E S P +0 x 0 4 ] E B P o f ma in ( ) s t a c k fr a me [E S P +0 x 0 8 ] r e t u r n t o ma in ( ) [E S P +0 x 0 C ] d e s t a r r a y in c r e me n t e d [E S P +0 x 1 0 ] s r c a r r a y in c r e me n t e d [E S P +0 x 1 4 ] “ e v e R ” is p u s h e d h e r e [E S P +0 x 1 8 ] “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 C ] “ ggn ” is p u s h e d h e r e [E S P +0 x 2 0 ] o n ly “ R ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 4 ] JUN K H E R E [E S P +0 x 2 8 ] JUN K H E R E [E S P +0 x 2 C ] JUN K H E R E [E S P +0 x 3 0 ] JUN K H E R E [E S P +0 x 3 4 ] JUN K H E R E [E S P +0 x 3 8 ] JUN K H E R E [E S P +0 x 3 C ] X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 4 0 ] o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 4 4 ] r e t u r n t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .1 5 : S r c a r r a y in c r e m e n t e d ▼L in e 5 7 -5 8 ; L in e 2 4 jm p S H O R T $L N 2 @x s t r c p y L in e 2 4 o f t h e C / C ++ c o d e is : } // w h ile lo o p c lo s in g T h is A S M in s t r u c t io n w ill p e r fo r m a n u n c o n d it io n a l ju m p t o t h e la b e l T h is u n c o n d it io n a l ju m p w ill c o p y t h e r e m a in in g b y t e s fr o m t h e s r c a r r a y ( s t o r e d a t t o t h e d e s t a r r a y ( s t o r e d a t N o w w e w ill c o n s id e r t h e it e r a t io n w h e r e a ll t h e b y t e s o f t h e s r c a r r a y a r e c o p ie d t o t h e d e s t a r r a y. T h e s t a c k s t a t e a f t e r c o p y in g a ll t h e b y t e s w ill b e a s fo llo w s : t o d e s t a r r a y    [E S P +0 x 0 4 ] E B P o f ma in ( ) s t a c k fr a me [E S P +0 x 0 8 ] r e t u r n t o ma in ( ) [E S P +0 x 0 C ] a r r a y in c r e me n t e d [E S P +0 x 1 0 ] a r r a y in c r e me n t e d [E S P +0 x 1 4 ] “ e v e R ” is p u s h e d h e r e [E S P +0 x 1 8 ] “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 C ] “ ggn ” is p u s h e d h e r e [E S P +0 x 2 0 ] “ e v e R ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 4 ] “ E e s r ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 8 ] 0 0 1 2 F F 2 8 “ ggn ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 C ] JUN K H E R E [E S P +0 x 3 0 ] JUN K H E R E [E S P +0 x 3 4 ] JUN K H E R E [E S P +0 x 3 8 ] JUN K H E R E [E S P +0 x 3 C ] X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 4 0 ] o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 4 4 ] t o 0 x 0 0 4 0 1 2 A 8 fr o m 0 x 0 0 4 0 1 0 5 0 F ig u r e 1 4 .1 6: S r c a r r a y a r e c o p ie d t o d e s t a r r a y N o w , w e w ill t a k e t h e it e r a t io n ( w h e r e a n u n c o n d it io n a l ju m p t o t h e la b e l $L N 2 @x s t r c p y w a s a f t e r a ll t h e b y t e s a r e c o p ie d fr o m t h e s r c a r r a y t o t h e d e s t a r r a y. ▼L in e 3 8 -4 3 $L N 2 @x s t r c p y : ; L in e 1 9 m o v e c x , D W O R D P T R _s r c $[e b p ] m o v s x e d x , B YTE P T R [e c x ] t e s t e d x , e d x je S H O R T $L N 1 @x s t r c p y L in e 1 9 o f t h e C / C ++ c o d e is : w h ile ( *s r c != '\\ 0 ') In t h e A S M c o d e , t h e M O V in s t r u c t io n is m o v in g t h e p o in t e r fr o m t h e s r c a r r a y b y t e ( 0 x 0 0 1 2 F F 1 F a t t o t h e E C X r e gis t e r. T h e n e x t M O V in s t r u c t io n m o v e s b y t e s t o r e d a t 0 x 0 0 1 2 F F 1 F t o m a k in g T h e T E S T in s t r u c t io n w ill p e r fo r m a n A N D o p e r a t io n o f E D X w it h it s e lf, r e s u lt in g in a z e r o v a lu e in E D X a n d Z F =1 . S o , a ju m p t o t h e la b e l $L N 1 @x s t r c p y w ill t a k e p la c e . T h e s t a c k s t a t e w ill b e t h e s a m e a s e a r lie r : F ig u r e 1 4 .1 7 : E D X is 0 x 0 0 ▼L in e 5 9 -6 2 $L N 1 @x s t r c p y : ; L in e 2 7 m o v e d x , D W O R D P T R _de s t $[e b p ] m o v B YTE P T R [e d x ], 0 L in e 2 7 o f t h e C / C ++ c o d e is : *de s t = '\\ 0 '; In A S M c o d e is p u s h in g p o in t e r t o d e s t a r r a y ( 0 x 0 0 1 2 F F 2 B a t t o E D X r e gis t e r, w h e r e it is ﬁ lle d w it h t h e n u ll c h a r a c t e r b y t e . T h e s t a c k s t a t e w ill b e t h e s a m e a s e a r lie r : ▼L in e 6 3 -6 9 ; L in e 3 0 m o v e a x , D W O R D P T R _p t r $[e b p ] $L N 4 @x s t r c p y : ; L in e 3 1 m o v e s p , e b p p o p e b p r e t 0 L in e 3 0 o f t h e C / C ++ c o d e is : r e t u r n p t r ; In t h e A S M c o d e , t h e p o in t e r t o t h e d e s t a r r a y s t o r e d a t is p u s h e d t o t h e E A X r e gis t e r, a s t h e fu n c t io n r e t u r n v a lu e w ill b e s t o r e d in t h e E A X r e gis t e r. O n c e t h is v a lu e is m o v e d t o t h e x s t r c p y fu n c t io n e p ilo gu e is c a lle d w it h t h e R E T in s t r u c t io n . T h e R E T in s t r u c t io n w ill m o v e t h e in s t r u c t io n p o in t e r b a c k t o t h e ma in fu n c t io n . T h e s t a c k s t a t e b e fo r e t h e R E T in s t r u c t io n is a s fo llo w s : [E S P -0 x 0 8 ] 0 0 1 2 F F 0 0   0 0 1 2 F F 2 0    N o w JUN K    [E S P -0 x 0 4 ] 0 0 1 2 F F 0 4   0 0 1 2 F F 4 0    N o w JUN K    [E S P ]  0 0 1 2 F F 0 8   0 0 4 0 1 0 8 7     r e t u r n a d d r e s s t o ma in ( ) [E S P +0 x 0 4 ] 0 0 1 2 F F 0 C   0 0 1 2 F F 2 B    P o in t e r t o d e s t a r r a y in c r e me n t e d [E S P +0 x 0 8 ] 0 0 1 2 F F 1 0   0 0 1 2 F F 1 F    P o in t e r t o s r c a r r a y in c r e me n t e d [E S P +0 x 0 C ] 0 0 1 2 F F 1 4   6 5 7 6 6 5 5 2    “ e v e R ” is p u s h e d h e r e [E S P +0 x 1 0 ] 0 0 1 2 F F 1 8   4 5 6 5 7 3 7 2    “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 4 ] 0 0 1 2 F F 1 C   0 0 6 7 6 7 6 E    “ ggn ” is p u s h e d h e r e [E S P +0 x 1 8 ] 0 0 1 2 F F 2 0   6 5 7 6 6 5 5 2    “ e v e R ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 1 C ] 0 0 1 2 F F 2 4   4 5 6 5 7 3 7 2    “ E e s r ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 0 ] 0 0 1 2 F F 2 8   0 0 6 7 6 7 6 E    “ ggn ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 4 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 B 0    JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B    JUN K H E R E [E S P +0 x 2 C ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8    JUN K H E R E [E S P +0 x 3 0 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E    JUN K H E R E [E S P +0 x 3 4 ] 0 0 1 2 F F 3 C    A C C A 6 6 5 7    X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 3 8 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8    o f e a r lie r s t a c k fr a me [E S P +0 x 3 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 8    r e t u r n t o 0 x 0 0 4 0 1 2 A 8 F ig u r e 1 4 .1 8: S t a c k s t a t e b e fo r e R E T ▼L in e 1 0 3 -1 0 7 a d d e s p , 8 p u s h e a x p u s h O F F S E T $S G 4 6 9 0 c a ll _p r in t f a d d e s p , 8 L in e 3 0 o f t h e C / C ++ c o d e is : p r in t f( \" %s \\ n \", x s t r c p y ( d e s t , s r c ) ) ; O n r e t u r n , t h e A D D in s t r u c t io n w ill c le a n u p t h e s t a c k b y 8 b y t e s . T h e p r in t f fu n c t io n is c a lle d b y p u s h in g t h e r e t u r n v a lu e o f x s t r c p y o n t o t h e s t a c k a n d t h e s t r in g c o n s t a n t $S G 4 6 9 0 ( w h ic h is $S G 4 6 9 0 D B '%s ', 0 a H , t o c a ll t h e p r in t f fu n c t io n . T h is w ill p r in t t h e c o p ie d s t r in g o n t h e s c r e e n . T h e A D D in s t r u c t io n a f t e r p r in t f is c a lle d t o c le a n u p t h e s t a c k b y 8 b y t e s . T h e s t a c k s t a t e b e fo r e t h e A D D in s t r u c t io n is a s fo llo w s : \" %s \\ n \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 4 ] \" R e v e r s e E n gg \", a r gu me n t t o p r in t f( ) [E S P +0 x 0 8 ] “ e v e R ” is p u s h e d h e r e [E S P +0 x 0 C ] “ E e s r ” is p u s h e d h e r e [E S P +0 x 1 0 ] “ ggn ” is p u s h e d h e r e [E S P +0 x 1 4 ] “ e v e R ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 1 8 ] “ E e s r ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 1 C ] “ ggn ” is c o p ie d h e r e a t d e s t a r r a y [E S P +0 x 2 0 ] JUN K H E R E [E S P +0 x 2 4 ] JUN K H E R E [E S P +0 x 2 8 ] JUN K H E R E [E S P +0 x 2 C ] JUN K H E R E [E S P +0 x 3 0 ] X O R o f s t a c k c o o k ie a n d E B P [E S P +0 x 3 4 ] o f e a r lie r s t a c k fr a me s t o r e d h e r e [E S P +0 x 3 8 ] r e t u r n t o 0 x 0 0 4 0 1 2 A 8 F ig u r e 1 4 .1 9: S t a c k s t a t e b e fo r e A D D in s t r u c t io n ▼L in e 1 0 8 -1 1 9 ; L in e 4 1 x o r e a x , e a x ; L in e 4 2 m o v e c x , D W O R D P T R __$A r r a y P a d $[e b p ] x o r e c x , e b p c a ll @__s e c u r it y _c h e c k _c o o k ie @4 m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D L in e 3 0 o f t h e C / C ++ c o d e is : r e t u r n 0 ; } In t h e A S M c o d e , E A X is c le a r e d b y X O R a n d t h e n t h e s t a c k c o o k ie is c h e c k e d fo r a n y b u ﬀ e r o v e r ﬂ o w a t t a c k b y c a llin g t h e s e c u r it y _c h e c k _c o o k ie p r o c e d u r e . O n r e t u r n , t h e ma in fu n c t io n e p ilo gu e is c a lle d t o r e t u r n 0 a n d e n d t h e ma in fu n c t io n , T E X T s e gm e n t , a n d c o d e . T h e s t a c k s t a t e b e fo r e t h e R E T in s t r u c t io n is a s fo llo w s : [E S P -0 x 0 C ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E    N o w JUN K H E R E [E S P -0 x 0 8 ] 0 0 1 2 F F 3 C    A C C A 6 6 5 7    N o w JUN K H E R E [E S P -0 x 0 4 ] 0 0 1 2 F F 4 0   0 0 1 2 F F 8 8    N o w JUN K H E R E [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 A 8     r e t u r n t o s t r c p y.0 0 4 0 1 2 A 8 fr o m s t r c p y.0 0 4 0 1 0 5 0 F ig u r e 1 4 .2 0 : S t a c k s t a t e b e fo r e R E T in s t r u c t io n S t r c p y w it h O p t imiz a t io n C o m p ile t h e c o d e w it h t h e o p t im iz a t io n ﬂ a g, / O x ﬂ a g. R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : E n a b le m a x im u m o p t im iz a t io n N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 4 .2 1 : S t r c p y w it h O p t im iz a t io n T h e c o m p ila t io n ge n e r a t e s t h e E X E ﬁ le a n d t h e a s s e m b ly c o d e . W e w ill a ga in m a n u a lly d is a b le A S L R . To d is a b le A S L R , u s e t h e C F F e x p lo r e r a n d c h a n ge t h e D llC h a r a c t e r is t ic s p a r a m e t e r t o u n c h e c k D L L c a n N o w , le t ’s m o v e o n t o t h e ge n e r a t e d a s s e m b ly lis t in g: F ig u r e 1 4 .2 2 : s t r c p y -O p t im iz e d .a s m -P a r t -1 F ig u r e 1 4 .2 3 : s t r c p y -O p t im iz e d .a s m -P a r t -2 F ig u r e 1 4 .2 4 : s t r c p y -O p t im iz e d .a s m -P a r t -3 L e t ’s d ir e c t ly ju m p t o t h e s t a r t o f t h e T E X T s e gm e n t o f t h e _ma in fu n c t io n . ▼L in e 6 3 -6 7 _TEX T S E G M E N T _s r c $ = -4 4       ; s iz e = 1 2 _de s t $ = -3 2       ; s iz e = 2 5 __$A r r a y P a d $ = -4      ; s iz e = 4 _m a in P R O C T h e lo c a l v a r ia b le o n t h e s t a c k fr a m e c a n b e a c c e s s e d b y a d d in g _ $ t o t h e E B P a d d r e s s . ▼L in e 6 7 _m a in P R O C S t a r t o f t h e ma in p r o c e d u r e . ▼L in e 6 8 -7 2 ; L in e 3 5 s u b e s p , 4 4      ; 0 0 0 0 0 0 2 c H m o v e a x , D W O R D P T R ___s e c u r it y _c o o k ie x o r e a x , e s p m o v D W O R D P T R __$A r r a y P a d $[e s p +4 4 ], e a x L in e 3 5 o f t h e C / C ++ c o d e s t a r t s t h e ma in fu n c t io n . in t m a in ( ) { T h is A S M c o d e is o p t im iz e d a n d s t a r t s b y s u b t r a c t in g E S P b y 4 4 ( 0 x 2 C ) b y t e s t o c r e a t e r o o m fo r t h e lo c a l v a r ia b le s . 4 4 b y t e s c a n b e v is u a liz e d a s 4 b y t e s fo r s e c u r it y _c o o k ie p lu s 1 2 b y t e s fo r t h e s r c a r r a y, a n d 2 8 b y t e s fo r t h e d e s t a r r a y. T h e s iz e s o f s r c a n d d e s t a r r a y s h a v e b e e n r o u n d o ﬀ t o a m u lt ip le o f 4 b y t e s . T h e n e x t M O V in s t r u c t io n m o v e s t h e s t a c k c o o k ie fr o m t h e E A X r e gis t e r t o X O R w it h E S P a n d s t o r e s t h e r e s u lt a n t o n t h e s t a c k . In a n o n -o p t im iz e d c o d e , t h is X O R p r o c e d u r e h a p p e n s w it h E B P. L e t ’s s e e t h e s t a c k s t a t e a f t e r m o v in g t h e s t a c k c o o k ie o n t h e s t a c k : [E S P ]  0 0 1 2 F F 1 8   0 0 1 2 F F 7 8   JUN K H E R E [E S P +0 x 0 4 ] 0 0 1 2 F F 1 C   0 0 4 0 2 4 F 0   JUN K H E R E [E S P +0 x 0 8 ] 0 0 1 2 F F 2 0   8 E 5 0 C A 6 1   JUN K H E R E [E S P +0 x 0 C ] 0 0 1 2 F F 2 4   F F F F F F F E   JUN K H E R E [E S P +0 x 1 0 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 9 C   JUN K H E R E [E S P +0 x 1 4 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 B 0   JUN K H E R E [E S P +0 x 1 8 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 1 C ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K H E R E [E S P +0 x 2 0 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E   JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 4 0   8 E 0 2 A E A 1   X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 0   ES P a t t h e s t a r t o f ma in p r o c e d u r e F ig u r e 1 4 .2 5 : S t a c k c o o k ie o n t h e s t a c k ▼L in e 7 3 -7 9 ; L in e 3 6 m o v e a x , D W O R D P T R $S G 4 6 8 8 m o v e d x , D W O R D P T R $S G 4 6 8 8 +8 m o v e c x , D W O R D P T R $S G 4 6 8 8 +4 m o v D W O R D P T R _s r c $[e s p +4 4 ], e a x p u s h e s i m o v D W O R D P T R _s r c $[e s p +5 6 ], e d x L in e 3 6 o f t h e C / C ++ c o d e s t a r t s t h e s r c a r r a y in it ia liz a t io n : c h a r s r c [] = \" R e v e r s e E n gg\" ; In t h e A S M c o d e , w e s e e t h r e e M O V in s t r u c t io n s t o m o v e t h e s t r in g $S G 4 6 8 8 in t h r e e p a r t s ( 4 b y t e s + 4 b y t e s + 4 b y t e s ) t o d iﬀ e r e n t r e gis t e r s . T h e ﬁ r s t M O V in s t r u c t io n m o v e s t h e ﬁ r s t 4 b y t e s o f t h e s t r in g ( “ R e v e ” ) t o a n o t h e r 4 b y t e s o f t h e s t r in g ( “ n gg” + “ 0 x 0 0 ” ) a r e m o v e d t o a n d t h e n t h e r e m a in in g b y t e s ( “ r s e E ” ) a r e m o v e d t o t h e E C X r e gis t e r. In t h e n e x t M O V in s t r u c t io n , t h e ﬁ r s t p a r t o f t h e s t r in g $S G 4 6 8 8 is m o v e d t o t h e t o p o f t h e s t a c k . T h e P US H in s t r u c t io n s t o r e s t h e E S I v a lu e o n t h e s t a c k , s o t h a t it c a n b e r e s t o r e d la t e r. T h e la s t M O V in s t r u c t io n m o v e s t h e t h ir d p a r t o f t h e s t r in g $S G 4 6 8 8 s t o r e d in E D X t o t h e s t a c k a t [E S P +0 x 0 C ]. T h e s t a c k s t a t e a f t e r t h e e x e c u t io n o f t h e p r e c e d in g in s t r u c t io n in x 3 2 d b g w ill b e : [E S P ]  0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0     E S I is s a v e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F F 1 8   6 5 7 6 6 5 5 2   “ e v e R ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 8 ] 0 0 1 2 F F 1 C   0 0 4 0 2 4 F 0   “ E e s r ” w ill b e p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 C ] 0 0 1 2 F F 2 0   0 0 6 7 6 7 6 E   “ ggn ” is p u s h e d h e r e , lit t le e n d ia n [E S P +0 x 1 0 ] 0 0 1 2 F F 2 4   F F F F F F F E   JUN K H E R E [E S P +0 x 1 4 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 9 C   JUN K H E R E [E S P +0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 B 0   JUN K H E R E [E S P +0 x 1 C ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 2 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E   JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 2 C ] 0 0 1 2 F F 4 0   8 E 0 2 A E A 1   X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 3 0 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 0   ES P a t t h e s t a r t o f ma in p r o c e d u r e F ig u r e 1 4 .2 6: S t r in g $S G 4 688 o n s t a c k ▼L in e 8 0 -8 8 ; L in e 3 9 le a e a x , D W O R D P T R _de s t $[e s p +4 8 ] m o v e s i, e a x le a e d x , D W O R D P T R _s r c $[e s p +4 8 ] m o v D W O R D P T R _s r c $[e s p +5 2 ], e c x s u b e d x , e s i m o v c l, 8 2      ; 0 0 0 0 0 0 5 2 H p o p e s i n p a d 6 L in e 3 9 o f t h e C / C ++ c o d e s t a r t s t h e p r in t f fu n c t io n . p r in t f( \" %s \\ n \", x s t r c p y ( d e s t , s r c ) ) ; In t h e A S M s e c t io n , t h e L o a d E ﬀ e c t iv e A d d r e s s in s t r u c t io n lo a d s t h e a d d r e s s [E S P +0 x 1 0 ] fo r m t h e d e s t a r r a y t o t h e E A X r e gis t e r. T h is a llo c a t e s s p a c e fo r t h e d e s t a r r a y o n t h e s t a c k . E A X is t h e n m o v e d t o t h e E S I r e gis t e r u s in g t h e M O V in s t r u c t io n . T h is is t o s t o r e t h e a d d r e s s o f t h e d e s t a r r a y in t h e E S I r e gis t e r a n d a t t h is a d d r e s s is w h e r e t h e s r c a r r a y w ill b e c o p ie d . E S I w ill b e c o m e T h e n e x t L E A in s t r u c t io n d o e s t h e s a m e fo r t h e s r c a r r a y. It lo a d s t h e a d d r e s s o f t h e s r c a r r a y [E S P +0 x 0 4 ] t o t h e E D X r e gis t e r. E D X w ill b e c o m e T h e M O V in s t r u c t io n m o v e s t h e s e c o n d p a r t o f t h e s t r in g $S G 4 6 8 8 s t o r e d in E C X t o t h e s t a c k a t [E S P +0 x 0 8 ]. T h e S UB in s t r u c t io n w ill c a lc u la t e t h e o ﬀ s e t b e t w e e n t h e d e s t a r r a y a n d t h e s r c a r r a y b y s u b t r a c t in g E D X fr o m T h e r e s u lt a n t o ﬀ s e t w ill b e s a v e d in E D X fo r la t e r c a lc u la t io n s . E S I=0 x 0 0 1 2 F F 2 4 S UB = E D X -E S I = 0 x F F F F F F F 4 T h e C L r e gis t e r is lo a d e d w it h t h e ﬁ r s t b y t e 5 2 ( “ R ” ) o f t h e s r c a r r a y u s in g t h e M O V in s t r u c t io n . Us in g P O P E S I is r e s t o r e d b a c k t o t h e o ld v a lu e . N e x t is t h e n p a d m a c r o , w h ic h in s e r t s t h e n o n -d e s t r u c t iv e , n o n - o p e r a t io n a l in s t r u c t io n s . F o r in fo r m a t io n o n p le a s e r e fe r t o t h e A p p e n d ix s e c t io n . O u r a s s e m b ly lis t in g u s e s t h e n p a d w h ic h is d e ﬁ n e d in L IS T IN G .IN C a s le a e b x , [e b x +0 0 0 0 0 0 0 0 ]. T h e s t a c k s t a t e a f t e r t h e n p a d m a c r o is a s fo llo w s : [E S P -0 x 0 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   JUN K H E R E [E S P ]  0 0 1 2 F F 1 8   6 5 7 6 6 5 5 2    “ e v e R ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 4 ] 0 0 1 2 F F 1 C   4 5 6 5 7 3 7 2   “ E e s r ” w ill b e p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 8 ] 0 0 1 2 F F 2 0   0 0 6 7 6 7 6 E   “ ggn ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 C ] 0 0 1 2 F F 2 4   F F F F F F F E   S p a c e fo r d e s t a r r a y [E S P +0 x 1 0 ] 0 0 1 2 F F 2 8   0 0 4 0 5 4 9 C   JUN K H E R E [E S P +0 x 1 4 ] 0 0 1 2 F F 2 C   0 0 4 0 5 4 B 0   JUN K H E R E [E S P +0 x 1 8 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 1 C ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K H E R E [E S P +0 x 2 0 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E   JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 4 0   8 E 0 2 A E A 1   X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 0   ES P a t t h e s t a r t o f ma in p r o c e d u r e F ig u r e 1 4 .2 7 : S t a c k s t a t e a f t e r n p a d ▼L in e 8 9 -9 4 $L L 4 @m a in : m o v B YTE P T R [e a x ], c l m o v c l, B YTE P T R [e d x +e a x +1 ] in c e a x t e s t c l, c l jn e S H O R T $L L 4 @m a in T h is p ie c e o f A S M c o d e is w h e r e t h e s r c a r r a y is c o p ie d t o t h e d e s t a r r a y m e m o r y lo c a t io n b y t e -b y -b y t e . T h e ﬁ r s t M O V in s t r u c t io n c o p ie s t h e “ R ” ( ﬁ r s t c h a r o r b y t e ) in t h e s r c a r r a y t o t h e s t a r t o f t h e d e s t a r r a y m e m o r y lo c a t io n , T h e s t a c k w it h t h e s r c a n d d e s t a r r a y c a n b e v is u a liz e d a s fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : Ta b le 1 4 .1 : S t a c k w it h s r c a n d d e s t a r r a y - P a r t -1 O n c e t h e ﬁ r s t b y t e is c o p ie d fr o m t h e s r c a r r a y t o t h e d e s t a r r a y, t h e C L r e gis t e r is ﬁ lle d w it h t h e n e x t b y t e o f t h e s r c a r r a y u s in g t h e s e c o n d M O V in s t r u c t io n w it h c a lc u la t io n s e x p la in e d a s fo llo w s : m o v c l, B YTE P T R [e d x +e a x +1 ] E D X = 0 X F F F F F F F 4 E A X = 0 x 0 0 1 2 F F 2 4 ( t h is is t h e m e m o r y a d d r e s s o f t h e s t a r t o f d e s t a r r a y ) E D X +EA X +1 =   0 x 0 0 1 2 F F 1 9 N o w , t h e b y t e w ill b e c o p ie d fr o m 0 x 0 0 1 2 F F 1 9 ( w h ic h is “ e ” o r 0 x 6 5 ) t o t h e C L r e gis t e r. A s t h e b y t e c o p ie d t o t h e C L r e gis t e r n e e d s t o b e m o v e d t o t h e n e x t m e m o r y lo c a t io n , E A X is in c r e m e n t e d b y 1 u s in g t h e IN C in s t r u c t io n . E A X w ill b e c o m e T h e T E S T in s t r u c t io n p e r fo r m s t h e A N D o f C L w it h it s e lf, r e s u lt in g in a n o n -z e r o o u t p u t in C L a n d Z F =0 . S o , a ju m p t o t h e la b e l $L L 4 @ma in w ill t a k e p la c e . T h e n e x t it e r a t io n o f t h is s a m e A S M c o d e r e s u lt s in c o p y in g t h e n e x t b y t e t o t h e d e s t a r r a y. T h e s t a c k s t a t e w ill b e c o m e a s fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : Ta b le 1 4 .2 : S t a c k w it h s r c a n d d e s t a r r a y - P a r t -2 N o w , im a gin e t h e it e r a t io n w h e r e w e r e a c h t h e fo llo w in g s t a c k s t a t e w h e r e w e c o p y a ll b y t e s fr o m t h e s r c a r r a y t o t h e d e s t a r r a y t ill 0 x 6 7 o r “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. “ g”. Ta b le 1 4 .3 : S t a c k w it h s r c a n d d e s t a r r a y - P a r t -3 In t h is it e r a t io n , 0 x 6 7 o r “ g” is c o p ie d a t t h e 0 x 0 0 1 2 F F 2 E m e m o r y lo c a t io n w it h t h e ﬁ r s t M O V in s t r u c t io n . A t t h is p o in t : E A X =0 x 0 0 1 2 F F 2 E E D X =0 x F F F F F F F 4 S o , t h e s e c o n d M O V in s t r u c t io n w ill b e e v a lu a t e d t o : m o v c l, b y t e p t r d s :[e d x +e a x *1 +0 x 1 ] m o v c l, b y t e p t r d s :[0 x 0 0 1 2 F F 2 3 ] T h is w ill c o p y 0 x 0 0 t o t h e C L r e gis t e r. T h e n e x t IN C in s t r u c t io n w ill in c r e m e n t E A X t o T h e T E S T in s t r u c t io n t h is t im e w ill s e t Z F =1 a s C L =0 x 0 0 , s t o p p in g t h e ju m p in s t r u c t io n a n d b r e a k in g t h e lo o p t o m o v e o n t o t h e n e x t in s t r u c t io n . T h e s t a c k s t a t e a f t e r t h is p a r t o f t h e A S M c o d e w ill b e : [E S P -0 x 0 4 ] 0 0 1 2 F F 1 4   0 0 0 0 0 0 0 0   JUN K H E R E [E S P ]  0 0 1 2 F F 1 8   6 5 7 6 6 5 5 2    “ e v e R ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 4 ] 0 0 1 2 F F 1 C   4 5 6 5 7 3 7 2   “ E e s r ” w ill b e p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 8 ] 0 0 1 2 F F 2 0   0 0 6 7 6 7 6 E   “ ggn ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 C ] 0 0 1 2 F F 2 4   6 5 7 6 6 5 5 2   “ e v e R ” is p u s h e d h e r e in d e s t a r r a y [E S P +0 x 1 0 ] 0 0 1 2 F F 2 8   4 5 6 5 7 3 7 2   “ E e s r ” w ill b e p u s h e d h e r e in d e s t a r r a y [E S P +0 x 1 4 ] 0 0 1 2 F F 2 C   0 0 6 7 6 7 6 E   “ ggn ” is p u s h e d h e r e in d e s t a r r a y [E S P +0 x 1 8 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 1 C ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K H E R E [E S P +0 x 2 0 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E   JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 4 0   8 E 0 2 A E A 1   X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 2 C ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 0   ES P a t t h e s t a r t o f ma in p r o c e d u r e F ig u r e 1 4 .2 8: S t a c k w it h s r c a n d d e s t a r r a y A s w e s a w in t h e p r e c e d in g in s t r u c t io n s , t h e d e s t a r r a y is n o t N UL L t e r m in a t e d a s w e m o v e o u t o f t h e lo o p b e fo r e N UL L is c o p ie d t o T h e a n s w e r lie s in t h e n e x t in s t r u c t io n . L e t ’s m o v e o n t o t h e n e x t in s t r u c t io n s : ▼L in e 9 5 -9 9 m o v B YTE P T R [e a x ], c l le a e a x , D W O R D P T R _de s t $[e s p +4 4 ] p u s h e a x p u s h O F F S E T $S G 4 6 9 0 c a ll _p r in t f In t h e ﬁ r s t p r e c e d in g M O V in s t r u c t io n , t h e A S M c o d e m o v e s 0 x 0 0 b y t e fr o m t h e C L r e gis t e r t o T h is w ill N UL L t e r m in a t e t h e d e s t a r r a y s h o w n a s fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : Ta b le 1 4 .4 : S t a c k w it h t h e s r c a n d d e s t a r r a y - P a r t -4 N o w , w e h a v e a p o in t e r t o t h e s r c a r r a y a n d a p o in t e r t o t h e d e s t a r r a y o n t h e s t a c k . N e x t , w e h a v e t o c a ll t h e p r in t f fu n c t io n fo r w h ic h t h e a r gu m e n t s t o p r in t f n e e d t o b e p u s h e d o n t o t h e s t a c k . T h e L E A in s t r u c t io n m o v e s t h e p o in t e r fr o m t h e d e s t a r r a y t o T h e P US H in s t r u c t io n p u s h e s t h e ﬁ r s t a r gu m e n t o n t o t h e s t a c k b y P US H T h e s e c o n d P US H in s t r u c t io n p u s h e s t h e s t r in g c o n s t a n t o n t o t h e s t a c k , w h ic h is t h e s e c o n d a r gu m e n t t o O n c e b o t h a r gu m e n t s a r e p u s h e d , a c a ll t o p r in t f is m a d e . T h e s t a c k s t a t e b e fo r e t h e e x e c u t io n o f t h e C A L L in s t r u c t io n is a s fo llo w s : [E S P ]  0 0 1 2 F F 1 0   0 0 4 0 8 1 4 C    \" %s \\ n \", s e c o n d a r gu me n t t o p r in t f is p u s h e d h e r e [E S P +0 x 0 4 ] 0 0 1 2 F F 1 4   0 0 1 2 F F 2 4   \" R e v e r s e E n g g \", s e c o n d a r gu me n t t o p r in t f( ) is p u s h e d [E S P +0 x 0 8 ] 0 0 1 2 F F 1 8   6 5 7 6 6 5 5 2   “ e v e R ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 0 C ] 0 0 1 2 F F 1 C   4 5 6 5 7 3 7 2   “ E e s r ” w ill b e p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 1 0 ] 0 0 1 2 F F 2 0   0 0 6 7 6 7 6 E   “ ggn ” is p u s h e d h e r e , in lit t le e n d ia n [E S P +0 x 1 4 ] 0 0 1 2 F F 2 4   6 5 7 6 6 5 5 2   “ e v e R ” is p u s h e d h e r e in d e s t a r r a y 0 0 1 2 F F 2 8   4 5 6 5 7 3 7 2   “ E e s r ” w ill b e p u s h e d h e r e in d e s t a r r a y [E S P +0 x 1 C ] 0 0 1 2 F F 2 C   0 0 6 7 6 7 6 E   “ ggn ” is p u s h e d h e r e in d e s t a r r a y [E S P +0 x 2 0 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 2 4 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   JUN K H E R E [E S P +0 x 2 8 ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E   JUN K H E R E [E S P +0 x 2 C ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 4 B   JUN K H E R E [E S P +0 x 3 0 ] 0 0 1 2 F F 4 0   8 E 0 2 A E A 1   X O R o f s t a c k c o o k ie a n d E B P s t o r e d h e r e [E S P +0 x 3 4 ] 0 0 1 2 F F 4 4   0 0 4 0 1 2 A 0   ES P a t t h e s t a r t o f ma in p r o c e d u r e F ig u r e 1 4 .2 9: S t a c k b e fo r e C A L L in s t r u c t io n ▼L in e 1 0 0 -1 1 0 ; L in e 4 2 m o v e c x , D W O R D P T R __$A r r a y P a d $[e s p +5 2 ] a d d e s p , 8 x o r e c x , e s p x o r e a x , e a x c a ll @__s e c u r it y _c h e c k _c o o k ie @4 a d d e s p , 4 4      ; 0 0 0 0 0 0 2 c H r e t 0 _m a in E N D P _TEX T E N D S E N D In t h e p r e c e d in g A S M c o d e , t h e M O V in s t r u c t io n m o v e s t h e s t a c k c o o k ie s t o r e d a t [E S P +0 x 3 0 ] t o w h e r e it is X O R ’e d w it h E C X t o c h e c k t h e b u ﬀ e r o v e r ﬂ o w c o n d it io n b y c a llin g t h e s e c u r it y _c h e c k _c o o k ie p r o c e d u r e . T h e r e s t o f t h e A D D in s t r u c t io n s c le a n u p t h e s t a c k t o e n d t h e ma in p r o c e d u r e , T E X T s e gm e n t , a n d c o d e . T h e s t a c k s t a t e b e fo r e t h e R E T in s t r u c t io n is a s fo llo w s : [E S P -0 x 3 4 ] 0 0 1 2 F F 1 0   0 0 4 0 8 1 4 C   N o w JUN K H E R E [E S P -0 x 3 0 ] 0 0 1 2 F F 1 4   0 0 1 2 F F 2 4   N o w JUN K H E R E [E S P -0 x 2 C ] 0 0 1 2 F F 1 8   6 5 7 6 6 5 5 2   N o w JUN K H E R E [E S P -0 x 2 8 ] 0 0 1 2 F F 1 C   4 5 6 5 7 3 7 2   N o w JUN K H E R E [E S P -0 x 2 4 ] 0 0 1 2 F F 2 0   0 0 6 7 6 7 6 E   N o w JUN K H E R E [E S P -0 x 2 0 ] 0 0 1 2 F F 2 4   6 5 7 6 6 5 5 2   N o w JUN K H E R E [E S P -0 x 1 C ] 0 0 1 2 F F 2 8   4 5 6 5 7 3 7 2   N o w JUN K H E R E [E S P -0 x 1 8 ] 0 0 1 2 F F 2 C   0 0 6 7 6 7 6 E   N o w JUN K H E R E [E S P -0 x 1 4 ] 0 0 1 2 F F 3 0   0 0 4 0 3 4 4 B   N o w JUN K H E R E [E S P -0 x 1 0 ] 0 0 1 2 F F 3 4   0 0 1 2 F F 4 8   N o w JUN K H E R E [E S P -0 x 0 C ] 0 0 1 2 F F 3 8   0 0 4 0 2 8 C E   N o w JUN K H E R E [E S P -0 x 0 8 ] 0 0 1 2 F F 3 C   0 0 4 0 3 4 4 B   N o w JUN K H E R E [E S P -0 x 0 4 ] 0 0 1 2 F F 4 0   8 E 0 2 A E A 1   N o w JUN K H E R E [E S P ]  0 0 1 2 F F 4 4   0 0 4 0 1 2 A 0   ES P a t t h e s t a r t o f ma in p r o c e d u r e F ig u r e 1 4 .3 0 : S t a c k c le a n e d C o n c lu s io n In t h is c h a p t e r, w e c o v e r e d t h e s t r c p y fu n c t io n im p le m e n t a t io n b y c o p y in g d a t a fr o m o n e m e m o r y lo c a t io n t o a n o t h e r w it h r e s p e c t t o r e v e r s e e n gin e e r in g. W e a ls o le a r n e d a b o u t b y t e -b y -b y t e o p e r a t io n s t h a t h a p p e n d u r in g t h e s t r c p y e x e c u t io n . In t h e o p t im iz e d a s s e m b ly lis t in g, d u r in g t h e s t a c k c o o k ie o p e r a t io n , t h e X O R p r o c e d u r e h a p p e n s w it h E S P a n d in a n o n -o p t im iz e d a s s e m b ly lis t in g, it h a p p e n s w it h E B P. W e a ls o c o v e r e d t h e d iﬀ e r e n c e b e t w e e n o p t im iz e d a n d n o n -o p t im iz e d c o d e s o f s t r c p y p r o gr a m a s s e m b ly p a t t e r n . In t h e n e x t c h a p t e r, w e w ill t a lk a b o u t a n o t h e r r e a l-w o r ld e x a m p le , w h e r e in w e w ill w r it e a p r o gr a m t o c a lc u la t e s im p le in t e r e s t c o d e . C H A P T E R 1 5 S imp le In t e r e s t C o d e P a t t e r n in R e v e r s e E n gin e e r in g W e a ll d r e a m a b o u t b u y in g a b e a u t ifu l h o u s e a n d a n ic e c a r. N o w t o b u y a n y o f t h e s e , w e n e e d m o n e y w h ic h c a n e it h e r b e e a r n e d w it h o u r s k ills o r it c a n b e b o r r o w e d fr o m a b a n k . T h is is w h e r e t e r m s lik e in t e r e s t c o m e in t o p ic t u r e . Im a gin g a p e r s o n n a m e d A t u l N a r u la w h o w o r k s fo r In t e r n a t io n a l In s t it u t e o f C y b e r S e c u r it y a n d w a n t s t o b u y a c a r. N o w , A t u l h a s s a v in gs o f 1 0 ,0 0 0 d o lla r s a n d d e c id e s t o t a k e t h e r e m a in in g 1 0 ,0 0 0 d o lla r s fr o m a b a n k . A b a n k o ﬀ e r s h im a lo a n o n a n a n n u a l s im p le in t e r e s t r a t e o f 2 p e r c e n t fo r a t e r m o f 5 y e a r s . A t u l go e s t o t h e b a n k a n d a s k s t h e b a n k o ﬃ c ia l a b o u t t h e in t e r e s t t h a t h e h a s t o p a y o v e r t h e t e r m o f t h e lo a n . T h e b a n k o ﬃ c ia l u s e s a s o f t w a r e w h ic h u s e s a m a t h e m a t ic a l fo r m u la t o c a lc u la t e in t e r e s t . T h e m a t h e m a t ic a l fo r m u la t h a t go e s in s id e t h e s o f t w a r e w ill b e $1 0 ,0 0 0 t im e s 2 p e r c e n t t im e s 5 y e a r s , o r 1 0 ,0 0 0 x .0 2 x 5 . T h is is t h e in t e r e s t a m o u n t A t u l h a s t o p a y o v e r t h e e n t ir e t e r m o f t h e lo a n . N o w im a gin e , a s a r e v e r s e e n gin e e r, y o u h a v e t o e x t r a c t t h e m a t h e m a t ic a l fo r m u la o f t h is b a n k in g s o f t w a r e w it h o u t a n y a c c e s s t o t h e s o f t w a r e c o d e . In t h is c h a p t e r, w e w ill u s e t h is r e a l-life s o f t w a r e e x a m p le t o u n d e r s t a n d t h e a s s e m b ly p a t t e r n o f s u c h k in d s o f s o f t w a r e . T h is t y p e o f r e v e r s e e n gin e e r in g w ill h e lp y o u u n d e r s t a n d s o m e p a t t e r n s u s e d b y m a lw a r e w r it e r s . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : P r o gr a m t o c a lc u la t e s im p le in t e r e s t C a lc u la t e s im p le in t e r e s t w it h o u t O p t im iz a t io n O b je c t iv e In t h is c h a p t e r, w e w ill t a lk a b o u t a r e a l-life s o f t w a r e t h a t u s e s a n in t e r n a l m a t h e m a t ic a l fo r m u la t o c a lc u la t e s im p le in t e r e s t . W e w ill ﬁ n d o u t h o w a n in t e ge r a n d ﬂ o a t a r e t o ge t h e r h a n d le d in m e m o r y. R e v e r s e e n gin e e r in g a s o f t w a r e w it h m a t h e m a t ic a l c a lc u la t io n w ill h e lp u s u n d e r s t a n d t h e a s s e m b ly p a t t e r n o f t h e s o f t w a r e a lo n g w it h t h e m a t h e m a t ic a l c a lc u la t io n s . P r o gr a m t o C a lc u la t e S imp le In t e r e s t L e t ’s w r it e d o w n a C / C ++ p r o gr a m t o c a lc u la t e s im p le in t e r e s t fr o m a s e t o f v a lu e s r e p r e s e n t e d b y P r in c ip a l A m o u n t , In t e r e s t A m o u n t , a n d N u m b e r o f Ye a r s . F ig u r e 1 5 .1 : S im p le Int e r e s t C a lc u la t io n .c p p C a lc u la t e S imp le In t e r e s t Wit h o u t O p t imiz a t io n C o m p ile t h e c o d e w it h o u t o p t im iz a t io n in t h e M S V C c o m p ile r o n t h e s a m e x 8 6 Win d o w s m a c h in e . R u n t h e fo llo w in g c o m m a n d s o n t h e Win d o w s c o m m a n d p r o m p t t o s e t t h e e n v ir o n m e n t fo r c l.e x e ( V S c o m p ile r ) , a n d t h e n c o m p ile t h e c o d e w it h t h e fo llo w in g s w it c h e s : N a m e o f t h e o u t p u t a s s e m b ly lis t in g ﬁ le N a m e o f t h e o u t p u t e x e c u t a b le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le ﬁ le T h e fo llo w in g is t h e o u t p u t o f r u n n in g t h e p r e c e d in g c o m m a n d s : F ig u r e 1 5 .2 : S im p le Int e r e s t w it h o u t O p t im iz a t io n T h e ge n e r a t e d a s s e m b ly c o d e w ill b e a s fo llo w s : F ig u r e 1 5 .3 : S im p le Int e r e s t C a lc u la t io n .a s m -P a r t -1 F ig u r e 1 5 .4 : S im p le Int e r e s t C a lc u la t io n .a s m -P a r t -2 F ig u r e 1 5 .5 : S im p le Int e r e s t C a lc u la t io n .a s m -P a r t -3 W e h a v e a lr e a d y d is c u s s e d m o s t o f t h e p a r t s in t h e lis t in g in t h e p r e c e d in g c h a p t e r s . L e t ’s m o v e o n t o lin e 1 2 . ▼L in e 1 2 -1 4 C O N S T S E G M E N T $S G 4 6 8 1 D B '%f ', 0 0 H C O N S T E N D S T h e s t r in g c o n s t a n t is a llo c a t e d in t h e c o n s t a n t s e gm e n t . In o u r c a s e , t h e lin k e r is r e n a m e d fr o m C O N S T S E G M E N T t o .r d a t a ( t h e c o d e is p la c e d in t h e .c o d e s e gm e n t , t h e c o n s t a n t s t r in gs a r e p la c e d in t h e C O N S T ( .r d a t a ) s e gm e n t , a n d if n o t a c o n s t a n t , it is p la c e d in t h e .d a t a s e gm e n t ) , w h ic h c a n b e d u m p e d u s in g a n y d e b u gge r. F o llo w in g s c r e e n s h o t d e m o n s t r a t e s s t r in g $S G 4 6 8 1 in t h e m e m o r y d u m p : F ig u r e 1 5 .6: .r d a t a ▼L in e 1 5 -2 1 P UB L IC __r e a l@4 0 5 9 0 0 0 0 0 0 0 0 0 0 0 0 P UB L IC __r e a l@4 0 f0 0 0 0 0 P UB L IC _m a in E X T R N _p r in t f:P R O C E X T R N __ﬂ t u s e d :D W O R D ; C O M D A T __r e a l@4 0 5 9 0 0 0 0 0 0 0 0 0 0 0 0 ; F ile c :\\ jit e n d e r n \\ r e b o o k \\ s im p le in t e r e s t c a lc u la t io n \\ s im p le in t e r e s t c a lc u la t io n \\ s im p le in t e r e s t c a lc u la t io n .c p p T h e p u b lic d e r iv a t iv e is t o m a k e t h e r e a l v a r ia b le p u b lic t o m a k e it a v a ila b le a c r o s s m o d u le s . T h e E X T R N d e r iv a t iv e d e c la r e s t h e e x t e r n fu n c t io n w h ic h is p r in t f a n d T h e r e s t a r e a ll c o m m e n t s . ▼L in e 2 2 -2 9 C O N S T S E G M E N T __r e a l@4 0 5 9 0 0 0 0 0 0 0 0 0 0 0 0 D Q 0 4 0 5 9 0 0 0 0 0 0 0 0 0 0 0 0 r ; 1 0 0 C O N S T E N D S ; C O M D A T __r e a l@4 0 f0 0 0 0 0 C O N S T S E G M E N T __r e a l@4 0 f0 0 0 0 0 D D 0 4 0 f0 0 0 0 0 r    ; 7 .5 ; F u n c t io n c o m p ile ﬂ a gs : / O d t p C O N S T E N D S H e r e , t h e r e a l v a r ia b le s / n u m b e r s a r e a llo c a t e d in t h e .r d a t a s e gm e n t . B o t h c a n b e v ie w e d b y d u m p in g t h e .r d a t a s e gm e n t : F ig u r e 1 5 .7 : F lo a t 7 .5 t o h e x T h e ﬂ o a t in g p o in t a r gu m e n t ’s h e x a d e c im a l r e p r e s e n t a t io n w ill b e s t o r e d in a r e v e r s e o r d e r, a s w e a r e d e a lin g w it h t h e lit t le -e n d ia n . F ig u r e 1 5 .8: .r d a t a w it h ﬂ o a t h e x ▼L in e 3 0 -3 5 _TEX T S E G M E N T t v 7 6 = -2 0       ; s iz e = 4 _fIn t e r e s t A m t $ = -1 6      ; s iz e = 4 _iP r in c ip a lA m t $ = -1 2      ; s iz e = 4 _iN o O fYr s $ = -8       ; s iz e = 4 _fS im p le In t e r e s t $ = -4      ; s iz e = 4 Fr o m h e r e , o u r t e x t s e gm e n t s t a r t s . To a c c e s s t h e lo c a l v a r ia b le o n t h e s t a c k fr a m e , w e h a v e t o a d d _ $ t o t h e E B P a d d r e s s . T h e fo llo w in g ﬁ gu r e w ill h e lp u s u n d e r s t a n d t h e c o n c e p t b e h in d a c c e s s in g a r gu m e n t s o n t h e s t a c k : F ig u r e 1 5 .9: S t a c k v ie w To a c c e s s t h e lo c a l v a r ia b le fIn t e r e s t A mt o n t h e s t a c k fr a m e , w e h a v e t o a d d _fIn t e r e s t A mt $ t o t h e E B P a d d r e s s . S o , t o a c c e s s t h e fIn t e r e s t A mt v a r ia b le o n t h e s t a c k , w e h a v e t o a d d -1 6 t o t h e E B P a d d r e s s . T h e s a m e a p p lie s t o o t h e r v a r ia b le s , e a c h o f 4 b y t e s in s iz e . T h e s a m e p r e c e d in g s t a c k c a n b e v is u a liz e d a s fo llo w s : F ig u r e 1 5 .1 0 : V a r ia b le s o n s t a c k ▼L in e 3 6 -4 0 _m a in P R O C ; L in e 7 p u s h e b p m o v e b p , e s p s u b e s p , 2 0      ; 0 0 0 0 0 0 1 4 H T h e ma in p r o c e d u r e s t a r t s h e r e a n d t h e r e a l c o d e b e gin s w it h t h e fu n c t io n p r o lo gu e . T h e S UB in s t r u c t io n is c r e a t in g r o o m fo r t h e lo c a l v a r ia b le s b y s u b t r a c t in g 2 0 b y t e s ( 1 4 H in H e x ) , e q u iv a le n t t o t h e s p a c e fo r 5 lo c a l v a r ia b le s a s s h o w n in t h e fo llo w in g s c r e e n s h o t . F ig u r e 1 5 .1 1 : C r e a t in g r o o m fo r v a r ia b le s o n t h e s t a c k A s w e h a v e o n ly 4 lo c a l v a r ia b le s , y o u m a y b e w o n d e r in g w h y a s p a c e fo r 5 lo c a l v a r ia b le s is r e q u ir e d . To u n d e r s t a n d t h is p o in t , w e w ill w a lk t h r o u gh t h e c o d e in s t r u c t io n -b y -in s t r u c t io n b y p u t t in g a b r e a k p o in t p o in t o n t h e ma in p r o c e d u r e c a ll. W e w ill u s e x 3 2 d b g t o s t e p in t o t h e n e x t in s t r u c t io n : ▼L in e 4 1 -4 2 ; L in e 1 1 m o v D W O R D P T R _iP r in c ip a lA m t $[e b p ], 1 0 0 0 0 ; 0 0 0 0 2 7 1 0 H T h is in s t r u c t io n w ill m o v e t h e ﬁ r s t v a r ia b le , t h a t is o n t h e s t a c k a t [E B P -1 2 ] a s s h o w n in t h e fo llo w in g s c r e e n s h o t . F ig u r e 1 5 .1 2 : iP r in c ip a lA m t o n t h e s t a c k ▼L in e 4 3 -4 4 ; L in e 1 2 m o v D W O R D P T R _iN o O fYr s $[e b p ], 5 T h is in s t r u c t io n w ill m o v e t h e s e c o n d v a r ia b le , t h a t is o n t h e s t a c k a t [E B P -8 ]. ▼L in e 4 5 -4 6 ; L in e 1 3 ﬂ d D W O R D P T R __r e a l@4 0 f0 0 0 0 0 . T h e F lo a t in g P o in t L o a d w ill p u s h t h e ﬂ o a t in g p o in t v a lu e o n t h e F P U s t a c k . In x 3 2 d b g, w e c a n s e e t h e s a m e in s t r u c t io n a s fo llo w s : ﬂ d s t 0 , d w o r d p t r d s :[0 x 0 1 0 0 C 1 5 0 ] T h is m e a n s p u s h in g t h e ﬂ o a t in g p o in t v a lu e s t o r e d a t d s : [0 x 0 1 0 0 C 1 5 0 ] t o t h e S T ( 0 ) r e gis t e r a s s h o w n b e lo w . F ig u r e 1 5 .1 3 : F lo a t in g p o in t v a lu e o n t h e F P U s t a c k ▼L in e 4 7 fs t p D W O R D P T R _fIn t e r e s t A m t $[e b p ] T h is w ill m o v e t h e fIn t e r e s t A mt ﬂ o a t in g p o in t v a lu e s t o r e d a t S T ( 0 ) t o t h e s t a c k [E B P -0 x 1 0 ] a n d P O P s t h e v a r ia b le fr o m t h e F P U s t a c k . T h e s a m e in s t r u c t io n is v ie w e d a s fo llo w s in x 3 2 d b g: fs t p d w o r d p t r s s :[e b p -0 x 1 0 ], s t 0 F ig u r e 1 5 .1 4 : fInt e r e s t A m t o n s t a c k ▼L in e 4 9 m o v e a x , D W O R D P T R _iP r in c ip a lA m t $[e b p ] It w ill m o v e t h e iP r in c ip a lA mt v a r ia b le v a lu e t o E A X fo r fu r t h e r c a lc u la t io n . ▼L in e 5 0 im u l e a x , D W O R D P T R _iN o O fYr s $[e b p ] T h is m u lt ip lie s t h e iN o O fYr s v a r ia b le s t o r e d o n t h e s t a c k [E B P -8 ] w it h t h e iP r in c ip a lA mt v a r ia b le s t o r e d in T h e r e s u lt o f t h e m u lt ip lic a t io n is s t o r e d in t h e E A X r e gis t e r. ▼L in e 5 1 m o v D W O R D P T R t v 7 6 [e b p ], e a x T h e s a m e c a n b e v ie w e d a s fo llo w s in x 3 2 d b g: m o v d w o r d p t r s s :[e b p -0 x 1 4 ], e a x M O V w ill m o v e t h e m u lt ip lic a t io n v a lu e o f iP r in c ip a lA mt a n d iN o O fYr s o n t o t h e s t a c k a t [E B P -0 x 1 4 ] a s a t e m p o r a r y lo c a t io n . W e c a n im a gin e t h is m u lt ip lic a t io n r e s u lt a s a v a r ia b le lo c a l t o t h e ma in p r o c e d u r e . T h is is w h e r e w e o u r v a r ia b le c o m e s in p ic t u r e a s s h o w n b e lo w in t h e s c r e e n s h o t . F ig u r e 1 5 .1 5 : M u lt ip lic a t io n v a lu e o n t h e s t a c k ▼L in e 5 2 ﬁ ld D W O R D P T R t v 7 6 [e b p ] ;In x 3 2 d b g, ﬁ ld s t 0 , d w o r d p t r s s :[e b p - 0 x 1 4 ] T h e m u lt ip lic a t io n r e s u lt o f iP r in c ip a lA mt a n d iN o O fYr s s t o r e d a t [E B P -0 x 1 4 ] is s ign e d -in t e ge r. If it h a s t o b e m o v e d t o t h e F P U s t a c k , it h a s t o b e c o n v e r t e d t o t h e ﬂ o a t in g p o in t fo r m a t . T h e F IL D in s t r u c t io n c o n v e r t s t h e s ign e d -in t e ge r in t o a ﬂ o a t in g p o in t fo r m a t a n d t h e n p u s h e s t h e v a lu e o n t o t h e F P U r e gis t e r s t a c k . F ig u r e 1 5 .1 6: F IL D in s t r u c t io n o u t p u t ▼L in e 5 3 fm u l D W O R D P T R _fIn t e r e s t A m t $[e b p ]    ;in x 3 2 d b g, fm u l s t 0 , d w o r d p t r s s :[e b p -0 x 1 0 ] It w ill m u lt ip le t h e fIn t e r e s t A mt v a r ia b le s t o r e d o n t h e s t a c k w it h t h e v a lu e s t o r e d a t S T ( 0 ) . S o , t h is b a s ic a lly m u lt ip le s t h e m u lt ip lic a t io n r e s u lt o f iP r in c ip a lA mt a n d iN o O fYr s ( s t o r e d a t w it h fIn t e r e s t A mt ( s t o r e d o n t h e s t a c k F ig u r e 1 5 .1 7 : F M UL in s t r u c t io n o u t p u t ▼L in e 5 4 fd iv Q W O R D P T R __r e a l@4 0 5 9 0 0 0 0 0 0 0 0 0 0 0 0 ; in x 3 2 d b g, fd iv s t 0 , q w o r d p t r d s :[0 x 0 1 0 0 C 1 4 8 ] Up u n t il n o w , w e h a v e m u lt ip lie d a ll t h r e e , iP r in c ip a lA mt * iN o O fYr s * a n d t h e r e s u lt o f t h is is s t o r e d in t h e F P U s t a c k a t N o w , t h is w ill d iv id e t h e r e s u lt a n t w it h 1 0 0 a s p e r o u r C / C ++ c o d e . F D IV w ill d iv id e Q W O R D ( 1 Q W O R D = 8 b y t e s ) s t o r e d a t d s :[0 x 0 1 0 0 C 1 4 8 ] w it h t h e v a lu e o n t h e F P U s t a c k . ▼L in e 5 5 fs t p D W O R D P T R _fS im p le In t e r e s t $[e b p ] ;In x 3 2 d b g, fs t p d w o r d p t r s s :[e b p -0 x 4 ], s t 0 T h is w ill m o v e t h e fS imp le In t e r e s t t h a t w e go t fr o m S T ( 0 ) t o t h e s t a c k [E B P -0 x 4 ] a n d P O P t h e v a r ia b le fr o m F P U s t a c k a s s h o w n in t h e fo llo w in g s c r e e n s h o t . F ig u r e 1 5 .1 8: F S T P in s t r u c t io n o u t p u t ▼L in e 5 7 ﬂ d D W O R D P T R _fS im p le In t e r e s t $[e b p ] ;In x 3 2 d b g, ﬂ d s t 0 , d w o r d p t r s s :[e b p -0 x 4 ] T h is p u s h e s t h e fS imp le In t e r e s t ﬂ o a t in g p o in t v a lu e o n t o t h e F P U s t a c k . ▼L in e 5 8 s u b e s p , 8 B e fo r e c a llin g t h e p r in t f fu n c t io n , it w ill c r e a t e r o o m fo r a r gu m e n t s o n t h e s t a c k b y 8 b y t e s . ▼L in e 5 9 fs t p Q W O R D P T R [e s p ] ;In x 3 2 d b g, fs t p q w o r d p t r s s :[e s p ], s t 0 T h is w ill m o v e fS imp le In t e r e s t fr o m S T ( 0 ) t o t h e s t a c k [E S P ] in t h e Q W O R D fo r m a t a n d t h e n P O P t h e v a r ia b le fr o m F P U s t a c k . In t h e fo llo w in g s c r e e n s h o t , v a r ia b le s a r e m a r k e d o n s t a c k fo r p r o p e r u n d e r s t a n d in g. F ig u r e 1 5 .1 9: fS im p le Int e r e s t fr o m S T ( 0 ) t o s t a c k ▼L in e 6 0 p u s h O F F S E T $S G 4 6 8 1 ; in x 3 2 d b g, p u s h 0 x 1 0 0 C 1 4 0 T h is w ill p u s h t h e s t r in g c o n s t a n t o n t h e s t a c k . F ig u r e 1 5 .2 0 : B e fo r e c a ll t o p r in t f ▼L in e 6 1 -6 2 c a ll _p r in t f a d d e s p , 1 2      ; 0 0 0 0 0 0 0 c H x o r e a x , e a x m o v e s p , e b p p o p e b p r e t 0 _m a in E N D P _TEX T E N D S E N D N o w , t h e p r in t f fu n c t io n a r gu m e n t s a r e p u s h e d o n t o t h e s t a c k ; C A L L in s t r u c t io n w ill c a ll t h e p r in t f fu n c t io n . O n r e t u r n a s p e r t h e C D E C L c a llin g c o n v e n t io n , t h e c a lle r c le a n s t h e s t a c k . Wit h t h is , t h e lis t in g e n d s b y c a llin g t h e fu n c t io n e p ilo gu e a n d r e t u r n in g 0 . C o n c lu s io n In t h is c h a p t e r, w e le a r n e d a b o u t a r e a l-life s o f t w a r e t h a t u s e s in t e r n a l m a t h e m a t ic a l fo r m u la t o c a lc u la t e s im p le in t e r e s t . W e s a w h o w a n in t e ge r a n d ﬂ o a t a r e t o ge t h e r h a n d le d in m e m o r y. W e s t u d ie d t h e a s s e m b ly p a t t e r n o f a s o f t w a r e w it h m a t h e m a t ic a l c a lc u la t io n s . In t h e n e x t c h a p t e r, w e w ill r e v e r s e e n gin e e r a p o p u la r r a n s o m w a r e t o c r a c k . C H A P T E R 1 6 B r e a k in g W a n n a c r y R a n s o m w a r e Wit h R e v e r s e E n gin e e r in g R a n s o m w a r e is a k in d o f m a lw a r e t h a t e n c r y p t s t h e v ic t im ’ s ﬁ le a n d d e m a n d s a r a n s o m t o d e c r y p t t h o s e ﬁ le s . If t h e r a n s o m is n o t giv e n w it h in t im e , t h e v ic t im ’ s c o m p u t e r d a t a is d e le t e d o r le f t e n c r y p t e d fo r e v e r o r, s o m e t im e s , is s o ld in t h e b la c k m a r k e t . W a n n a c r y w a s s u c h r a n s o m w a r e w h ic h t a r ge t e d t h e Win d o w s c o m p u t e r s b y e n c r y p t in g d a t a a n d t h e n d e m a n d in g a r a n s o m t o d e c r y p t t h e d a t a . R a n s o m w a s d e m a n d e d in t h e fo r m o f B it c o in c r y p t o c u r r e n c y. T h e im p a c t o f W a n n a c r y w a s s o b ig t h a t it in fe c t e d m illio n s o f c o m p u t e r s w o r ld w id e a n d , m o r e o v e r, it a ls o in fe c t e d A p p le & o t h e r s e r v e r s ’ O S . In fo r m a t io n S e c u r it y N e w s p a p e r r e p o r t e d t h a t m a n y b ig c o m p a n ie s ’ m a n u fa c t u r in g p la n t s , lik e H o n d a ’ s , w a s s h u t d o w n a f t e r s o m e o f t h e ir c o m p u t e r s go t in fe c t e d w it h W a n n a c r y. C h e c k t h e fo llo w in g lin k fo r r e fe r e n c e : h t t p s :// w w w .s e c u r it y n e w s p a p e r.c o m / 2 0 1 7 / 0 6 / 2 1 / o n e -m o n t h -la t e r - w a n n a c r y -r a n s o m w a r e -s t ill-s h u t t in g -fa c t o r ie s / A s a r e v e r s e e n gin e e r, w e w ill a n a ly z e a n d b r e a k t h e W a n n a c r y r a n s o m w a r e . Wh e n w e s a y ‘ b r e a k it ’ , it m e a n s t h a t w e w ill t r y t o d ig in t o t h e c o d e ﬂ o w o f W a n n a c r y a n d ﬁ n d s o m e t h in g t h a t c a n c h a n ge t h e o p e r a t io n t o m a k e it in e ﬀ e c t iv e . W e w ill u s e t h e r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d G h id r a t o a n a ly z e a n d b r e a k t h e W a n n a c r y r a n s o m w a r e . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : In s t a lla t io n o f r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d G h id r a H o w t o a n a ly z e m a lw a r e u s in g r e v e r s e e n gin e e r in g H o w t o k ill W a n n a c r y m a lw a r e O b je c t iv e T h e o b je c t iv e o f t h is c h a p t e r is t o u n d e r s t a n d t h e s t e p s in v o lv e d in in s t a llin g t h e r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d G h id r a . A f t e r in s t a llin g it , w e w ill a n a ly z e t h e W a n n a c r y m a lw a r e a n d ﬁ n d t h e k ill s w it c h o f W a n n a c r y. T h e a t t a c k o f W a n n a c r y w a s s t o p p e d a f t e r a fe w d a y s o f t h e k ill s w it c h d is c o v e r y. It a ﬀ e c t e d t h o u s a n d s o f c o m p u t e r s in 1 5 0 c o u n t r ie s w it h a lo s s o f b illio n s o f d o lla r s . In s t a lla t io n A s w e h a v e c o v e r e d t h e b a s ic in t r o d u c t io n o f G h id r a in C h a p t e r 3 , Up a n d R u n n in g w it h R e v e r s e E n g in e e r in g in t h is c h a p t e r w e w ill w a lk o v e r t h e in s t a lla t io n o f t h e r e v e r s e e n gin e e r in g fr a m e w o r k . G h id r a in s t a lla t io n is v e r y s im p le a n d w e w ill u s e t h e Win d o w s 1 0 6 4 -b it v e r s io n t o c a r r y o u t o u r G h id r a in s t a lla t io n . F o llo w t h e giv e n p r o c e d u r e s t e p b y s t e p t o in s t a ll G h id r a : D o w n lo a d a n d in s t a ll JD K 1 1 fr o m t h e o ﬃ c ia l w e b s it e o f O r a c le – h t t p s :// w w w .o r a c le .c o m/ ja v a / t e c h n o lo g ie s / ja v a s e -jd k 1 1 -d o w n lo a d s .h t m l S e le c t Win d o w s x 6 4 In s t a lle r fo r d o w n lo a d . Wh ile d o w n lo a d in g JD K , y o u w ill b e r e d ir e c t e d t o c r e a t e a n a c c o u n t o n t h e O r a c le w e b s it e a s fo llo w s : h t t p s :// p r o ﬁ le .o r a c le .c o m/ m y p r o ﬁ le / a c c o u n t / c r e a t e -a c c o u n t .js p x F ig u r e 1 6.1 : R e g is t r a t io n fo r JD K d o w n lo a d A f t e r c r e a t in g a n a c c o u n t , lo gin t o d o w n lo a d a n d in s t a ll t h e JD K o n y o u r m a c h in e . A d d t h e JD K b in d ir e c t o r y t o y o u r w in d o w s m a c h in e P A T H v a r ia b le . To d o t h a t , fo llo w : R igh t -c lic k o n t h e Win d o w s S t a r t b u t t o n a n d c lic k o n C lic k o n A d v a n c e d s y s t e m Un d e r A d v a n c e T A B in t h e S y s t e m P r o p e r t ie s w in d o w , c lic k o n E n v ir o n me n t Un d e r S y s t e m e d it t h e P A T H v a r ia b le . A t t h e e n d o f t h e v a r ia b le , a d d a s e m ic o lo n fo llo w e d b y p a t h o f JD K d ir >\\ b in a s fo llo w s : F ig u r e 1 6.2 : A d d JD K t o P A T H N o w t h e JD K p a t h is s e t . It is t im e t o d o w n lo a d G h id r a . D o s o fr o m t h e fo llo w in g lin k : h t t p s :// gh id r a -s r e .o r g/ E x t r a c t t h e d o w n lo a d e d fo ld e r a n d r u n gh id r a R u n .b a t a s fo llo w s : F ig u r e 1 6.3 : S t a r t G h id r a It w ill p r o m p t y o u t o A gr e e t h e G h id r a Us e r O n a c c e p t in g, y o u w ill ge t t h e N O A C T IV E P R O JEC T s c r e e n a s w e h a v e n o a c t iv e p r o je c t s o n G h id r a . F ig u r e 1 6.4 : G h id r a ﬁ r s t s c r e e n Wit h t h is , w e h a v e s u c c e s s fu lly in s t a lle d a n d s t a r t e d G h id r a . A n a ly z in g a n d B r e a k in g W a n n a c r y B e fo r e a n a ly z in g t h e W a n n a c r y r a n s o m w a r e , w e n e e d t o ge t t h e c o p y o f t h e r a n s o m w a r e fr o m t h e fo llo w in g w e b s it e . T h is is 3 2 -b it v e r s io n o f t h e r a n s o m w a r e b in a r y. h t t p s :// w w w .gh id r a .n in ja / s a mp le s / w a n n a c r y.z ip N o t e : D o n o t r u n e x e c u t a b le ﬁ le c o m p r e s s e d in t h e W a n n a c r y z ip ﬁ le o n y o u r m a c h in e . If y o u w a n t t o r u n a n d c h e c k h o w W a n n a c r y m a lw a r e w o r k s , t h e n d o it o n a v ir t u a l m a c h in e w it h n o im p o r t a n t d a t a o n it . O n c e t h is b in a r y is e x e c u t e d o n m a c h in e , y o u w ill n o t b e a b le t o a c c e s s ﬁ le s o n t h a t v ir t u a l m a c h in e . If y o u r u n t h e W a n n a c r y e x e c u t a b le o r b in a r y o n y o u r v ir t u a l m a c h in e , d is a b le D e fe n d e r t o ge t t h e fo llo w in g s c r e e n : F ig u r e 1 6.5 : W a n n a c r y L e t ’s lo a d W a n n a c r y in t o G h id r a b y d o w n lo a d in g t h e W a n n a c r y z ip ( p a s s w o r d : fr o m t h e p r e c e d in g lin k a n d e x t r a c t it . O p e n G h id r a t o c r e a t e a n e w p r o je c t fr o m F ile > N e w N a m e it F ig u r e 1 6.6: G h id r a n e w p r o je c t s c r e e n F ig u r e 1 6.7 : P r o je c t n a m e O n c lic k in g y o u r W a n n a c r y p r o je c t w ill c o m e u n d e r A c t iv e D r a g a n d d r o p t h e W a n n a c r y e x e c u t a b le u n d e r A c t iv e P r o je c t a n d it w ill im p o r t t h e b in a r y a n d ﬂ a s h t h e fo llo w in g s c r e e n : F ig u r e 1 6.8: D r a g d r o p w a n n a c r y b in a r y O n c lic k in g t h e n e x t s c r e e n w ill s h o w t h e Imp o r t R e s u lt S u mma r y fo r t h e W a n n a c r y b in a r y. T h is w ill lis t t h e E x e c u t a b le fo r m a t , C o m p ile r ID , P r o c e s s o r, E n d ia n e s s , a n d m a n y o t h e r c o m p o n e n t s a s fo llo w s : F ig u r e 1 6.9: Im p o r t r e s u lt s u m m a r y P r e s s O K a n d d o u b le c lic k o n t h e w a n n a c r y p r o je c t t o o p e n C o d e B r o w s e r a s fo llo w s . In t h e it w ill a s k y o u t o a n a ly z e t h e e x e c u t a b le . F ig u r e 1 6.1 0 : W a n n a c r y a n a ly z e n o w s c r e e n C lic k Ye s t o c o n t in u e . Yo u w ill h a v e t o e n a b le a fe w a n a ly s is o p t io n s lik e Win d o w s P E x 8 6 P r o p a ga t e E x t e r n a l P a r a me t e r a n d D e c o mp ile r P a r a me t e r F ig u r e 1 6.1 1 : E n a b le a n a ly s is o p t io n s O n c e e n a b le d , c lic k o n A n a ly z e a n d ign o r e t h e w a r n in gs if a n y. F ig u r e 1 6.1 2 : D is a s s e m b ly v ie w O n t h e r igh t , w e s e e P r o gr a m Tr e e s w h ic h d is p la y s t h e P E s e c t io n d e t a ils . In t h e S y mb o l it d is p la y s t h e s y m b o ls c u r r e n t ly d e ﬁ n e d in t h e p r o gr a m . T h e m id d le s c r e e n is t h e d is a s s e m b le d v ie w o f t h e b in a r y a n d o n t h e le f t , w e s e e It s h o w s N o F u n c t io n a s w e h a v e n o t s e le c t e d a n y fu n c t io n fr o m t h e F u n c t io n s T A B o n t h e b o t t o m o f t h e D e c o mp ile r w in d o w . To v ie w t h e e n t r y p o in t o f t h is e x e c u t a b le , t y p e in e n t r y in t h e fu n c t io n s t a b a n d d o u b le c lic k o n t h e e n t r y fu n c t io n t o v ie w it s d is a s s e m b le d a n d d e c o m p ile d c o d e . F ig u r e 1 6.1 3 : E n t r y fu n c t io n T h e a s s e m b ly c o d e w e s e e in t h e lis t in g s e c t io n o f t h e p r e c e d in g s c r e e n s h o t is t h e e n t r y c o d e o f t h e b in a r y. T h is e n t r y fu n c t io n is a ma in ( ) o r Win M a in ( ) fu n c t io n . F o r b r e a k in g W a n n a c r y, w e w ill h a v e t o a n a ly z e a n d u n d e r s t a n d t h e c o d e ﬂ o w . In t h is p r o c e s s o f u n d e r s t a n d in g t h e c o d e ﬂ o w , w e w ill ﬁ r s t s e e a ll t h e fu n c t io n c a lls m a d e fr o m t h e e n t r y d is a s s e m b le d fu n c t io n . T h is is d o n e b y go in g t o t h e m e n u Win d o w s > F u n c t io n C a ll A w in d o w w it h a ll t h e c a lls m a d e fr o m t h e e n t r y fu n c t io n w ill b e s h o w n in a gr a p h ic a l w a y : F ig u r e 1 6.1 4 : E n t r y fu n c t io n c a ll g r a p h M o s t o f t h e c a lls a r e m a d e t o t h e in t e r n a l lib r a r ie s fu n c t io n s . L e t ’s a n a ly z e t h e fu n c t io n s o f o u r in t e r e s t . F ig u r e 1 6.1 5 : F UN _0 0 4 0 9 b a 1 F UN _0 0 4 0 9 b a 1 is ju s t a s o it d o e s n o t r e v e a lin g a n y t h in g. M o v e t o t h e n e x t fu n c t io n a s fo llo w s : F ig u r e 1 6.1 6: F UN _0 0 4 0 9 b 8c F UN _0 0 4 0 9 b 8 c a ls o d o e s n o t r e v e a lin g a n y t h in g. L e t ’s m o v e t o t h e n e x t fu n c t io n , a s fo llo w s : F ig u r e 1 6.1 7 : F UN _0 0 4 0 81 4 0 -P a r t -1 F ig u r e 1 6.1 8: F UN _0 0 4 0 81 4 0 -P a r t -2 T h is fu n c t io n is s o m e t h in g o f o u r in t e r e s t . W e w ill a n a ly z e t h e d is a s s e m b le d c o d e fr o m w h a t e v e r w e h a v e le a r n e d fr o m t h e e a r lie r c h a p t e r s . G h id r a a ls o d e c o m p ile s t h e b in a r y, b u t w e w ill ﬁ r s t go o v e r t h e d is a s s e m b le d c o d e s t e p b y s t e p t o r e v ie w o u r le a r n in g. Wh ile a n a ly z in g t h e d is a s s e m b le d c o d e lin e b y lin e , w e w ill v is u a liz e t h e s t a c k s t a t e t o ge t a n o v e r v ie w o f t h e s t a c k s t a t e d u r in g c o d e ﬂ o w . N o t e : W e w ill b e d o in g a s t a t ic a n a ly s is o f t h e d is a s s e m b le d c o d e . W e w ill n o t e x e c u t e t h is b in a r y d u r in g o u r a n a ly s is . S t a t ic a n a ly s is w ill h e lp u s u n d e r s t a n d t h e c o d e ﬂ o w a s w e ll a s t h e w o r k in g o f t h e r a n s o m w a r e . B e fo r e w e s t a r t t h e a n a ly s is , le t ’s v is u a liz e a s t a c k w h e r e E S P is p o in t in g o n t h e t o p o f t h e s t a c k . In t h e fo llo w in g s c r e e n s h o t , y o u c a n s e e t h e v is u a liz a t io n o f t h e s t a c k in a s e q u e n c e o f 4 c e lls , o n e a b o v e t h e o t h e r. E a c h c e ll d e n o t e s a b y t e a n d t h e m e m o r y a d d r e s s in g is d o n e o n t h e le f t s id e fr o m a h igh e r m e m o r y lo c a t io n t o a lo w e r m e m o r y lo c a t io n a s w e m o v e u p . T h e m e m o r y lo c a t io n m a r k e d w it h gr e e n is t h e lo c a t io n o f E S P, p o in t in g t o t h e t o p o f t h e s t a c k h a v in g s o m e d a t a m a r k e d w it h X X b y t e s . T h e in it ia l s t a c k s t a t e b e fo r e s t a r t in g t h e F UN _0 0 4 0 8 1 4 0 fu n c t io n w ill b e a s fo llo w s . R igh t n o w , a ll t h e c e lls a r e ﬁ lle d w it h s o m e d a t a w h ic h is m a r k e d a s JUN K . Wit h t h e in s t r u c t io n s ﬂ o w , b y t e s w ill b e p u s h e d a n d p o p p e d o f t h e s t a c k . F ig u r e 1 6.1 9: Init ia l s t a c k s t a t e ▼L in e 0 1 -1 8 u n d e ﬁ n e d 4 __s t d c a ll F UN _0 0 4 0 8 1 4 0 ( v o id ) u n d e ﬁ n e d 4         EA X :4            u n d e ﬁ n e d 1         S t a c k [-0 x 1 ]:1   lo c a l_1     X R E F [1 ]:     0 0 4 0 8 1 7 7 ( W)    u n d e ﬁ n e d 2         S t a c k [-0 x 3 ]:2   lo c a l_3     X R E F [1 ]:     0 0 4 0 8 1 6 c ( W)    u n d e ﬁ n e d 4         S t a c k [-0 x 7 ]:4   lo c a l_7     X R E F [1 ]:     0 0 4 0 8 1 6 8 ( W)    u n d e ﬁ n e d 4         S t a c k [-0 x b ]:4   lo c a l_b     X R E F [1 ]:     0 0 4 0 8 1 6 4 ( W)    u n d e ﬁ n e d 4         S t a c k [-0 x f ]:4   lo c a l_f    X R E F [1 ]:     0 0 4 0 8 1 6 0 ( W)    u n d e ﬁ n e d 4         S t a c k [-0 x 1 3 ]:4 lo c a l_1 3    X R E F [1 ]:     0 0 4 0 8 1 5 c ( W)    u n d e ﬁ n e d 4         S t a c k [-0 x 1 7 ]:4 lo c a l_1 7    X R E F [1 ]:     0 0 4 0 8 1 5 8 ( W)    u n d e ﬁ n e d 1         S t a c k [-0 x 5 0 ]:1 lo c a l_5 0    X R E F [2 ]:     0 0 4 0 8 1 4 f( *) , S UB E S P,0 x 5 0 P US H E S I P US H E D I A t t h e s t a r t o f w e s e e t h a t d iﬀ e r e n t v a r ia b le m a c r o s a r e d e ﬁ n e d . S UB is c r e a t in g r o o m fo r v a r ia b le s o n t h e s t a c k b y s u b t r a c t in g 0 x 5 0 fr o m A f t e r c r e a t in g s o m e r o o m , t h e E S I a n d E D I v a lu e s a r e p r e s e r v e d o n t h e s t a c k b y p u s h in g t h e m o n t h e s t a c k . T h e s t a c k s t a t e a f t e r t h e s e in s t r u c t io n s w ill b e a s fo llo w s : F ig u r e 1 6.2 0 : A f t e r c r e a t in g r o o m fo r t h e lo c a l v a r ia b le s ▼L in e 1 9 -3 2 M O V E C X ,0 x e M O V E S I,s _h t t p :// w w w .iu q e r fs o d p 9 if ja p o s d f j_0 0 4 3 1 3 d 0 L E A E D I=>lo c a l_5 0 ,[E S P + 0 x 8 ] X O R E A X ,E A X M O V S D .R E P E S :E D I,E S I=>s _h t t p :// w w w .iu q e r fs o d p 9 if ja p o s d f j M O V S B E S :E D I,E S I=>s _h t t p :// w w w .iu q e r fs o d p 9 if ja p o s d f j M O V d w o r d p t r [E S P + lo c a l_1 7 ],E A X M O V d w o r d p t r [E S P + lo c a l_1 3 ],E A X M O V d w o r d p t r [E S P + lo c a l_f ],E A X M O V d w o r d p t r [E S P + lo c a l_b ],E A X M O V d w o r d p t r [E S P + lo c a l_7 ],E A X M O V w o r d p t r [E S P + lo c a l_3 ],A X Wit h t h e M O V in s t r u c t io n , E C X is ﬁ lle d w it h 0 x 0 E w h ic h w ill a c t a s a c o u n t e r t o t h e lo o p in s t r u c t io n a f t e r w a r d s . E S I is p o in t in g t o o ﬀ s e t T h e le n gt h o f t h is UR L s t r in g is 5 7 b y t e s , w h e r e o n e b y t e is fo r n u ll t e r m in a t io n . T h e L o a d e ﬀ e c t iv e a d d r e s s in s t r u c t io n is lo a d in g t h e a d d r e s s o f E S P +0 x 0 8 in E D I. In t h e s e in s t r u c t io n s , y o u w ill s e e t h e R E P a n d M O V S in s t r u c t io n . T h e R E P in s t r u c t io n r e p e a t s t h e s t r in g o p e r a t io n E C X t im e s , w h e r e E C X is in it ia liz e d t o 0 x 0 E , w h ic h is 1 4 in d e c im a l. A s t h e M O V S D in s t r u c t io n is c o p y in g t h e b y t e s in t h e c h u n k o f 4 b y t e s t h a t is , D W O R D fr o m E S I t o S o , t h e t o t a l n u m b e r o f b y t e s t h a t a r e c o p ie d u s in g t h e M O V S D .R E P o p e r a t io n is 1 4 m u lt ip lie d b y 4 b y t e s ( 1 D W O R D h a s 4 b y t e s ) = 5 6 b y t e s . A n a d d it io n a l n u ll b y t e fo r t e r m in a t io n is c o p ie d u s in g t h e M O V S B o p e r a t io n , r e s u lt in g in a t o t a l o f 5 7 b y t e s t h a t a r e c o p ie d fr o m E S I t o T h is is t h e s a m e a s t h e le n gt h o f t h is UR L s t r in g, w h ic h is 5 7 b y t e s . D u r in g t h e s t a r t o f t h e fu n c t io n , w e c r e a t e d r o o m fo r t h e lo c a l v a r ia b le s b y s u b t r a c t in g 0 x 5 0 ( 8 0 b y t e s in d e c im a l) fr o m A f t e r c o p y in g t h e UR L s t r in g in t h is 8 0 -b y t e s r o o m , t h e r e m a in in g 2 3 b y t e s ( 8 0 b y t e s m in u s 5 7 b y t e s ) o f t h e m e m o r y lo c a t io n o n t h e s t a c k w ill b e c le a r e d u s in g X O R a n d s e v e r a l M O V in s t r u c t io n s . E A X is c le a r e d u s in g t h e X O R o p e r a t io n a n d w it h t h e r e m a in in g M O V in s t r u c t io n s , t h e 2 2 b y t e s o f t h e m e m o r y lo c a t io n w ill b e c le a r e d a s s h o w n in t h e fo llo w in g s t a c k s t a t e s c r e e n s h o t . T h e y e llo w -m a r k e d c e lls a r e t h e UR L s t r in g d a t a c o p ie d fr o m E S I t o E D I o n t h e s t a c k . T h e b la n k c e lls m a r k e d w it h 0 x 0 0 s h o w t h e r e s u lt o f t h e X O R a n d M O V X O R o p e r a t io n s . T h e r e m a in in g 1 b y t e w ill b e c le a r e d in t h e s u b s e q u e n t M O V in s t r u c t io n . F ig u r e 1 6.2 1 : UR L c o p ie d fr o m E S I t o E D I ▼L in e 3 4 -4 0 P US H     EA X   ; d w F la gs P US H     EA X   ; lp s z P r o x y B y p a s s P US H     EA X   ; lp s z P r o x y P US H     0 x 1   ; d w A c c e s s Ty p e P US H     EA X   ; lp s z A ge n t M O V      b y t e p t r [E S P + lo c a l_1 ],A L C A L L     dw o r d p t r [->WIN IN E T.D L L ::In t e r n e t O p e n A ] T h e In t e r n e t O p e n A fu n c t io n is c a lle d , a s w e c a n s e e in t h is s e t o f a s s e m b ly lis t in g. A s p e r t h e M ic r o s o f t d o c u m e n t a t io n , t h e In t e r n e t O p e n A s y n t a x is d e ﬁ n e d a s fo llo w s : v o id In t e r n e t O p e n A ( L P C S T R lp s z A ge n t , D W O R D d w A c c e s s Ty p e , L P C S T R lp s z P r o x y, L P C S T R lp s z P r o x y B y p a s s , D W O R D d w F la gs ) ; A ll t h e p a r a m e t e r s t o In t e r n e t O p e n A a r e p u s h e d o n t h e s t a c k u s in g t h e P US H in s t r u c t io n s o n e b y o n e . T h is is m a r k e d in t h e fo llo w in g s t a c k s t a t e fo r a b e t t e r u n d e r s t a n d in g. T h e M O V in s t r u c t io n is c le a r in g t h e r e m a in in g 1 b y t e lo c a t io n o n t h e s t a c k a s s h o w n in t h e fo llo w in g s t a c k s t a t e : F ig u r e 1 6.2 2 : Int e r n e t O p e n A c a ll ▼L in e 4 2 -5 1 P US H 0 x 0        ; d w C o n t e x t P US H 0 x 8 4 0 0 0 0 0 0       ; d w F la gs P US H 0 x 0        ; d w H e a d e r s L e n gt h L E A E C X =>lo c a l_5 0 ,[E S P + 0 x 1 4 ]     M O V E S I,E A X P US H 0 x 0        ; lp s z H e a d e r s P US H E C X        ; lp s z Ur l P US H E S I       ; h In t e r n e t C A L L d w o r d p t r [->WIN IN E T.D L L ::In t e r n e t O p e n Ur lA ] T h e In t e r n e t O p e n A fu n c t io n in w in in e t .d ll ( 3 2 -b it ) r e t u r n s w it h t h e R E T N 0 x 1 4 in s t r u c t io n s , w h ic h c le a r s o ﬀ t h e p u s h e d p a r a m e t e r s o f t h e In t e r n e t O p e n A fu n c t io n o n t h e s t a c k u p o n N o w , w it h t h e p r e c e d in g in s t r u c t io n s , t h e s t a c k is a ga in p o p u la t e d w it h p a r a m e t e r s t o t h e In t e r n e t O p e n Ur lA fu n c t io n . A c c o r d in g t o t h e M ic r o s o f t d o c u m e n t a t io n , t h e s y n t a x o f In t e r n e t O p e n Ur lA fu n c t io n is : v o id In t e r n e t O p e n Ur lA ( H IN T E R N E T h In t e r n e t , L P C S T R     lp s z Ur l, L P C S T R     lp s z H e a d e r s , D W O R D      d w H e a d e r s L e n gt h , D W O R D      d w F la gs , D W O R D _P T R d w C o n t e x t ) ; T h e r e t u r n v a lu e o f t h e In t e r n e t O p e n A fu n c t io n is s t o r e d in t h e E A X r e gis t e r a n d is p u s h e d o n t o t h e s t a c k a s a p a r a m e t e r t o t h e In t e r n e t O p e n Ur lA fu n c t io n w it h M O V E S I, a n d P US H E S I in s t r u c t io n s . T h e L E A in s t r u c t io n lo a d s t h e a d d r e s s o f t h e UR L s t r in g a t [E S P + 0 x 1 4 ] in t o w h ic h is la t e r p u s h e d o n t o t h e s t a c k a s a p a r a m e t e r t o t h e In t e r n e t O p e n Ur lA fu n c t io n . T h e s t a c k s t a t e b e fo r e t h e c a ll t o t h e In t e r n e t O p e n Ur lA fu n c t io n w ill b e a s fo llo w s : F ig u r e 1 6.2 3 : B e fo r e c a ll t o Int e r n e t O p e n Ur lA ▼L in e 5 3 -7 7 M O V     ED I,E A X P US H    E S I M O V     ES I,d w o r d p t r [->WIN IN E T.D L L ::In t e r n e t C lo s e H a n    = 0 0 0 0 a 7 b 2 T E S T    E D I,E D I JN Z     L A B _0 0 4 0 8 1 b c C A L L    E S I=>WIN IN E T.D L L ::In t e r n e t C lo s e H a n d le P US H    0 x 0 C A L L    E S I=>WIN IN E T.D L L ::In t e r n e t C lo s e H a n d le C A L L    F UN _0 0 4 0 8 0 9 0    P O P     ED I X O R     EA X ,E A X P O P     ES I A D D     ES P,0 x 5 0 R E T     0 x 1 0 L A B _0 0 4 0 8 1 b c    X R E F [1 ]:     0 0 4 0 8 1 a 5 ( j) C A L L    E S I=>WIN IN E T.D L L ::In t e r n e t C lo s e H a n d le P US H    E D I C A L L    E S I=>WIN IN E T.D L L ::In t e r n e t C lo s e H a n d le P O P     ED I X O R     EA X ,E A X P O P     ES I A D D     ES P,0 x 5 0 R E T     0 x 1 0 T h e In t e r n e t O p e n Ur lA fu n c t io n in w in in e t .d ll ( 3 2 -b it ) r e t u r n s w it h t h e R E T N 0 x 1 8 in s t r u c t io n , w h ic h c le a r s o ﬀ t h e p u s h e d p a r a m e t e r s o f t h e In t e r n e t O p e n Ur lA fu n c t io n o n t h e s t a c k . In t h is s e t o f a s s e m b ly in s t r u c t io n s , w e s e e s o m e t h in g r e a lly in t e r e s t in g. T h e r e t u r n v a lu e o f t h e fu n c t io n in E A X is m o v e d t o A s p e r t h e d o c u m e n t a t io n o f M ic r o s o f t fo r In t e r n e t O p e n Ur lA fu n c t io n , if t h e r e t u r n v a lu e is N UL L , it m e a n s t h a t t h e c o n n e c t io n t o t h e UR L fa ile d . If t h e r e t u r n v a lu e is a v a lid h a n d le t o t h e UR L , it m e a n s t h a t t h e c o n n e c t io n t o t h e UR L is s u c c e s s fu lly e s t a b lis h e d . T h is c o n d it io n is c h e c k e d w it h t h e T E S T in s t r u c t io n in t h e p r e c e d in g a s s e m b ly lis t in g. T h is b r in gs u s t o s o m e in t e r e s t in g c o n c lu s io n s fr o m t h e F u n c t io n F ig u r e 1 6.2 4 : T E S T c o n d it io n T E S T    E D I,E D I JN Z     L A B _0 0 4 0 8 1 b c T h e T E S T in s t r u c t io n p e r fo r m s t h e lo gic a l A N D b e t w e e n E D I a n d T h is in s t r u c t io n is u s e d t o c h e c k t h e r e gis t e r s fo r z e r o w it h o u t a lt e r in g it s v a lu e . If E D I is e q u a l t o 0 , s e t Z F t o 1 . If t h e Z F is s e t t o 1 , t h e n n o a c t io n w ill b e t a k e n a n d t h e n e x t in s t r u c t io n fo llo w in g it w ill b e e x e c u t e d . T h is is a c o n d it io n a l ju m p in s t r u c t io n w h ic h ju m p s t o t h e L A B _0 0 4 0 8 1 b c lo c a t io n if t h e z e r o ﬂ a g ( Z F ) is s e t t o 0 . T h e T E S T in s t r u c t io n c h e c k s t h e r e t u r n v a lu e o f t h e In t e r n e t O p e n Ur lA fu n c t io n . If t h e r e q u e s t t o h t t p :// w w w .iu q e r fs o d p 9 if ja p o s d f jh g o s u r ĳ fa e w r w e r g w e a .c o m fa ils , t h e In t e r n e t O p e n Ur lA fu n c t io n r e t u r n s t h e n u ll h a n d le w h ic h t h e n c lo s e s t h e h a n d le t o c a lls F UN _0 0 4 0 8 0 9 0 fu n c t io n . T h is is w h e r e t h e r a n s o m w a r e d o e s a ll it s w o r k in g. B u t if t h e r e q u e s t t o h t t p :// w w w .iu q e r fs o d p 9 if ja p o s d f jh g o s u r ĳ fa e w r w e r g w e a .c o m p a s s e s , it s im p ly c lo s e s t h e h a n d le a n d t h e n q u it s t h e W a n n a c r y p r o gr a m t o m a k e t h e r a n s o m w a r e in e ﬀ e c t iv e . A c c o r d in g t o In fo r m a t io n S e c u r it y N e w s p a p e r, lin k a s m e n t io n e d b e lo w : M a r c u s H u t c h in s w a s t h e h e r o b e h in d t h e s w it c h o f W a n n a c r y. S o o n c e h e r e gis t e r e d t h is d o m a in , W a n n a c r y w a s s h u t d o w n . S o w e s a w b y u n d e r s t a n d in g t h e a s s e m b ly lis t in g, w e a r e a b le t o d e c o d e t h e fu n c t io n in g o f t h e m a lw a r e a n d ﬁ n d a w a y t o b r e a k t h e W a n n a c r y r a n s o m w a r e . N o w , w e c a n v a lid a t e o u r u n d e r s t a n d in g o f t h e c o d e ﬂ o w w it h t h e d e c o m p ile d c o d e ge n e r a t e d b y G h id r a a s fo llo w s : F ig u r e 1 6.2 5 : D e c o m p ile d c o d e Wh a t e v e r w e h a v e a n a ly z e d fr o m t h e s t e p -b y -s t e p a s s e m b ly in s t r u c t io n s is in lin e w it h t h e d e c o m p ile d c o d e ge n e r a t e d fr o m G h id r a . If t h e In t e r n e t O p e n Ur lA fu n c t io n r e t u r n s t h e n u ll h a n d le , t h e r a n s o m w a r e d o e s a ll it s w o r k in g w it h t h e F UN _0 0 4 0 8 0 9 0 fu n c t io n . O r e ls e , it s im p ly c lo s e s t h e h a n d le a n d t h e n q u it s t h e W a n n a c r y p r o gr a m . C o n c lu s io n In t h is c h a p t e r, w e c o v e r e d t h e s t e p s t o in s t a ll a r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d Us in g G h id r a , w e a n a ly z e d t h e W a n n a c r y m a lw a r e t o d is a s s e m b le t h e m a lw a r e . Wit h w h a t w e le a r n e d fr o m t h e e a r lie r c h a p t e r s , w e a n a ly z e d t h e c o d e ﬂ o w w it h t h e h e lp o f v is u a liz in g t h e s t a c k s t a t e d u r in g t h e in s t r u c t io n ﬂ o w . T h is h e lp e d u s u n d e r s t o o d t h e c o d e ﬂ o w a n d ﬁ n d t h e k ill s w it c h o f W a n n a c r y. C H A P T E R 1 7 G e n e r a t e P s e u d o C o d e F r o m B in a r y F ile In t h e e a r lie r c h a p t e r, w e c o v e r e d t h e d iﬀ e r e n t p a t t e r n s o f a s s e m b ly c o d e fo r v a r io u s C / C ++ a p p lic a t io n s a n d s o m e r e a l-life e x a m p le s . T h e jo b o f a r e v e r s e e n gin e e r is t o ge t t h e c o p y o f t h e b in a r y fo r r e v e r s e e n gin e e r in g a n d u n d e r s t a n d in g t h e c o d e ﬂ o w . T h is b in a r y c a n b e o f a n y s o f t w a r e o r a p p lic a t io n o r it c a n b e m a lw a r e . A ll t h e m o d e r n m a lw a r e s a r e c o d e d w it h s o m e UR L t o c o m m u n ic a t e w it h t h e s e r v e r t o u p lo a d d a t a o r t o s e n d fe e d s o f t h e m a lw a r e a c t iv it ie s . S o , t h e s e UR L a r e n o t h a r d c o d e d in t h e p la in t e x t fo r m a t b u t a r e e n c r y p t e d o r e n c o d e d in s id e t h e c o d e . In t h is c h a p t e r, w e w ill ge n e r a t e t h e p s e u d o c o d e fr o m t h e b in a r y ﬁ le t o c r a c k s u c h e n c r y p t e d UR L . T h e e n c r y p t io n lo gic u s e d in s u c h c a s e s c a n b e s t a n d a r d o n e s o r c u s t o m m a d e , a ll d e p e n d in g o n t h e m a lw a r e w r it e r. W e w ill u s e w h ic h is a n o p e n -s o u r c e in t e r fa c e t o t h e R a d a r e 2 r e v e r s e e n gin e e r in g fr a m e w o r k . R a d a r e 2 is u s e d fo r s t a t ic a n d d y n a m ic a n a ly s is o f b in a r y fo r m a t s o n d iﬀ e r e n t p la t fo r m s a n d a r c h it e c t u r e s . R a d a r e 2 is fo r t h o s e w h o lo v e t o w o r k o n c o m m a n d lin e in t e r fa c e . C u t t e r is t h e gr a p h ic a l u s e r in t e r fa c e o f R a d a r e 2 . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : In s t a lla t io n o f t h e r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d C u t t e r B in a r y a n a ly s is u s in g C u t t e r D e c r y p t in g a h id d e n UR L O b je c t iv e T h e o b je c t iv e o f t h is c h a p t e r is t o u n d e r s t a n d t h e s t e p s in v o lv e d in in s t a llin g t h e r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d C u t t e r. A f t e r in s t a llin g, w e w ill a n a ly z e t h e b in a r y t o ge n e r a t e t h e p s e u d o c o d e t o e x t r a c t t h e e n c r y p t io n k e y. T h is e n c r y p t io n k e y is u s e d t o e n c r y p t t h e UR L in t h e b in a r y. W e w ill a ls o s e e h o w t h is e n c r y p t io n o f UR L is u s e d t o e s c a p e fr o m r e v e r s e e n gin e e r in g. C u t t e r In s t a lla t io n C u t t e r c a n b e d o w n lo a d e d fr o m t h e G it H u b r e p o s it o r y. It c a n b e c o m p ile d fr o m t h e s o u r c e c o d e o r c a n b e d o w n lo a d e d a s a b in a r y. It is a v a ila b le fo r d iﬀ e r e n t p la t fo r m s ( Win d o w s , L in u x , m a c O S ) . W e w ill u s e t h e Win d o w s 1 0 6 4 -b it v e r s io n t o c a r r y o u t o u r C u t t e r in s t a lla t io n . F o llo w in g is t h e s t e p -b y -s t e p p r o c e d u r e t o in s t a ll C u t t e r : D o w n lo a d a n d e x t r a c t t h e z ip ﬁ le fr o m t h e G it H u b r e p o s it o r y : h t t p s :// git h u b .c o m/ r iz in o r g/ c u t t e r / r e le a s e s / d o w n lo a d / v 1 .1 2 .0 / C u t t e r - v 1 .1 2 .0 -x 6 4 .Win d o w s .z ip In t h e e x t r a c t e d fo ld e r, r u n c u t t e r.e x e t o o p e n t h e ﬁ r s t s c r e e n o f C u t t e r. T h is is t h e s c r e e n w h e r e w e h a v e t o s e le c t a n d o p e n t h e b in a r y ﬁ le t o a n a ly z e . F ig u r e 1 7 .1 : C u t t e r ﬁ r s t s c r e e n D o w n lo a d t h is C r a c k M e .e x e fr o m t h e fo llo w in g lin k : h t t p s :// git h u b .c o m/ b p b p u b lic a t io n s / Im p le m e n t in g -R e v e r s e -E n g in e e r in g O n c e t h e b in a r y ﬁ le t o b e a n a ly z e d is s e le c t e d , c lic k O p e n t o ge t t h e c u t t e r L o a d W e a r e k e e p in g e v e r y t h in g d e fa u lt . If y o u h a v e a s y m b o l ﬁ le , w e c a n s e le c t t h e L o a d P D B o p t io n . F ig u r e 1 7 .2 : C u t t e r L o a d O p t io n s O n c lic k in g y o u w ill b e p r e s e n t e d w it h t h e d is a s s e m b ly v ie w o f t h e b in a r y. A lo n g w it h t h is , w e ge t t o s e e s e v e r a l t a b s a t t h e b o t t o m o f w in d o w . F ig u r e 1 7 .3 : B in a r y d is a s s e m b le v ie w Wit h t h is , w e h a v e s u c c e s s fu lly s t a r t e d C u t t e r fo r fu r t h e r a n a ly s is . B u t b e fo r e w e b e gin o u r a n a ly s is , w e w ill w a lk t h r o u gh t h e d iﬀ e r e n t fu n c t io n a lit ie s a n d t e r m in o lo gie s in t h e C u t t e r gr a p h ic a l u s e r in t e r fa c e . B in a r y A n a ly s is Us in g C u t t e r T h e C u t t e r u s e r in t e r fa c e h a s m a n y t a b s . W e w ill w a lk t h r o u gh e a c h t a b a n d e x p la in it s r e le v a n c e in a n a ly z in g a n y b in a r y ﬁ le . D a s h b o a r d T h e D a s h b o a r d t a b s h o w s t h e b in a r y p a t h , a r c h it e c t u r e , e n d ia n n e s s , a n d m a n y o t h e r d e t a ils . O u r b in a r y ﬁ le is a p o r t a b le e x e c u t a b le fo r m a t ﬁ le a n d c o m p ile d fo r 3 2 -b it a r c h it e c t u r e a s fo llo w s . T h e v a lu e s p r e s e n t in t h e H a s h e s s e c t io n is u s e d t o e n s u r e t h a t t h e ﬁ le is n o t c o r r u p t e d o r a lt e r e d b y u n a u t h o r iz e d u s e r s . S o m e a n t iv ir u s c o m p a n ie s u s e t h e s e v a lu e s t o d e t e r m in e if a ﬁ le is m a lic io u s o r n o t . T h e y m a in t a in t h e h a s h d a t a b a s e o f k n o w n m a lw a r e s a n d u p o n s c a n n in g, t h e y e v a lu a t e t h e ﬁ le h a s h t o c o m p a r e w it h t h a t in t h e d a t a b a s e . If t h e h a s h v a lu e s m a t c h t h e v a lu e s in t h e d a t a b a s e , t h e ﬁ le in fe c t io n is t r igge r e d . F ig u r e 1 7 .4 : D a s h b o a r d v ie w S t r in gs T h e S t r in gs t a b s h o w s t h e t e x t s t r in g fo u n d in t h e b in a r y. It is t h e ﬁ r s t le v e l o f a n a ly s is fo r a n y b in a r y a s s o m e t im e s it giv e s a lo t o f c lu e s a b o u t t h e b in a r y in t e r n a ls . Im a gin e if s o m e IP a d d r e s s o r UR L is u s e d in a p la in t e x t fo r m a t in a m a lw a r e c o d e , t h e n t h a t IP o r UR L w ill b e r e ﬂ e c t e d in t h e S t r in gs t a b . F ig u r e 1 7 .5 : S t r in g s v ie w Imp o r t s T h is t a b s h o w s t h e lib r a r ie s im p o r t e d b y t h e b in a r y. If t h e b in a r y is u s in g t h e in t e r n e t t o c o n n e c t t o s o m e s e r v ic e , t h e n it c a n b e ﬁ gu r e d o u t w it h t h e u s e o f t h e r e le v a n t fu n c t io n s u s e d t o c o n n e c t t o t h e in t e r n e t . F ig u r e 1 7 .6: Im p o r t s v ie w D is a s s e mb ly T h is t a b s h o w s t h e d is a s s e m b le d v ie w o f t h e b in a r y. Wh a t e v e r c o n c e p t s a n d in s t r u c t io n s w e h a v e le a r n e d in t h e e a r lie r c h a p t e r s w ill h e lp u s u n d e r s t a n d t h is ﬂ o w . It m igh t b e o v e r w h e lm in g fo r y o u in t h e ﬁ r s t v ie w b u t d o n ’t w o r r y, w e w ill u n d e r s t a n d t h is in a s t e p -b y -s t e p m a n n e r. F ig u r e 1 7 .7 : D is a s s e m b le v ie w G r a p h A s s e e n in t h e e a r lie r ﬁ gu r e , t h is t a b is n a m e d a s G r a p h ( E m p t y ) . E m p t y is s u ﬃ x e d a s w e h a v e n o t s e le c t e d a n y fu n c t io n . O n t h is t a b s e le c t io n , w e ge t a n e m p t y s c r e e n w it h t h e s a m e m e s s a ge t o s e le c t a fu n c t io n . H e x d u mp T h is s h o w s t h e h e x d u m p o f t h e b in a r y ﬁ le a n d is r e p r e s e n t e d b y 3 c o lu m n s . T h e ﬁ r s t c o lu m n s h o w s t h e o ﬀ s e t , t h e s e c o n d c o lu m n s h o w s t h e h e x a d e c im a l o u t p u t , a n d t h e t h ir d c o lu m n is t h e r e p r e s e n t a t io n o f d a t a in t h e A S C II fo r m a t . F ig u r e 1 7 .8: H e x d u m p v ie w D e c o mp ile r To p o p u la t e t h is t a b , w e w ill ﬁ r s t go t o t h e Win d o w s m e n u a n d s e le c t F u n c t io n s t o ge t t h e lis t o f fu n c t io n s in t h e b in a r y. In t h e ﬁ lt e r, s e a r c h fo r t h e ma in fu n c t io n a s it is t h e s t a r t in g p o in t o f t h e b in a r y. O n c e t h e ma in fu n c t io n is d o u b le -c lic k e d , t h e d e c o m p ile r w ill a n a ly z e t h e b in a r y t o d is p la y t h e h igh -le v e l r e p r e s e n t a t io n o f t h e a s s e m b ly c o d e in t h e D e c o mp ile r t a b . C u t t e r s u p p o r t s p lu gin fo r m u lt ip le d e c o m p ile r s s u c h a s R e t D e c a n d G h id r a . F ig u r e 1 7 .9: D e c o m p ile r v ie w D e c r y p t in g t h e H id d e n UR L N o w w e w ill m o v e b a c k t o t h e G r a p h s e c t io n w h ic h d is p la y s t h e v is u a l p r o c e s s ﬂ o w o f t h e ma in fu n c t io n . T h is gr a p h v ie w c a n b e z o o m e d in o r o u t u s in g t h e C t r l++ o r C t r l— s h o r t c u t s . W e w ill u n d e r s t a n d t h e e x e c u t io n p a t h in a s t e p -b y -s t e p m a n n e r t o u n d e r s t a n d w h a t t h e b in a r y is a c t u a lly d o in g. T h e fo llo w in g is t h e s c r e e n s h o t o f w h a t w e go t in t h e gr a p h v ie w fo r t h e ma in fu n c t io n . In t h e gr a p h v ie w , w e s e e b lo c k s c o n n e c t e d w it h a r r o w s . A r r o w s a r e r e p r e s e n t a t io n s o f d iﬀ e r e n t ju m p s s u c h a s T h e gr e e n a r r o w s h o w s w h a t h a p p e n s w h e n a ju m p t a k e s p la c e . T h e r e d a r r o w s h o w s if a ju m p d o e s n o t t a k e p la c e . T h e b lu e a r r o w s h o w s t h e lo o p . F ig u r e 1 7 .1 0 : E x p o r t e d g r a p h o f m a in L e t ’s w a lk o v e r t h e d is a s s e m b le d c o d e b lo c k o n e b y o n e t o u n d e r s t a n d t h e c o d e ﬂ o w : F ig u r e 1 7 .1 1 : E x p o r t e d g r a p h o f m a in -B lo c k -1 A f t e r t h e fu n c t io n p r o lo gu e , t h e S UB in s t r u c t io n is c r e a t in g r o o m fo r t h e lo c a l v a r ia b le b y s u b t r a c t in g E S P b y 0 x 3 C ( 6 0 b y t e s in d e c im a l) . A t t h e s t a c k c o o k ie is s t o r e d b y X O R ’in g E A X a n d In t h e s u b s e q u e n t M O V in s t r u c t io n s , t h e t e x t s t r in g w it h s t r in g le n gt h 2 4 ( in d e c im a l) is c o p ie d o n t h e s t a c k . T h is t e x t s t r in g s e e m s t o b e t h e e n c r y p t e d v e r s io n o f s o m e t h in g. W e w ill c a ll it t h e e n c r y p t e d t e x t s t r in g. O u t o f 6 0 b y t e s ( in d e c im a l) o n t h e s t a c k , w e h a v e c o n s u m e d 2 4 b y t e s ( in d e c im a l) fo r e n c r y p t e d t e x t s t r in g a n d 4 b y t e s fo r t h e s t a c k c o o k ie . T h e r e m a in in g m e m o r y lo c a t io n s o n t h e s t a c k a r e c le a r e d u s in g t h e M O V in s t r u c t io n s a f t e r X O R ’in g t h e E A X in s t r u c t io n . T h is e n d s t h e b lo c k s w it h a JM P in s t r u c t io n . L e t ’s m o v e t o t h e r e m a in in g in s t r u c t io n s in t h e b lo c k s . F ig u r e 1 7 .1 2 : E x p o r t e d G r a p h o f m a in r e m a in in g b lo c k s W e s e e t h e lo o p in g a r r o w r e p r e s e n t e d b y t h e b lu e a r r o w . It in d ic a t e s t h a t E C X is in it ia liz e d t o 0 x 3 2 ( 5 0 in d e c im a l) t o lo o p o v e r w it h t h e C M P a n d JG E in s t r u c t io n s . T h e gr e e n a r r o w o n t h e r igh t in d ic a t e s t h a t E C X r e a c h e s a c o u n t o f 5 0 in d e c im a l. T h is gr e e n a r r o w m o v e s t o t h e e n d o f t h e c o d e b lo c k . T h e r e d a r r o w in d ic a t e s t h a t w e a r e in s id e t h e lo o p . T h e M O V S X in s t r u c t io n is c o p y in g e v e r y c h a r fr o m t h e e n c r y p t e d t e x t s t r in g o n t h e s t a c k t o C h e c k if it is N UL L o r n o t . If it is N UL L , t h e n m o v e t o t h e e n d o f t h e c o d e b lo c k a t t h e b o t t o m r igh t . O r e ls e , a ga in c o p y t h e ﬁ r s t b y t e ( c h a r ) fr o m t h e e n c r y p t e d t e x t s t r in g o n t h e s t a c k t o E D X u s in g t h e M O V S X in s t r u c t io n . T h e S UB in s t r u c t io n s u b t r a c t s 2 fr o m t h e H E X v a lu e o f t h e c h a r c o p ie d in Fr o m it is m o v e d t o o v e r w r it e t h e ﬁ r s t c h a r o f t h e e n c r y p t e d t e x t s t r in g o n t h e s t a c k in t h e ﬁ r s t lo o p . T h is lo o p is c a r r ie d o u t u n t il a ll t h e H E X v a lu e s o f t h e c h a r a c t e r s o f t h e e n c r y p t e d t e x t s t r in g a r e s u b t r a c t e d b y 2 . T h u s , 2 is t h e e n c r y p t in g k e y u s e d t o e n c r y p t s o m e t e x t s t r in g. Wit h t h is , w e c a n ge n e r a t e a h igh -le v e l p s e u d o c o d e fo r t h e b in a r y a s fo llo w s : E n c r y p t e d Te x t = “ y y y 0 k k e { d gt u ge w t k v { 0 e q o ” fo r ( it e r a t io n =5 0 , E n c r y p t e d Te x t !=’\\ 0 ’, it e r a t io n ++) { E n c r y p t e d Te x t [it e r a t io n ] = E n c r y p t e d Te x t [it e r a t io n ] -2 ; } r e t u r n 0 ; S o , w e s a w h o w t o ge n e r a t e t h e p s e u d o c o d e b y s t e p p in g o v e r t h e a s s e m b ly in s t r u c t io n s a n d e x t r a c t in g t h e m e a n in g o u t o f it . Yo u r p s e u d o c o d e m igh t n o t b e t h e s a m e a s t h e o r igin a l b in a r y c o d e , b u t it ’s a glim p s e o f w h a t ’s h a p p e n in g in s id e t h e b in a r y w o r k in g. Wit h t h is , w e a r e n o w c le a r o n h o w t o e x t r a c t t h e h id d e n t e x t b e h in d t h e e n c r y p t e d t e x t s t r in g. To e x t r a c t t h e o r igin a l t e x t s t r in g, w e c a n e it h e r fo llo w a m a n u a l o r a u t o m a t e d p r o c e s s . M a n u a lly, it c a n b e d o n e a s fo llo w s . R e fe r t o t h e A S C II t a b le in t h e A p p e n d ix fo r t h e c h a r t o h e x c o n v e r s io n . F ig u r e 1 7 .1 3 : D e c r y p t e d t e x t S o , t h e d e c r y p t e d t e x t is a UR L , w h ic h is T h is w a s a s im p le c u s t o m e n c r y p t io n t o h id e t h e UR L in t h e c o d e . If a p la in t e x t UR L is u s e d in t h e c o d e , t h e n it w o u ld b e v is ib le in t h e S t r in gs t a b o f t h e C u t t e r gr a p h ic a l in t e r fa c e . T h e a u t o m a t e d a p p r o a c h t o e x t r a c t t h e UR L fr o m a n e n c r y p t e d UR L is t o w r it e t h e P y t h o n c o d e a s fo llo w s : F ig u r e 1 7 .1 4 : P y t h o n c o d e t o g e t t h e d e c r y p t e d t e x t T h e o u t p u t o f t h e p r e c e d in g P y t h o n p r o gr a m is a s fo llo w s : w w w .iic y b e r s e c u r it y.c o m In t h e p r e c e d in g P y t h o n c o d e , w e a r e it e r a t in g o v e r e v e r y c h a r o f e n c s t r a n d s u b t r a c t in g t h e e n c r y p t io n k e y 2 fr o m t h e A S C II v a lu e t o ge t t h e d e c r y p t e d c h a r u s in g t h e c h r fu n c t io n . It is t im e t o c h e c k t h e o r igin a l C ++ c o d e fr o m w h ic h t h e C r a c k M e b in a r y is ge n e r a t e d . F ig u r e 1 7 .1 5 : B in a r y C P P c o d e Wit h t h is , w e a r e a b le t o c r a c k t h e s im p le e n c r y p t io n u s e d in t h e b in a r y. C o n c lu s io n W e c o v e r e d t h e s t e p s in v o lv e d in t h e in s t a lla t io n o f t h e r e v e r s e e n gin e e r in g fr a m e w o r k c a lle d Wit h w h a t w e h a v e le a r n e d in t h e p r e v io u s c h a p t e r s , w e w e r e a b le t o a n a ly z e t h e b in a r y t o ge n e r a t e a p s e u d o c o d e t o e x t r a c t t h e e n c r y p t io n k e y. W e a ls o c o v e r e d t h e m a n u a l a s w e ll a s t h e a u t o m a t e d w a y t o e x t r a c t a h id d e n UR L fr o m t h e e n c r y p t e d t e x t . In t h e n e x t c h a p t e r, w e w ill le a r n s o m e n e w t h in gs a b o u t t h e w e ll-k n o w n Win d o w s a p p lic a t io n . C H A P T E R 1 8 F u n Wit h Win d o w s C a lc u la t o r Us in g R e v e r s e E n gin e e r in g In t h is c h a p t e r, w e w ill t a k e u p a n e x a m p le t o u n d e r s t a n d h o w w e c a n u s e r e v e r s e e n gin e e r in g t o m o d if y a p p lic a t io n s o r s o f t w a r e b e h a v io u r w it h o u t h a v in g a c c e s s t o t h e s o u r c e c o d e . W e w ill t a k e a w e ll-k n o w n Win d o w s a p p lic a t io n u s e d b y e v e r y o n e . E v e n t h o s e w h o k n o w t h e b a s ic s o f c o m p u t e r u s e it . W e a r e t a lk in g a b o u t t h e Win d o w s C a lc u la t o r. It is u s e d b y c o m p u t e r le a r n e r s , in t e r m e d ia t e s , a n d e x p e r t s . E v e r y o n e u s e s it fo r b a s ic a n d a d v a n c e c a lc u la t io n s . S o , w h a t a r e w e go in g t o d o w it h t h is c a lc u la t o r ? T h is w ill b e a n in t e r e s t in g r e a l-life e x a m p le w h e r e , a s a r e v e r s e e n gin e e r, w e w ill c h a n ge t h e w o r k in g o f a n a p p lic a t io n w it h h a v in g it s s o u r c e c o d e . If y o u a r e r e v e r s e e n gin e e r in g a m a lw a r e , t h e n t h is t y p e o f r e a l-life s c e n a r io w ill h e lp y o u c h a n ge t h e e x e c u t io n ﬂ o w o f a n y m a lw a r e . W e w ill a ls o t a lk in d e t a il a b o u t m a n y c o n c e p t s in v o lv e d in t h is p r o c e s s . T h is w ill b e a fu n e x e r c is e t o u n d e r s t a n d . S t r u c t u r e In t h is c h a p t e r, w e w ill c o v e r t h e fo llo w in g t o p ic s : R e v e r s e e n gin e e r in g a c a lc u la t o r Un d e r s t a n d in g t h e c o d e ﬂ o w w it h b r e a k p o in t s F in d in g a p la c e h o ld e r t o c a ll o u r c o d e W r it in g o u r c o d e in t h e C o d e C a v e P a t c h in g t h e b in a r y O b je c t iv e In t h is c h a p t e r, u s in g r e v e r s e e n gin e e r in g, w e w ill c h a n ge t h e w o r k in g o f a c a lc u la t o r b y m o d if y in g it s b e h a v io u r t o o u t p u t o u r d e ﬁ n e d s t r in g fo r a n y c a lc u la t io n t h a t w e p e r fo r m . It m e a n s t h a t r a t h e r t h a n ge t t in g 8 a s a n o u t p u t t o 2 +6 o r a n y o t h e r c a lc u la t io n , t h e c a lc u la t o r w ill d is p la y o u r d e ﬁ n e d m e s s a ge o n t h e p r e s s o f e q u a l t o b u t t o n . F o r t h is , w e w ill u s e t h e Win 3 2 C a lc u la t o r a v a ila b le in t h e o ld Win d o w s X P. R e v e r s e E n gin e e r in g C a lc u la t o r If w e w a n t t o c h a n ge t h e b e h a v io u r o f a n y a p p lic a t io n , w e c a n d o s o in t h e a p p lic a t io n s o u r c e c o d e a n d r e c o m p ile it t o ge t t h e d e s ir e d r e s u lt o n e x e c u t io n . In t h is c a s e , w e o n ly h a v e t h e c a lc u la t o r b in a r y o r P o r t a b le E x e c u t a b le ﬁ le . W e w ill u s e e n gin e e r in g t o m o d if y t h e c a lc u la t o r b in a r y b y w r it in g o u r c o d e t o w o r k a s d e s ir e d . To ge t t h e d e s ir e d r e s u lt , w e w ill fo llo w a 4 -s t e p p r o c e s s t o m o d if y t h e c a lc u la t o r b in a r y : Un d e r s t a n d in g t h e c o d e ﬂ o w w it h b r e a k p o in t s F in d in g a p la c e h o ld e r t o c a ll o u r c o d e W r it in g o u r c o d e in t h e C o d e C a v e P a t c h in g t h e b in a r y Un d e r s t a n d in g t h e c o d e ﬂ o w w it h b r e a k p o in t s T h is s t e p in v o lv e s u n d e r s t a n d in g t h e c o d e ﬂ o w o f a n a p p lic a t io n , t h e c a lc u la t o r in o u r c a s e , u s in g x 3 2 d b g o r O lly d b g. O u r o b je c t iv e is t o m o d if y t h e c a lc u la t o r is s u c h a w a y t h a t if s o m e b o d y p r e s s e s t h e e q u a l t o b u t t o n , t h e u s e r w ill b e p r e s e n t e d w it h o u r d e s ir e d s t r in g r a t h e r t h a n t h e c a lc u la t e d o u t p u t . To s t a r t , t a k e a c o p y o f c a lc .e x e fr o m t h e Win X P s y s t e m3 2 fo ld e r. F ig u r e 1 8.1 : C a lc u la t o r b in a r y p a t h C F F E x p lo r e r s h o w s t h a t t h e b in a r y is P o r t a b le E x e c u t a b le 3 2 . O p e n t h is b in a r y in x 3 2 d b g a n d go t o D e b u g | R u n t o s t a r t t h e c a lc u la t o r. O r y o u c a n a ls o p r e s s F 9 t o r u n . F ig u r e 1 8.2 : O p e n t h e c a lc u la t o r b in a r y in x 3 2 d b g F ir s t , w e w ill c h e c k t h e lis t o f Win 3 2 fu n c t io n c a lls in o u r b in a r y b y go in g t o t h e C P U t a b , r igh t -c lic k in g t o ge t t h e c o n t e x t m e n u , a n d t h e n go in g t o S e a r c h fo r -> A ll M o d u le s -> In t e r mo d u la r F ig u r e 1 8.3 : Int e r m o d u la r c a lls T h is w ill b r in g u p t h e A ll M o d u le s ( C a lls ) t a b , w h e r e w e c a n s e e a b u n c h o f fu n c t io n c a lls a n d in t h e b o t t o m , w e h a v e a ﬁ lt e r o p t io n t o ﬁ n d a n y s p e c iﬁ c fu n c t io n c a ll r e fe r e n c e . N o w , Win 3 2 o ﬀ e r s t h e S e t Win d o w Te x t fu n c t io n t o c h a n ge t h e t e x t o f c o n t r o l. B O O L S e t Win d o w Te x t W( H WN D     h W n d , L P C WS T R lp S t r in g ) ; It t a k e s 2 p a r a m e t e r s : h W n d is t h e h a n d le t o t h e w in d o w o r c o n t r o l w h o s e t e x t is t o b e c h a n ge d . lp S t r in g is t h e c o n t r o l t e x t L e t ’s ﬁ n d t h is fu n c t io n in t h e S e a r c h ﬁ lt e r t o ﬁ n d a ll t h e r e fe r e n c e s t o t h e fu n c t io n c a ll in o u r c o d e a n d s e t t h e b r e a k p o in t . F ig u r e 1 8.4 : S e a r c h S e t Wind o w Te x t W a n d s e t t h e b r e a k p o in t N o w , w e a r e a ll s e t t o u n d e r s t a n d t h e c o d e ﬂ o w o f t h e a p p lic a t io n . W e w ill p e r fo r m a c a lc u la t io n o f 2 +6 t o s e e if o u r b r e a k p o in t is h it o r n o t . L e t ’s b e gin b y ﬁ r s t p r e s s in g t h e b u t t o n fo r t h e d igit A s s o o n a s 2 is p r e s s e d o n t h e c a lc u la t o r, o u r b r e a k p o in t is h it . F ig u r e 1 8.5 : B r e a k p o in t h it a s 2 is p r e s s e d T h e b r e a k p o in t is s e t a t t h e S e t Win d o w Te x t W fu n c t io n c a ll a n d w e c a n s e e t h a t b e fo r e t h e C A L L t o t h e a r gu m e n t s t o t h e fu n c t io n a r e p u s h e d o n t o t h e s t a c k . s t a c k . s t a c k . s t a c k . s t a c k . s t a c k . s t a c k . s t a c k . s t a c k . s t a c k . T h e s e c o n d a r gu m e n t o f S e t Win d o w Te x t W is L P C WS T R w h ic h is p u s h e d ﬁ r s t o n t h e s t a c k b y t h e in s t r u c t io n : p u s h d w o r d p t r s s :[e s p +0 x 1 0 ] T h is p u s h e s [E S P +0 x 1 0 ] o n t h e s t a c k . Wh ile r u n n in g t h is p u s h in s t r u c t io n , [E S P +0 x 1 0 ] w a s p o in t in g t o w h ic h is t h e m e m o r y lo c a t io n o f t h e d igit w e p r e s s e d o n t h e c a lc u la t o r, S o t h a t m e a n s t h e m e m o r y lo c a t io n o f t h e d igit 2 ( w h ic h w e p r e s s e d o n t h e c a lc u la t o r ) w a s p u s h e d o n t h e s t a c k . L e t ’s s e e h o w t h e d igit 2 is s t o r e d in t h e m e m o r y b y d u m p in g 0 x 0 0 0 6 F 7 E 0 in t h e m e m o r y d u m p . W e c a n o b s e r v e t h a t t h e d igit is s t o r e d in t h e Un ic o d e fo r m a t . F o r u n d e r s t a n d in g A S C II a n d Un ic o d e , r e fe r t o t h e F ig u r e 1 8.6: M e m o r y lo c a t io n o f t h e d ig it 2 T h e ﬁ r s t a r gu m e n t o f S e t Win d o w Te x t W is H WN D w h ic h is t h e h a n d le t o t h e c o n t r o l w h o s e t e x t is t o b e c h a n ge d . T h is is p u s h e d o n t h e s t a c k b y t h e P US H E S I in s t r u c t io n . W e n o w u n d e r s t a n d h o w a d igit t h a t w e p r e s s o n t h e c a lc u la t o r is s t o r e d in t h e m e m o r y. N o w w e w ill p r e s s R u n in x 3 2 d b g t o r e t u r n t h e c o n t r o l b a c k t o t h e c a lc u la t o r. O n c e t h e c a lc u la t o r h a s t h e c o n t r o l, p r e s s p lu s ( +) o n t h e c a lc u la t o r. A f t e r p r e s s in g p lu s t h e b r e a k p o in t is h it a ga in . F ig u r e 1 8.7 : B r e a k p o in t h it w h e n + is p r e s s e d A ll t h e r e gis t e r s a r e u n c h a n ge d a t t h is p o in t a n d w e s e e t h a t t h e r e is n o id e n t iﬁ e r t o d iﬀ e r e n t ia t e w h e n t h e p lu s ( +) is p r e s s e d o n t h e c a lc u la t o r. P r e s s R u n in x 3 2 d b g a ga in t o r e t u r n t h e c o n t r o l b a c k t o t h e c a lc u la t o r. N o w w e w ill p r e s s t h e n e x t d igit , w h ic h is o n t h e c a lc u la t o r. W e c a n a ga in s e e t h a t o u r b r e a k p o in t is h it a n d t h e s t a c k is p u s h e d w it h t h e m e m o r y lo c a t io n o f t h e d igit T h e s a m e b e h a v io u r w a s o b s e r v e d e a r lie r, w h e r e in t h e p a r a m e t e r s t o t h e S e t Win d o w Te x t W fu n c t io n w e r e p u s h e d o n t o t h e s t a c k . F ig u r e 1 8.8: B r e a k p o in t h it o n p r e s s in g 6 N e x t , t o e v a lu a t e 2 +6 , w e w ill p r e s s t h e e q u a l t o b u t t o n o n t h e c a lc u la t o r. A f t e r p r e s s in g e q u a l o u r b r e a k p o in t is h it b u t n o t h in g s p e c ia l is o b s e r v e d o n t h e s t a c k o r in t h e r e gis t e r v a lu e t o h e lp u s d iﬀ e r e n t ia t e w h e n t h e e q u a l t o b u t t o n is p r e s s e d o n t h e c a lc u la t o r. F ig u r e 1 8.9: B r e a k p o in t h it w h e n = is p r e s s e d S o , w e w ill p a s s t h e e x e c u t io n b y p r e s s in g R u n a ga in . T h is t im e w h e n t h e b r e a k p o in t is h it , w e c a n s e e t h a t t h e r e s u lt o f 2 +6 , w h ic h is is p u s h e d o n t h e s t a c k . F ig u r e 1 8.1 0 : S u m 8 is p u s h e d o n t h e s t a c k A ga in , 0 x 0 0 0 6 F 7 E 0 is t h e m e m o r y lo c a t io n o f t h e e v a lu a t e d r e s u lt , w h ic h is B y d u m p in g 0 x 0 0 0 6 F 7 E 0 in t h e m e m o r y d u m p , w e c a n o b s e r v e t h a t t h e r e s u lt is s t o r e d in t h e Un ic o d e fo r m a t . O n t h e n e x t R u n in x 3 2 d b g, o u r e v a lu a t e d v a lu e 8 is d is p la y e d o n t h e c a lc u la t o r. F ig u r e 1 8.1 1 : S u m 8 is d is p la y e d o n t h e c a lc u la t o r W e c a n o b s e r v e t h a t e v e r y t im e w e p r e s s a n y d igit o n t h e c a lc u la t o r, t h e S e t Win d o w Te x t W fu n c t io n is c a lle d , w h ic h p u s h e s t h e m e m o r y lo c a t io n o f t h e d igit o n t h e s t a c k . B u t w e w e r e n o t a b le t o ﬁ n d a n y id e n t iﬁ e r o r d iﬀ e r e n t ia l ﬂ o w t ill t h a t p o in t t o h e lp u s id e n t if y w h e n t h e u s e r p r e s s e d t h e e q u a l t o b u t t o n o n t h e c a lc u la t o r. F in d in g a p la c e h o ld e r t o c a ll o u r c o d e T h e o b je c t iv e o f t h is s t e p is t o id e n t if y a c o n d it io n w h e r e w e c a n d iﬀ e r e n t ia t e b e t w e e n t h e p r e s s o f t h e e q u a l t o b u t t o n o n t h e c a lc u la t o r a n d t h e p r e s s o f a n o t h e r d igit o r a b u t t o n o n t h e c a lc u la t o r. W e h a v e t o b e a b le t o ﬁ n d t h a t d iﬀ e r e n t ia l ﬂ o w o r s o m e r e gis t e r v a lu e t o h e lp u s id e n t if y t h e p r e s s o f t h e e q u a l t o b u t t o n . Us in g t h a t a s a c o n d it io n o r t r igge r, w e c a n ju m p t o o u r w r it t e n c o d e t o ﬂ a s h o u r d e ﬁ n e d s t r in g o n t h e c a lc u la t o r w h e n t h e e q u a l t o b u t t o n is p r e s s e d . To ﬁ n d t h a t d iﬀ e r e n t ia t in g p a r a m e t e r, w e w ill fo llo w a s im p le p r o c e s s , w h e r e in w e w ill n o t e d o w n t h e v a lu e o f a ll t h e r e gis t e r s a n d t h e s t a c k a t t h e p r e s s o f a n y b u t t o n o n t h e c a lc u la t o r. A s w e h a v e t h e x 3 2 d b g d e b u gge r a t t a c h e d t o o u r c a lc u la t o r, w e w ill fo llo w t h e giv e n s t e p s : F ir s t p r e s s 2 o n t h e c a lc u la t o r t o h it t h e b r e a k p o in t . Wh e n t h e e x e c u t io n is p a u s e d a t t h e b r e a k p o in t , n o t e t h e r e gis t e r v a lu e a n d t h e s t a c k . N o w p r e s s R u n in x 3 2 d b g t o r e t u r n t h e c o n t r o l t o t h e c a lc u la t o r. P r e s s t h e p lu s ( +) b u t t o n t o h it b r e a k p o in t a ga in a n d n o t e t h e r e gis t e r v a lu e a n d t h e s t a c k . P r e s s R u n in x 3 2 d b g a ga in a n d t h e n p r e s s 6 t o h it b r e a k p o in t t o n o t e t h e r e gis t e r v a lu e a n d t h e s t a c k . P r e s s R u n a ga in in x 3 2 d b g t o r e t u r n t h e c o n t r o l t o t h e c a lc u la t o r. T h e n p r e s s e q u a l t o ( =) t o h it t h e b r e a k p o in t . A t t h is p o in t , y o u w ill s e e t h a t t h e c a lc u la t e d v a lu e o f 8 is n o t p u s h e d o n t h e s t a c k . P r e s s R u n in x 3 2 d b g a ga in a n d n o t e t h e r e gis t e r s ’ v a lu e s a n d t h e s t a c k . N o w if y o u p r e s s R u n in x 3 2 d b g a ga in , it w ill u p d a t e t h e c a lc u la t o r w it h t h e c a lc u la t e d v a lu e , w h ic h is 2 +6 = 8 . F o r y o u r b e t t e r u n d e r s t a n d in g, w e h a v e p la c e d t h e o u t p u t o f t h e p r e c e d in g s t e p s in a t a b le fo r m a t . T h is w ill a ls o h e lp u s a n a ly z e a ll t h e r e gis t e r s a n d t h e s t a c k t o ﬁ n d a n y d iﬀ e r e n t ia t in g p a r a m e t e r t o h e lp u s id e n t if y t h e p r e s s o f t h e e q u a l t o b u t t o n o n t h e c a lc u la t o r. Ta b le 1 8.1 : C o m p a r is o n o f r e g is t e r s a n d t h e s t a c k w h e n B P a t C A L L A s w e c a n s e e fr o m t h e t a b le , t h e r e gis t e r v a lu e s a r e t h e s a m e w h e n t h e d iﬀ e r e n t k e y s a r e p r e s s e d o n t h e c a lc u la t o r. T h is is n o t le a d in g u s t o ﬁ n d a n y d iﬀ e r e n t ia t in g p a r a m e t e r t o d e t e r m in e w h e t h e r t h e u s e r p r e s s e d t h e e q u a l t o b u t t o n o r s o m e o t h e r d igit . L e t ’s m o v e o u r b r e a k p o in t p o s it io n t o t h e s t a r t o f t h e p r o c e d u r e a n d s e e if w e c a n ﬁ n d s o m e t h in g t h e r e t o d iﬀ e r e n t ia t e b e t w e e n t h e k e y s p r e s s e d o n t h e c a lc u la t o r. S e t t h e b r e a k p o in t a t t h e s t a r t o f p r o c e d u r e a n d fo llo w t h e s a m e d e b u ggin g p r o c e s s t o c a lc u la t e 2 +6 o n t h e c a lc u la t o r. Ta b le 1 8.2 : C o m p a r is o n o f t h e r e g is t e r s a n d t h e s t a c k w h e n B P a t t h e P R O C s t a r t In t h is e x e r c is e , w e c a n o b s e r v e t w o p o in t s : F ir s t , E A X is h o ld in g t h e m e m o r y lo c a t io n o f t h e e v a lu a t e d r e s u lt ( t h a t is 2 + 6 = 8 ) a n d w e k n o w t h a t E A X h o ld s t h e r e t u r n v a lu e o f t h e c a lle r fu n c t io n . S e c o n d , t h e E S I r e gis t e r c a n b e o f o u r in t e r e s t . Wh e n 2 o r p lu s ( +) o r 6 is p r e s s e d o n t h e c a lc u la t o r, t h e v a lu e o f E S I is a lw a y s lo w e r t h a n le t ’s s a y a b o u t 1 0 0 0 ( in d e c im a l) ( 0 x 3 E 8 in h e x ) . B u t w h e n t h e e q u a l t o b u t t o n is p r e s s e d o n t h e c a lc u la t o r, t h e E S I v a lu e is gr e a t e r t h a n 1 0 0 0 ( in d e c im a l) ( 0 x 3 E 8 in h e x ) . T h is c o n d it io n w ill h e lp u s d iﬀ e r e n t ia t e b e t w e e n t h e o t h e r b u t t o n s t h a t a r e p r e s s e d a n d w h e n t h e e q u a l t o b u t t o n is p r e s s e d o n t h e c a lc u la t o r. S o , w e c a n u s e t h is a s a t r igge r in g c o n d it io n t o ju m p t o o u r c o d e a n d t o a u t o m a t e t h is w h o le p r o c e s s o f c h e c k in g w h e n t h e e q u a l t o b u t t o n is p r e s s e d o n t h e c a lc u la t o r. T h e p s e u d o c o d e o f t h is c a n b e a s fo llo w s : If ( E S I ≤ 0 x 3 E 8 )   // 2 o r p lu s ( +) o r 6 b u t t o n is p r e s s e d o n t h e c a lc u la t o r { C o n t in u e e x e c u t io n n o r m a lly } e ls e     // e q u a l t o b u t t o n is p r e s s e d o n t h e c a lc u la t o r { R u n o u r c o d e t o p r in t t e x t o n c a lc u la t o r s c r e e n } N o w , w e w ill m o v e o n t o w r it e o u r c o d e . B u t t h e b ig q u e s t io n is , w h e r e a r e w e go in g t o w r it e o u r c o d e ? T h e a n s w e r t o t h e q u e s t io n is t h a t w e w ill w r it e o u r c o d e in t h e C o d e C a v e . B u t ﬁ r s t , w e w ill u n d e r s t a n d w h a t c o d e c a v e is in t h e fo llo w in g s e c t io n . W r it in g o u r c o d e in t h e C o d e C a v e To m o d if y a n y a p p lic a t io n o r a d d s o m e fu n c t io n a lit y t o a n y a p p lic a t io n , w e n e e d t o h a v e t h e s o u r c e c o d e . H a v in g a s o u r c e c o d e a n d m o d if y in g it is t h e s im p le s t s o lu t io n t o a d d s o m e fu n c t io n a lit y t o t h e a p p lic a t io n . B u t w h a t if w e d o n ’t h a v e t h e s o u r c e c o d e ? In t h a t c a s e , w e w ill h a v e t o m o d if y t h e a p p lic a t io n b in a r y a n d a d d o u r c o d e t o it . F o r a d d in g o u r c o d e t o t h e c o m p ile d a p p lic a t io n o r b in a r y, w e w ill u s e t h e c o d e c a v e . F o r a d d in g t h e c o d e , w e w ill h a v e t o ﬁ n d a n u n u s e d a r e a in t h e c o m p ile d a p p lic a t io n o r e x e ﬁ le . T h is u n u s e d s p a c e w ill b e o u r W e w ill in s e r t o u r c u s t o m c o d e in t h is c a v e . F in a lly, s o m e w h e r e in t h e o r igin a l b in a r y, w e w ill a d d ju m p t o o u r c o d e c a v e s o t h a t it is e x e c u t e d a lo n g w it h t h e o r igin a l b in a r y e x e c u t io n . A t t h e e n d , t o r e t u r n t h e e x e c u t io n fr o m o u r c o d e c a v e t o t h e o r igin a l b in a r y, w e w ill a d d r e t u r n t o o u r c o d e c a v e . T h is p r o c e s s is u s e d b y m a n y m a lw a r e w r it e r s t o a d d c u s t o m c o d e t o t h e c o m p lie d a p p lic a t io n . F ig u r e 1 8.1 2 : C o d e c a v e c o n c e p t S o m e t im e s , a n e m p t y s p a c e is n o t e n o u gh t o w r it e a b ig c o d e . In s u c h c a s e s , a n e w s e c t io n c a n b e a d d e d t o t h e b in a r y w it h e x e c u t a b le p r iv ile ge s . T h e n w e c a n ju m p t o t h a t s e c t io n a n d r e t u r n b a c k . T h is t e c h n iq u e is n o t c o v e r e d h e r e , s o le t ’s m o v e o n t o c o d e c a v e . Wh ile w r it in g a c o d e in t h e c a v e , w e a lw a y s h a v e t o r e m e m b e r t h a t e v e r y b y t e c o u n t s . T h e s iz e o f t h e c o d e s h o u ld b e a s s m a ll a s p o s s ib le . To ﬁ n d t h e s p a c e a v a ila b le fo r u s , le t ’s w a lk t h r o u gh t h e c o m p ile d b in a r y o f t h e c a lc u la t o r a n d b a s e d o n t h a t , w e w ill t a k e a d e c is io n . C o m p ile d a p p lic a t io n , e x e , p o r t a b le e x e , b in a r y – A ll t h e s e m e a n t h e s a m e . A s w e m o v e t o w a r d s t h e e n d o f t h e c a lc u la t o r e x e c u t a b le , w e s e e e n o u gh s p a c e t o w r it e o u r c o d e ( s h o w n in t h e fo llo w in g s c r e e n s h o t ) . W e w ill s e le c t s o m e s e c t io n s o f t h e s p a c e a n d ﬁ ll it w it h t h e N O P in s t r u c t io n . T h is s e c t io n c a n b e r e fe r r e d t o a s t h e c a v e . F ig u r e 1 8.1 3 : C o d e c a v e w it h N O P s A f t e r ﬁ llin g t h e c a v e w it h t h e w e c a n s t a r t w r it in g o u r c o d e . T h e o b je c t iv e o f t h is c o d e is t o p r in t JITEN D E R N A R UL A IS W A T C H IN G Y O U o n t h e c a lc u la t o r w h e n s o m e b o d y p e r fo r m s s o m e c a lc u la t io n a n d p r e s s e s t h e e q u a l t o b u t t o n fo r t h e r e s u lt . T h is o u t p u t t e x t c a n b e c u s t o m iz e d t o a n y t h in g o f y o u r c h o ic e . T h e c o d e t h a t go e s in t o t h e c a v e is : F ig u r e 1 8.1 4 : C o d e c a v e T h e c o d e h a s b e e n e x p la in e d a s fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : fo llo w s : Ta b le 1 8.3 : C o d e c a v e e x p la in e d in s t r u c t io n b y in s t r u c t io n N o w w e h a v e w r it t e n o u r c o d e in t h e c a v e . To c a ll t h is c o d e d u r in g t h e c a lc u la t o r e x e c u t io n , w e h a v e t o m o d if y t h e e x e c u t io n ﬂ o w o f t h e e x e c u t a b le a s e x p la in e d in ﬁ g u r e To d o t h is , w e c a n e it h e r u s e t h e C A L L in s t r u c t io n o r t h e JM P in s t r u c t io n . W e c a n u s e t h e C A L L in s t r u c t io n t o c a ll o u r c o d e b u t s in c e w e d o n ’t h a v e a n y s p a c e c o n s t r a in t s , w e w ill u s e t h e b a s ic JM P in s t r u c t io n fo r e a s y u n d e r s t a n d in g. F o llo w b e lo w s c r e e n s t o m o d if y e x e c u t a b le c o d e ﬂ o w a t t h e s t a r t o f t h e p r o c e d u r e w h e r e w e in s e r t e d o u r b r e a k p o in t fo r t h e c o m p a r is o n o f r e gis t e r s a n d t h e s t a c k t o ge t t h e t r igge r in g c o n d it io n in t a b le F ig u r e 1 8.1 5 : O r ig in a l e x e c u t a b le F ig u r e 1 8.1 6: A f t e r a d d in g ju m p t o C o d e C a v e T h e JM P in s t r u c t io n is p o in t in g t o t h e c o d e c a v e a n d t h e in s t r u c t io n s o c c u p ie d b y N O P a r e c a lle d in t h e c o d e c a v e . N o w w e a r e d o n e w it h o u r c o d e in s e r t io n in t h e c o m p ile d b in a r y. W e w ill n o w p a t c h t h is b in a r y t o s a v e t h e c h a n ge s in t h e c a lc u la t o r e x e . P a t c h in g t h e b in a r y P a t c h in g w ill h e lp u s in w r it in g o u r c o d e in t h e c o m p ile d c a lc u la t o r a p p lic a t io n o n t h e d is k . To p a t c h , go t o F ile -> P a t c h S e le c t A ll t o P a t c h S p e c if y t h e p a t h & ﬁ le n a m e t o s a v e t h e ﬁ le o n t h e d is k . N o w , b y p e r fo r m in g a n y c a lc u la t io n o n o u r p a t c h e d c a lc u la t o r b in a r y, t h e fo llo w in g r e s u lt w ill b e p r o d u c e d o n p r e s s in g t h e e q u a l t o b u t t o n . F o r e x a m p le , if w e p r e s s 2 +6 a n d t h e n t h e e q u a l t o b u t t o n , w e w ill ge t t h e fo llo w in g r e s u lt : F ig u r e 1 8.1 7 : P a t c h e d c a lc u la t o r P la c in g t h e b r e a k p o in t in o u r c o d e c a v e s h o w s t h a t w e h a v e o v e r w r it t e n t h e c a lc u la t o r r e s u lt in t h e m e m o r y w it h o u r c u s t o m t e x t JITEN D E R N A R UL A IS W A T C H IN G F ig u r e 1 8.1 8: P a t c h e d c a lc u la t o r in x 3 2 d b g C o n c lu s io n In t h is c h a p t e r, w e le a r n e d t o r e v e r s e e n gin e e r t h e c a lc u la t o r b y m o d if y in g it s b e h a v io u r t o o u t p u t o u r d e ﬁ n e d s t r in g fo r a n y c a lc u la t io n . T h is m e a n s t h a t r a t h e r t h a n ge t t in g 8 a s a n o u t p u t t o 2 +6 o r a n y o t h e r c a lc u la t io n , t h e c a lc u la t o r w ill d is p la y o u r d e ﬁ n e d m e s s a ge o n p r e s s in g t h e e q u a l t o b u t t o n . W e a ls o le a r n e d t h e c o n c e p t o f ﬁ n d in g a c a v e in t h e c lo s e d b in a r y a n d w r it in g a c o d e c a v e t o c h a n ge t h e e x e c u t io n p a t h o f t h e b in a r y. F u r t h e r, w e le a r n e d h o w t o p a t c h t h e b in a r y t o p e r m a n e n t ly w r it e t h e c h a n ge s o n t h e d is k . A p p e n d ix M a c r o M a c r o s in t h e a s s e m b le la n gu a ge a r e u s e d t o w r it e m o d u la r p r o gr a m s . M a c r o s a r e t h e s e q u e n c e o f in s t r u c t io n , a s s ign e d b y n a m e . T h e y c a n b e u s e d a n y w h e r e in t h e c o d e . T h e m a c r o s m a k e p r o gr a m s s h o r t e r a n d r e a d a b le . P r o c e d u r e A p r o c e d u r e o r s u b r o u t in e is a s e q u e n c e o f in s t r u c t io n s t h a t p e r fo r m c e r t a in t a s k s . T h e y a r e v e r y im p o r t a n t in a s s e m b ly la n gu a ge . T h e y a r e id e n t iﬁ e d b y n a m e a n d t h e e n d o f t h e p r o c e d u r e is id e n t iﬁ e d b y R E T s t a t e m e n t . n p a d T h e n p a d is a m a c r o d e ﬁ n e d in t h e lis t in g .in c w h ic h r e s id e s in R o o t _F o ld e r \\ V C \\ in c lu d e fo ld e r o f M S V C . n p a d m a c r o in s e r t s n o n - d e s t r u c t iv e a n d n o n -o p e r a t io n a l in s t r u c t io n s , r a t h e r t h a n a s e r ie s o f N O P in s t r u c t io n . Wh ile d o in g o p t im iz a t io n t h e c o m p ile r in s e r t n o n -o p e r a t io n a l in s t r u c t io n fo r e n fo r c in g a lign m e n t o f t h e d a t a . A s e r ie s o f N O P ’s c a n a ls o b e u s e d , b u t s in gle in s t r u c t io n s a r e a lw a y s go o d fo r b e t t e r C P U p e r fo r m a n c e . F ig u r e A .1 : L is t in g .in c ﬁ le p a t h n p a d m a c r o is a c c o m p a n ie d b y a n u m b e r ( X ) . Wh e r e n u m b e r X c a n b e fr o m 1 t o 1 5 , t h is n u m b e r d e ﬁ n e s t h e a m o u n t o f m e m o r y a lign m e n t o r p a d d in g r e q u ir e d b y t h e c o m p ile r d u r in g o p t im iz a t io n . C o m p ile r p a d s t h e e x t r a s p a c e b e t w e e n t h e p r e v io u s in s t r u c t io n / d a t a a n d t h e o n e a f t e r n p a d m a c r o . If w e lo o k in t o n p a d 1 d e ﬁ n e s p a d d in g o f 1 b y t e N O P n p a d 2 d e ﬁ n e s p a d d in g o f 2 b y t e s w it h mo v e d i, e d i in s t r u c t io n . n p a d 2 d e ﬁ n e s p a d d in g o f 3 b y t e s w it h le a e c x , [e c x +0 0 ] in s t r u c t io n , s o o n A ll t h e s e a r e b a s ic a lly d iﬀ e r e n t v a r ia t io n s o f N O P, w h ic h h a v e n o im p a c t o n t h e c o d e ﬂ o w . L IS T IN G .IN C fo r r e fe r e n c e : ; L IS T IN G .IN C ; ; T h is ﬁ le c o n t a in s a s s e mb le r ma c r o s a n d is in c lu d e d b y t h e ﬁ le s c r e a t e d ; w it h t h e -F A c o mp ile r s w it c h t o b e a s s e mb le d b y M A S M ( M ic r o s o f t M a c r o ; A s s e mb le r ) . ; ; C o p y r igh t ( c ) 1 9 9 3 -2 0 0 3 , M ic r o s o f t C o r p o r a t io n . A ll r igh t s r e s e r v e d . ; n o n -d e s t r u c t iv e n o p s n p a d ma c r o s iz e if s iz e e q 1 n o p e ls e if s iz e e q 2 mo v e d i, e d i e ls e if s iz e e q 3 ; le a e c x , [e c x +0 0 ] D B 8 D H , 4 9 H , 0 0 H e ls e if s iz e e q 4 ; le a e s p , [e s p +0 0 ] D B 8 D H , 6 4 H , 2 4 H , 0 0 H e ls e if s iz e e q 5 a d d e a x , D W O R D P T R 0 e ls e if s iz e e q 6 ; le a e b x , [e b x +0 0 0 0 0 0 0 0 ] D B 8 D H , 9 B H , 0 0 H , 0 0 H , 0 0 H , 0 0 H e ls e if s iz e e q 7 ; le a e s p , [e s p +0 0 0 0 0 0 0 0 ] D B 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H e ls e if s iz e e q 8 ; jmp .+8 ; .n p a d 6 D B 0 E B H , 0 6 H , 8 D H , 9 B H , 0 0 H , 0 0 H , 0 0 H , 0 0 H e ls e if s iz e e q 9 ; jmp .+9 ; .n p a d 7 D B 0 E B H , 0 7 H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H e ls e if s iz e e q 1 0 ; jmp .+A ; .n p a d 7 ; .n p a d 1 D B 0 E B H , 0 8 H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H , 9 0 H e ls e if s iz e e q 1 1 ; jmp .+B ; .n p a d 7 ; .n p a d 2 D B 0 E B H , 0 9 H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H , 8 B H , 0 F F H e ls e if s iz e e q 1 2 ; jmp .+C ; .n p a d 7 ; .n p a d 3 D B 0 E B H , 0 A H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H , 8 D H , 4 9 H , 0 0 H e ls e if s iz e e q 1 3 ; jmp .+D ; .n p a d 7 ; .n p a d 4 D B 0 E B H , 0 B H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H , 8 D H , 6 4 H , 2 4 H , 0 0 H e ls e if s iz e e q 1 4 ; jmp .+E; .n p a d 7 ; .n p a d 5 D B 0 E B H , 0 C H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H , 0 5 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H e ls e if s iz e e q 1 5 ; jmp .+F ; .n p a d 7 ; .n p a d 6 D B 0 E B H , 0 D H , 8 D H , 0 A 4 H , 2 4 H , 0 0 H , 0 0 H , 0 0 H , 0 0 H , 8 D H , 9 B H , 0 0 H , 0 0 H , 0 0 H , 0 0 H e ls e %o u t e r r o r : u n s u p p o r t e d n p a d s iz e .e r r e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d if e n d m ; d e s t r u c t iv e n o p s d p a d ma c r o s iz e , r e g if s iz e e q 1 in c r e g e ls e %o u t e r r o r : u n s u p p o r t e d d p a d s iz e .e r r e n d if e n d m L S B a n d M S B To u n d e r s t a n d le a s t s ign iﬁ c a n t b it a n d mo s t s ign iﬁ c a n t b it w e w ill t a k e a n e x a m p le o f b y t e : 0 0 0 0 0 0 0 1 In t h e a b o v e b y t e e x a m p le , b it in t h e r igh t e n d m o s t is s e t t o 1 . T h is is w h a t is r e fe r r e d a s t h e L S B . N o w t a k e a n o t h e r e x a m p le : 1 0 0 0 0 0 0 0 In t h e p r e c e d in g b y t e e x a m p le , b it in t h e le f t e n d m o s t is s e t t o 1 . T h is is w h a t is r e fe r r e d a s t h e M S B . T h is s a m e c o n c e p t go e s w it h t h e W O R D , D W O R D a n d s o o n . W O R D ( M S B ) 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 ( L S B ) D W O R D ( M S B ) 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 ( L S B ) S ign e d a n d Un s ign e d In m a t h e m a t ic s w e h a v e p o s it iv e ( 1 , 2 , 3 , 4 , s o o n ) a n d n e ga t iv e n u m b e r s ( -1 , -2 , -3 , -4 , s o o n ) . S im ila r ly t o r e p r e s e n t p o s it iv e a n d n e ga t iv e n u m b e r c o n c e p t in p r o gr a m m in g, s ign e d a n d u n s ign e d t e r m s a r e u s e d . Un s ign e d D a t a is r e p r e s e n t e d b y b y t e o f d a t a , w h e r e 0 0 is t h e lo w e s t n u m b e r in b y t e a n d F F is t h e h igh e s t n u m b e r in b y t e . T h e p o s it iv e d e c im a l n u m b e r s a r e r e p r e s e n t e d in b y t e s a s s h o w n b e lo w a n d s im ila r ly n u m b e r s c a n a ls o b e r e p r e s e n t e d in W O R D , D W O R D : F ig u r e A .2 : P o s it iv e d e c im a l n u m b e r s in b y t e s F o r W O R D t h is r a n ge is fr o m 0 0 0 0 t o F F F F a n d fo r D W O R D it is fr o m 0 0 0 0 0 0 0 0 t o F F F F F F F F. T h e s e a ll a r e r e fe r r e d t o a s u n s ign e d n u m b e r s . S ign e d Wh e n d a t a is r e p r e s e n t e d a s a s ign e d , t h e n 0 x 0 0 t o 0 x 7 F is t r e a t e d a s p o s it iv e a n d 0 x 8 0 t o 0 x F F is t r e a t e d a s n e ga t iv e n u m b e r s : F ig u r e A .3 : S ig n e d n u m b e r s in b y t e s A s w e c a n o b s e r v e M S B o f a ll n e ga t iv e n u m b e r is s e t t o 1 a n d fo r p o s it iv e n u m b e r s M S B is s e t t o 0 . C o n s id e r -4 a n d + 4 in d e c im a l, it s b y t e a n d b in a r y r e p r e s e n t a t io n is : +4 = 0 x 0 4 = 0 0 0 0 0 1 0 0 , M S B = 0 -4 = 0 x F C = 1 1 1 1 1 1 0 0 , M S B = 1 B u t w h e n t h e s a m e d e c im a l is r e p r e s e n t e d in W O R D , -4 ( d e c im a l) w ill n o t b e c o m e 0 x 0 0 F C . A s 0 x 0 0 F C is n o t n e ga t iv e , it r e p r e s e n t s p o s it iv e n u m b e r t h a t fa lls b e t w e e n 0 0 0 0 a n d 7 F F F. To r e p r e s e n t -4 in W O R D , w e n e e d t o e x t e n d it a s 0 x F F F C a n d in D W O R D it is 0 x F F F F F F F C . N o w w e u n d e r s t o o d t h a t s im p ly c h a n gin g t h e M S B b it w ill n o t c h a n ge t h e p o la r it y o f n u m b e r. To c o n v e r t p o s it iv e n u m b e r t o n e ga t iv e a n d v ic e v e r s a , c a n b e d o n e b y p e r fo r m in g 2 ’s c o m p le m e n t o f t h e n u m b e r. To c a lc u la t e 2 ’s c o m p le m e n t o f n u m b e r fo llo w in g p r o c e s s is fo llo w e d : In v e r t a ll b it s in b y t e o r W O R D o r D W O R D A f t e r ﬂ a p p in g a ll b it s , a d d 1 t o t h e n u m b e r B it S h if t in g To u n d e r s t a n d b it s h if t in g c o n c e p t , t a k e 0 x 4 4 w h ic h in b in a r y is : 0 1 0 0 0 1 0 0 In b it s h if t in g, b it s a r e s h if t e d e it h e r r igh t o r le f t . Wh e n s h if t e d t o r igh t 0 x 4 4 w ill b e c o m e : ? 0 1 0 0 0 1 0 Wh e n s h if t e d t o le f t , 0 x 4 4 w ill b e c o m e : 1 0 0 0 1 0 0 ? Wh e n w e s h if t e d t o r igh t o r le f t a b it p la c e h o ld e r p o s it io n is c r e a t e d , d e n o t e d b y q u e s t io n m a r k ( ? ) a b o v e . N o w t h is q u e s t io n m a r k c a n b e 0 o r 1 , w h ic h is d e c id e d b y t h e t y p e o f s h if t in g d o n e .i.e . L o gic a l a n d A r it h m e t ic s h if t in g. L o gic a l b it s h if t in g In lo gic a l b it s h if t in g, w h e n b it s a r e s h if t e d t o t h e r igh t , b it p la c e h o ld e r w h ic h is q u e s t io n m a r k is a lw a y s s e t t o 0 . E x a m p le : 0 1 0 0 0 1 0 0 L o gic a l s h if t r igh t o f 0 x 4 4 b e c o m e s , 0 0 1 0 0 0 1 0 Wh e n b it s h if t in g is d o n e t o le f t , L S B is a lw a y s s e t t o 0 : 0 1 0 0 0 1 0 0 L o gic a l s h if t le f t o f 0 x 4 4 b e c o m e s , 1 0 0 0 1 0 0 0 A r it h me t ic b it s h if t in g In A r it h m e t ic b it s h if t in g, w h e n b it s a r e s h if t e d t o t h e r igh t , b it p la c e h o ld e r w h ic h is q u e s t io n m a r k is d e c id e d b y m o s t s ign iﬁ c a n t b it ( M S B ) . E x a m p le : 0 1 0 0 0 1 0 0 A r it h m e t ic s h if t r igh t o f 0 x 4 4 b e c o m e s , 0 0 1 0 0 0 1 0 Ta k e a n o t h e r e x a m p le : 1 0 0 0 1 0 0 0 A r it h m e t ic s h if t r igh t o f 0 x 4 4 b e c o m e s , 1 1 0 0 0 1 0 0 Wh e n b it s h if t in g is d o n e t o le f t , L S B is a lw a y s s e t t o 0 : 0 1 0 0 0 1 0 0 A r it h m e t ic S h if t le f t o f 0 x 4 4 b e c o m e s , 1 0 0 0 1 0 0 0 A S C II W e a ll a r e fa m ilia r w it h t h e A S C II, w h e r e 7 b it s a r e u s e d t o r e p r e s e n t 1 2 8 c h a r a c t e r s a n d s t o r in g t h e m in 8 b it s . E v e r y c h a r a c t e r o c c u p ie s 1 b y t e . B e lo w is t h e A S C II t a b le fo r r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : r e fe r e n c e : Ta b le A .1 : A S C II t a b le Un ic o d e T h e r e a r e m a n y v e r s io n s o f Un ic o d e , UTF -1 6 is t h e m o s t p o p u la r o n e . It is r e p r e s e n t e d b y 1 6 b it s , w h ic h is n e e d e d t o s a t is f y a n y la n gu a ge e ﬃ c ie n t ly. It r a n ge s fr o m 0 x 0 0 0 0 t o 0 x F F F F. In A S C II it w a s n o t p o s s ib le t o s t o r e c h a r a c t e r s o f d iﬀ e r e n t la n gu a ge s , a s it ju s t 7 b it s . B u t Un ic o d e v e r s io n s a r e e x p a n d e d t o 1 6 , 3 2 b it s E x a m p le : A S C II o f ‘ A’ = 0 x 4 1 a n d Un ic o d e ( UTF =1 6 ) r e p r e s e n t a t io n is 0 0 4 1 . D is a b le A d d r e s s S p a c e L a y o u t R a n d o miz a t io n A d d r e s s S p a c e L a y o u t R a n d o miz a t io n is a s e c u r it y m e c h a n is m b y w h ic h b a s e a d d r e s s o f P E ﬁ le is r a n d o m iz e d o n e v e r y lo a d . To d is a b le t h e A S L R o n t h e P o r t a b le E x e c u t a b le ﬁ le ge n e r a t e d w it h o u r M S V C c o m p ile r w e w ill fo llo w in g s t e p s . T h is w ill h e lp u s r e lo a d P E ﬁ le w it h o u t r a n d o m iz in g b a s e a d d r e s s o f P E ﬁ le . To d is a b le A S L R w e w ill u s e a C F F E x p lo r e r ( it c a n b e d o w n lo a d fr o m O p e n t h e P E ﬁ le ge n e r a t e d in C F F E x p lo r e r a n d fo llo w s t e p s : S e le c t fr o m t h e le f t p a n e l, O p t io n a l H e a d e r In t h e O p t io n a l ﬁ n d F ig u r e A .4 : P E ﬁ le o p t io n a l h e a d e r u s in g C F F E x p lo r e r C lic k o n C lic k h e r e o n t h e r igh t b o t t o m . Un c h e c k t h e D L L c a n mo v e a n d c lic k F ig u r e A .5 : D is a b le A S L R o n P E ﬁ le N o w go t o F ile me n u a n d S a v e c h a n ge s . N o w u s in g x 3 2 d b g, w e c a n lo a d P E ﬁ le t o d o a n a ly s is w it h o u t r a n d o m iz in g b a s e a d d r e s s o n e v e r y lo a d . In d e x A A d d N u m b e r.c p p c o d e 8 6 A d d r e s s S p a c e L a y o u t R a n d o m iz a t io n ( A S L R ) a b o u t 4 6 0 d is a b lin g 4 6 1 A d v a n c e d M ic r o D e v ic e s 3 a r c h it e c t u r e , c o m p u t in g s y s t e m a b o u t 9 C P U 9 in p u t / o u t p u t d e v ic e s 1 0 m e m o r y 1 0 S y s t e m B u s 1 0 a r it h m e t ic b it s h if t in g 4 5 6 a r it h m e t ic in s t r u c t io n s A A A 4 1 A A D 4 2 A A M 4 3 A A S 4 2 A D C 4 3 A D D 4 3 C M P 4 4 D A A 4 4 D A S 4 4 D E C 4 5 D IV 4 5 ID IV 4 6 IM UL 4 7 IN C 4 7 M UL 4 7 N E G 4 8 S B B 4 8 S UB 4 8 X A D D 4 9 a r r a y a b o u t 2 4 7 d e ﬁ n in g 2 4 8 a r r a y c o d e r e v e r s e e n gin e e r in g p a t t e r n 2 4 7 a r r a y lo o p w it h o p t im iz a t io n w it h o u t o p t im iz a t io n A S C II 4 6 0 a s s e m b ly in s t r u c t io n s a b o u t 2 3 a r it h m e t ic in s t r u c t io n s 4 1 b it m a n ip u la t io n in s t r u c t io n s 6 1 b r a n c h in g in s t r u c t io n s 5 4 c a t e go r ie s 3 5 d a t a t r a n s fe r in s t r u c t io n s 3 7 p r o c e s s o r c o n t r o l in s t r u c t io n s 7 0 p r o gr a m e x e c u t io n in s t r u c t io n s 4 9 s t a c k in s t r u c t io n s 3 5 s t r in g in s t r u c t io n s 7 3 a s s e m b ly in s t r u c t io n , w it h r e gis t e r o p e r a n d s e x a m p le 3 5 a s s e m b ly la n gu a ge in s t r u c t io n s 3 4 B b a s ic c o d e r e v e r s e e n gin e e r in g p a t t e r n 9 7 b in a r y a n a ly s is , w it h C u t t e r d a s h b o a r d t a b 4 1 9 d e c o m p ile r t a b 4 2 3 d is a s s e m b ly t a b 4 2 1 gr a p h t a b 4 2 1 h e x d u m p t a b 4 2 2 im p o r t s t a b 4 2 0 s t r in gs t a b 4 2 0 b it m a n ip u la t io n in s t r u c t io n s a b o u t 6 1 A N D 6 2 B S W A P 6 1 N O T 6 2 O R 6 2 R C L 6 3 X O R 6 3 b it s h if t in g 4 5 5 b r a n c h in g in s t r u c t io n s a b o u t 5 4 JA 5 7 JA E 5 8 JB 5 9 JB E 5 9 JE 5 5 JEC X Z 6 1 JG 5 6 JG E 5 7 JL 5 8 JL E 5 8 JM P 5 4 JN E 5 6 JN Z 5 5 JO 6 0 JS 6 0 JZ 5 5 R C R 6 4 R O L 6 4 R O R 6 5 S A L 6 8 S A R 6 8 S H L 6 7 S H L D 6 9 S H R 6 6 S H R D 6 9 b u ild in g b lo c k s , o f c o m p u t in g s y s t e m B it 1 1 B y t e 1 1 D W O R D 1 1 N ib b le 1 1 W o r d 1 1 C c a llin g c o n v e n t io n s a b o u t 8 4 C D E C L 8 5 F A S T C A L L 8 5 S T D C A L L 8 5 t y p e s 8 4 C D E C L c a llin g c o n v e n t io n 8 5 C F F E x p lo r e r, P E 2 8 C le a r t h e C a r r y F la g ( C L C ) in s t r u c t io n 7 0 C le a r t h e D ir e c t io n F la g ( C L D ) in s t r u c t io n 7 0 C le a r t h e In t e r r u p t F la g ( C L I) in s t r u c t io n 7 1 c o d e c a v e c o n c e p t 4 4 2 c o d e o p t im iz a t io n a b o u t 9 8 e m p t y fu n c t io n 9 8 e m p t y fu n c t io n w it h o p t im iz a t io n 1 0 7 e m p t y fu n c t io n w it h o u t o p t im iz a t io n c o m m o n s e c t io n s , P E .b s s 2 7 .d e b u g 2 8 .e d a t a 2 8 .id a t a 2 8 .r d a t a 2 8 .r s r c 2 8 .t e x t 2 7 C o m p le m e n t C a r r y ( C M C ) in s t r u c t io n 7 1 C o m p o n e n t O b je c t M o d e l ( C O M ) 2 7 c o m p u t in g s y s t e m a b o u t 8 a r c h it e c t u r e 9 b u ild in g b lo c k s 1 1 ﬁ x e d p r o gr a m c o m p u t in g s y s t e m 8 s t o r e d p r o gr a m c o m p u t in g s y s t e m 8 c o n c e p t , b e h in d d iﬀ e r e n t c a llin g c o n v e n t io n s a b o u t 8 6 C D E C L F A S T C A L L S T D C A L L c o n d it io n a l ju m p 5 4 C P U, c o m p u t in g s y s t e m c o n t r o l u n it 9 e x e c u t io n u n it 9 ﬂ a gs 1 0 r e gis t e r s 9 c r y p t o c u r r e n c y 4 C u t t e r a b o u t 4 1 6 d o w n lo a d in g 4 1 6 in s t a llin g u s in g, fo r b in a r y a n a ly s is 4 1 8 D d a t a t r a n s fe r in s t r u c t io n s C M P X C H G 3 8 L A H F 3 9 L A R 3 9 L E A 3 8 M O V 3 7 M O V S 4 1 M O V S X 4 0 M O V Z X 4 0 S A H F 3 9 X C H G 3 8 X L A T 4 0 d e b u gge r s a b o u t 3 0 x 3 2 d b g 3 1 d e c is io n c o n t r o l s t r u c t u r e r e v e r s e e n gin e e r in g p a t t e r n 1 8 6 d is a s s e m b le r s a b o u t 2 9 C u t t e r 3 0 G h id r a 2 9 D is k O p e r a t in g S y s t e m ( D O S ) 2 D L L c a n m o v e 1 8 7 D llC h a r a c t e r is t ic s p a r a m e t e r 1 8 7 D y n a m ic L in k L ib r a r y ( D L L ) 2 7 E E E F L A G S r e gis t e r 1 7 E IP. S e e In s t r u c t io n P o in t e r r e gis t e r E s c a p e t o F lo a t in g P o in t C o p r o c e s s o r ( E S C ) in s t r u c t io n 7 1 E x c h a n ge a n d A d d ( X A D D ) in s t r u c t io n 4 8 F F A S T C A L L 8 5 ﬁ r s t ge n e r a t io n m ic r o p r o c e s s o r s In t e l 8 0 8 6 1 2 In t e l 8 0 1 8 6 1 2 In t e l 8 0 2 8 6 1 3 In t e l 8 0 3 8 6 1 3 In t e l 8 0 4 8 6 1 3 ﬁ x e d p r o gr a m c o m p u t in g s y s t e m 8 F lo a t in g P o in t Un it ( F P U) 1 3 1 F o o fu n c t io n 1 9 fo r lo o p a b o u t 2 3 0 w it h o p t im iz a t io n w it h o u t o p t im iz a t io n fu n c t io n p r in t f w it h c h a r a b o u t 1 4 7 fu n c t io n p r in t f p r in t in g c h a r w it h o p t im iz a t io n fu n c t io n p r in t f p r in t in g c h a r w it h o u t o p t im iz a t io n fu n c t io n p r in t f w it h ﬂ o a t a b o u t 1 3 1 fu n c t io n p r in t f p r in t in g ﬂ o a t w it h o p t im iz a t io n fu n c t io n p r in t f p r in t in g ﬂ o a t w it h o u t o p t im iz a t io n fu n c t io n p r in t f w it h in t e ge r s a b o u t 1 2 2 fu n c t io n p r in t f p r in t in g in t e ge r s w it h o p t im iz a t io n 1 3 0 fu n c t io n p r in t f p r in t in g in t e ge r s w it h o u t o p t im iz a t io n fu n c t io n s c a n f w it h in t e ge r s 3 1 2 w it h o p t im iz a t io n w it h o u t o p t im iz a t io n G ge n e r a l p u r p o s e r e gis t e r s , x 8 6 a r c h it e c t u r e E A X 1 6 E B P 1 6 E B X 1 6 E C X 1 6 E D I 1 6 E D X 1 6 E S I 1 6 E S P 1 6 G h id r a a b o u t 2 9 in s t a llin g H H a r d D is k ( H D D ) 1 0 H a s h e s s e c t io n 4 1 8 “ h e llo , w o r ld ” p r o gr a m a b o u t 1 1 3 w it h o p t im iz a t io n w it h o u t o p t im iz a t io n h id d e n UR L d e c r y p t in g H u n ga r ia n N o t a t io n 1 5 4 I iA r r a y 2 4 8 if-e ls e s t a t e m e n t a b o u t 1 8 6 w it h o p t im iz a t io n w it h o u t o p t im iz a t io n in s t a lla t io n G h id r a 3 9 4 In s t r u c t io n P o in t e r r e gis t e r 1 8 In t e ge r M u lt ip le ( IM UL ) in s t r u c t io n 4 7 In t e l 8 0 8 6 1 2 In t e l 8 0 1 8 6 1 2 In t e l 8 0 2 8 6 1 3 In t e l 8 0 3 8 6 1 3 In t e l 8 0 4 8 6 1 3 In t e l p r o c e s s o r x 8 6 -1 6 1 4 x 8 6 -3 2 ( a k a IA 3 2 ) 1 4 x 8 6 -6 4 1 4 In t e l x 8 6 -3 2 p r o c e s s o r m e m o r y 1 4 r e gis t e r s 1 5 In t e r r u p t O v e r ﬂ o w ( IN T O ) 5 1 In t e r r u p t R e t u r n ( IR E T ) in s t r u c t io n 5 2 In t e r r u p t S e r v ic e R o u t in e ( IS R ) 5 2 iN u m b e r 1 5 4 I/ O ( in p u t / o u t p u t ) d e v ic e s , c o m p u t in g d e v ic e 1 0 J JD K 1 1 d o w n lo a d in g 3 9 4 in s t a llin g 3 9 4 Ju m p if a b o v e ( JA ) in s t r u c t io n 5 7 Ju m p if a b o v e o r e q u a l ( JA E ) in s t r u c t io n 5 7 Ju m p if b e lo w ( JB ) in s t r u c t io n 5 9 Ju m p if b e lo w o r e q u a l ( JB E ) in s t r u c t io n 5 9 Ju m p if E q u a l ( JE) in s t r u c t io n 5 5 Ju m p if G r e a t e r ( JG ) in s t r u c t io n 5 6 Ju m p if G r e a t e r o r E q u a l ( JG E ) in s t r u c t io n 5 7 Ju m p if L e s s ( JL ) in s t r u c t io n 5 8 Ju m p if L e s s o r e q u a l ( JL E ) in s t r u c t io n 5 8 Ju m p if N o t E q u a l ( JN E ) in s t r u c t io n 5 6 ju m p s , in x 8 6 c o n d it io n a l ju m p 5 4 u n c o n d it io n a l ju m p 5 4 L L a s t In F ir s t O u t ( L IF O ) 1 8 le a s t s ign iﬁ c a n t b it ( L S B ) 4 5 3 L o a d E ﬀ e c t iv e A d d r e s s ( L E A ) 1 6 2 L o a d S t r in g B y t e ( L O D S B ) 7 8 L o a d S t r in g D W O R D ( L O D S D ) 7 8 L o a d S t r in g ( L O D S ) 7 8 L o a d S t r in g W o r d ( L O D S W) 7 8 lo gic a l b it s h if t in g 4 5 5 lo o p c o n t r o l s t r u c t u r e r e v e r s e e n gin e e r in g p a t t e r n 2 1 1 M m a c r o 4 4 9 m a in fu n c t io n 1 9 m e m o r y, c o m p u t in g s y s t e m R a n d o m A c c e s s M e m o r y ( R A M ) 1 0 R e a d O n ly M e m o r y ( R O M ) 1 0 m e m o r y, In t e l x 8 6 -3 2 p r o c e s s o r d a t a 1 5 h e a p 1 5 k e r n e l s p a c e 1 5 lib r a r ie s 1 5 s t a c k 1 5 t e x t 1 5 m ic r o p r o c e s s o r a b o u t 1 2 ﬁ r s t ge n e r a t io n m ic r o p r o c e s s o r m o d e ls 1 2 m o s t s ign iﬁ c a n t b it ( M S B ) 4 5 3 M o v e S t r in g B y t e ( M O V S B ) 8 0 M o v e S t r in g D W O R D ( M O V S D ) 8 0 M o v e S t r in g ( M O V S ) 8 0 M o v e S t r in g W o r d ( M O V S W) 8 0 N N a t io n a l S e c u r it y A ge n c y ( N S A ) 2 9 N o O p e r a t io n ( N O P ) in s t r u c t io n 7 2 n p a d 4 4 9 n p a d m a c r o 4 5 0 O o p e r a n d s in t e r m e d ia t e o p e r a n d s 3 4 m e m o r y a d d r e s s o p e r a n d s 3 4 r e gis t e r o p e r a n d s 3 4 o p e r a t io n c o d e 3 4 o p t im iz a t io n 9 8 O UTS B in s t r u c t io n 7 7 O UTS D in s t r u c t io n 7 7 O UTS W in s t r u c t io n 7 7 O v e r ﬂ o w ﬂ a g ( O F ) 5 1 P p a t c h e d c a lc u la t o r 4 4 6 p o in t e r p r o gr a m r e v e r s e e n gin e e r in g p a t t e r n 1 5 3 p o in t e r s a b o u t w it h o p t im iz a t io n w it h o u t o p t im iz a t io n P O P 1 8 P o r t a b le E x e c u t a b le E d it o r s a b o u t 2 7 b a s ic s t r u c t u r e 2 7 C F F E x p lo r e r 2 8 c o m m o n s e c t io n s 2 7 p r in t f p r o gr a m r e v e r s e e n gin e e r in g p a t t e r n 1 2 1 p r o c e d u r e 4 4 9 p r o c e s s o r c o n t r o l in s t r u c t io n s C L C 7 0 C L D 7 0 C L I 7 1 C M C 7 1 E S C 7 1 L O C K 7 2 N O P 7 2 S T C 7 3 S T D 7 3 S T I 7 3 p r o gr a m c o d e 3 4 p r o gr a m e x e c u t io n in s t r u c t io n s a b o u t 4 9 C A L L 4 9 E N T E R 5 0 IN T 5 1 IN T O 5 1 IR E T 5 2 L E A V E 5 0 L O O P 5 2 L O O P E 5 2 L O O P N E 5 3 T E S T 5 3 p s e u d o c o d e a b o u t 1 8 F o o fu n c t io n 1 9 m a in fu n c t io n 1 9 P US H 1 8 R R a d a r e 2 3 0 R a n d o m A c c e s s M e m o r y ( R A M ) 1 0 r a n s o m w a r e s 3 R e a d O n ly M e m o r y ( R O M ) 1 0 r e gis t e r s , In t e l x 8 6 -3 2 p r o c e s s o r a b o u t 1 7 ge n e r a l p u r p o s e r e gis t e r s 1 6 In s t r u c t io n P o in t e r r e gis t e r 1 8 s e gm e n t r e gis t e r s 1 7 R e p e a t if E q u a l ( R E P E ) 8 1 R e p e a t if N o t E q u a l ( R E P N E ) 8 2 R e p e a t if N o t Z e r o ( R E P N Z ) 8 2 R e p e a t if Z e r o ( R E P Z ) 8 1 R e p e a t ( R E P ) 8 1 r e t u r n in g v a lu e a b o u t 1 0 8 r e t u r n in g v a lu e w it h o p t im iz a t io n r e t u r n in g v a lu e w it h o u t o p t im iz a t io n R e v e r s e E n gin e e r in g ( R E ) a b o u t 2 b o u n t y fo r c y b e r e n t h u s ia s t s 5 e x a m p le 3 e x is t in g d e s ign , s t u d y in g 4 im p o r t a n c e 4 m ilit a r y e s p io n a ge 4 o u t d a t e d o r lo s t p r o d u c t , r e d e v e lo p in g 4 p r o d u c t v u ln e r a b ilit ie s , ﬁ n d in g 5 r o le 6 s e c u r it y a u d it 4 s e n s it iv e d a t a , ﬁ n d in g 4 r e v e r s e e n gin e e r in g t o o ls c a t e go r ie s 2 7 d e b u gge r s 3 0 d is a s s e m b le r s 2 9 im p o r t a n c e 2 6 P o r t a b le E x e c u t a b le E d it o r s 2 7 R o t a t e L e f t ( R O L ) 6 4 R o t a t e R igh t ( R O R ) 6 5 R o t a t e t h r o u gh C a r r y L e f t ( R C L ) in s t r u c t io n 6 3 R o t a t e t h r o u gh c a r r y r igh t ( R C R ) 6 4 S s c a n f p r o gr a m p a t t e r n in r e v e r s e e n gin e e r in g 3 1 1 S c a n S t r in g B y t e ( S C A S B ) 7 9 S c a n S t r in g D W O R D ( S C A S D ) 7 9 S c a n S t r in g ( S C A S ) 7 9 S c a n S t r in g W o r d ( S C A S W) 7 9 s e gm e n t r e gis t e r s , x 8 6 a r c h it e c t u r e C o d e S e gm e n t ( C S ) 1 7 D a t a S e gm e n t ( D S ) 1 7 E S 1 7 F S 1 7 G S 1 7 S t a c k S e gm e n t ( S S ) 1 7 S e t t h e C a r r y F la g ( S T C ) in s t r u c t io n 7 3 S e t t h e D ir e c t io n F la g ( S T D ) in s t r u c t io n 7 3 S e t t h e In t e r r u p t F la g ( S T I) in s t r u c t io n 7 3 S h if t A r it h m e t ic L e f t ( S A L ) 6 8 S h if t A r it h m e t ic R igh t ( S A R ) 6 8 S h if t L e f t D o u b le ( S H L D ) 6 9 S h if t L o gic a l L e f t ( S H L ) 6 7 S h if t L o gic a l R igh t ( S H R ) 6 6 S h if t R igh t D o u b le ( S H R D ) 6 9 s ign e d t e r m s 4 5 5 s im p le in t e r e s t c a lc u la t io n p r o gr a m , w r it in g fo r 3 7 6 w it h o u t o p t im iz a t io n s im p le in t e r e s t c o d e p a t t e r n in r e v e r s e e n gin e e r in g 3 7 5 s t a c k a b o u t 1 9 p s e u d o c o d e 1 8 s t a c k fr a m e a b o u t 1 9 C a lle e A f t e r F u n c t io n C a ll 2 2 C a lle e B e fo r e R e t u r n in g 2 3 C a lle r A f t e r R e t u r n in g 2 4 C a lle r B e fo r e C a lle e C a ll 2 1 s t a c k in s t r u c t io n s a b o u t 3 5 P O P 3 6 P O P A D 3 7 P O P F D 3 7 P US H 3 6 P US H A D 3 6 P US H F D 3 6 R E T 3 7 s t a t u s r e gis t e r, x 8 6 a r c h it e c t u r e C a r r y F la g ( C F ) 1 7 O v e r ﬂ o w F la g ( O F ) 1 8 P a r it y F la g ( P F ) 1 8 S ign F la g ( S F ) 1 7 Tr a p F la g ( T F ) 1 8 Z e r o F la g ( Z F ) 1 7 S T D C A L L 8 5 s t o r e d p r o gr a m c o m p u t in g s y s t e m 8 S t o r e S t r in g B y t e ( S T O S B ) 7 8 S t o r e S t r in g D W O R D ( S T O S D ) 7 9 S t o r e S t r in g ( S T O S ) 7 8 S t o r e S t r in g W o r d ( S T O S W) 7 9 s t r c p y a b o u t 3 2 8 w it h o p t im iz a t io n w it h o u t o p t im iz a t io n s t r c p y p r o gr a m p a t t e r n in r e v e r s e e n gin e e r in g 3 2 7 s t r in g in s t r u c t io n s C M P S / C M P S B / C M P S W 7 4 IN / IN S B / IN S W/ IN S D 7 6 L O D S / L O D S B / L O D S W/ L O D S D 7 8 M O V S / M O V S B / M O V S W 8 0 O UT/ O UTS B / O UTS W/ O UTS D 7 7 R E P 8 1 R E P E / R E P Z 8 1 R E P N E / R E P N Z 8 2 S C A S / S C A S B / S C A S W 7 9 S T O S / S T O S B / S T O S W 7 8 s t r u c t u r e a b o u t 2 8 2 w it h o p t im iz a t io n w it h o u t o p t im iz a t io n s t r u c t u r e c o d e r e v e r s e e n gin e e r in g p a t t e r n 2 8 1 s u b r o u t in e 4 4 9 S y s t e m B u s , c o m p u t in g s y s t e m A d d r e s s B u s 1 0 C o n t r o l B u s 1 0 D a t a B u s 1 0 T t o o ls , r e v e r s e e n gin e e r in g. S e e r e v e r s e e n gin e e r in g t o o ls U u n c o n d it io n a l ju m p 5 4 Un ic o d e 4 6 0 u n s ign e d t e r m s 4 5 4 UTF -1 6 4 6 0 V v o n N e u m a n n a r c h it e c t u r e 9 W W a n n a c r y r a n s o m w a r e a b o u t 3 a n a ly z in g b r e a k in g 3 9 3 d is a s s e m b lin g w h ile c o n d it io n a b o u t 2 1 2 with optimization without optimization Windows Calculator reverse engineering 429 Windows Calculator, reverse engineering about 430 binary, patching 446 code ﬂow, with breakpoints code, writing in code cave placeholder, ﬁnding to call code X x32dbg about 31 disassembly or CPU instructions 31 memory dump 31 registers and ﬂags 31 stack 31 x86 Intel family 14 sanet.st","libVersion":"0.2.3","langs":""}